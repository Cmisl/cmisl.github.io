<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="ASM学习笔记ASM 是什么？简单来说，ASM 是一个操作 Java 字节码的类库。它操作的对象是字节码数据，通常以 .class 文件形式存在。ASM 处理字节码的方式是“拆分－修改－合并”，具体步骤如下：  将 .class 文件拆分成多个部分。 对某个部分的信息进行修改。 将多个部分重新组织成一个新的 .class 文件。  ASM 能够做什么ASM 可以：  修改父类 添加或删除接口 添加">
<meta property="og:type" content="article">
<meta property="og:title" content="ASM字节码编辑学习笔记">
<meta property="og:url" content="http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="cmisl_破站">
<meta property="og:description" content="ASM学习笔记ASM 是什么？简单来说，ASM 是一个操作 Java 字节码的类库。它操作的对象是字节码数据，通常以 .class 文件形式存在。ASM 处理字节码的方式是“拆分－修改－合并”，具体步骤如下：  将 .class 文件拆分成多个部分。 对某个部分的信息进行修改。 将多个部分重新组织成一个新的 .class 文件。  ASM 能够做什么ASM 可以：  修改父类 添加或删除接口 添加">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/class-visitor-cv-field.png">
<meta property="og:image" content="http://example.com/.https:/cmisl.oss-cn-beijing.aliyuncs.com/cmisl/asm-core-classes.png">
<meta property="article:published_time" content="2024-09-24T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-17T17:35:23.185Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/class-visitor-cv-field.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ASM字节码编辑学习笔记</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/10/28/%E9%AB%98%E7%89%88%E6%9C%ACJDK%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/09/08/Weblogic/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=ASM字节码编辑学习笔记"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&is_video=false&description=ASM字节码编辑学习笔记"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ASM字节码编辑学习笔记&body=Check out this article: http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=ASM字节码编辑学习笔记&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=ASM字节码编辑学习笔记"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ASM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">ASM学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ASM-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">ASM 是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ASM-%E8%83%BD%E5%A4%9F%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.2.</span> <span class="toc-text">ASM 能够做什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#class-%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">.class 文件的结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#field-info-%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">field_info 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#method-info-%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">method_info 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-%E5%B1%9E%E6%80%A7%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.3.</span> <span class="toc-text">Code 属性结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ASMPrint-%E7%B1%BB"><span class="toc-number">1.4.</span> <span class="toc-text">ASMPrint 类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassVisitor-%E7%B1%BB"><span class="toc-number">1.5.</span> <span class="toc-text">ClassVisitor 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info"><span class="toc-number">1.5.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields"><span class="toc-number">1.5.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors"><span class="toc-number">1.5.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods"><span class="toc-number">1.5.4.</span> <span class="toc-text">methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.5.5.</span> <span class="toc-text">方法的调用顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visit-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.6.</span> <span class="toc-text">visit() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visitField-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.7.</span> <span class="toc-text">visitField() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visitMethod-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.8.</span> <span class="toc-text">visitMethod() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visitEnd-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.9.</span> <span class="toc-text">visitEnd() 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassWriter-%E7%B1%BB"><span class="toc-number">1.6.</span> <span class="toc-text">ClassWriter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-1"><span class="toc-number">1.6.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-1"><span class="toc-number">1.6.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-1"><span class="toc-number">1.6.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#COMPUTE-MAXS"><span class="toc-number">1.6.4.</span> <span class="toc-text">COMPUTE_MAXS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#COMPUTE-FRAMES"><span class="toc-number">1.6.5.</span> <span class="toc-text">COMPUTE_FRAMES</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-ClassWriter-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.6.6.</span> <span class="toc-text">创建 ClassWriter 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ClassWriter-%E7%B1%BB"><span class="toc-number">1.6.7.</span> <span class="toc-text">使用 ClassWriter 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.6.8.</span> <span class="toc-text">示例一：生成接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.8.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3-%E5%AD%97%E6%AE%B5-%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.9.</span> <span class="toc-text">示例二：生成接口 + 字段 + 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">1.6.9.1.</span> <span class="toc-text">编码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#visitField-%E5%92%8C-visitMethod-%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.9.2.</span> <span class="toc-text">visitField() 和 visitMethod() 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%88descriptor%EF%BC%89"><span class="toc-number">1.6.9.3.</span> <span class="toc-text">描述符（descriptor）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E7%94%9F%E6%88%90%E7%B1%BB"><span class="toc-number">1.6.10.</span> <span class="toc-text">示例三：生成类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">1.6.10.1.</span> <span class="toc-text">编码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%92%8C-%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.10.2.</span> <span class="toc-text">&lt;init&gt;() 和 &lt;clinit&gt;() 方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FieldVisitor-%E7%B1%BB"><span class="toc-number">1.7.</span> <span class="toc-text">FieldVisitor 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-2"><span class="toc-number">1.7.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-2"><span class="toc-number">1.7.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-2"><span class="toc-number">1.7.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-1"><span class="toc-number">1.7.4.</span> <span class="toc-text">methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E5%AD%97%E6%AE%B5%E5%B8%B8%E9%87%8F"><span class="toc-number">1.7.5.</span> <span class="toc-text">示例一：字段常量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E7%9B%AE%E6%A0%87"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">预期目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">编码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FieldWriter-%E7%B1%BB"><span class="toc-number">1.8.</span> <span class="toc-text">FieldWriter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-3"><span class="toc-number">1.8.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-3"><span class="toc-number">1.8.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-3"><span class="toc-number">1.8.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-2"><span class="toc-number">1.8.4.</span> <span class="toc-text">methods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EFrame"><span class="toc-number">1.9.</span> <span class="toc-text">关于Frame</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-static-%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.1.</span> <span class="toc-text">1.static 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">方法定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B-Frame"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">初始 Frame</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HelloWorldFrameTree-%E7%B1%BB%E8%BE%93%E5%87%BA%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">HelloWorldFrameTree 类输出的内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">字节码指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Frame-%E5%8F%98%E5%8C%96"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">Frame 变化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-non-static-%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.2.</span> <span class="toc-text">2.non-static 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">方法定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B-Frame-1"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">初始 Frame</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HelloWorldFrameTree-%E7%B1%BB%E8%BE%93%E5%87%BA%E7%9A%84%E5%86%85%E5%AE%B9-1"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">HelloWorldFrameTree 类输出的内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4-1"><span class="toc-number">1.9.2.4.</span> <span class="toc-text">字节码指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Frame-%E5%8F%98%E5%8C%96-1"><span class="toc-number">1.9.2.5.</span> <span class="toc-text">Frame 变化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-long-%E5%92%8C-double-%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.9.3.</span> <span class="toc-text">3.long 和 double 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89-2"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">方法定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B-Frame-2"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">初始 Frame</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4-2"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">字节码指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Frame-%E5%8F%98%E5%8C%96-2"><span class="toc-number">1.9.3.4.</span> <span class="toc-text">Frame 变化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MethodVisitor-%E7%B1%BB"><span class="toc-number">1.10.</span> <span class="toc-text">MethodVisitor 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-4"><span class="toc-number">1.10.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-4"><span class="toc-number">1.10.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-4"><span class="toc-number">1.10.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-3"><span class="toc-number">1.10.4.</span> <span class="toc-text">methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A-%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.5.</span> <span class="toc-text">示例一：&lt;init&gt;() 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A-%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.6.</span> <span class="toc-text">示例二：&lt;clinit&gt; 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-5"><span class="toc-number">1.10.6.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.10.7.</span> <span class="toc-text">示例三：创建对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-6"><span class="toc-number">1.10.7.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%9B%9B%EF%BC%9A%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.8.</span> <span class="toc-text">示例四：调用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-7"><span class="toc-number">1.10.8.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%94%EF%BC%9A%E4%B8%8D%E8%B0%83%E7%94%A8-visitMaxs-%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.9.</span> <span class="toc-text">示例五：不调用 visitMaxs() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%85%AD%EF%BC%9A%E4%B8%8D%E5%90%8C%E7%9A%84-MethodVisitor-%E4%BA%A4%E5%8F%89%E4%BD%BF%E7%94%A8"><span class="toc-number">1.10.10.</span> <span class="toc-text">示例六：不同的 MethodVisitor 交叉使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E7%9B%AE%E6%A0%87-1"><span class="toc-number">1.10.10.1.</span> <span class="toc-text">预期目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%88%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%8C%E9%A1%BA%E5%BA%8F%EF%BC%89"><span class="toc-number">1.10.10.2.</span> <span class="toc-text">编码实现（第一种方式，顺序）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%88%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%8C%E4%BA%A4%E5%8F%89%EF%BC%89"><span class="toc-number">1.10.10.3.</span> <span class="toc-text">编码实现（第二种方式，交叉）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MethodWriter-%E7%B1%BB"><span class="toc-number">1.11.</span> <span class="toc-text">MethodWriter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-5"><span class="toc-number">1.11.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-5"><span class="toc-number">1.11.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-5"><span class="toc-number">1.11.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-4"><span class="toc-number">1.11.4.</span> <span class="toc-text">methods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassReader-%E7%B1%BB"><span class="toc-number">1.12.</span> <span class="toc-text">ClassReader 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-6"><span class="toc-number">1.12.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-6"><span class="toc-number">1.12.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-6"><span class="toc-number">1.12.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-5"><span class="toc-number">1.12.4.</span> <span class="toc-text">methods</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getXxx-%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.4.1.</span> <span class="toc-text">getXxx() 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#accept-%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.4.2.</span> <span class="toc-text">accept() 方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ClassReader-%E7%B1%BB"><span class="toc-number">1.12.5.</span> <span class="toc-text">使用 ClassReader 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parsingOptions-%E5%8F%82%E6%95%B0"><span class="toc-number">1.12.6.</span> <span class="toc-text">parsingOptions 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E4%BF%AE%E6%94%B9%E7%B1%BB%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-number">1.12.7.</span> <span class="toc-text">示例一：修改类的版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E4%BF%AE%E6%94%B9%E7%B1%BB%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.12.8.</span> <span class="toc-text">示例二：修改类的接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80"><span class="toc-number">1.12.9.</span> <span class="toc-text">总结一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5"><span class="toc-number">1.12.10.</span> <span class="toc-text">示例三：删除字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%9B%9B%EF%BC%9A%E6%B7%BB%E5%8A%A0%E5%AD%97%E6%AE%B5"><span class="toc-number">1.12.11.</span> <span class="toc-text">示例四：添加字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%BA%8C"><span class="toc-number">1.12.12.</span> <span class="toc-text">总结二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%94%EF%BC%9A%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.13.</span> <span class="toc-text">示例五：删除方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%85%AD%EF%BC%9A%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.14.</span> <span class="toc-text">示例六：添加方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AdviceAdapter-%E7%B1%BB"><span class="toc-number">1.13.</span> <span class="toc-text">AdviceAdapter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-7"><span class="toc-number">1.13.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-7"><span class="toc-number">1.13.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-7"><span class="toc-number">1.13.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-6"><span class="toc-number">1.13.4.</span> <span class="toc-text">methods</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">1. 应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.13.4.2.</span> <span class="toc-text">2. 注意事项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.13.4.3.</span> <span class="toc-text">3. 工作原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%89%93%E5%8D%B0%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.13.5.</span> <span class="toc-text">示例：打印方法参数和返回值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%87%E4%BB%A4%E8%A1%A8"><span class="toc-number">1.14.</span> <span class="toc-text">Java虚拟机指令表</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        ASM字节码编辑学习笔记
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cmisl</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-09-24T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-09-25</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="ASM学习笔记"><a href="#ASM学习笔记" class="headerlink" title="ASM学习笔记"></a>ASM学习笔记</h1><h2 id="ASM-是什么？"><a href="#ASM-是什么？" class="headerlink" title="ASM 是什么？"></a>ASM 是什么？</h2><p>简单来说，ASM 是一个操作 Java 字节码的类库。它操作的对象是字节码数据，通常以 .class 文件形式存在。ASM 处理字节码的方式是“拆分－修改－合并”，具体步骤如下：</p>
<ol>
<li>将 .class 文件拆分成多个部分。</li>
<li>对某个部分的信息进行修改。</li>
<li>将多个部分重新组织成一个新的 .class 文件。</li>
</ol>
<h2 id="ASM-能够做什么"><a href="#ASM-能够做什么" class="headerlink" title="ASM 能够做什么"></a>ASM 能够做什么</h2><p>ASM 可以：</p>
<ul>
<li>修改父类</li>
<li>添加或删除接口</li>
<li>添加或删除字段</li>
<li>添加或删除或修改方法</li>
</ul>
<h2 id="class-文件的结构"><a href="#class-文件的结构" class="headerlink" title=".class 文件的结构"></a>.class 文件的结构</h2><p>ClassFile 结构</p>
<p>每个 .class 文件遵循 Java Virtual Machine Specification 中定义的 ClassFile 结构。其具体定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;</span><br><span class="line">    u2             minor_version;</span><br><span class="line">    u2             major_version;</span><br><span class="line">    u2             constant_pool_count;</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-<span class="number">1</span>];</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             this_class;</span><br><span class="line">    u2             super_class;</span><br><span class="line">    u2             interfaces_count;</span><br><span class="line">    u2             interfaces[interfaces_count];</span><br><span class="line">    u2             fields_count;</span><br><span class="line">    field_info     fields[fields_count];</span><br><span class="line">    u2             methods_count;</span><br><span class="line">    method_info    methods[methods_count];</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>u1</strong>: 1 个字节</li>
<li><strong>u2</strong>: 2 个字节</li>
<li><strong>u4</strong>: 4 个字节</li>
<li><strong>u8</strong>: 8 个字节</li>
</ul>
<p>其中，<code>cp_info</code>、<code>field_info</code>、<code>method_info</code> 和 <code>attribute_info</code> 结构由 u1、u2、u4 和 u8 组成。</p>
<h3 id="field-info-结构"><a href="#field-info-结构" class="headerlink" title="field_info 结构"></a>field_info 结构</h3><p>在 .class 文件中定义的字段遵循 <code>field_info</code> 结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">field_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="method-info-结构"><a href="#method-info-结构" class="headerlink" title="method_info 结构"></a>method_info 结构</h3><p>在 .class 文件中定义的方法遵循 <code>method_info</code> 结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">method_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Code-属性结构"><a href="#Code-属性结构" class="headerlink" title="Code 属性结构"></a>Code 属性结构</h3><p>在 <code>method_info</code> 结构中，方法体的代码存储在 <code>Code</code> 属性中，其结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 max_stack;</span><br><span class="line">    u2 max_locals;</span><br><span class="line">    u4 code_length;</span><br><span class="line">    u1 code[code_length];</span><br><span class="line">    u2 exception_table_length;</span><br><span class="line">    &#123;   u2 start_pc;</span><br><span class="line">        u2 end_pc;</span><br><span class="line">        u2 handler_pc;</span><br><span class="line">        u2 catch_type;</span><br><span class="line">    &#125; exception_table[exception_table_length];</span><br><span class="line">    u2 attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ASMPrint-类"><a href="#ASMPrint-类" class="headerlink" title="ASMPrint 类"></a>ASMPrint 类</h2><p>在刚开始学习 ASM 的时候，编写 ASM 代码是不太容易的。 <code>ASMPrint</code> 类能帮助我们将 <code>.class</code> 文件转换为 ASM 代码，这个功能非常实用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.util.ASMifier;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.util.Printer;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.util.Textifier;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.util.TraceClassVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ASMPrint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// (1) 设置参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;Study.HelloWorld&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_FRAMES | ClassReader.SKIP_DEBUG;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">asmCode</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 打印结果</span></span><br><span class="line">        <span class="type">Printer</span> <span class="variable">printer</span> <span class="operator">=</span> asmCode ? <span class="keyword">new</span> <span class="title class_">ASMifier</span>() : <span class="keyword">new</span> <span class="title class_">Textifier</span>();</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">printWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(System.out, <span class="literal">true</span>);</span><br><span class="line">        <span class="type">TraceClassVisitor</span> <span class="variable">traceClassVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TraceClassVisitor</span>(<span class="literal">null</span>, printer, printWriter);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ClassReader</span>(className).accept(traceClassVisitor, parsingOptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于 <code>ASMPrint</code> 类来说，其中</p>
<ul>
<li><code>className</code> 值设置为类的全限定名，可以是我们自己写的类，例如 <code>sample.HelloWorld</code>，也可以是 JDK 自带的类，例如 <code>java.lang.Comparable</code>。</li>
<li><code>asmCode</code> 值设置为 <code>true</code> 或 <code>false</code>。如果是 <code>true</code>，可以打印出对应的 ASM 代码；如果是 <code>false</code>，可以打印出方法对应的 Instruction。</li>
<li><code>parsingOptions</code> 值设置为 <code>ClassReader.SKIP_CODE</code>、<code>ClassReader.SKIP_DEBUG</code>、<code>ClassReader.SKIP_FRAMES</code>、<code>ClassReader.EXPAND_FRAMES</code> 的组合值，也可以设置为 <code>0</code>，可以打印出详细程度不同的信息。</li>
</ul>
<h2 id="ClassVisitor-类"><a href="#ClassVisitor-类" class="headerlink" title="ClassVisitor 类"></a>ClassVisitor 类</h2><h3 id="class-info"><a href="#class-info" class="headerlink" title="class info"></a>class info</h3><p> <code>ClassVisitor</code> 类是一个 <code>abstract</code> 类，要想使用它，就必须有具体的子类来继承它。</p>
<p>比较常见的 <code>ClassVisitor</code> 子类是 <code>ClassWriter</code> 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassWriter</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields"><a href="#fields" class="headerlink" title="fields"></a>fields</h3><p><code>ClassVisitor</code> 类定义的字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> api;</span><br><span class="line">    <span class="keyword">protected</span> ClassVisitor cv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>api</code> 字段：它是一个 <code>int</code> 类型的数据，指出了当前使用的 ASM 版本，其可取值为 <code>Opcodes.ASM4</code>~&#96;Opcodes.ASM9<code>。我们使用的 ASM 版本是 9.0，因此我们在给 </code>api<code>字段赋值的时候，选择</code>Opcodes.ASM9&#96; 就可以了。</li>
<li><code>cv</code> 字段：它是一个 <code>ClassVisitor</code> 类型的数据，它的作用是将多个 <code>ClassVisitor</code> 串连起来。</li>
</ul>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/class-visitor-cv-field.png" alt="class-visitor-cv-field"></p>
<h3 id="constructors"><a href="#constructors" class="headerlink" title="constructors"></a>constructors</h3><p><code>ClassVisitor</code> 类定义的构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassVisitor</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> api)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(api, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassVisitor</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> api, <span class="keyword">final</span> ClassVisitor classVisitor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.api = api;</span><br><span class="line">        <span class="built_in">this</span>.cv = classVisitor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="methods"><a href="#methods" class="headerlink" title="methods"></a>methods</h3><p><code>ClassVisitor</code> 类定义的方法。重点关注关注这 4 个方法：<code>visit()</code>、<code>visitField()</code>、<code>visitMethod()</code> 和 <code>visitEnd()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> version,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> access,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String name,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String signature,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String superName,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String[] interfaces)</span>;</span><br><span class="line">    <span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">( // 访问字段</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> access,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String name,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String descriptor,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String signature,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> Object value)</span>;</span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">( // 访问方法</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> access,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String name,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String descriptor,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String signature,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> String[] exceptions)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 <code>ClassVisitor</code> 的 <code>visit()</code> 方法、<code>visitField()</code> 方法和 <code>visitMethod()</code> 方法中都带有 <code>signature</code> 参数。这个 <code>signature</code> 参数与“泛型”密切相关；换句话说，如果处理的是一个带有泛型信息的类、字段或方法，那么就需要给 <code>signature</code> 参数提供一定的值；如果处理的类、字段或方法不带有“泛型”信息，那么将 <code>signature</code> 参数设置为 <code>null</code> 就可以了。在本次课程当中，我们不去考虑“泛型”相关的内容，所以我们都将 <code>signature</code> 参数设置成 <code>null</code> 值。</p>
<p>如果大家对 <code>signature</code> 参数感兴趣，我们可以使用之前介绍的 <code>PrintASMCodeCore</code> 类去打印一下某个泛型类的 ASM 代码。例如，<code>java.lang.Comparable</code> 是一个泛型接口，我们就可以使用 <code>PrintASMCodeCore</code> 类来打印一下它的 ASM 代码，从来查看 <code>signature</code> 参数的值是什么。</p>
</blockquote>
<h3 id="方法的调用顺序"><a href="#方法的调用顺序" class="headerlink" title="方法的调用顺序"></a>方法的调用顺序</h3><p><code>visitXxx()</code> 方法，遵循一定的调用顺序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">visit</span><br><span class="line">[visitSource][visitModule][visitNestHost][visitPermittedSubclass][visitOuterClass]</span><br><span class="line">(</span><br><span class="line"> visitAnnotation |</span><br><span class="line"> visitTypeAnnotation |</span><br><span class="line"> visitAttribute</span><br><span class="line">)*</span><br><span class="line">(</span><br><span class="line"> visitNestMember |</span><br><span class="line"> visitInnerClass |</span><br><span class="line"> visitRecordComponent |</span><br><span class="line"> visitField |</span><br><span class="line"> visitMethod</span><br><span class="line">)* </span><br><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<ul>
<li><code>[]</code>: 表示最多调用一次，可以不调用，但最多调用一次。</li>
<li><code>()</code> 和 <code>|</code>: 表示在多个方法之间，可以选择任意一个，并且多个方法之间不分前后顺序。</li>
<li><code>*</code>: 表示方法可以调用 0 次或多次。</li>
</ul>
<p>由于我们作为初学者，只关注 <code>ClassVisitor</code> 类当中的 <code>visit()</code> 方法、<code>visitField()</code> 方法、<code>visitMethod()</code> 方法和 <code>visitEnd()</code> 方法这 4 个方法，因此调用顺序是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">visit</span><br><span class="line">(</span><br><span class="line"> visitField |</span><br><span class="line"> visitMethod</span><br><span class="line">)* </span><br><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<h3 id="visit-方法"><a href="#visit-方法" class="headerlink" title="visit() 方法"></a>visit() 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> <span class="type">int</span> version,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> <span class="type">int</span> access,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String name,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String signature,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String superName,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String[] interfaces</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;</span><br><span class="line">    u2             minor_version;</span><br><span class="line">    u2             major_version;</span><br><span class="line">    u2             constant_pool_count;</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-<span class="number">1</span>];</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             this_class;</span><br><span class="line">    u2             super_class;</span><br><span class="line">    u2             interfaces_count;</span><br><span class="line">    u2             interfaces[interfaces_count];</span><br><span class="line">    u2             fields_count;</span><br><span class="line">    field_info     fields[fields_count];</span><br><span class="line">    u2             methods_count;</span><br><span class="line">    method_info    methods[methods_count];</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>ClassVisitor 方法</th>
<th>参数</th>
<th>ClassFile</th>
</tr>
</thead>
<tbody><tr>
<td><code>ClassVisitor.visit()</code></td>
<td><code>version</code></td>
<td><code>minor_version</code>和<code>major_version</code></td>
</tr>
<tr>
<td></td>
<td><code>access</code></td>
<td><code>access_flags</code></td>
</tr>
<tr>
<td></td>
<td><code>name</code></td>
<td><code>this_class</code></td>
</tr>
<tr>
<td></td>
<td><code>signature</code></td>
<td><code>attributes</code>的一部分信息</td>
</tr>
<tr>
<td></td>
<td><code>superName</code></td>
<td><code>super_class</code></td>
</tr>
<tr>
<td></td>
<td><code>interfaces</code></td>
<td><code>interfaces_count</code>和<code>interfaces</code></td>
</tr>
<tr>
<td><code>ClassVisitor.visitField()</code></td>
<td></td>
<td><code>field_info</code></td>
</tr>
<tr>
<td><code>ClassVisitor.visitMethod()</code></td>
<td></td>
<td><code>method_info</code></td>
</tr>
</tbody></table>
<h3 id="visitField-方法"><a href="#visitField-方法" class="headerlink" title="visitField() 方法"></a>visitField() 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">( // 访问字段</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> <span class="type">int</span> access,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String name,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String descriptor,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String signature,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> Object value</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line">field_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>ClassVisitor 方法</th>
<th>参数</th>
<th>field_info</th>
</tr>
</thead>
<tbody><tr>
<td><code>ClassVisitor.visitField()</code></td>
<td><code>access</code></td>
<td><code>access_flags</code></td>
</tr>
<tr>
<td></td>
<td><code>name</code></td>
<td><code>name_index</code></td>
</tr>
<tr>
<td></td>
<td><code>descriptor</code></td>
<td><code>descriptor_index</code></td>
</tr>
<tr>
<td></td>
<td><code>signature</code></td>
<td><code>attributes</code>的一部分信息</td>
</tr>
<tr>
<td></td>
<td><code>value</code></td>
<td><code>attributes</code>的一部分信息</td>
</tr>
</tbody></table>
<h3 id="visitMethod-方法"><a href="#visitMethod-方法" class="headerlink" title="visitMethod() 方法"></a>visitMethod() 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">( // 访问方法</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> <span class="type">int</span> access,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String name,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String descriptor,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String signature,</span></span><br><span class="line"><span class="params">    <span class="keyword">final</span> String[] exceptions</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line">method_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>ClassVisitor 方法</th>
<th>参数</th>
<th>method_info</th>
</tr>
</thead>
<tbody><tr>
<td><code>ClassVisitor.visitMethod()</code></td>
<td><code>access</code></td>
<td><code>access_flags</code></td>
</tr>
<tr>
<td></td>
<td><code>name</code></td>
<td><code>name_index</code></td>
</tr>
<tr>
<td></td>
<td><code>descriptor</code></td>
<td><code>descriptor_index</code></td>
</tr>
<tr>
<td></td>
<td><code>signature</code></td>
<td><code>attributes</code>的一部分信息</td>
</tr>
<tr>
<td></td>
<td><code>exceptions</code></td>
<td><code>attributes</code>的一部分信息</td>
</tr>
</tbody></table>
<h3 id="visitEnd-方法"><a href="#visitEnd-方法" class="headerlink" title="visitEnd() 方法"></a>visitEnd() 方法</h3><p><code>visitEnd()</code> 方法，它是这些 <code>visitXxx()</code> 方法当中最后一个调用的方法。</p>
<p>为什么 <code>visitEnd()</code> 方法是“最后一个调用的方法”呢？是因为在 <code>ClassVisitor</code> 当中，定义了多个 <code>visitXxx()</code> 方法，这些个 <code>visitXxx()</code> 方法之间要遵循一个先后调用的顺序，而 <code>visitEnd()</code> 方法是最后才去调用的。</p>
<p>等到 <code>visitEnd()</code> 方法调用之后，就表示说再也不去调用其它的 <code>visitXxx()</code> 方法了，所有的“工作”已经做完了，到了要结束的时候了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Visits the end of the class.</span></span><br><span class="line"><span class="comment"> * This method, which is the last one to be called,</span></span><br><span class="line"><span class="comment"> * is used to inform the visitor that all the fields and methods of the class have been visited.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cv != <span class="literal">null</span>) &#123;</span><br><span class="line">        cv.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ClassWriter-类"><a href="#ClassWriter-类" class="headerlink" title="ClassWriter 类"></a>ClassWriter 类</h2><h3 id="class-info-1"><a href="#class-info-1" class="headerlink" title="class info"></a>class info</h3><p> <code>ClassWriter</code> 的父类是 <code>ClassVisitor</code>，因此 <code>ClassWriter</code> 类继承了 <code>visit()</code>、<code>visitField()</code>、<code>visitMethod()</code> 和 <code>visitEnd()</code> 等方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassWriter</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields-1"><a href="#fields-1" class="headerlink" title="fields"></a>fields</h3><p> <code>ClassWriter</code> 定义的字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassWriter</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> version;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SymbolTable symbolTable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> accessFlags;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> thisClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> superClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> interfaceCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] interfaces;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FieldWriter firstField;</span><br><span class="line">    <span class="keyword">private</span> FieldWriter lastField;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MethodWriter firstMethod;</span><br><span class="line">    <span class="keyword">private</span> MethodWriter lastMethod;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Attribute firstAttribute;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些字段与 ClassFile 结构密切相关：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;</span><br><span class="line">    u2             minor_version;</span><br><span class="line">    u2             major_version;</span><br><span class="line">    u2             constant_pool_count;</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-<span class="number">1</span>];</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             this_class;</span><br><span class="line">    u2             super_class;</span><br><span class="line">    u2             interfaces_count;</span><br><span class="line">    u2             interfaces[interfaces_count];</span><br><span class="line">    u2             fields_count;</span><br><span class="line">    field_info     fields[fields_count];</span><br><span class="line">    u2             methods_count;</span><br><span class="line">    method_info    methods[methods_count];</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructors-1"><a href="#constructors-1" class="headerlink" title="constructors"></a>constructors</h3><p> <code>ClassWriter</code> 定义的构造方法</p>
<p><code>ClassWriter</code> 定义的构造方法有两个，这里只关注其中一个，也就是只接收一个 <code>int</code> 类型参数的构造方法。在使用 <code>new</code> 关键字创建 <code>ClassWriter</code> 对象时，推荐使用 <code>COMPUTE_FRAMES</code> 参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassWriter</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="comment">/* A flag to automatically compute the maximum stack size and the maximum number of local variables of methods. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COMPUTE_MAXS</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/* A flag to automatically compute the stack map frames of methods from scratch. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COMPUTE_FRAMES</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// flags option can be used to modify the default behavior of this class.</span></span><br><span class="line">    <span class="comment">// Must be zero or more of COMPUTE_MAXS and COMPUTE_FRAMES.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassWriter</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h3 id="COMPUTE-MAXS"><a href="#COMPUTE-MAXS" class="headerlink" title="COMPUTE_MAXS"></a><code>COMPUTE_MAXS</code></h3><ul>
<li><strong>标志作用</strong>：这个标志用于自动计算方法的<strong>最大栈大小</strong>（maximum stack size）和<strong>最大局部变量数量</strong>（maximum number of local variables）。</li>
<li><strong>使用方式</strong>：当设置这个标志时，你不需要手动传递最大栈大小和最大局部变量数量给<code>MethodVisitor</code>接口的<code>visitMaxs</code>方法。相反，这些值将会根据方法的签名和字节码自动计算出来。</li>
<li><strong>效果</strong>：这意味着，当你在<code>visitMethod</code>方法中返回<code>MethodVisitor</code>时，不需要关心传递给<code>visitMaxs</code>方法的参数，因为它们会被忽略。</li>
</ul>
<h3 id="COMPUTE-FRAMES"><a href="#COMPUTE-FRAMES" class="headerlink" title="COMPUTE_FRAMES"></a><code>COMPUTE_FRAMES</code></h3><ul>
<li><strong>标志作用</strong>：这个标志用于从零开始自动计算方法的<strong>栈映射帧</strong>（stack map frames）。</li>
<li><strong>使用方式</strong>：如果你设置了<code>COMPUTE_FRAMES</code>标志，那么<code>MethodVisitor.visitFrame</code>方法的调用将会被忽略，框架会重新根据方法的字节码来计算栈映射帧。</li>
<li><strong>效果</strong>：同样，这也意味着传递给<code>visitMaxs</code>方法的参数会被忽略，并且将会根据字节码重新计算。换句话说，<code>COMPUTE_FRAMES</code>标志隐含了<code>COMPUTE_MAXS</code>标志的设置，因为你不能在不计算最大栈大小的情况下计算栈映射帧。</li>
</ul>
<p>简而言之，这两个标志是为了简化字节码操作过程中的一些繁琐计算。<code>COMPUTE_MAXS</code>可以自动确定方法执行时所需的栈大小和局部变量表的大小，而<code>COMPUTE_FRAMES</code>会进一步计算方法在执行期间的每个指令点的栈状态。使用这些标志，开发者不需要手动管理这些信息，字节码框架会根据提供的字节码自动完成这些计算。这在处理复杂字节码时特别有用，它可以减少出错的机会，并简化代码的编写。</p>
</li>
</ul>
<h3 id="创建-ClassWriter-对象"><a href="#创建-ClassWriter-对象" class="headerlink" title="创建 ClassWriter 对象"></a>创建 ClassWriter 对象</h3><p>在创建<code>ClassWriter</code>对象时，可以指定一个<code>flags</code>参数来决定ASM框架在生成类文件时是否自动计算某些字节码相关的信息。</p>
<ul>
<li><code>ClassWriter</code>的<code>flags</code>参数有三个可选值：<ol>
<li><code>0</code>：ASM不会自动计算最大栈大小（max stacks）和最大局部变量数量（max locals），也不会自动计算栈映射帧（stack map frames）。</li>
<li><code>ClassWriter.COMPUTE_MAXS</code>：ASM会自动计算最大栈大小和最大局部变量数量，但不会自动计算栈映射帧。</li>
<li><code>ClassWriter.COMPUTE_FRAMES</code>（推荐使用）：ASM会自动计算最大栈大小、最大局部变量数量，并且会自动计算栈映射帧。</li>
</ol>
</li>
</ul>
<p>下表展示了不同<code>flags</code>值对应的行为：</p>
<table>
<thead>
<tr>
<th>Flags</th>
<th>Max Stacks and Max Locals</th>
<th>Stack Map Frames</th>
</tr>
</thead>
<tbody><tr>
<td><code>0</code></td>
<td>NO</td>
<td>NO</td>
</tr>
<tr>
<td><code>ClassWriter.COMPUTE_MAXS</code></td>
<td>YES</td>
<td>NO</td>
</tr>
<tr>
<td><code>ClassWriter.COMPUTE_FRAMES</code></td>
<td>YES</td>
<td>YES</td>
</tr>
</tbody></table>
<p>示例代码<code>ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);</code>创建了一个<code>ClassWriter</code>实例，并指定了<code>COMPUTE_FRAMES</code>标志，这意味着ASM将自动计算最大栈大小、最大局部变量数量，并且会计算栈映射帧，从而简化了字节码生成过程，并减少了手动错误的可能性。</p>
<h3 id="使用-ClassWriter-类"><a href="#使用-ClassWriter-类" class="headerlink" title="使用 ClassWriter 类"></a>使用 ClassWriter 类</h3><p>使用 <code>ClassWriter</code> 生成一个 Class 文件，可以大致分成三个步骤：</p>
<ul>
<li>第一步，创建 <code>ClassWriter</code> 对象。</li>
<li>第二步，调用 <code>ClassWriter</code> 对象的 <code>visitXxx()</code> 方法。</li>
<li>第三步，调用 <code>ClassWriter</code> 对象的 <code>toByteArray()</code> 方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump () <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(...);</span><br><span class="line">        cw.visitField(...);</span><br><span class="line">        cw.visitMethod(...);</span><br><span class="line">        cw.visitEnd(...);       <span class="comment">// 注意，最后要调用 visitEnd() 方法</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = cw.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例一：生成接口"><a href="#示例一：生成接口" class="headerlink" title="示例一：生成接口"></a>示例一：生成接口</h3><p>生成 <code>HelloWorld</code> 接口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public interface HelloWorld &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现"><a href="#编码实现" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(</span><br><span class="line">                V1_8,                                        <span class="comment">// version</span></span><br><span class="line">                ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE,   <span class="comment">// access</span></span><br><span class="line">                <span class="string">&quot;sample/HelloWorld&quot;</span>,                         <span class="comment">// name</span></span><br><span class="line">                <span class="literal">null</span>,                                        <span class="comment">// signature</span></span><br><span class="line">                <span class="string">&quot;java/lang/Object&quot;</span>,                          <span class="comment">// superName</span></span><br><span class="line">                <span class="literal">null</span>                                         <span class="comment">// interfaces</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了 <code>visit()</code> 方法、<code>visitEnd()</code> 方法和 <code>toByteArray()</code> 方法。</p>
<p>由于 <code>sample.HelloWorld</code> 这个接口中，并没有定义任何的字段和方法，因此，在上述代码中没有调用 <code>visitField()</code> 方法和 <code>visitMethod()</code> 方法。</p>
<blockquote>
<ul>
<li><code>version</code>: 表示当前类的版本信息。在上述示例代码中，其取值为 <code>Opcodes.V1_8</code>，表示使用 Java 8 版本。</li>
<li><code>access</code>: 表示当前类的访问标识（access flag）信息。在上面的示例中，<code>access</code> 的取值是 <code>ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE</code>，也可以写成 <code>ACC_PUBLIC | ACC_ABSTRACT | ACC_INTERFACE</code>。如果想进一步了解这些标识的含义，可以参考 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">Java Virtual Machine Specification</a> 的 Chapter 4. The class File Format 部分。</li>
<li><code>name</code>: 表示当前类的名字，它采用的格式是 Internal Name 的形式。</li>
<li><code>signature</code>: 表示当前类的泛型信息。因为在这个接口当中不包含任何的泛型信息，因此它的值为 <code>null</code>。</li>
<li><code>superName</code>: 表示当前类的父类信息，它采用的格式是 Internal Name 的形式。</li>
<li><code>interfaces</code>: 表示当前类实现了哪些接口信息。</li>
</ul>
</blockquote>
<h3 id="示例二：生成接口-字段-方法"><a href="#示例二：生成接口-字段-方法" class="headerlink" title="示例二：生成接口 + 字段 + 方法"></a>示例二：生成接口 + 字段 + 方法</h3><p>生成 <code>HelloWorld</code> 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HelloWorld</span> <span class="keyword">extends</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">LESS</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">EQUAL</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">GREATER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(Object o)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现-1"><a href="#编码实现-1" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.FieldVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE, <span class="string">&quot;sample/HelloWorld&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;java/lang/Cloneable&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">FieldVisitor</span> <span class="variable">fv1</span> <span class="operator">=</span> cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, <span class="string">&quot;LESS&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="literal">null</span>, -<span class="number">1</span>);</span><br><span class="line">            fv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">FieldVisitor</span> <span class="variable">fv2</span> <span class="operator">=</span> cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, <span class="string">&quot;EQUAL&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">            fv2.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">FieldVisitor</span> <span class="variable">fv3</span> <span class="operator">=</span> cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, <span class="string">&quot;GREATER&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">            fv3.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC + ACC_ABSTRACT, <span class="string">&quot;compareTo&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;)I&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="visitField-和-visitMethod-方法"><a href="#visitField-和-visitMethod-方法" class="headerlink" title="visitField() 和 visitMethod() 方法"></a>visitField() 和 visitMethod() 方法</h4><ul>
<li><code>visitField (access, name, descriptor, signature, value)</code></li>
<li><code>visitMethod(access, name, descriptor, signature, exceptions)</code></li>
</ul>
<p>这两个方法的前 4 个参数是相同的，第 5 个参数不同</p>
<ul>
<li><p>access: 用于指定字段或方法的访问标识，如 ACC_PUBLIC（公共）、ACC_STATIC（静态）、ACC_FINAL（最终）等，这些标识符可以组合使用。</p>
</li>
<li><p>name: 字符串参数，表示字段或方法的名称。</p>
</li>
<li><p>descriptor: 字符串参数，表示字段或方法的描述符，这是一个特殊的字符串，用来描述字段或方法的类型和参数类型，它与Java语言中使用的类型表示法不同，例如，()V 表示无参无返回值的方法，I 表示 int 类型。</p>
</li>
<li><p>signature: 可以为 null 或具体的泛型签名字符串，用于表示字段或方法是否包含泛型信息。如果包含泛型，则需要提供具体的泛型签名；如果不包含，则提供 null。</p>
</li>
<li><p>value: 仅用于 visitField() 方法，表示字段的初始值。如果字段是一个常量，则需要提供这个常量的值；如果字段不是常量，则使用 null。</p>
</li>
<li><p>exceptions: 仅用于 visitMethod() 方法，表示方法可能抛出的异常列表。如果方法有 throws 声明，则提供异常类的完全限定名列表；如果没有，则使用 null。</p>
</li>
</ul>
<h4 id="描述符（descriptor）"><a href="#描述符（descriptor）" class="headerlink" title="描述符（descriptor）"></a>描述符（descriptor）</h4><ul>
<li>对于字段（field）来说，描述符（descriptor）就是对<strong>字段本身的类型</strong>进行简单化描述。</li>
<li>对于方法（method）来说，描述符（descriptor）就是对方法的<strong>接收参数的类型</strong>和<strong>返回值的类型</strong>进行简单化描述。</li>
</ul>
<table>
<thead>
<tr>
<th>Java 类型</th>
<th>ClassFile 描述符</th>
</tr>
</thead>
<tbody><tr>
<td><code>boolean</code></td>
<td><code>Z</code>（Z 表示 Zero，零表示 <code>false</code>，非零表示 <code>true</code>）</td>
</tr>
<tr>
<td><code>byte</code></td>
<td><code>B</code></td>
</tr>
<tr>
<td><code>char</code></td>
<td><code>C</code></td>
</tr>
<tr>
<td><code>double</code></td>
<td><code>D</code></td>
</tr>
<tr>
<td><code>float</code></td>
<td><code>F</code></td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>I</code></td>
</tr>
<tr>
<td><code>long</code></td>
<td><code>J</code></td>
</tr>
<tr>
<td><code>short</code></td>
<td><code>S</code></td>
</tr>
<tr>
<td><code>void</code></td>
<td><code>V</code></td>
</tr>
<tr>
<td><code>non-array reference</code></td>
<td><code>L&lt;InternalName&gt;;</code></td>
</tr>
<tr>
<td><code>array reference</code></td>
<td><code>[</code></td>
</tr>
</tbody></table>
<p>对字段描述符的举例：</p>
<ul>
<li><code>boolean flag</code>: <code>Z</code></li>
<li><code>byte byteValue</code>: <code>B</code></li>
<li><code>int intValue</code>: <code>I</code></li>
<li><code>float floatValue</code>: <code>F</code></li>
<li><code>double doubleValue</code>: <code>D</code></li>
<li><code>String strValue</code>: <code>Ljava/lang/String;</code></li>
<li><code>Object objValue</code>: <code>Ljava/lang/Object;</code></li>
<li><code>byte[] bytes</code>: <code>[B</code></li>
<li><code>String[] array</code>: <code>[Ljava/lang/String;</code></li>
<li><code>Object[][] twoDimArray</code>: <code>[[Ljava/lang/Object;</code></li>
</ul>
<p>对方法描述符的举例：</p>
<ul>
<li><code>int add(int a, int b)</code>: <code>(II)I</code></li>
<li><code>void test(int a, int b)</code>: <code>(II)V</code></li>
<li><code>boolean compare(Object obj)</code>: <code>(Ljava/lang/Object;)Z</code></li>
<li><code>void main(String[] args)</code>: <code>([Ljava/lang/String;)V</code></li>
</ul>
<h3 id="示例三：生成类"><a href="#示例三：生成类" class="headerlink" title="示例三：生成类"></a>示例三：生成类</h3><p>生成 <code>HelloWorld</code> 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现-2"><a href="#编码实现-2" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_SUPER, <span class="string">&quot;sample/HelloWorld&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">MethodVisitor</span> <span class="variable">mv</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        mv.visitCode();</span><br><span class="line">        mv.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">        mv.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        mv.visitInsn(RETURN);</span><br><span class="line">        mv.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        mv.visitEnd();</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="和-方法"><a href="#和-方法" class="headerlink" title="&lt;init&gt;() 和 &lt;clinit&gt;() 方法"></a>&lt;init&gt;() 和 &lt;clinit&gt;() 方法</h4><p>对于一个类（Class）来说，如果没有提供任何构造方法，Java 编译器会自动生成一个默认构造方法。在所有的 <code>.class</code> 文件中，构造方法的名字是 <code>&lt;init&gt;()</code>。</p>
<p>另外，如果在 <code>.class</code> 文件中包含静态代码块，那么就会有一个 <code>&lt;clinit&gt;()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sample;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;static code block&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的静态代码码，对应于 <code>visitMethod(ACC_STATIC, &quot;&lt;clinit&gt;&quot;, &quot;()V&quot;, null, null)</code> 的调用。</p>
<blockquote>
<p>在 <code>.class</code> 文件中，构造方法的名字是 <code>&lt;init&gt;()</code>，表示 instance initialization method；静态代码块的名字是 <code>&lt;clinit&gt;()</code>，表示 class initialization method。</p>
</blockquote>
<h2 id="FieldVisitor-类"><a href="#FieldVisitor-类" class="headerlink" title="FieldVisitor 类"></a>FieldVisitor 类</h2><p>通过调用 <code>ClassVisitor</code> 类的 <code>visitField()</code> 方法，会返回一个 <code>FieldVisitor</code> 类型的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, Object value)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="class-info-2"><a href="#class-info-2" class="headerlink" title="class info"></a>class info</h3><p><code>FieldVisitor</code> 类是一个 <code>abstract</code> 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields-2"><a href="#fields-2" class="headerlink" title="fields"></a>fields</h3><p><code>FieldVisitor</code> 类定义的字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> api;</span><br><span class="line">    <span class="keyword">protected</span> FieldVisitor fv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructors-2"><a href="#constructors-2" class="headerlink" title="constructors"></a>constructors</h3><p><code>FieldVisitor</code> 类定义的构造方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FieldVisitor</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> api)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(api, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FieldVisitor</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> api, <span class="keyword">final</span> FieldVisitor fieldVisitor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.api = api;</span><br><span class="line">        <span class="built_in">this</span>.fv = fieldVisitor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="methods-1"><a href="#methods-1" class="headerlink" title="methods"></a>methods</h3><p><code>FieldVisitor</code> 类定义的方法。</p>
<p>在 <code>FieldVisitor</code> 类当中，一共定义了 4 个 <code>visitXxx()</code> 方法，对于初学者的我们只需要关注其中的 <code>visitEnd()</code> 方法就可以了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fv != <span class="literal">null</span>) &#123;</span><br><span class="line">            fv.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多个 <code>visitXxx()</code> 方法遵循的调用顺序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line"> visitAnnotation |</span><br><span class="line"> visitTypeAnnotation |</span><br><span class="line"> visitAttribute</span><br><span class="line">)*</span><br><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<p>由于我们只关注 <code>visitEnd()</code> 方法，那么，这个调用顺序就变成如下这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<h3 id="示例一：字段常量"><a href="#示例一：字段常量" class="headerlink" title="示例一：字段常量"></a>示例一：字段常量</h3><h4 id="预期目标"><a href="#预期目标" class="headerlink" title="预期目标"></a>预期目标</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">intValue</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">strValue</span> <span class="operator">=</span> <span class="string">&quot;ABC&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现-3"><a href="#编码实现-3" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.FieldVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_ABSTRACT + ACC_INTERFACE, <span class="string">&quot;sample/HelloWorld&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 多个 ACC_XXX 之间用 | 或 + 的效果是一样的</span></span><br><span class="line">            <span class="type">FieldVisitor</span> <span class="variable">fv1</span> <span class="operator">=</span> cw.visitField(ACC_PUBLIC | ACC_FINAL | ACC_STATIC, <span class="string">&quot;intValue&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="literal">null</span>, <span class="number">100</span>);</span><br><span class="line">            fv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 多个 ACC_XXX 之间用 | 或 + 的效果是一样的</span></span><br><span class="line">            <span class="type">FieldVisitor</span> <span class="variable">fv2</span> <span class="operator">=</span> cw.visitField(ACC_PUBLIC + ACC_FINAL + ACC_STATIC, <span class="string">&quot;strValue&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;ABC&quot;</span>);</span><br><span class="line">            fv2.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FieldWriter-类"><a href="#FieldWriter-类" class="headerlink" title="FieldWriter 类"></a>FieldWriter 类</h2><h3 id="class-info-3"><a href="#class-info-3" class="headerlink" title="class info"></a>class info</h3><p><code>FieldWriter</code> 类的父类是 <code>FieldVisitor</code> 类。<code>FieldWriter</code> 类并不带有 <code>public</code> 修饰，因此它的有效访问范围只局限于它所处的 package 当中，不能像其它的 <code>public</code> 类一样被外部所使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FieldWriter</span> <span class="keyword">extends</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields-3"><a href="#fields-3" class="headerlink" title="fields"></a>fields</h3><p><code>FieldWriter</code> 类定义的字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FieldWriter</span> <span class="keyword">extends</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> accessFlags;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> nameIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> descriptorIndex;</span><br><span class="line">    <span class="keyword">private</span> Attribute firstAttribute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些字段与 ClassFile 当中的 <code>field_info</code> 是对应的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">field_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructors-3"><a href="#constructors-3" class="headerlink" title="constructors"></a>constructors</h3><p><code>FieldWriter</code> 类定义的构造方法。在 <code>FieldWriter</code> 类当中，只定义了一个构造方法；同时，它也不带有 <code>public</code> 标识，只能在 package 内使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FieldWriter</span> <span class="keyword">extends</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">    FieldWriter(SymbolTable symbolTable, <span class="type">int</span> access, String name, String descriptor, String signature, Object constantValue) &#123;</span><br><span class="line">        <span class="built_in">super</span>(Opcodes.ASM9);</span><br><span class="line">        <span class="built_in">this</span>.symbolTable = symbolTable;</span><br><span class="line">        <span class="built_in">this</span>.accessFlags = access;</span><br><span class="line">        <span class="built_in">this</span>.nameIndex = symbolTable.addConstantUtf8(name);</span><br><span class="line">        <span class="built_in">this</span>.descriptorIndex = symbolTable.addConstantUtf8(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (signature != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.signatureIndex = symbolTable.addConstantUtf8(signature);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (constantValue != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.constantValueIndex = symbolTable.addConstant(constantValue).index;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="methods-2"><a href="#methods-2" class="headerlink" title="methods"></a>methods</h3><p><code>FieldWriter</code> 类定义的方法。在 <code>FieldWriter</code> 类当中，有两个重要的方法：<code>computeFieldInfoSize()</code> 和 <code>putFieldInfo()</code> 方法。这两个方法会在 <code>ClassWriter</code> 类的 <code>toByteArray()</code> 方法内使用到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FieldWriter</span> <span class="keyword">extends</span> <span class="title class_">FieldVisitor</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">computeFieldInfoSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// The access_flags, name_index, descriptor_index and attributes_count fields use 8 bytes.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">        <span class="comment">// For ease of reference, we use here the same attribute order as in Section 4.7 of the JVMS.</span></span><br><span class="line">        <span class="keyword">if</span> (constantValueIndex != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ConstantValue attributes always use 8 bytes.</span></span><br><span class="line">            symbolTable.addConstantUtf8(Constants.CONSTANT_VALUE);</span><br><span class="line">            size += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">putFieldInfo</span><span class="params">(<span class="keyword">final</span> ByteVector output)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">useSyntheticAttribute</span> <span class="operator">=</span> symbolTable.getMajorVersion() &lt; Opcodes.V1_5;</span><br><span class="line">        <span class="comment">// Put the access_flags, name_index and descriptor_index fields.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mask</span> <span class="operator">=</span> useSyntheticAttribute ? Opcodes.ACC_SYNTHETIC : <span class="number">0</span>;</span><br><span class="line">        output.putShort(accessFlags &amp; ~mask).putShort(nameIndex).putShort(descriptorIndex);</span><br><span class="line">        <span class="comment">// Compute and put the attributes_count field.</span></span><br><span class="line">        <span class="comment">// For ease of reference, we use here the same attribute order as in Section 4.7 of the JVMS.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">attributesCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (constantValueIndex != <span class="number">0</span>) &#123;</span><br><span class="line">            ++attributesCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        output.putShort(attributesCount);</span><br><span class="line">        <span class="comment">// Put the field_info attributes.</span></span><br><span class="line">        <span class="comment">// For ease of reference, we use here the same attribute order as in Section 4.7 of the JVMS.</span></span><br><span class="line">        <span class="keyword">if</span> (constantValueIndex != <span class="number">0</span>) &#123;</span><br><span class="line">            output</span><br><span class="line">              .putShort(symbolTable.addConstantUtf8(Constants.CONSTANT_VALUE))</span><br><span class="line">              .putInt(<span class="number">2</span>)</span><br><span class="line">              .putShort(constantValueIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于 <code>FieldWriter</code> 类的使用，它主要出现在 <code>ClassWriter</code> 类当中的 <code>visitField()</code> 和 <code>toByteArray()</code> 方法内。</p>
<h2 id="关于Frame"><a href="#关于Frame" class="headerlink" title="关于Frame"></a>关于Frame</h2><h3 id="1-static-方法"><a href="#1-static-方法" class="headerlink" title="1.static 方法"></a>1.static 方法</h3><h4 id="方法定义"><a href="#方法定义" class="headerlink" title="方法定义"></a>方法定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个简单的静态方法<code>add</code>，它接收两个整数参数并返回它们的和。</p>
<h4 id="初始-Frame"><a href="#初始-Frame" class="headerlink" title="初始 Frame"></a>初始 Frame</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[int, int] []</span><br></pre></td></tr></table></figure>
<p>这个表示method frame的初始状态，其中：</p>
<ul>
<li>第一个<code>[]</code>（<code>[int, int]</code>）表示局部变量表（locals），包含两个整数参数<code>a</code>和<code>b</code>。</li>
<li>第二个<code>[]</code>表示操作数栈（operand stack），初始为空。</li>
</ul>
<h4 id="HelloWorldFrameTree-类输出的内容"><a href="#HelloWorldFrameTree-类输出的内容" class="headerlink" title="HelloWorldFrameTree 类输出的内容"></a><code>HelloWorldFrameTree</code> 类输出的内容</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add:(II)I</span><br><span class="line">┌───────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                           │   locals: 2</span><br><span class="line">│    operand stack                                          │   stacks: 0</span><br><span class="line">│    ┌───────────────────────────┐                          │</span><br><span class="line">│    │                           │      local variable      │   0: I</span><br><span class="line">│    ├───────────────────────────┤      ┌─────┬─────┐       │   1: I</span><br><span class="line">│    │                           │      │  0  │  1  │       │</span><br><span class="line">│    └───────────────────────────┘      └─────┴─────┘       │</span><br><span class="line">│                                                           │</span><br><span class="line">└───────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>这个图示表示当前方法的Frame结构：</p>
<ul>
<li><code>locals: 2</code>：表示局部变量表包含2个变量。</li>
<li><code>stacks: 0</code>：表示操作数栈当前为空。</li>
<li><code>local variable</code>：显示局部变量表的内容，其中<code>0</code>和<code>1</code>对应于方法参数<code>a</code>和<code>b</code>。</li>
</ul>
<h4 id="字节码指令"><a href="#字节码指令" class="headerlink" title="字节码指令"></a>字节码指令</h4><p>使用命令 <code>javap -c sample.HelloWorld</code> 可以看到方法的字节码指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line">  Code:</span><br><span class="line">     <span class="number">0</span>: iload_0</span><br><span class="line">     <span class="number">1</span>: iload_1</span><br><span class="line">     <span class="number">2</span>: iadd</span><br><span class="line">     <span class="number">3</span>: ireturn</span><br></pre></td></tr></table></figure>
<p>这些指令分别表示：</p>
<ul>
<li><code>0: iload_0</code>：将局部变量表中索引为<code>0</code>的整数（即参数<code>a</code>）加载到操作数栈上。</li>
<li><code>1: iload_1</code>：将局部变量表中索引为<code>1</code>的整数（即参数<code>b</code>）加载到操作数栈上。</li>
<li><code>2: iadd</code>：弹出操作数栈顶部的两个整数并将它们相加，然后将结果压回操作数栈。</li>
<li><code>3: ireturn</code>：从当前方法返回栈顶的整数值。</li>
</ul>
<h4 id="Frame-变化"><a href="#Frame-变化" class="headerlink" title="Frame 变化"></a>Frame 变化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(II)I</span><br><span class="line">[int, int] []</span><br><span class="line">[int, int] [int]</span><br><span class="line">[int, int] [int, int]</span><br><span class="line">[int, int] [int]</span><br><span class="line">[] []</span><br></pre></td></tr></table></figure>
<p>这个表示方法执行过程中Frame的变化：</p>
<ol>
<li>初始状态：<code>[int, int] []</code>（局部变量表有<code>a</code>和<code>b</code>，操作数栈为空）。</li>
<li><code>iload_0</code>：<code>[int, int] [int]</code>（<code>a</code>被加载到操作数栈）。</li>
<li><code>iload_1</code>：<code>[int, int] [int, int]</code>（<code>b</code>被加载到操作数栈）。</li>
<li><code>iadd</code>：<code>[int, int] [int]</code>（栈顶的两个整数相加，结果压回栈）。</li>
<li><code>ireturn</code>：<code>[] []</code>（方法返回，Frame被清空）。</li>
</ol>
<p>或者：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// &#123;int, int&#125; | &#123;&#125;</span><br><span class="line">0000: iload_0                  // &#123;int, int&#125; | &#123;int&#125;</span><br><span class="line">0001: iload_1                  // &#123;int, int&#125; | &#123;int, int&#125;</span><br><span class="line">0002: iadd                     // &#123;int, int&#125; | &#123;int&#125;</span><br><span class="line">0003: ireturn                  // &#123;&#125; | &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这也是对Frame变化的另一种表示方式，注释中<code>|</code>左侧表示局部变量表的内容，右侧表示操作数栈的内容。</p>
<h3 id="2-non-static-方法"><a href="#2-non-static-方法" class="headerlink" title="2.non-static 方法"></a>2.non-static 方法</h3><h4 id="方法定义-1"><a href="#方法定义-1" class="headerlink" title="方法定义"></a>方法定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个非静态方法<code>add</code>，它接收两个整数参数并返回它们的和。</p>
<h4 id="初始-Frame-1"><a href="#初始-Frame-1" class="headerlink" title="初始 Frame"></a>初始 Frame</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[sample/HelloWorld, int, int] []</span><br></pre></td></tr></table></figure>
<p>表示方法的初始Frame，其中：</p>
<ul>
<li>第一个<code>[]</code>（<code>[sample/HelloWorld, int, int]</code>）表示局部变量表（locals），包含：<ul>
<li><code>this</code>引用（<code>sample/HelloWorld</code>）</li>
<li>第一个<code>int</code>参数（<code>a</code>）</li>
<li>第二个<code>int</code>参数（<code>b</code>）</li>
</ul>
</li>
<li>第二个<code>[]</code>表示操作数栈（operand stack），初始为空。</li>
</ul>
<h4 id="HelloWorldFrameTree-类输出的内容-1"><a href="#HelloWorldFrameTree-类输出的内容-1" class="headerlink" title="HelloWorldFrameTree 类输出的内容"></a><code>HelloWorldFrameTree</code> 类输出的内容</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add:(II)I</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                             │   locals: 3</span><br><span class="line">│    operand stack                                            │   stacks: 0</span><br><span class="line">│    ┌───────────────────────────┐                            │</span><br><span class="line">│    │                           │      local variable        │   0: HelloWorld</span><br><span class="line">│    ├───────────────────────────┤      ┌─────┬─────┬─────┐   │   1: I</span><br><span class="line">│    │                           │      │  0  │  1  │  2  │   │   2: I</span><br><span class="line">│    └───────────────────────────┘      └─────┴─────┴─────┘   │</span><br><span class="line">│                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>这个图示表示方法的Frame结构：</p>
<ul>
<li><code>locals: 3</code>：表示局部变量表包含3个位置。</li>
<li><code>stacks: 0</code>：表示操作数栈当前为空。</li>
<li><code>local variable</code>：显示局部变量表的内容，其中<code>0</code>是<code>this</code>引用，<code>1</code>是第一个<code>int</code>参数<code>a</code>，<code>2</code>是第二个<code>int</code>参数<code>b</code>。</li>
</ul>
<h4 id="字节码指令-1"><a href="#字节码指令-1" class="headerlink" title="字节码指令"></a>字节码指令</h4><p>方法的字节码指令如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line">  Code:</span><br><span class="line">     <span class="number">0</span>: iload_1</span><br><span class="line">     <span class="number">1</span>: iload_2</span><br><span class="line">     <span class="number">2</span>: iadd</span><br><span class="line">     <span class="number">3</span>: ireturn</span><br></pre></td></tr></table></figure>
<p>这些指令分别表示：</p>
<ul>
<li><code>0: iload_1</code>：将局部变量表中索引为<code>1</code>的位置（即第一个<code>int</code>参数<code>a</code>）加载到操作数栈上。</li>
<li><code>1: iload_2</code>：将局部变量表中索引为<code>2</code>的位置（即第二个<code>int</code>参数<code>b</code>）加载到操作数栈上。</li>
<li><code>2: iadd</code>：弹出操作数栈顶部的两个整数并将它们相加，然后将结果压回操作数栈。</li>
<li><code>3: ireturn</code>：从当前方法返回栈顶的整数值。</li>
</ul>
<h4 id="Frame-变化-1"><a href="#Frame-变化-1" class="headerlink" title="Frame 变化"></a>Frame 变化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(II)I</span><br><span class="line">[sample/HelloWorld, int, int] []</span><br><span class="line">[sample/HelloWorld, int, int] [int]</span><br><span class="line">[sample/HelloWorld, int, int] [int, int]</span><br><span class="line">[sample/HelloWorld, int, int] [int]</span><br><span class="line">[] []</span><br></pre></td></tr></table></figure>
<p>这个表示方法执行过程中Frame的变化：</p>
<ol>
<li>初始状态：<code>[sample/HelloWorld, int, int] []</code>（局部变量表有<code>this</code>、<code>a</code>和<code>b</code>，操作数栈为空）。</li>
<li><code>iload_1</code>：<code>[sample/HelloWorld, int, int] [int]</code>（<code>a</code>被加载到操作数栈）。</li>
<li><code>iload_2</code>：<code>[sample/HelloWorld, int, int] [int, int]</code>（<code>b</code>被加载到操作数栈）。</li>
<li><code>iadd</code>：<code>[sample/HelloWorld, int, int] [int]</code>（栈顶的两个整数相加，结果压回栈）。</li>
<li><code>ireturn</code>：<code>[] []</code>（方法返回，Frame被清空）。</li>
</ol>
<p>或者：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// &#123;this, int, int&#125; | &#123;&#125;</span><br><span class="line">0000: iload_1                  // &#123;this, int, int&#125; | &#123;int&#125;</span><br><span class="line">0001: iload_2                  // &#123;this, int, int&#125; | &#123;int, int&#125;</span><br><span class="line">0002: iadd                     // &#123;this, int, int&#125; | &#123;int&#125;</span><br><span class="line">0003: ireturn                  // &#123;&#125; | &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这也是对Frame变化的另一种表示方式，注释中<code>|</code>左侧表示局部变量表的内容，右侧表示操作数栈的内容。</p>
<h3 id="3-long-和-double-类型"><a href="#3-long-和-double-类型" class="headerlink" title="3.long 和 double 类型"></a>3.long 和 double 类型</h3><p>这段内容描述了一个Java非静态方法<code>add(long, long)</code>的执行过程及其字节码指令对应的局部变量表（locals）和操作数栈（operand stack）的变化。下面是对这段内容的详细解释：</p>
<h4 id="方法定义-2"><a href="#方法定义-2" class="headerlink" title="方法定义"></a>方法定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">add</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个非静态方法<code>add</code>，它接收两个长整型参数并返回它们的和。</p>
<h4 id="初始-Frame-2"><a href="#初始-Frame-2" class="headerlink" title="初始 Frame"></a>初始 Frame</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[sample/HelloWorld, long, top, long, top] []</span><br></pre></td></tr></table></figure>
<p>表示方法的初始Frame，其中：</p>
<ul>
<li>第一个<code>[]</code>（<code>[sample/HelloWorld, long, top, long, top]</code>）表示局部变量表（locals），包含：<ul>
<li><code>this</code>引用（<code>sample/HelloWorld</code>）</li>
<li>第一个<code>long</code>参数（占用两个位置，<code>long</code>和<code>top</code>）</li>
<li>第二个<code>long</code>参数（占用两个位置，<code>long</code>和<code>top</code>）</li>
</ul>
</li>
<li>第二个<code>[]</code>表示操作数栈（operand stack），初始为空。</li>
</ul>
<p><code>HelloWorldFrameTree</code> 类输出的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">add:(JJ)J</span><br><span class="line">┌───────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                           │   locals: 5</span><br><span class="line">│    operand stack                                                          │   stacks: 0</span><br><span class="line">│    ┌───────────────────────────┐                                          │</span><br><span class="line">│    │                           │                                          │   0: HelloWorld</span><br><span class="line">│    ├───────────────────────────┤                                          │   1: J</span><br><span class="line">│    │                           │                                          │   2: .</span><br><span class="line">│    ├───────────────────────────┤                                          │   3: J</span><br><span class="line">│    │                           │      local variable                      │   4: .</span><br><span class="line">│    ├───────────────────────────┤      ┌─────┬─────┬─────┬─────┬─────┐     │</span><br><span class="line">│    │                           │      │  0  │  1  │  2  │  3  │  4  │     │</span><br><span class="line">│    └───────────────────────────┘      └─────┴─────┴─────┴─────┴─────┘     │</span><br><span class="line">│                                                                           │</span><br><span class="line">└───────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>这个图示表示方法的Frame结构：</p>
<ul>
<li><code>locals: 5</code>：表示局部变量表包含5个位置。</li>
<li><code>stacks: 0</code>：表示操作数栈当前为空。</li>
<li><code>local variable</code>：显示局部变量表的内容，其中<code>0</code>是<code>this</code>引用，<code>1</code>和<code>2</code>是第一个<code>long</code>参数，<code>3</code>和<code>4</code>是第二个<code>long</code>参数。</li>
</ul>
<h4 id="字节码指令-2"><a href="#字节码指令-2" class="headerlink" title="字节码指令"></a>字节码指令</h4><p>方法的字节码指令如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">add</span><span class="params">(<span class="type">long</span>, <span class="type">long</span>)</span>;</span><br><span class="line">  Code:</span><br><span class="line">     <span class="number">0</span>: lload_1</span><br><span class="line">     <span class="number">1</span>: lload_3</span><br><span class="line">     <span class="number">2</span>: ladd</span><br><span class="line">     <span class="number">3</span>: lreturn</span><br></pre></td></tr></table></figure>
<p>这些指令分别表示：</p>
<ul>
<li><code>0: lload_1</code>：将局部变量表中索引为<code>1</code>和<code>2</code>的位置（即第一个<code>long</code>参数）加载到操作数栈上。</li>
<li><code>1: lload_3</code>：将局部变量表中索引为<code>3</code>和<code>4</code>的位置（即第二个<code>long</code>参数）加载到操作数栈上。</li>
<li><code>2: ladd</code>：弹出操作数栈顶部的两个<code>long</code>值并将它们相加，然后将结果压回操作数栈。</li>
<li><code>3: lreturn</code>：从当前方法返回栈顶的<code>long</code>值。</li>
</ul>
<h4 id="Frame-变化-2"><a href="#Frame-变化-2" class="headerlink" title="Frame 变化"></a>Frame 变化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(JJ)J</span><br><span class="line">[sample/HelloWorld, long, top, long, top] []</span><br><span class="line">[sample/HelloWorld, long, top, long, top] [long, top]</span><br><span class="line">[sample/HelloWorld, long, top, long, top] [long, top, long, top]</span><br><span class="line">[sample/HelloWorld, long, top, long, top] [long, top]</span><br><span class="line">[] []</span><br></pre></td></tr></table></figure>
<p>这个表示方法执行过程中Frame的变化：</p>
<ol>
<li>初始状态：<code>[sample/HelloWorld, long, top, long, top] []</code>（局部变量表有<code>this</code>、<code>a</code>和<code>b</code>，操作数栈为空）。</li>
<li><code>lload_1</code>：<code>[sample/HelloWorld, long, top, long, top] [long, top]</code>（第一个<code>long</code>参数被加载到操作数栈）。</li>
<li><code>lload_3</code>：<code>[sample/HelloWorld, long, top, long, top] [long, top, long, top]</code>（第二个<code>long</code>参数被加载到操作数栈）。</li>
<li><code>ladd</code>：<code>[sample/HelloWorld, long, top, long, top] [long, top]</code>（栈顶的两个<code>long</code>值相加，结果压回栈）。</li>
<li><code>lreturn</code>：<code>[] []</code>（方法返回，Frame被清空）。</li>
</ol>
<p>或者：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// &#123;this, long, top, long, top&#125; | &#123;&#125;</span><br><span class="line">0000: lload_1                  // &#123;this, long, top, long, top&#125; | &#123;long, top&#125;</span><br><span class="line">0001: lload_3                  // &#123;this, long, top, long, top&#125; | &#123;long, top, long, top&#125;</span><br><span class="line">0002: ladd                     // &#123;this, long, top, long, top&#125; | &#123;long, top&#125;</span><br><span class="line">0003: lreturn                  // &#123;&#125; | &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这也是对Frame变化的另一种表示方式，注释中<code>|</code>左侧表示局部变量表的内容，右侧表示操作数栈的内容。</p>
<h2 id="MethodVisitor-类"><a href="#MethodVisitor-类" class="headerlink" title="MethodVisitor 类"></a>MethodVisitor 类</h2><h3 id="class-info-4"><a href="#class-info-4" class="headerlink" title="class info"></a>class info</h3><p><code>MethodVisitor</code> 类是一个 <code>abstract</code> 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields-4"><a href="#fields-4" class="headerlink" title="fields"></a>fields</h3><p><code>MethodVisitor</code> 类定义的字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> api;</span><br><span class="line">    <span class="keyword">protected</span> MethodVisitor mv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructors-4"><a href="#constructors-4" class="headerlink" title="constructors"></a>constructors</h3><p><code>MethodVisitor</code> 类定义的构造方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MethodVisitor</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> api)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(api, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MethodVisitor</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> api, <span class="keyword">final</span> MethodVisitor methodVisitor)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.api = api;</span><br><span class="line">        <span class="built_in">this</span>.mv = methodVisitor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="methods-3"><a href="#methods-3" class="headerlink" title="methods"></a>methods</h3><p><code>MethodVisitor</code> 类定义的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitCode</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitIntInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode, <span class="keyword">final</span> <span class="type">int</span> operand)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitVarInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode, <span class="keyword">final</span> <span class="type">int</span> <span class="keyword">var</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitTypeInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode, <span class="keyword">final</span> String type)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitFieldInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode, <span class="keyword">final</span> String owner, <span class="keyword">final</span> String name, <span class="keyword">final</span> String descriptor)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitMethodInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode, <span class="keyword">final</span> String owner, <span class="keyword">final</span> String name, <span class="keyword">final</span> String descriptor,</span></span><br><span class="line"><span class="params">                                <span class="keyword">final</span> <span class="type">boolean</span> isInterface)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitInvokeDynamicInsn</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> String descriptor, <span class="keyword">final</span> Handle bootstrapMethodHandle,</span></span><br><span class="line"><span class="params">                                       <span class="keyword">final</span> Object... bootstrapMethodArguments)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitJumpInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode, <span class="keyword">final</span> Label label)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitLabel</span><span class="params">(<span class="keyword">final</span> Label label)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitLdcInsn</span><span class="params">(<span class="keyword">final</span> Object value)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitIincInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> <span class="keyword">var</span>, <span class="keyword">final</span> <span class="type">int</span> increment)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitTableSwitchInsn</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> min, <span class="keyword">final</span> <span class="type">int</span> max, <span class="keyword">final</span> Label dflt, <span class="keyword">final</span> Label... labels)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitLookupSwitchInsn</span><span class="params">(<span class="keyword">final</span> Label dflt, <span class="keyword">final</span> <span class="type">int</span>[] keys, <span class="keyword">final</span> Label[] labels)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitMultiANewArrayInsn</span><span class="params">(<span class="keyword">final</span> String descriptor, <span class="keyword">final</span> <span class="type">int</span> numDimensions)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitTryCatchBlock</span><span class="params">(<span class="keyword">final</span> Label start, <span class="keyword">final</span> Label end, <span class="keyword">final</span> Label handler, <span class="keyword">final</span> String type)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitMaxs</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> maxStack, <span class="keyword">final</span> <span class="type">int</span> maxLocals)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于这些 <code>visitXxx()</code> 方法，可以从以下资料参阅：</p>
<ul>
<li>第一，从 ASM API 的角度来讲，我们可以查看 API 文档，来具体了解某一个方法是要实现什么样的作用，该方法所接收的参数代表什么含义。</li>
<li>第二，从 ClassFile 的角度来讲，这些 <code>visitXxxInsn()</code> 方法的本质就是组装 instruction 的内容。我们可以参考 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">Java Virtual Machine Specification</a> 的 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html">Chapter 6. The Java Virtual Machine Instruction Set</a> 部分。</li>
<li>第三，《<a target="_blank" rel="noopener" href="https://lsieun.github.io/java/asm/java-asm-season-02.html">Java ASM 系列二：OPCODE</a>》，主要是对 opcode 进行介绍。</li>
</ul>
</blockquote>
<p>在 <code>MethodVisitor</code> 类当中，定义了许多的 <code>visitXxx()</code> 方法，这些方法的调用，也要遵循一定的顺序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(visitParameter)*</span><br><span class="line">[visitAnnotationDefault]</span><br><span class="line">(visitAnnotation | visitAnnotableParameterCount | visitParameterAnnotation | visitTypeAnnotation | visitAttribute)*</span><br><span class="line">[</span><br><span class="line">    visitCode</span><br><span class="line">    (</span><br><span class="line">        visitFrame |</span><br><span class="line">        visitXxxInsn |</span><br><span class="line">        visitLabel |</span><br><span class="line">        visitInsnAnnotation |</span><br><span class="line">        visitTryCatchBlock |</span><br><span class="line">        visitTryCatchAnnotation |</span><br><span class="line">        visitLocalVariable |</span><br><span class="line">        visitLocalVariableAnnotation |</span><br><span class="line">        visitLineNumber</span><br><span class="line">    )*</span><br><span class="line">    visitMaxs</span><br><span class="line">]</span><br><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<p>我们可以把这些 <code>visitXxx()</code> 方法分成三组：</p>
<ul>
<li>第一组，在 <code>visitCode()</code> 方法之前的方法。这一组的方法，主要负责 parameter、annotation 和 attributes 等内容，这些内容并不是方法当中“必不可少”的一部分。</li>
<li>第二组，在 <code>visitCode()</code> 方法和 <code>visitMaxs()</code> 方法之间的方法。这一组的方法，主要负责当前方法的“方法体”内的 opcode 内容。其中，<code>visitCode()</code> 方法，标志着方法体的开始，而 <code>visitMaxs()</code> 方法，标志着方法体的结束。</li>
<li>第三组，是 <code>visitEnd()</code> 方法。这个 <code>visitEnd()</code> 方法，是最后一个进行调用的方法。</li>
</ul>
<p>对这些 <code>visitXxx()</code> 方法进行精简之后，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    visitCode</span><br><span class="line">    (</span><br><span class="line">        visitFrame |</span><br><span class="line">        visitXxxInsn |</span><br><span class="line">        visitLabel |</span><br><span class="line">        visitTryCatchBlock</span><br><span class="line">    )*</span><br><span class="line">    visitMaxs</span><br><span class="line">]</span><br><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<p>这些方法的调用顺序，可以记忆如下：</p>
<ul>
<li>第一步，调用 <code>visitCode()</code> 方法，调用一次。</li>
<li>第二步，调用 <code>visitXxxInsn()</code> 方法，可以调用多次。对这些方法的调用，就是在构建方法的“方法体”。</li>
<li>第三步，调用 <code>visitMaxs()</code> 方法，调用一次。</li>
<li>第四步，调用 <code>visitEnd()</code> 方法，调用一次。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">                 ┌─── visitCode()</span><br><span class="line">                 │</span><br><span class="line">                 │                      ┌─── visitXxxInsn()</span><br><span class="line">                 │                      │</span><br><span class="line">                 │                      ├─── visitLabel()</span><br><span class="line">                 ├─── visitXxxInsn() ───┤</span><br><span class="line">MethodVisitor ───┤                      ├─── visitFrame()</span><br><span class="line">                 │                      │</span><br><span class="line">                 │                      └─── visitTryCatchBlock()</span><br><span class="line">                 │</span><br><span class="line">                 ├─── visitMaxs()</span><br><span class="line">                 │</span><br><span class="line">                 └─── visitEnd()</span><br></pre></td></tr></table></figure>

<h3 id="示例一：-方法"><a href="#示例一：-方法" class="headerlink" title="示例一：&lt;init&gt;() 方法"></a>示例一：&lt;init&gt;() 方法</h3><p>在 <code>.class</code> 文件中，构造方法的名字是 <code>&lt;init&gt;</code>，它表示 instance <strong>init</strong>ialization method 的缩写。</p>
<p>编写代码实现以下.class文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloWorld</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现-4"><a href="#编码实现-4" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_SUPER, <span class="string">&quot;sample/HelloWorld&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv1.visitCode();</span><br><span class="line">            mv1.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">            mv1.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv1.visitInsn(RETURN);</span><br><span class="line">            mv1.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            mv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例二：-方法"><a href="#示例二：-方法" class="headerlink" title="示例二：&lt;clinit&gt; 方法"></a>示例二：&lt;clinit&gt; 方法</h3><p>在 <code>.class</code> 文件中，静态初始化方法的名字是 <code>&lt;clinit&gt;</code>，它表示<strong>cl</strong>ass <strong>init</strong>ialization method 的缩写。它的方法描述符是 <code>()V</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;class initialization method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现-5"><a href="#编码实现-5" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_SUPER, <span class="string">&quot;sample/HelloWorld&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv1.visitCode();</span><br><span class="line">            mv1.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">            mv1.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv1.visitInsn(RETURN);</span><br><span class="line">            mv1.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            mv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv2</span> <span class="operator">=</span> cw.visitMethod(ACC_STATIC, <span class="string">&quot;&lt;clinit&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv2.visitCode();</span><br><span class="line">            mv2.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv2.visitLdcInsn(<span class="string">&quot;class initialization method&quot;</span>);</span><br><span class="line">            mv2.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv2.visitInsn(RETURN);</span><br><span class="line">            mv2.visitMaxs(<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">            mv2.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例三：创建对象"><a href="#示例三：创建对象" class="headerlink" title="示例三：创建对象"></a>示例三：创建对象</h3><p>假如有一个 <code>GoodChild</code> 类，内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodChild</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GoodChild</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的预期目标是生成一个 <code>HelloWorld</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GoodChild</span> <span class="variable">child</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GoodChild</span>(<span class="string">&quot;Lucy&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现-6"><a href="#编码实现-6" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_SUPER, <span class="string">&quot;sample/HelloWorld&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv1.visitCode();</span><br><span class="line">            mv1.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">            mv1.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv1.visitInsn(RETURN);</span><br><span class="line">            mv1.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            mv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv2</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv2.visitCode();</span><br><span class="line">            mv2.visitTypeInsn(NEW, <span class="string">&quot;sample/GoodChild&quot;</span>);</span><br><span class="line">            mv2.visitInsn(DUP);</span><br><span class="line">            mv2.visitLdcInsn(<span class="string">&quot;Lucy&quot;</span>);</span><br><span class="line">            mv2.visitIntInsn(BIPUSH, <span class="number">8</span>);</span><br><span class="line">            mv2.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;sample/GoodChild&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;I)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv2.visitVarInsn(ASTORE, <span class="number">1</span>);</span><br><span class="line">            mv2.visitInsn(RETURN);</span><br><span class="line">            mv2.visitMaxs(<span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line">            mv2.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例四：调用方法"><a href="#示例四：调用方法" class="headerlink" title="示例四：调用方法"></a>示例四：调用方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> Math.max(a, b); <span class="comment">// 对 static 方法进行调用</span></span><br><span class="line">        System.out.println(val);  <span class="comment">// 对 non-static 方法进行调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现-7"><a href="#编码实现-7" class="headerlink" title="编码实现"></a>编码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;ClassFilePath/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_SUPER, <span class="string">&quot;sample/HelloWorld&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv1.visitCode();</span><br><span class="line">            mv1.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">            mv1.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv1.visitInsn(RETURN);</span><br><span class="line">            mv1.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            mv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv2</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;(II)V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv2.visitCode();</span><br><span class="line">            mv2.visitVarInsn(ILOAD, <span class="number">1</span>);</span><br><span class="line">            mv2.visitVarInsn(ILOAD, <span class="number">2</span>);</span><br><span class="line">            mv2.visitMethodInsn(INVOKESTATIC, <span class="string">&quot;java/lang/Math&quot;</span>, <span class="string">&quot;max&quot;</span>, <span class="string">&quot;(II)I&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv2.visitVarInsn(ISTORE, <span class="number">3</span>);</span><br><span class="line">            mv2.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv2.visitVarInsn(ILOAD, <span class="number">3</span>);</span><br><span class="line">            mv2.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv2.visitInsn(RETURN);</span><br><span class="line">            mv2.visitMaxs(<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            mv2.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例五：不调用-visitMaxs-方法"><a href="#示例五：不调用-visitMaxs-方法" class="headerlink" title="示例五：不调用 visitMaxs() 方法"></a>示例五：不调用 visitMaxs() 方法</h3><p>在创建 <code>ClassWriter</code> 对象时，使用了 <code>ClassWriter.COMPUTE_FRAMES</code> 选项。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);</span><br></pre></td></tr></table></figure>

<p>使用 <code>ClassWriter.COMPUTE_FRAMES</code> 后，ASM 会自动计算 max stacks、max locals 和 stack map frames 的具体值。 从代码的角度来说，使用 <code>ClassWriter.COMPUTE_FRAMES</code>，会忽略我们在代码中 <code>visitMaxs()</code> 方法和 <code>visitFrame()</code> 方法传入的具体参数值。 换句话说，无论我们传入的参数值是否正确，ASM 会帮助我们从新计算一个正确的值，代替我们在代码中传入的参数。</p>
<ul>
<li>第 1 种情况，在创建 <code>ClassWriter</code> 对象时，<code>flags</code> 参数使用 <code>ClassWriter.COMPUTE_FRAMES</code> 值，在调用 <code>mv.visitMaxs(0, 0)</code> 方法之后，仍然能得到一个正确的 <code>.class</code> 文件。</li>
<li>第 2 种情况，在创建 <code>ClassWriter</code> 对象时，<code>flags</code> 参数使用 <code>0</code> 值，在调用 <code>mv.visitMaxs(0, 0)</code> 方法之后，得到的 <code>.class</code> 文件就不能正确运行。</li>
</ul>
<p>需要注意的是，在创建 <code>ClassWriter</code> 对象时，<code>flags</code> 参数使用 <code>ClassWriter.COMPUTE_FRAMES</code> 值，我们可以给 <code>visitMaxs()</code> 方法传入一个错误的值，但是不能省略对于 <code>visitMaxs()</code> 方法的调用。 如果我们省略掉 <code>visitCode()</code> 和 <code>visitEnd()</code> 方法，生成的 <code>.class</code> 文件也不会出错；当然，并不建议这么做。但是，如果我们省略掉对于 <code>visitMaxs()</code> 方法的调用，生成的 <code>.class</code> 文件就会出错。</p>
<p>如果省略掉对于 <code>visitMaxs()</code> 方法的调用，会出现如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.VerifyError: Operand stack overflow</span><br></pre></td></tr></table></figure>

<h3 id="示例六：不同的-MethodVisitor-交叉使用"><a href="#示例六：不同的-MethodVisitor-交叉使用" class="headerlink" title="示例六：不同的 MethodVisitor 交叉使用"></a>示例六：不同的 MethodVisitor 交叉使用</h3><p>假如我们有两个 <code>MethodVisitor</code> 对象 <code>mv1</code> 和 <code>mv2</code>，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MethodVisitor mv1 = cw.visitMethod(...);</span><br><span class="line">MethodVisitor mv2 = cw.visitMethod(...);</span><br></pre></td></tr></table></figure>

<p>同时，我们也知道 <code>MethodVisitor</code> 类里的 <code>visitXxx()</code> 方法需要遵循一定的调用顺序：</p>
<ul>
<li>第一步，调用 <code>visitCode()</code> 方法，调用一次</li>
<li>第二步，调用 <code>visitXxxInsn()</code> 方法，可以调用多次</li>
<li>第三步，调用 <code>visitMaxs()</code> 方法，调用一次</li>
<li>第四步，调用 <code>visitEnd()</code> 方法，调用一次</li>
</ul>
<p>对于 <code>mv1</code> 和 <code>mv2</code> 这两个对象来说，它们的 <code>visitXxx()</code> 方法的调用顺序是彼此独立的、不会相互干扰。</p>
<p>一般情况下，我们可以如下写代码，这样逻辑比较清晰：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MethodVisitor mv1 = cw.visitMethod(...);</span><br><span class="line">mv1.visitCode(...);</span><br><span class="line">mv1.visitXxxInsn(...)</span><br><span class="line">mv1.visitMaxs(...);</span><br><span class="line">mv1.visitEnd();</span><br><span class="line"></span><br><span class="line">MethodVisitor mv2 = cw.visitMethod(...);</span><br><span class="line">mv2.visitCode(...);</span><br><span class="line">mv2.visitXxxInsn(...)</span><br><span class="line">mv2.visitMaxs(...);</span><br><span class="line">mv2.visitEnd();</span><br></pre></td></tr></table></figure>

<p>但是，我们也可以这样来写代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(...);</span><br><span class="line"><span class="type">MethodVisitor</span> <span class="variable">mv2</span> <span class="operator">=</span> cw.visitMethod(...);</span><br><span class="line"></span><br><span class="line">mv1.visitCode(...);</span><br><span class="line">mv2.visitCode(...);</span><br><span class="line"></span><br><span class="line">mv2.visitXxxInsn(...)</span><br><span class="line">mv1.visitXxxInsn(...)</span><br><span class="line"></span><br><span class="line">mv1.visitMaxs(...);</span><br><span class="line">mv1.visitEnd();</span><br><span class="line">mv2.visitMaxs(...);</span><br><span class="line">mv2.visitEnd();</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，<code>mv1</code> 和 <code>mv2</code> 这两个对象的 <code>visitXxx()</code> 方法交叉调用，这是可以的。 换句话说，只要每一个 <code>MethodVisitor</code> 对象在调用 <code>visitXxx()</code> 方法时，遵循了调用顺序，那结果就是正确的； 不同的 <code>MethodVisitor</code> 对象，是相互独立的、不会彼此影响。</p>
<p>那么，可能有的同学会问：<code>MethodVisitor</code> 对象交叉使用有什么作用呢？有没有什么场景下的应用呢？回答是“有的”。 在 ASM 当中，有一个 <code>org.objectweb.asm.commons.StaticInitMerger</code> 类，其中有一个 <code>MethodVisitor mergedClinitVisitor</code> 字段，它就是一个很好的示例，在后续内容中，我们会介绍到这个类。</p>
<h4 id="预期目标-1"><a href="#预期目标-1" class="headerlink" title="预期目标"></a>预期目标</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is a test method.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        System.out.println(now);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现（第一种方式，顺序）"><a href="#编码实现（第一种方式，顺序）" class="headerlink" title="编码实现（第一种方式，顺序）"></a>编码实现（第一种方式，顺序）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;sample/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_SUPER, <span class="string">&quot;sample/HelloWorld&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv1.visitCode();</span><br><span class="line">            mv1.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">            mv1.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv1.visitInsn(RETURN);</span><br><span class="line">            mv1.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            mv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv2</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv2.visitCode();</span><br><span class="line">            mv2.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv2.visitLdcInsn(<span class="string">&quot;This is a test method.&quot;</span>);</span><br><span class="line">            mv2.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv2.visitInsn(RETURN);</span><br><span class="line">            mv2.visitMaxs(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">            mv2.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv3</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;printDate&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv3.visitCode();</span><br><span class="line">            mv3.visitTypeInsn(NEW, <span class="string">&quot;java/util/Date&quot;</span>);</span><br><span class="line">            mv3.visitInsn(DUP);</span><br><span class="line">            mv3.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/util/Date&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv3.visitVarInsn(ASTORE, <span class="number">1</span>);</span><br><span class="line">            mv3.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv3.visitVarInsn(ALOAD, <span class="number">1</span>);</span><br><span class="line">            mv3.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv3.visitInsn(RETURN);</span><br><span class="line">            mv3.visitMaxs(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">            mv3.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编码实现（第二种方式，交叉）"><a href="#编码实现（第二种方式，交叉）" class="headerlink" title="编码实现（第二种方式，交叉）"></a>编码实现（第二种方式，交叉）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldGenerateCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;sample/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) 生成 byte[] 内容</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = dump();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 保存 byte[] 到文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] dump() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// (1) 创建 ClassWriter 对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 visitXxx() 方法</span></span><br><span class="line">        cw.visit(V1_8, ACC_PUBLIC + ACC_SUPER, <span class="string">&quot;sample/HelloWorld&quot;</span>,</span><br><span class="line">                <span class="literal">null</span>, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv1</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv1.visitCode();</span><br><span class="line">            mv1.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">            mv1.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/lang/Object&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">            mv1.visitInsn(RETURN);</span><br><span class="line">            mv1.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            mv1.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 第 1 部分，mv2</span></span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv2</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第 2 部分，mv3</span></span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">mv3</span> <span class="operator">=</span> cw.visitMethod(ACC_PUBLIC, <span class="string">&quot;printDate&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            mv3.visitCode();</span><br><span class="line">            mv3.visitTypeInsn(NEW, <span class="string">&quot;java/util/Date&quot;</span>);</span><br><span class="line">            mv3.visitInsn(DUP);</span><br><span class="line">            mv3.visitMethodInsn(INVOKESPECIAL, <span class="string">&quot;java/util/Date&quot;</span>, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第 3 部分，mv2</span></span><br><span class="line">            mv2.visitCode();</span><br><span class="line">            mv2.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv2.visitLdcInsn(<span class="string">&quot;This is a test method.&quot;</span>);</span><br><span class="line">            mv2.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第 4 部分，mv3</span></span><br><span class="line">            mv3.visitVarInsn(ASTORE, <span class="number">1</span>);</span><br><span class="line">            mv3.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">            mv3.visitVarInsn(ALOAD, <span class="number">1</span>);</span><br><span class="line">            mv3.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(Ljava/lang/Object;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第 5 部分，mv2</span></span><br><span class="line">            mv2.visitInsn(RETURN);</span><br><span class="line">            mv2.visitMaxs(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">            mv2.visitEnd();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第 6 部分，mv3</span></span><br><span class="line">            mv3.visitInsn(RETURN);</span><br><span class="line">            mv3.visitMaxs(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">            mv3.visitEnd();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cw.visitEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) 调用 toByteArray() 方法</span></span><br><span class="line">        <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="MethodWriter-类"><a href="#MethodWriter-类" class="headerlink" title="MethodWriter 类"></a>MethodWriter 类</h2><h3 id="class-info-5"><a href="#class-info-5" class="headerlink" title="class info"></a>class info</h3><p><code>MethodWriter</code> 类的父类是 <code>MethodVisitor</code> 类。<code>MethodWriter</code> 类并不带有 <code>public</code> 修饰，因此它的有效访问范围只局限于它所处的 package 当中，不能像其它的 <code>public</code> 类一样被外部所使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MethodWriter</span> <span class="keyword">extends</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields-5"><a href="#fields-5" class="headerlink" title="fields"></a>fields</h3><p><code>MethodWriter</code> 类定义的字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MethodWriter</span> <span class="keyword">extends</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> accessFlags;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> nameIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> descriptorIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String descriptor;</span><br><span class="line">    <span class="keyword">private</span> Attribute firstAttribute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些字段与 <code>ClassFile</code> 当中的 <code>method_info</code> 也是对应的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">method_info &#123;</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             name_index;</span><br><span class="line">    u2             descriptor_index;</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的几个字段，是与“方法体”直接相关的几个字段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MethodWriter</span> <span class="keyword">extends</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxStack;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> maxLocals;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ByteVector</span> <span class="variable">code</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteVector</span>();</span><br><span class="line">    <span class="keyword">private</span> Handler firstHandler;</span><br><span class="line">    <span class="keyword">private</span> Handler lastHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> numberOfExceptions;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] exceptionIndexTable;</span><br><span class="line">    <span class="keyword">private</span> Attribute firstCodeAttribute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些字段对应于 <code>Code</code> 属性结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Code_attribute &#123;</span><br><span class="line">    u2 attribute_name_index;</span><br><span class="line">    u4 attribute_length;</span><br><span class="line">    u2 max_stack;</span><br><span class="line">    u2 max_locals;</span><br><span class="line">    u4 code_length;</span><br><span class="line">    u1 code[code_length];</span><br><span class="line">    u2 exception_table_length;</span><br><span class="line">    &#123;   u2 start_pc;</span><br><span class="line">        u2 end_pc;</span><br><span class="line">        u2 handler_pc;</span><br><span class="line">        u2 catch_type;</span><br><span class="line">    &#125; exception_table[exception_table_length];</span><br><span class="line">    u2 attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructors-5"><a href="#constructors-5" class="headerlink" title="constructors"></a>constructors</h3><p><code>MethodWriter</code> 类定义的构造方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MethodWriter</span> <span class="keyword">extends</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">    MethodWriter(SymbolTable symbolTable, <span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions, <span class="type">int</span> compute) &#123;</span><br><span class="line">        <span class="built_in">super</span>(Opcodes.ASM9);</span><br><span class="line">        <span class="built_in">this</span>.symbolTable = symbolTable;</span><br><span class="line">        <span class="built_in">this</span>.accessFlags = <span class="string">&quot;&lt;init&gt;&quot;</span>.equals(name) ? access | Constants.ACC_CONSTRUCTOR : access;</span><br><span class="line">        <span class="built_in">this</span>.nameIndex = symbolTable.addConstantUtf8(name);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.descriptorIndex = symbolTable.addConstantUtf8(descriptor);</span><br><span class="line">        <span class="built_in">this</span>.descriptor = descriptor;</span><br><span class="line">        <span class="built_in">this</span>.signatureIndex = signature == <span class="literal">null</span> ? <span class="number">0</span> : symbolTable.addConstantUtf8(signature);</span><br><span class="line">        <span class="keyword">if</span> (exceptions != <span class="literal">null</span> &amp;&amp; exceptions.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            numberOfExceptions = exceptions.length;</span><br><span class="line">            <span class="built_in">this</span>.exceptionIndexTable = <span class="keyword">new</span> <span class="title class_">int</span>[numberOfExceptions];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numberOfExceptions; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.exceptionIndexTable[i] = symbolTable.addConstantClass(exceptions[i]).index;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            numberOfExceptions = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">this</span>.exceptionIndexTable = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.compute = compute;</span><br><span class="line">        <span class="keyword">if</span> (compute != COMPUTE_NOTHING) &#123;</span><br><span class="line">            <span class="comment">// Update maxLocals and currentLocals.</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">argumentsSize</span> <span class="operator">=</span> Type.getArgumentsAndReturnSizes(descriptor) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> ((access &amp; Opcodes.ACC_STATIC) != <span class="number">0</span>) &#123;</span><br><span class="line">                --argumentsSize;</span><br><span class="line">            &#125;</span><br><span class="line">            maxLocals = argumentsSize;</span><br><span class="line">            currentLocals = argumentsSize;</span><br><span class="line">            <span class="comment">// Create and visit the label for the first basic block.</span></span><br><span class="line">            firstBasicBlock = <span class="keyword">new</span> <span class="title class_">Label</span>();</span><br><span class="line">            visitLabel(firstBasicBlock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="methods-4"><a href="#methods-4" class="headerlink" title="methods"></a>methods</h3><p><code>MethodWriter</code> 类定义的方法。</p>
<p>在 <code>MethodWriter</code> 类当中，也有两个重要的方法：<code>computeMethodInfoSize()</code> 和 <code>putMethodInfo()</code> 方法。这两个方法也是在 <code>ClassWriter</code> 类的 <code>toByteArray()</code> 方法内使用到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MethodWriter</span> <span class="keyword">extends</span> <span class="title class_">MethodVisitor</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">computeMethodInfoSize</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="comment">// 2 bytes each for access_flags, name_index, descriptor_index and attributes_count.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">        <span class="comment">// For ease of reference, we use here the same attribute order as in Section 4.7 of the JVMS.</span></span><br><span class="line">        <span class="keyword">if</span> (code.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (code.length &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MethodTooLargeException</span>(symbolTable.getClassName(), name, descriptor, code.length);</span><br><span class="line">            &#125;</span><br><span class="line">            symbolTable.addConstantUtf8(Constants.CODE);</span><br><span class="line">            <span class="comment">// The Code attribute has 6 header bytes, plus 2, 2, 4 and 2 bytes respectively for max_stack,</span></span><br><span class="line">            <span class="comment">// max_locals, code_length and attributes_count, plus the ByteCode and the exception table.</span></span><br><span class="line">            size += <span class="number">16</span> + code.length + Handler.getExceptionTableSize(firstHandler);</span><br><span class="line">            <span class="keyword">if</span> (stackMapTableEntries != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">useStackMapTable</span> <span class="operator">=</span> symbolTable.getMajorVersion() &gt;= Opcodes.V1_6;</span><br><span class="line">                symbolTable.addConstantUtf8(useStackMapTable ? Constants.STACK_MAP_TABLE : <span class="string">&quot;StackMap&quot;</span>);</span><br><span class="line">                <span class="comment">// 6 header bytes and 2 bytes for number_of_entries.</span></span><br><span class="line">                size += <span class="number">8</span> + stackMapTableEntries.length;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ......</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (numberOfExceptions &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            symbolTable.addConstantUtf8(Constants.EXCEPTIONS);</span><br><span class="line">            size += <span class="number">8</span> + <span class="number">2</span> * numberOfExceptions;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">putMethodInfo</span><span class="params">(<span class="keyword">final</span> ByteVector output)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">useSyntheticAttribute</span> <span class="operator">=</span> symbolTable.getMajorVersion() &lt; Opcodes.V1_5;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mask</span> <span class="operator">=</span> useSyntheticAttribute ? Opcodes.ACC_SYNTHETIC : <span class="number">0</span>;</span><br><span class="line">        output.putShort(accessFlags &amp; ~mask).putShort(nameIndex).putShort(descriptorIndex);</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="comment">// For ease of reference, we use here the same attribute order as in Section 4.7 of the JVMS.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">attributeCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (code.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ++attributeCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (numberOfExceptions &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ++attributeCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="comment">// For ease of reference, we use here the same attribute order as in Section 4.7 of the JVMS.</span></span><br><span class="line">        output.putShort(attributeCount);</span><br><span class="line">        <span class="keyword">if</span> (code.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 2, 2, 4 and 2 bytes respectively for max_stack, max_locals, code_length and</span></span><br><span class="line">            <span class="comment">// attributes_count, plus the ByteCode and the exception table.</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">10</span> + code.length + Handler.getExceptionTableSize(firstHandler);</span><br><span class="line">            <span class="type">int</span> <span class="variable">codeAttributeCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (stackMapTableEntries != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 6 header bytes and 2 bytes for number_of_entries.</span></span><br><span class="line">                size += <span class="number">8</span> + stackMapTableEntries.length;</span><br><span class="line">                ++codeAttributeCount;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ......</span></span><br><span class="line">            output</span><br><span class="line">                .putShort(symbolTable.addConstantUtf8(Constants.CODE))</span><br><span class="line">                .putInt(size)</span><br><span class="line">                .putShort(maxStack)</span><br><span class="line">                .putShort(maxLocals)</span><br><span class="line">                .putInt(code.length)</span><br><span class="line">                .putByteArray(code.data, <span class="number">0</span>, code.length);</span><br><span class="line">            Handler.putExceptionTable(firstHandler, output);</span><br><span class="line">            output.putShort(codeAttributeCount);</span><br><span class="line">            <span class="comment">// ......</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (numberOfExceptions &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            output</span><br><span class="line">                .putShort(symbolTable.addConstantUtf8(Constants.EXCEPTIONS))</span><br><span class="line">                .putInt(<span class="number">2</span> + <span class="number">2</span> * numberOfExceptions)</span><br><span class="line">                .putShort(numberOfExceptions);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> exceptionIndex : exceptionIndexTable) &#123;</span><br><span class="line">              output.putShort(exceptionIndex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于 <code>MethodWriter</code> 类的使用，在 <code>ClassWriter</code> 类当中，<code>visitMethod()</code> 方法代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassWriter</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="type">MethodWriter</span> <span class="variable">methodWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MethodWriter</span>(symbolTable, access, name, descriptor, signature, exceptions, compute);</span><br><span class="line">        <span class="keyword">if</span> (firstMethod == <span class="literal">null</span>) &#123;</span><br><span class="line">            firstMethod = methodWriter;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            lastMethod.mv = methodWriter;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">return</span> <span class="variable">lastMethod</span> <span class="operator">=</span> methodWriter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>toByteArray 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassWriter</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] toByteArray() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// First step: compute the size in bytes of the ClassFile structure.</span></span><br><span class="line">        <span class="comment">// The magic field uses 4 bytes, 10 mandatory fields (minor_version, major_version,</span></span><br><span class="line">        <span class="comment">// constant_pool_count, access_flags, this_class, super_class, interfaces_count, fields_count,</span></span><br><span class="line">        <span class="comment">// methods_count and attributes_count) use 2 bytes each, and each interface uses 2 bytes too.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">24</span> + <span class="number">2</span> * interfaceCount;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">methodsCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">MethodWriter</span> <span class="variable">methodWriter</span> <span class="operator">=</span> firstMethod;</span><br><span class="line">        <span class="keyword">while</span> (methodWriter != <span class="literal">null</span>) &#123;</span><br><span class="line">            ++methodsCount;</span><br><span class="line">            size += methodWriter.computeMethodInfoSize();        <span class="comment">// 这里是对 MethodWriter.computeMethodInfoSize() 方法的调用</span></span><br><span class="line">            methodWriter = (MethodWriter) methodWriter.mv;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Second step: allocate a ByteVector of the correct size (in order to avoid any array copy in</span></span><br><span class="line">        <span class="comment">// dynamic resizes) and fill it with the ClassFile content.</span></span><br><span class="line">        <span class="type">ByteVector</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteVector</span>(size);</span><br><span class="line">        result.putInt(<span class="number">0xCAFEBABE</span>).putInt(version);</span><br><span class="line">        symbolTable.putConstantPool(result);</span><br><span class="line">        <span class="type">int</span> <span class="variable">mask</span> <span class="operator">=</span> (version &amp; <span class="number">0xFFFF</span>) &lt; Opcodes.V1_5 ? Opcodes.ACC_SYNTHETIC : <span class="number">0</span>;</span><br><span class="line">        result.putShort(accessFlags &amp; ~mask).putShort(thisClass).putShort(superClass);</span><br><span class="line">        result.putShort(interfaceCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; interfaceCount; ++i) &#123;</span><br><span class="line">            result.putShort(interfaces[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        result.putShort(methodsCount);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasFrames</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasAsmInstructions</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        methodWriter = firstMethod;</span><br><span class="line">        <span class="keyword">while</span> (methodWriter != <span class="literal">null</span>) &#123;</span><br><span class="line">            hasFrames |= methodWriter.hasFrames();</span><br><span class="line">            hasAsmInstructions |= methodWriter.hasAsmInstructions();</span><br><span class="line">            methodWriter.putMethodInfo(result);                    <span class="comment">// 这里是对 MethodWriter.putMethodInfo() 方法的调用</span></span><br><span class="line">            methodWriter = (MethodWriter) methodWriter.mv;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Third step: replace the ASM specific instructions, if any.</span></span><br><span class="line">        <span class="keyword">if</span> (hasAsmInstructions) &#123;</span><br><span class="line">            <span class="keyword">return</span> replaceAsmInstructions(result.data, hasFrames);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> result.data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于 <code>MethodWriter</code> 类的使用，它主要出现在 <code>ClassWriter</code> 类当中的 <code>visitMethod()</code> 和 <code>toByteArray()</code> 方法内。</p>
<h2 id="ClassReader-类"><a href="#ClassReader-类" class="headerlink" title="ClassReader 类"></a>ClassReader 类</h2><p><code>ClassReader</code> 类和 <code>ClassWriter</code> 类，从功能角度来说，是完全相反的两个类，一个用于读取 <code>.class</code> 文件，另一个用于生成 <code>.class</code> 文件。</p>
<h3 id="class-info-6"><a href="#class-info-6" class="headerlink" title="class info"></a>class info</h3><p>与 <code>ClassWriter</code> 类不同的是，<code>ClassReader</code> 类并没有继承自 <code>ClassVisitor</code> 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassReader</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ClassWriter</code> 类的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassWriter</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields-6"><a href="#fields-6" class="headerlink" title="fields"></a>fields</h3><p><code>ClassReader</code> 类定义的字段有哪些。主要是以下三个片段： <code>classFileBuffer</code> 字段、<code>cpInfoOffsets</code> 字段和 <code>header</code> 字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassReader</span> &#123;</span><br><span class="line">    <span class="comment">// 第 1 组，真实的数据部分</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] classFileBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第 2 组，数据的索引信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] cpInfoOffsets;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> header;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这 3 个字段能够体现出 <code>ClassReader</code> 类处理 <code>.class</code> 文件的整体思路：</p>
<ul>
<li>第 1 组，<code>classFileBuffer</code> 字段：它里面包含的信息，就是从 <code>.class</code> 文件中读取出来的字节码数据。</li>
<li>第 2 组，<code>cpInfoOffsets</code> 字段和 <code>header</code> 字段：它们分别标识了 <code>classFileBuffer</code> 中数据里包含的常量池（constant pool）和访问标识（access flag）的位置信息。</li>
</ul>
<p>我们拿到 <code>classFileBuffer</code> 字段后，一个主要目的就是对它的内容进行修改，来实现一个新的功能。它处理的大体思路是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.class 文件 --&gt; ClassReader --&gt; byte[] --&gt; 经过各种转换 --&gt; ClassWriter --&gt; byte[] --&gt; .class 文件</span><br></pre></td></tr></table></figure>

<h3 id="constructors-6"><a href="#constructors-6" class="headerlink" title="constructors"></a>constructors</h3><p><code>ClassReader</code> 类定义的构造方法。在 <code>ClassReader</code> 类当中定义了 5 个构造方法。但是，从本质上来说，这 5 个构造方法本质上是同一个构造方法的不同表现形式。其中，最常用的构造方法有两个：</p>
<ul>
<li>第一个是 <code>ClassReader cr = new ClassReader(&quot;sample.HelloWorld&quot;);</code></li>
<li>第二个是 <code>ClassReader cr = new ClassReader(bytes);</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassReader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassReader</span><span class="params">(<span class="keyword">final</span> String className)</span> <span class="keyword">throws</span> IOException &#123; <span class="comment">// 第一个构造方法（常用）</span></span><br><span class="line">        <span class="built_in">this</span>(</span><br><span class="line">            readStream(ClassLoader.getSystemResourceAsStream(className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&quot;.class&quot;</span>), <span class="literal">true</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassReader</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] classFile)</span> &#123; <span class="comment">// 第二个构造方法（常用）</span></span><br><span class="line">        <span class="built_in">this</span>(classFile, <span class="number">0</span>, classFile.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassReader</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] classFileBuffer, <span class="keyword">final</span> <span class="type">int</span> classFileOffset, <span class="keyword">final</span> <span class="type">int</span> classFileLength)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(classFileBuffer, classFileOffset, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClassReader( <span class="comment">// 这是最根本、最本质的构造方法</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classFileBuffer,</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> classFileOffset,</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> checkClassVersion) &#123;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassReader</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>(readStream(inputStream, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="methods-5"><a href="#methods-5" class="headerlink" title="methods"></a>methods</h3><p><code>ClassReader</code> 类定义的方法。</p>
<h4 id="getXxx-方法"><a href="#getXxx-方法" class="headerlink" title="getXxx() 方法"></a>getXxx() 方法</h4><p>这里介绍的几个 <code>getXxx()</code> 方法，都是在 <code>header</code> 字段的基础上获得的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> readUnsignedShort(header);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getClassName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// this_class is just after the access_flags field (using 2 bytes).</span></span><br><span class="line">        <span class="keyword">return</span> readClass(header + <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">char</span>[maxStringLength]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSuperName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// super_class is after the access_flags and this_class fields (2 bytes each).</span></span><br><span class="line">        <span class="keyword">return</span> readClass(header + <span class="number">4</span>, <span class="keyword">new</span> <span class="title class_">char</span>[maxStringLength]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getInterfaces() &#123;</span><br><span class="line">        <span class="comment">// interfaces_count is after the access_flags, this_class and super_class fields (2 bytes each).</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">currentOffset</span> <span class="operator">=</span> header + <span class="number">6</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">interfacesCount</span> <span class="operator">=</span> readUnsignedShort(currentOffset);</span><br><span class="line">        String[] interfaces = <span class="keyword">new</span> <span class="title class_">String</span>[interfacesCount];</span><br><span class="line">        <span class="keyword">if</span> (interfacesCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span>[] charBuffer = <span class="keyword">new</span> <span class="title class_">char</span>[maxStringLength];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; interfacesCount; ++i) &#123;</span><br><span class="line">                currentOffset += <span class="number">2</span>;</span><br><span class="line">                interfaces[i] = readClass(currentOffset, charBuffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> interfaces;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的几个 <code>getXxx()</code> 方法也需要参考 ClassFile 结构来理解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic;</span><br><span class="line">    u2             minor_version;</span><br><span class="line">    u2             major_version;</span><br><span class="line">    u2             constant_pool_count;</span><br><span class="line">    cp_info        constant_pool[constant_pool_count-1];</span><br><span class="line">    u2             access_flags;</span><br><span class="line">    u2             this_class;</span><br><span class="line">    u2             super_class;</span><br><span class="line">    u2             interfaces_count;</span><br><span class="line">    u2             interfaces[interfaces_count];</span><br><span class="line">    u2             fields_count;</span><br><span class="line">    field_info     fields[fields_count];</span><br><span class="line">    u2             methods_count;</span><br><span class="line">    method_info    methods[methods_count];</span><br><span class="line">    u2             attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假如，有如下一个类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class HelloWorld extends Exception implements Serializable, Cloneable &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以使用 <code>ClassReader</code> 类中的 <code>getXxx()</code> 方法来获取相应的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldRun</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;sample/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line">        <span class="type">byte</span>[] bytes = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（1）构建 ClassReader</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) 调用 getXxx() 方法</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">access</span> <span class="operator">=</span> cr.getAccess();</span><br><span class="line">        System.out.println(<span class="string">&quot;access: &quot;</span> + access);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> cr.getClassName();</span><br><span class="line">        System.out.println(<span class="string">&quot;className: &quot;</span> + className);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">superName</span> <span class="operator">=</span> cr.getSuperName();</span><br><span class="line">        System.out.println(<span class="string">&quot;superName: &quot;</span> + superName);</span><br><span class="line"></span><br><span class="line">        String[] interfaces = cr.getInterfaces();</span><br><span class="line">        System.out.println(<span class="string">&quot;interfaces: &quot;</span> + Arrays.toString(interfaces));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">access: 33</span><br><span class="line">className: sample/HelloWorld</span><br><span class="line">superName: java/lang/Exception</span><br><span class="line">interfaces: [java/io/Serializable, java/lang/Cloneable]</span><br></pre></td></tr></table></figure>

<h4 id="accept-方法"><a href="#accept-方法" class="headerlink" title="accept() 方法"></a>accept() 方法</h4><p>在 <code>ClassReader</code> 类当中，有一个 <code>accept()</code> 方法，这个方法接收一个 <code>ClassVisitor</code> 类型的参数，因此 <code>accept()</code> 方法是将 <code>ClassReader</code> 和 <code>ClassVisitor</code> 进行连接的“桥梁”。<code>accept()</code> 方法的代码逻辑就是按照一定的顺序来调用 <code>ClassVisitor</code> 当中的 <code>visitXxx()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassReader</span> &#123;</span><br><span class="line">    <span class="comment">// A flag to skip the Code attributes.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SKIP_CODE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A flag to skip the SourceFile, SourceDebugExtension,</span></span><br><span class="line">    <span class="comment">// LocalVariableTable, LocalVariableTypeTable,</span></span><br><span class="line">    <span class="comment">// LineNumberTable and MethodParameters attributes.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SKIP_DEBUG</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A flag to skip the StackMap and StackMapTable attributes.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SKIP_FRAMES</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A flag to expand the stack map frames.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXPAND_FRAMES</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(<span class="keyword">final</span> ClassVisitor classVisitor, <span class="keyword">final</span> <span class="type">int</span> parsingOptions)</span> &#123;</span><br><span class="line">        accept(classVisitor, <span class="keyword">new</span> <span class="title class_">Attribute</span>[<span class="number">0</span>], parsingOptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> ClassVisitor classVisitor,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> Attribute[] attributePrototypes,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> parsingOptions)</span> &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Context</span>();</span><br><span class="line">        context.attributePrototypes = attributePrototypes;</span><br><span class="line">        context.parsingOptions = parsingOptions;</span><br><span class="line">        context.charBuffer = <span class="keyword">new</span> <span class="title class_">char</span>[maxStringLength];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the access_flags, this_class, super_class, interface_count and interfaces fields.</span></span><br><span class="line">        <span class="type">char</span>[] charBuffer = context.charBuffer;</span><br><span class="line">        <span class="type">int</span> <span class="variable">currentOffset</span> <span class="operator">=</span> header;</span><br><span class="line">        <span class="type">int</span> <span class="variable">accessFlags</span> <span class="operator">=</span> readUnsignedShort(currentOffset);</span><br><span class="line">        <span class="type">String</span> <span class="variable">thisClass</span> <span class="operator">=</span> readClass(currentOffset + <span class="number">2</span>, charBuffer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">superClass</span> <span class="operator">=</span> readClass(currentOffset + <span class="number">4</span>, charBuffer);</span><br><span class="line">        String[] interfaces = <span class="keyword">new</span> <span class="title class_">String</span>[readUnsignedShort(currentOffset + <span class="number">6</span>)];</span><br><span class="line">        currentOffset += <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; interfaces.length; ++i) &#123;</span><br><span class="line">          interfaces[i] = readClass(currentOffset, charBuffer);</span><br><span class="line">          currentOffset += <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Visit the class declaration. The minor_version and major_version fields start 6 bytes before</span></span><br><span class="line">        <span class="comment">// the first constant pool entry, which itself starts at cpInfoOffsets[1] - 1 (by definition).</span></span><br><span class="line">        classVisitor.visit(readInt(cpInfoOffsets[<span class="number">1</span>] - <span class="number">7</span>), accessFlags, thisClass, signature, superClass, interfaces);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Visit the fields and methods.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">fieldsCount</span> <span class="operator">=</span> readUnsignedShort(currentOffset);</span><br><span class="line">        currentOffset += <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span> (fieldsCount-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          currentOffset = readField(classVisitor, context, currentOffset);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">methodsCount</span> <span class="operator">=</span> readUnsignedShort(currentOffset);</span><br><span class="line">        currentOffset += <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span> (methodsCount-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          currentOffset = readMethod(classVisitor, context, currentOffset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Visit the end of the class.</span></span><br><span class="line">        classVisitor.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>ClassVisitor</code> 类中 <code>visitXxx()</code> 方法的调用顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">visit</span><br><span class="line">[visitSource][visitModule][visitNestHost][visitPermittedSubclass][visitOuterClass]</span><br><span class="line">(</span><br><span class="line"> visitAnnotation |</span><br><span class="line"> visitTypeAnnotation |</span><br><span class="line"> visitAttribute</span><br><span class="line">)*</span><br><span class="line">(</span><br><span class="line"> visitNestMember |</span><br><span class="line"> visitInnerClass |</span><br><span class="line"> visitRecordComponent |</span><br><span class="line"> visitField |</span><br><span class="line"> visitMethod</span><br><span class="line">)* </span><br><span class="line">visitEnd</span><br></pre></td></tr></table></figure>

<h3 id="使用-ClassReader-类"><a href="#使用-ClassReader-类" class="headerlink" title="使用 ClassReader 类"></a>使用 ClassReader 类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;sample/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（1）构建 ClassReader</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）构建 ClassWriter</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（3）串连 ClassVisitor</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">api</span> <span class="operator">=</span> Opcodes.ASM9;</span><br><span class="line">        <span class="type">ClassVisitor</span> <span class="variable">cv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassVisitor</span>(api, cw) &#123; <span class="comment">/**/ &#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        //（4）结合 ClassReader 和 ClassVisitor</span></span><br><span class="line"><span class="comment">        int parsingOptions = ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES;</span></span><br><span class="line"><span class="comment">        cr.accept(cv, parsingOptions);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        //（5）生成 byte[]</span></span><br><span class="line"><span class="comment">        byte[] bytes2 = cw.toByteArray();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        FileUtils.writeBytes(filepath, bytes2);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>

<p>代码的整体处理流程是如下这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.class --&gt; ClassReader --&gt; ClassVisitor1 ... --&gt; ClassVisitorN --&gt; ClassWriter --&gt; .class 文件</span><br></pre></td></tr></table></figure>

<p>我们可以将整体的处理流程想像成一条河流，那么</p>
<ul>
<li>第一步，构建 <code>ClassReader</code>。生成的 <code>ClassReader</code> 对象，它是这条“河流”的“源头”。</li>
<li>第二步，构建 <code>ClassWriter</code>。生成的 <code>ClassWriter</code> 对象，它是这条“河流”的“归处”，它可以想像成是“百川东到海”中的“大海”。</li>
<li>第三步，串连 <code>ClassVisitor</code>。生成的 <code>ClassVisitor</code> 对象，它是这条“河流”上的重要节点，可以想像成一个“水库”；可以有多个 <code>ClassVisitor</code> 对象，也就是在这条“河流”上存在多个“水库”，这些“水库”可以对“河水”进行一些处理，最终会这些“水库”的水会流向“大海”；也就是说多个 <code>ClassVisitor</code> 对象最终会连接到 <code>ClassWriter</code> 对象上。</li>
<li>第四步，结合 <code>ClassReader</code> 和 <code>ClassVisitor</code>。在 <code>ClassReader</code> 类上，有一个 <code>accept()</code> 方法，它接收一个 <code>ClassVisitor</code> 类型的对象；换句话说，就是将“河流”的“源头”和后续的“水库”连接起来。</li>
<li>第五步，生成 <code>byte[]</code>。到这一步，就是所有的“河水”都流入 <code>ClassWriter</code> 这个“大海”当中，这个时候我们调用 <code>ClassWriter.toByteArray()</code> 方法，就能够得到 <code>byte[]</code> 内容。</li>
</ul>
<p><img src="/.https:/cmisl.oss-cn-beijing.aliyuncs.com/cmisl/asm-core-classes.png" alt="img"></p>
<h3 id="parsingOptions-参数"><a href="#parsingOptions-参数" class="headerlink" title="parsingOptions 参数"></a>parsingOptions 参数</h3><p>在 <code>ClassReader</code> 类当中，<code>accept()</code> 方法接收一个 <code>int</code> 类型的 <code>parsingOptions</code> 参数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public void accept(final ClassVisitor classVisitor, final int parsingOptions)</span><br></pre></td></tr></table></figure>

<p><code>parsingOptions</code> 参数可以选取的值有以下 5 个：</p>
<ul>
<li><code>0</code></li>
<li><code>ClassReader.SKIP_CODE</code></li>
<li><code>ClassReader.SKIP_DEBUG</code></li>
<li><code>ClassReader.SKIP_FRAMES</code></li>
<li><code>ClassReader.EXPAND_FRAMES</code></li>
</ul>
<p>推荐使用：</p>
<ul>
<li>在调用 <code>ClassReader.accept()</code> 方法时，其中的 <code>parsingOptions</code> 参数，推荐使用 <code>ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES</code>。</li>
<li>在创建 <code>ClassWriter</code> 对象时，其中的 <code>flags</code> 参数，推荐使用 <code>ClassWriter.COMPUTE_FRAMES</code>。</li>
</ul>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes);</span><br><span class="line"><span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES;</span><br><span class="line">cr.accept(cv, parsingOptions);</span><br><span class="line"></span><br><span class="line"><span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br></pre></td></tr></table></figure>

<p>为什么我们推荐使用 <code>ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES</code> 呢？因为使用这样的一个值，可以生成最少的 ASM 代码，但是又能实现完整的功能。</p>
<ul>
<li><code>0</code>：会生成所有的 ASM 代码，包括调试信息、frame 信息和代码信息。</li>
<li><code>ClassReader.SKIP_CODE</code>：会忽略代码信息，例如，会忽略对于 <code>MethodVisitor.visitXxxInsn()</code> 方法的调用。</li>
<li><code>ClassReader.SKIP_DEBUG</code>：会忽略调试信息，例如，会忽略对于 <code>MethodVisitor.visitParameter()</code>、<code>MethodVisitor.visitLineNumber()</code> 和 <code>MethodVisitor.visitLocalVariable()</code> 等方法的调用。</li>
<li><code>ClassReader.SKIP_FRAMES</code>：会忽略 frame 信息，例如，会忽略对于 <code>MethodVisitor.visitFrame()</code> 方法的调用。</li>
<li><code>ClassReader.EXPAND_FRAMES</code>：会对 frame 信息进行扩展，例如，会对 <code>MethodVisitor.visitFrame()</code> 方法的参数有影响。</li>
</ul>
<p>简而言之，使用 <code>ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES</code> 的目的是<strong>功能完整、代码少、复杂度低，</strong>：</p>
<ul>
<li>不使用 <code>ClassReader.SKIP_CODE</code>，使代码的<strong>功能</strong>保持完整。</li>
<li>使用 <code>ClassReader.SKIP_DEBUG</code>，减少不必要的调试信息，会使<strong>代码量</strong>减少。</li>
<li>使用 <code>ClassReader.SKIP_FRAMES</code>，降低代码的<strong>复杂度</strong>。</li>
<li>不使用 <code>ClassReader.EXPAND_FRAMES</code>，降低代码的<strong>复杂度</strong>。</li>
</ul>
<p>我们使用 <code>ClassReader.SKIP_DEBUG</code> 的时候，就不会生成调试信息。因为这些调试信息主要是记录某一条 instruction 在代码当中的行数，以及变量的名字等信息；如果没有这些调试信息，也不会影响程序的正常运行，也就是说功能不受影响，因此省略这些信息，就会让 ASM 代码尽可能的简洁。</p>
<p>我们使用 <code>ClassReader.SKIP_FRAMES</code> 的时候，就会忽略 frame 的信息。为什么要忽略这些 frame 信息呢？因为 frame 计算的细节会很繁琐，需要处理的情况也有很多，总的来说，就是比较麻烦。我们解决这个麻烦的方式，就是让 ASM 帮助我们来计算 frame 的情况，也就是在创建 <code>ClassWriter</code> 对象的时候使用 <code>ClassWriter.COMPUTE_FRAMES</code> 选项。</p>
<h3 id="示例一：修改类的版本"><a href="#示例一：修改类的版本" class="headerlink" title="示例一：修改类的版本"></a>示例一：修改类的版本</h3><p>假如有一个 <code>HelloWorld.java</code> 文件，经过 Java 8 编译之后，生成的 <code>HelloWorld.class</code> 文件的版本就是 Java 8 的版本，我们的目标是将 <code>HelloWorld.class</code> 由 Java 8 版本转换成 Java 7 版本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassChangeVersionVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassChangeVersionVisitor</span><span class="params">(<span class="type">int</span> api, ClassVisitor classVisitor)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, classVisitor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(<span class="type">int</span> version, <span class="type">int</span> access, String name, String signature, String superName, String[] interfaces)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.visit(Opcodes.V1_7, access, name, signature, superName, interfaces);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行转换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;sample/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（1）构建 ClassReader</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）构建 ClassWriter</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（3）串连 ClassVisitor</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">api</span> <span class="operator">=</span> Opcodes.ASM9;</span><br><span class="line">        <span class="type">ClassVisitor</span> <span class="variable">cv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassChangeVersionVisitor</span>(api, cw);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（4）结合 ClassReader 和 ClassVisitor</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES;</span><br><span class="line">        cr.accept(cv, parsingOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（5）生成 byte[]</span></span><br><span class="line">        <span class="type">byte</span>[] bytes2 = cw.toByteArray();</span><br><span class="line"></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例二：修改类的接口"><a href="#示例二：修改类的接口" class="headerlink" title="示例二：修改类的接口"></a>示例二：修改类的接口</h3><p>在下面的 <code>HelloWorld</code> 类中，我们定义了一个 <code>clone()</code> 方法，但存在一个问题，也就是，如果没有实现 <code>Cloneable</code> 接口，<code>clone()</code> 方法就会出错，我们的目标是希望通过 ASM 为 <code>HelloWorld</code> 类添加上 <code>Cloneable</code> 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassCloneVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassCloneVisitor</span><span class="params">(<span class="type">int</span> api, ClassVisitor cw)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, cw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(<span class="type">int</span> version, <span class="type">int</span> access, String name, String signature, String superName, String[] interfaces)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.visit(version, access, name, signature, superName, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;java/lang/Cloneable&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：<code>ClassCloneVisitor</code> 这个类写的比较简单，直接添加 <code>java/lang/Cloneable</code> 接口信息；在项目代码当中，有一个 <code>ClassAddInterfaceVisitor</code> 类，实现更灵活。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;sample/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（1）构建 ClassReader</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）构建 ClassWriter</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（3）串连 ClassVisitor</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">api</span> <span class="operator">=</span> Opcodes.ASM9;</span><br><span class="line">        <span class="type">ClassVisitor</span> <span class="variable">cv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassCloneVisitor</span>(api, cw);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（4）结合 ClassReader 和 ClassVisitor</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES;</span><br><span class="line">        cr.accept(cv, parsingOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（5）生成 byte[]</span></span><br><span class="line">        <span class="type">byte</span>[] bytes2 = cw.toByteArray();</span><br><span class="line"></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>验证结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldRun</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HelloWorld</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloWorld</span>();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">anotherObj</span> <span class="operator">=</span> obj.clone();</span><br><span class="line">        System.out.println(anotherObj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结一"><a href="#总结一" class="headerlink" title="总结一"></a>总结一</h3><p>上面的两个例子，一个是修改类的版本信息，另一个是修改类的接口信息，那么这两个示例都是基于 <code>ClassVisitor.visit()</code> 方法实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visit</span><span class="params">(<span class="type">int</span> version, <span class="type">int</span> access, String name, String signature, String superName, String[] interfaces)</span></span><br></pre></td></tr></table></figure>

<p>这两个示例，就是通过修改 <code>visit()</code> 方法的参数实现的：</p>
<ul>
<li>修改类的版本信息，是通过修改 <code>version</code> 这个参数实现的</li>
<li>修改类的接口信息，是通过修改 <code>interfaces</code> 这个参数实现的</li>
</ul>
<p>其实，在 <code>visit()</code> 方法当中的其它参数也可以修改：</p>
<ul>
<li>修改 <code>access</code> 参数，也就是修改了类的访问标识信息。</li>
<li>修改 <code>name</code> 参数，也就是修改了类的名称。但是，在大多数的情况下，不推荐修改 <code>name</code> 参数。因为调用类里的方法，都是先找到类，再找到相应的方法；如果将当前类的类名修改成别的名称，那么其它类当中可能就找不到原来的方法了，因为类名已经改了。但是，也有少数的情况，可以修改 <code>name</code> 参数，比如说对代码进行混淆（obfuscate）操作。</li>
<li>修改 <code>superName</code> 参数，也就是修改了当前类的父类信息。</li>
</ul>
<h3 id="示例三：删除字段"><a href="#示例三：删除字段" class="headerlink" title="示例三：删除字段"></a>示例三：删除字段</h3><p>删除掉 HelloWorld 类里的 String strValue 字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> intValue;</span><br><span class="line">    <span class="keyword">public</span> String strValue; <span class="comment">// 删除这个字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.FieldVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassRemoveFieldVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fieldName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fieldDesc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ClassRemoveFieldVisitor</span><span class="params">(<span class="type">int</span> api, ClassVisitor classVisitor, String fieldName, String fieldDesc)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, classVisitor);</span><br><span class="line">        <span class="built_in">this</span>.fieldName = fieldName;</span><br><span class="line">        <span class="built_in">this</span>.fieldDesc = fieldDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(fieldName)&amp;&amp;descriptor.equals(fieldDesc))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.visitField(access, name, descriptor, signature, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这段代码中，<code>ClassRemoveFieldVisitor</code> 通过继承 <code>ClassVisitor</code> 类来实现删除特定字段的功能。关键在于 <code>visitField()</code> 方法。当 <code>visitField()</code> 返回 <code>null</code> 时，该字段就会被“过滤”掉，相当于从字节码中删除。</p>
<p>我们可以用邮递系统来比喻这个过程。<code>ClassReader</code> 就像邮件的发送者，<code>ClassVisitor</code> 是邮件经过的中间站，而 <code>ClassWriter</code> 是最终的收件人。如果在某个中间站 <code>ClassVisitor</code> 拦截并丢弃了某封邮件（字段），那么这封邮件就不会到达收件人。</p>
<p>同样，也可以用流水线来形容。<code>ClassReader</code> 是生产线上最初的步骤，<code>ClassVisitor</code> 是中间的处理环节，而 <code>ClassWriter</code> 是最终的成品阶段。如果某一个处理环节（<code>ClassVisitor</code>）中某个零件（字段）被移除了，那么最终产品中就不会包含这个零件。</p>
<p>通过这种方法，在字节码处理中实现了对特定字段的删除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ASM9;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 定义相对路径</span></span><br><span class="line">        String relative_path=<span class="string">&quot;Study/ClassReader/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="comment">// 获取文件路径</span></span><br><span class="line">        String filepath= FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取文件字节码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassReader对象</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassWriter对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassRemoveFieldVisitor</span> <span class="variable">classRemoveFieldVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassRemoveFieldVisitor</span>(ASM9, classWriter,<span class="string">&quot;strValue&quot;</span>,<span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG| ClassReader.SKIP_FRAMES;</span><br><span class="line">        classReader.accept(classRemoveFieldVisitor,parsingOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将修改后的字节码写入文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath,classWriter.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldRun</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;Study.ClassReader.HelloWorld&quot;</span>);</span><br><span class="line">        System.out.println(clazz.getName());</span><br><span class="line"></span><br><span class="line">        Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field f : declaredFields) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    &quot;</span> + f.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例四：添加字段"><a href="#示例四：添加字段" class="headerlink" title="示例四：添加字段"></a>示例四：添加字段</h3><p>为了 <code>HelloWorld</code> 类添加一个 <code>Object objValue</code> 字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> intValue;</span><br><span class="line">    <span class="keyword">public</span> String strValue;</span><br><span class="line">    <span class="comment">// 添加一个 Object objValue 字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编码方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.FieldVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassAddFieldVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> fieldAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fieldName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String fieldDesc;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isFieldPresent;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ClassAddFieldVisitor</span><span class="params">(<span class="type">int</span> api, ClassVisitor classVisitor,<span class="type">int</span> fieldAccess, String fieldName, String fieldDesc)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, classVisitor);</span><br><span class="line">        <span class="built_in">this</span>.fieldAccess = fieldAccess;</span><br><span class="line">        <span class="built_in">this</span>.fieldName = fieldName;</span><br><span class="line">        <span class="built_in">this</span>.fieldDesc = fieldDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(fieldName))&#123;</span><br><span class="line">            isFieldPresent = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitField(access, name, descriptor, signature, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isFieldPresent)&#123;</span><br><span class="line">            <span class="type">FieldVisitor</span> <span class="variable">fieldVisitor</span> <span class="operator">=</span> <span class="built_in">super</span>.visitField(fieldAccess,fieldName,fieldDesc,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span>(fieldVisitor != <span class="literal">null</span>)&#123;</span><br><span class="line">                fieldVisitor.visitEnd();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="built_in">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第一步，在 <code>visitField()</code> 方法中，判断某个字段是否已经存在，其结果存在于 <code>isFieldPresent</code> 字段当中；第二步，就是在 <code>visitEnd()</code> 方法中，根据 <code>isFieldPresent</code> 字段的值，来决定是否添加新的字段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ACC_PUBLIC;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ASM9;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 定义相对路径</span></span><br><span class="line">        String relative_path=<span class="string">&quot;Study/ClassReader/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="comment">// 获取文件路径</span></span><br><span class="line">        String filepath= FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取文件字节码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassReader对象</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassWriter对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassAddFieldVisitor</span> <span class="variable">classAddFieldVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassAddFieldVisitor</span>(ASM9, classWriter, ACC_PUBLIC, <span class="string">&quot;objValue&quot;</span>, <span class="string">&quot;Ljava/lang/Object;&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG| ClassReader.SKIP_FRAMES;</span><br><span class="line">        classReader.accept(classAddFieldVisitor,parsingOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将修改后的字节码写入文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath,classWriter.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>验证与实例三相同。</p>
<h3 id="总结二"><a href="#总结二" class="headerlink" title="总结二"></a>总结二</h3><p>在字节码处理中，<code>ClassVisitor.visitField()</code> 方法用于字段操作，主要包括以下几种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> FieldVisitor <span class="title function_">visitField</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, Object value)</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>修改字段</strong>：</p>
<ul>
<li>可以改变字段名称、类型或访问权限。</li>
<li>需要通过调整 <code>visitField()</code> 方法中的参数来实现。</li>
<li>通常不建议修改，因为这可能导致引用不匹配，从而导致程序错误。例如，如果某个类中的字段名被修改，其他引用该字段的代码也必须同步更新，否则会报错。</li>
</ul>
</li>
<li><p><strong>删除字段</strong>：</p>
<ul>
<li>在 <code>visitField()</code> 中返回 <code>null</code> 可以实现删除。</li>
<li>通常不建议删除已有字段，因为字段通常有其特定用途，删除可能导致缺失功能或程序错误。</li>
</ul>
</li>
<li><p><strong>添加字段</strong>：</p>
<ul>
<li>判断字段是否已存在，如果不存在，则在 <code>visitEnd()</code> 中添加。</li>
<li>不建议在 <code>visitField()</code> 中添加，以避免重复添加导致类文件不合法。</li>
</ul>
</li>
</ol>
<p>以上操作在字节码操作中需要谨慎，以保证程序的正确性和稳定性。</p>
<h3 id="示例五：删除方法"><a href="#示例五：删除方法" class="headerlink" title="示例五：删除方法"></a>示例五：删除方法</h3><p>删除掉 <code>HelloWorld</code> 类里的 <code>add()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123; <span class="comment">// 删除 add 方法</span></span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a - b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassRemoveMethodVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodDesc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ClassRemoveMethodVisitor</span><span class="params">(<span class="type">int</span> api, ClassVisitor classVisitor,String methodName,String methodDesc)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, classVisitor);</span><br><span class="line">        <span class="built_in">this</span>.methodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.methodDesc = methodDesc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(name.equals(methodName) &amp;&amp; descriptor.equals(methodDesc))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和之前删除字段差不多</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ACC_PUBLIC;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ASM9;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 定义相对路径</span></span><br><span class="line">        String relative_path=<span class="string">&quot;Study/ClassReader/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="comment">// 获取文件路径</span></span><br><span class="line">        String filepath= FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取文件字节码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassReader对象</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassWriter对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassRemoveMethodVisitor</span> <span class="variable">classRemoveMethodVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassRemoveMethodVisitor</span>(ASM9, classWriter, <span class="string">&quot;add&quot;</span>,<span class="string">&quot;(II)I&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG| ClassReader.SKIP_FRAMES;</span><br><span class="line">        classReader.accept(classRemoveMethodVisitor,parsingOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将修改后的字节码写入文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath,classWriter.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldRun</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;Study.ClassReader.HelloWorld&quot;</span>);</span><br><span class="line">        System.out.println(clazz.getName());</span><br><span class="line"></span><br><span class="line">        Method[] declaredMethods = clazz.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m : declaredMethods) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    &quot;</span> + m.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例六：添加方法"><a href="#示例六：添加方法" class="headerlink" title="示例六：添加方法"></a>示例六：添加方法</h3><p>为 <code>HelloWorld</code> 类添加一个 <code>mul()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a - b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 添加一个乘法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ClassAddMethodVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> methodAccess;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodDesc;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodSignature;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] methodExceptions;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> isMethodPresent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">ClassAddMethodVisitor</span><span class="params">(<span class="type">int</span> api, ClassVisitor classVisitor, <span class="type">int</span> methodAccess, String methodName, String methodDesc,</span></span><br><span class="line"><span class="params">                                    String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, classVisitor);</span><br><span class="line">        <span class="built_in">this</span>.methodAccess = methodAccess;</span><br><span class="line">        <span class="built_in">this</span>.methodName = methodName;</span><br><span class="line">        <span class="built_in">this</span>.methodDesc = methodDesc;</span><br><span class="line">        <span class="built_in">this</span>.methodSignature = signature;</span><br><span class="line">        <span class="built_in">this</span>.methodExceptions = exceptions;</span><br><span class="line">        <span class="built_in">this</span>.isMethodPresent = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name.equals(methodName) &amp;&amp; descriptor.equals(methodDesc)) &#123;</span><br><span class="line">            isMethodPresent = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">visitEnd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!isMethodPresent) &#123;</span><br><span class="line">            <span class="type">MethodVisitor</span> <span class="variable">methodVisitor</span> <span class="operator">=</span> <span class="built_in">super</span>.visitMethod(methodAccess, methodName, methodDesc, methodSignature, methodExceptions);</span><br><span class="line">            <span class="keyword">if</span>(methodVisitor!=<span class="literal">null</span>)&#123;</span><br><span class="line">                generateMethodBody(methodVisitor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">generateMethodBody</span><span class="params">(MethodVisitor methodVisitor)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加新的方法，和添加新的字段的思路，在前期，两者是一样的，都是先要判断该字段或该方法是否已经存在；但是，在后期，两者会有一些差异，因为方法需要有“方法体”，在上面的代码中，我们定义了一个 <code>generateMethodBody()</code> 方法，这个方法需要在子类当中进行实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.ClassReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 定义相对路径</span></span><br><span class="line">        String relative_path=<span class="string">&quot;Study/ClassReader/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="comment">// 获取文件路径</span></span><br><span class="line">        String filepath= FileUtils.getFilePath(relative_path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取文件字节码</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassReader对象</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">classReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建ClassWriter对象</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">classWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_MAXS);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassAddMethodVisitor</span> <span class="variable">classAddMethodVisitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassAddMethodVisitor</span>(</span><br><span class="line">                ASM9,classWriter,ACC_PUBLIC,<span class="string">&quot;multiply&quot;</span>,<span class="string">&quot;(II)I&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">generateMethodBody</span><span class="params">(MethodVisitor methodVisitor)</span> &#123;</span><br><span class="line">                methodVisitor.visitCode();</span><br><span class="line">                methodVisitor.visitVarInsn(ILOAD,<span class="number">1</span>);</span><br><span class="line">                methodVisitor.visitVarInsn(ILOAD,<span class="number">2</span>);</span><br><span class="line">                methodVisitor.visitInsn(IMUL);</span><br><span class="line">                methodVisitor.visitInsn(IRETURN);</span><br><span class="line">                methodVisitor.visitMaxs(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">                methodVisitor.visitEnd();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG| ClassReader.SKIP_FRAMES;</span><br><span class="line">        classReader.accept(classAddMethodVisitor,parsingOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将修改后的字节码写入文件</span></span><br><span class="line">        FileUtils.writeBytes(filepath,classWriter.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于方法的操作，都是基于 <code>ClassVisitor.visitMethod()</code> 方法来实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>修改方法</strong>：</p>
<ul>
<li>可以更新方法体，即具体实现的代码。</li>
<li>不建议修改方法名称或类型（参数和返回值类型），因为这可能导致调用不匹配，从而引发错误。</li>
</ul>
</li>
<li><p><strong>删除方法</strong>：</p>
<ul>
<li>通常不建议删除已有方法，因这可能导致调用失败，进而引发程序错误。</li>
</ul>
</li>
<li><p><strong>添加方法</strong>：</p>
<ul>
<li>可以在适当的位置新增方法。</li>
</ul>
</li>
</ol>
<p>在操作方法时需谨慎，以维护程序的正确性和稳定性。</p>
<h2 id="AdviceAdapter-类"><a href="#AdviceAdapter-类" class="headerlink" title="AdviceAdapter 类"></a>AdviceAdapter 类</h2><p>对于 <code>AdviceAdapter</code> 类，可以方便地实现在“方法进入”和“方法退出”时插入自定义代码。 </p>
<p><code>AdviceAdapter</code> 类的核心特点是提供了 <code>onMethodEnter()</code> 和 <code>onMethodExit()</code> 方法，这两个方法可以被重写，以便在方法执行之前和之后执行特定的逻辑。</p>
<h3 id="class-info-7"><a href="#class-info-7" class="headerlink" title="class info"></a>class info</h3><p><code>AdviceAdapter</code> 类是一个抽象的 <code>MethodVisitor</code> 子类</p>
<p>具体而言，<code>AdviceAdapter</code> 继承自 <code>GeneratorAdapter</code>，而 <code>GeneratorAdapter</code> 又继承自 <code>LocalVariablesSorter</code>，最终 <code>LocalVariablesSorter</code> 继承自 <code>MethodVisitor</code>。</p>
<p>由于 <code>AdviceAdapter</code> 是一个抽象类，如果想要使用它，我们需要创建一个具体的子类来实现其功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AdviceAdapter</span> <span class="keyword">extends</span> <span class="title class_">GeneratorAdapter</span> <span class="keyword">implements</span> <span class="title class_">Opcodes</span> &#123;</span><br><span class="line">    <span class="comment">// 其他方法和实现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fields-7"><a href="#fields-7" class="headerlink" title="fields"></a>fields</h3><p><code>AdviceAdapter</code> 类定义的字段。其中， <code>isConstructor</code> 字段是判断当前方法是不是构造方法。如果当前方法是构造方法，在“方法进入”时添加代码，需要特殊处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AdviceAdapter</span> <span class="keyword">extends</span> <span class="title class_">GeneratorAdapter</span> <span class="keyword">implements</span> <span class="title class_">Opcodes</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> methodAccess;</span><br><span class="line">    <span class="keyword">protected</span> String methodDesc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> isConstructor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="constructors-7"><a href="#constructors-7" class="headerlink" title="constructors"></a>constructors</h3><p><code>AdviceAdapter</code> 类定义的构造方法。 <code>AdviceAdapter</code> 的构造方法是用 <code>protected</code> 修饰，因此这个构造方法只能在子类当中访问。 换句话说，在外界不能用 <code>new</code> 关键字来创建对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AdviceAdapter</span> <span class="keyword">extends</span> <span class="title class_">GeneratorAdapter</span> <span class="keyword">implements</span> <span class="title class_">Opcodes</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AdviceAdapter</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> api, <span class="keyword">final</span> MethodVisitor methodVisitor,</span></span><br><span class="line"><span class="params">                            <span class="keyword">final</span> <span class="type">int</span> access, <span class="keyword">final</span> String name, <span class="keyword">final</span> String descriptor)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, methodVisitor, access, name, descriptor);</span><br><span class="line">        methodAccess = access;</span><br><span class="line">        methodDesc = descriptor;</span><br><span class="line">        isConstructor = <span class="string">&quot;&lt;init&gt;&quot;</span>.equals(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="methods-6"><a href="#methods-6" class="headerlink" title="methods"></a>methods</h3><p><code>AdviceAdapter</code> 类定义了几个重要的方法，其中最关键的是 <code>onMethodEnter()</code> 和 <code>onMethodExit()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AdviceAdapter</span> <span class="keyword">extends</span> <span class="title class_">GeneratorAdapter</span> <span class="keyword">implements</span> <span class="title class_">Opcodes</span> &#123;</span><br><span class="line">    <span class="comment">// 在被访问的方法开始时生成“进入”建议。</span></span><br><span class="line">    <span class="comment">// 默认实现不执行任何操作。</span></span><br><span class="line">    <span class="comment">// 子类可以使用或修改所有局部变量，但不应改变栈的状态。</span></span><br><span class="line">    <span class="comment">// 此方法在方法开始时或构造函数调用父类构造函数后被调用。</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMethodEnter</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在被访问的方法结束时生成“退出”建议。</span></span><br><span class="line">    <span class="comment">// 默认实现不执行任何操作。</span></span><br><span class="line">    <span class="comment">// 子类可以使用或修改所有局部变量，但不应改变栈的状态。</span></span><br><span class="line">    <span class="comment">// 此方法在方法结束时被调用，返回和抛出指令之前。</span></span><br><span class="line">    <span class="comment">// 栈顶元素包含返回值或异常实例。</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMethodExit</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> opcode)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以从三个角度来理解这两个方法：</p>
<h4 id="1-应用场景"><a href="#1-应用场景" class="headerlink" title="1. 应用场景"></a>1. 应用场景</h4><ul>
<li><strong><code>onMethodEnter()</code></strong>：在方法执行开始时，可以插入一些逻辑代码，例如日志记录、性能监控等。</li>
<li><strong><code>onMethodExit()</code></strong>：在方法执行结束时，可以执行清理操作、获取返回结果或捕获异常等。</li>
</ul>
<h4 id="2-注意事项"><a href="#2-注意事项" class="headerlink" title="2. 注意事项"></a>2. 注意事项</h4><ul>
<li>对于 <code>onMethodEnter()</code> 和 <code>onMethodExit()</code>，都需要注意：<strong>子类可以修改所有局部变量，但不应改变栈的状态</strong>。换句话说，修改前后的操作数栈（operand stack）必须保持一致。</li>
<li>在 <code>onMethodExit()</code> 中，要注意<strong>栈顶元素包含返回值或异常实例</strong>，需要妥善处理，以确保这些信息不会丢失。</li>
</ul>
<h4 id="3-工作原理"><a href="#3-工作原理" class="headerlink" title="3. 工作原理"></a>3. 工作原理</h4><ul>
<li><strong><code>onMethodEnter()</code></strong>：通常通过 <code>visitCode()</code> 方法触发，使用 <code>onMethodEnter()</code> 的好处在于它能够处理 <code>&lt;init&gt;()</code> 方法的复杂情况，而直接使用 <code>visitCode()</code> 可能会导致 <code>&lt;init&gt;()</code> 方法的错误。</li>
<li><strong><code>onMethodExit()</code></strong>：通常通过 <code>visitInsn(int opcode)</code> 方法触发，用于在方法结束时执行相应的逻辑。</li>
</ul>
<h3 id="示例：打印方法参数和返回值"><a href="#示例：打印方法参数和返回值" class="headerlink" title="示例：打印方法参数和返回值"></a>示例：打印方法参数和返回值</h3><p>假如有一个 <code>HelloWorld</code> 类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloWorld</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> idCard, Object obj)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        hashCode += name.hashCode();</span><br><span class="line">        hashCode += age;</span><br><span class="line">        hashCode += (<span class="type">int</span>) (idCard % Integer.MAX_VALUE);</span><br><span class="line">        hashCode += obj.hashCode();</span><br><span class="line">        hashCode = Math.abs(hashCode);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hash Code is &quot;</span> + hashCode);</span><br><span class="line">        <span class="keyword">if</span> (hashCode % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;illegal&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们想实现的预期目标：打印出构造方法（<code>&lt;init&gt;()</code>）和 <code>test()</code> 的参数和返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParameterUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;SimpleDateFormat&gt; formatter = ThreadLocal.withInitial(</span><br><span class="line">            () -&gt; <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printValueOnStack</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    &quot;</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    &quot;</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    &quot;</span> + formatter.get().format(value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="type">char</span>[]) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    &quot;</span> + Arrays.toString((<span class="type">char</span>[])value));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;    &quot;</span> + value.getClass() + <span class="string">&quot;: &quot;</span> + value.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printText</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.AdviceAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Type;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.commons.AdviceAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ACC_ABSTRACT;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.objectweb.asm.Opcodes.ACC_NATIVE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassPrintParameterVisitor</span> <span class="keyword">extends</span> <span class="title class_">ClassVisitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ClassPrintParameterVisitor</span><span class="params">(<span class="type">int</span> api, ClassVisitor classVisitor)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(api, classVisitor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodVisitor <span class="title function_">visitMethod</span><span class="params">(<span class="type">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> &#123;</span><br><span class="line">        <span class="type">MethodVisitor</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="built_in">super</span>.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line">        <span class="keyword">if</span> (mv != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isAbstractMethod</span> <span class="operator">=</span> (access &amp; ACC_ABSTRACT) != <span class="number">0</span>;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isNativeMethod</span> <span class="operator">=</span> (access &amp; ACC_NATIVE) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!isAbstractMethod &amp;&amp; !isNativeMethod) &#123;</span><br><span class="line">                mv = <span class="keyword">new</span> <span class="title class_">MethodPrintParameterAdapter</span>(api, mv, access, name, descriptor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MethodPrintParameterAdapter</span> <span class="keyword">extends</span> <span class="title class_">AdviceAdapter</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MethodPrintParameterAdapter</span><span class="params">(<span class="type">int</span> api, MethodVisitor mv, <span class="type">int</span> access, String name, String descriptor)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(api, mv, access, name, descriptor);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMethodEnter</span><span class="params">()</span> &#123;</span><br><span class="line">            printMessage(<span class="string">&quot;Method Enter: &quot;</span> + getName() + methodDesc);</span><br><span class="line"></span><br><span class="line">            Type[] argumentTypes = getArgumentTypes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; argumentTypes.length; i++) &#123;</span><br><span class="line">                <span class="type">Type</span> <span class="variable">t</span> <span class="operator">=</span> argumentTypes[i];</span><br><span class="line">                loadArg(i);</span><br><span class="line">                box(t);</span><br><span class="line">                printValueOnStack(<span class="string">&quot;(Ljava/lang/Object;)V&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMethodExit</span><span class="params">(<span class="type">int</span> opcode)</span> &#123;</span><br><span class="line">            printMessage(<span class="string">&quot;Method Exit: &quot;</span> + getName() + methodDesc);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (opcode == ATHROW) &#123;</span><br><span class="line">                <span class="built_in">super</span>.visitLdcInsn(<span class="string">&quot;abnormal return&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (opcode == RETURN) &#123;</span><br><span class="line">                <span class="built_in">super</span>.visitLdcInsn(<span class="string">&quot;return void&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (opcode == ARETURN) &#123;</span><br><span class="line">                dup();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (opcode == LRETURN || opcode == DRETURN) &#123;</span><br><span class="line">                    dup2();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    dup();</span><br><span class="line">                &#125;</span><br><span class="line">                box(getReturnType());</span><br><span class="line">            &#125;</span><br><span class="line">            printValueOnStack(<span class="string">&quot;(Ljava/lang/Object;)V&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printMessage</span><span class="params">(String str)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.visitLdcInsn(str);</span><br><span class="line">            <span class="built_in">super</span>.visitMethodInsn(INVOKESTATIC, <span class="string">&quot;cmisl/utils/ParameterUtils&quot;</span>, <span class="string">&quot;printText&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printValueOnStack</span><span class="params">(String descriptor)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.visitMethodInsn(INVOKESTATIC, <span class="string">&quot;cmisl/utils/ParameterUtils&quot;</span>, <span class="string">&quot;printValueOnStack&quot;</span>, descriptor, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始在方法前后插入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Study.AdviceAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cmisl.utils.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorldTransformCore</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">relative_path</span> <span class="operator">=</span> <span class="string">&quot;Study/AdviceAdapter/HelloWorld.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filepath</span> <span class="operator">=</span> FileUtils.getFilePath(relative_path);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = FileUtils.readBytes(filepath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（1）构建 ClassReader</span></span><br><span class="line">        <span class="type">ClassReader</span> <span class="variable">cr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassReader</span>(bytes1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（2）构建 ClassWriter</span></span><br><span class="line">        <span class="type">ClassWriter</span> <span class="variable">cw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（3）串连 ClassVisitor</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">api</span> <span class="operator">=</span> Opcodes.ASM9;</span><br><span class="line">        <span class="type">ClassVisitor</span> <span class="variable">cv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPrintParameterVisitor</span>(api, cw);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（4）结合 ClassReader 和 ClassVisitor</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">parsingOptions</span> <span class="operator">=</span> ClassReader.SKIP_DEBUG | ClassReader.SKIP_FRAMES;</span><br><span class="line">        cr.accept(cv, parsingOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//（5）生成 byte[]</span></span><br><span class="line">        <span class="type">byte</span>[] bytes2 = cw.toByteArray();</span><br><span class="line"></span><br><span class="line">        FileUtils.writeBytes(filepath, bytes2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Java虚拟机指令表"><a href="#Java虚拟机指令表" class="headerlink" title="Java虚拟机指令表"></a>Java虚拟机指令表</h2><table>
<thead>
<tr>
<th>十六进制</th>
<th>助记符</th>
<th>指令说明</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>nop</td>
<td>什么都不做</td>
</tr>
<tr>
<td>0x01</td>
<td>aconst_null</td>
<td>将null推送至栈顶</td>
</tr>
<tr>
<td>0x02</td>
<td>iconst_m1</td>
<td>将int型-1推送至栈顶</td>
</tr>
<tr>
<td>0x03</td>
<td>iconst_0</td>
<td>将int型0推送至栈顶</td>
</tr>
<tr>
<td>0x04</td>
<td>iconst_1</td>
<td>将int型1推送至栈顶</td>
</tr>
<tr>
<td>0x05</td>
<td>iconst_2</td>
<td>将int型2推送至栈顶</td>
</tr>
<tr>
<td>0x06</td>
<td>iconst_3</td>
<td>将int型3推送至栈顶</td>
</tr>
<tr>
<td>0x07</td>
<td>iconst_4</td>
<td>将int型4推送至栈顶</td>
</tr>
<tr>
<td>0x08</td>
<td>iconst_5</td>
<td>将int型5推送至栈顶</td>
</tr>
<tr>
<td>0x09</td>
<td>lconst_0</td>
<td>将long型0推送至栈顶</td>
</tr>
<tr>
<td>0x0a</td>
<td>lconst_1</td>
<td>将long型1推送至栈顶</td>
</tr>
<tr>
<td>0x0b</td>
<td>fconst_0</td>
<td>将float型0推送至栈顶</td>
</tr>
<tr>
<td>0x0c</td>
<td>fconst_1</td>
<td>将float型1推送至栈顶</td>
</tr>
<tr>
<td>0x0d</td>
<td>fconst_2</td>
<td>将float型2推送至栈顶</td>
</tr>
<tr>
<td>0x0e</td>
<td>dconst_0</td>
<td>将double型0推送至栈顶</td>
</tr>
<tr>
<td>0x0f</td>
<td>dconst_1</td>
<td>将double型1推送至栈顶</td>
</tr>
<tr>
<td>0x10</td>
<td>bipush</td>
<td>将单字节的常量值(-128~127)推送至栈顶</td>
</tr>
<tr>
<td>0x11</td>
<td>sipush</td>
<td>将一个短整型常量值(-32768~32767)推送至栈顶</td>
</tr>
<tr>
<td>0x12</td>
<td>ldc</td>
<td>将int, float或String型常量值从常量池中推送至栈顶</td>
</tr>
<tr>
<td>0x13</td>
<td>ldc_w</td>
<td>将int, float或String型常量值从常量池中推送至栈顶（宽索引）</td>
</tr>
<tr>
<td>0x14</td>
<td>ldc2_w</td>
<td>将long或double型常量值从常量池中推送至栈顶（宽索引）</td>
</tr>
<tr>
<td>0x15</td>
<td>iload</td>
<td>将指定的int型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x16</td>
<td>lload</td>
<td>将指定的long型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x17</td>
<td>fload</td>
<td>将指定的float型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x18</td>
<td>dload</td>
<td>将指定的double型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x19</td>
<td>aload</td>
<td>将指定的引用类型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x1a</td>
<td>iload_0</td>
<td>将第一个int型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x1b</td>
<td>iload_1</td>
<td>将第二个int型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x1c</td>
<td>iload_2</td>
<td>将第三个int型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x1d</td>
<td>iload_3</td>
<td>将第四个int型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x1e</td>
<td>lload_0</td>
<td>将第一个long型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x1f</td>
<td>lload_1</td>
<td>将第二个long型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x20</td>
<td>lload_2</td>
<td>将第三个long型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x21</td>
<td>lload_3</td>
<td>将第四个long型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x22</td>
<td>fload_0</td>
<td>将第一个float型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x23</td>
<td>fload_1</td>
<td>将第二个float型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x24</td>
<td>fload_2</td>
<td>将第三个float型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x25</td>
<td>fload_3</td>
<td>将第四个float型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x26</td>
<td>dload_0</td>
<td>将第一个double型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x27</td>
<td>dload_1</td>
<td>将第二个double型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x28</td>
<td>dload_2</td>
<td>将第三个double型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x29</td>
<td>dload_3</td>
<td>将第四个double型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x2a</td>
<td>aload_0</td>
<td>将第一个引用类型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x2b</td>
<td>aload_1</td>
<td>将第二个引用类型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x2c</td>
<td>aload_2</td>
<td>将第三个引用类型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x2d</td>
<td>aload_3</td>
<td>将第四个引用类型本地变量推送至栈顶</td>
</tr>
<tr>
<td>0x2e</td>
<td>iaload</td>
<td>将int型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x2f</td>
<td>laload</td>
<td>将long型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x30</td>
<td>faload</td>
<td>将float型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x31</td>
<td>daload</td>
<td>将double型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x32</td>
<td>aaload</td>
<td>将引用型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x33</td>
<td>baload</td>
<td>将boolean或byte型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x34</td>
<td>caload</td>
<td>将char型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x35</td>
<td>saload</td>
<td>将short型数组指定索引的值推送至栈顶</td>
</tr>
<tr>
<td>0x36</td>
<td>istore</td>
<td>将栈顶int型数值存入指定本地变量</td>
</tr>
<tr>
<td>0x37</td>
<td>lstore</td>
<td>将栈顶long型数值存入指定本地变量</td>
</tr>
<tr>
<td>0x38</td>
<td>fstore</td>
<td>将栈顶float型数值存入指定本地变量</td>
</tr>
<tr>
<td>0x39</td>
<td>dstore</td>
<td>将栈顶double型数值存入指定本地变量</td>
</tr>
<tr>
<td>0x3a</td>
<td>astore</td>
<td>将栈顶引用型数值存入指定本地变量</td>
</tr>
<tr>
<td>0x3b</td>
<td>istore_0</td>
<td>将栈顶int型数值存入第一个本地变量</td>
</tr>
<tr>
<td>0x3c</td>
<td>istore_1</td>
<td>将栈顶int型数值存入第二个本地变量</td>
</tr>
<tr>
<td>0x3d</td>
<td>istore_2</td>
<td>将栈顶int型数值存入第三个本地变量</td>
</tr>
<tr>
<td>0x3e</td>
<td>istore_3</td>
<td>将栈顶int型数值存入第四个本地变量</td>
</tr>
<tr>
<td>0x3f</td>
<td>lstore_0</td>
<td>将栈顶long型数值存入第一个本地变量</td>
</tr>
<tr>
<td>0x40</td>
<td>lstore_1</td>
<td>将栈顶long型数值存入第二个本地变量</td>
</tr>
<tr>
<td>0x41</td>
<td>lstore_2</td>
<td>将栈顶long型数值存入第三个本地变量</td>
</tr>
<tr>
<td>0x42</td>
<td>lstore_3</td>
<td>将栈顶long型数值存入第四个本地变量</td>
</tr>
<tr>
<td>0x43</td>
<td>fstore_0</td>
<td>将栈顶float型数值存入第一个本地变量</td>
</tr>
<tr>
<td>0x44</td>
<td>fstore_1</td>
<td>将栈顶float型数值存入第二个本地变量</td>
</tr>
<tr>
<td>0x45</td>
<td>fstore_2</td>
<td>将栈顶float型数值存入第三个本地变量</td>
</tr>
<tr>
<td>0x46</td>
<td>fstore_3</td>
<td>将栈顶float型数值存入第四个本地变量</td>
</tr>
<tr>
<td>0x47</td>
<td>dstore_0</td>
<td>将栈顶double型数值存入第一个本地变量</td>
</tr>
<tr>
<td>0x48</td>
<td>dstore_1</td>
<td>将栈顶double型数值存入第二个本地变量</td>
</tr>
<tr>
<td>0x49</td>
<td>dstore_2</td>
<td>将栈顶double型数值存入第三个本地变量</td>
</tr>
<tr>
<td>0x4a</td>
<td>dstore_3</td>
<td>将栈顶double型数值存入第四个本地变量</td>
</tr>
<tr>
<td>0x4b</td>
<td>astore_0</td>
<td>将栈顶引用型数值存入第一个本地变量</td>
</tr>
<tr>
<td>0x4c</td>
<td>astore_1</td>
<td>将栈顶引用型数值存入第二个本地变量</td>
</tr>
<tr>
<td>0x4d</td>
<td>astore_2</td>
<td>将栈顶引用型数值存入第三个本地变量</td>
</tr>
<tr>
<td>0x4e</td>
<td>astore_3</td>
<td>将栈顶引用型数值存入第四个本地变量</td>
</tr>
<tr>
<td>0x4f</td>
<td>iastore</td>
<td>将栈顶int型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x50</td>
<td>lastore</td>
<td>将栈顶long型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x51</td>
<td>fastore</td>
<td>将栈顶float型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x52</td>
<td>dastore</td>
<td>将栈顶double型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x53</td>
<td>aastore</td>
<td>将栈顶引用型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x54</td>
<td>bastore</td>
<td>将栈顶boolean或byte型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x55</td>
<td>castore</td>
<td>将栈顶char型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x56</td>
<td>sastore</td>
<td>将栈顶short型数值存入指定数组的指定索引位置</td>
</tr>
<tr>
<td>0x57</td>
<td>pop</td>
<td>将栈顶数值弹出 (数值不能是long或double类型的)</td>
</tr>
<tr>
<td>0x58</td>
<td>pop2</td>
<td>将栈顶的一个（long或double类型的)或两个数值弹出（其它）</td>
</tr>
<tr>
<td>0x59</td>
<td>dup</td>
<td>复制栈顶数值并将复制值压入栈顶</td>
</tr>
<tr>
<td>0x5a</td>
<td>dup_x1</td>
<td>复制栈顶数值并将两个复制值压入栈顶</td>
</tr>
<tr>
<td>0x5b</td>
<td>dup_x2</td>
<td>复制栈顶数值并将三个（或两个）复制值压入栈顶</td>
</tr>
<tr>
<td>0x5c</td>
<td>dup2</td>
<td>复制栈顶一个（long或double类型的)或两个（其它）数值并将复制值压入栈顶</td>
</tr>
<tr>
<td>0x5d</td>
<td>dup2_x1</td>
<td>&lt;待补充&gt;</td>
</tr>
<tr>
<td>0x5e</td>
<td>dup2_x2</td>
<td>&lt;待补充&gt;</td>
</tr>
<tr>
<td>0x5f</td>
<td>swap</td>
<td>将栈最顶端的两个数值互换(数值不能是long或double类型的)</td>
</tr>
<tr>
<td>0x60</td>
<td>iadd</td>
<td>将栈顶两int型数值相加并将结果压入栈顶</td>
</tr>
<tr>
<td>0x61</td>
<td>ladd</td>
<td>将栈顶两long型数值相加并将结果压入栈顶</td>
</tr>
<tr>
<td>0x62</td>
<td>fadd</td>
<td>将栈顶两float型数值相加并将结果压入栈顶</td>
</tr>
<tr>
<td>0x63</td>
<td>dadd</td>
<td>将栈顶两double型数值相加并将结果压入栈顶</td>
</tr>
<tr>
<td>0x64</td>
<td>isub</td>
<td>将栈顶两int型数值相减并将结果压入栈顶</td>
</tr>
<tr>
<td>0x65</td>
<td>lsub</td>
<td>将栈顶两long型数值相减并将结果压入栈顶</td>
</tr>
<tr>
<td>0x66</td>
<td>fsub</td>
<td>将栈顶两float型数值相减并将结果压入栈顶</td>
</tr>
<tr>
<td>0x67</td>
<td>dsub</td>
<td>将栈顶两double型数值相减并将结果压入栈顶</td>
</tr>
<tr>
<td>0x68</td>
<td>imul</td>
<td>将栈顶两int型数值相乘并将结果压入栈顶</td>
</tr>
<tr>
<td>0x69</td>
<td>lmul</td>
<td>将栈顶两long型数值相乘并将结果压入栈顶</td>
</tr>
<tr>
<td>0x6a</td>
<td>fmul</td>
<td>将栈顶两float型数值相乘并将结果压入栈顶</td>
</tr>
<tr>
<td>0x6b</td>
<td>dmul</td>
<td>将栈顶两double型数值相乘并将结果压入栈顶</td>
</tr>
<tr>
<td>0x6c</td>
<td>idiv</td>
<td>将栈顶两int型数值相除并将结果压入栈顶</td>
</tr>
<tr>
<td>0x6d</td>
<td>ldiv</td>
<td>将栈顶两long型数值相除并将结果压入栈顶</td>
</tr>
<tr>
<td>0x6e</td>
<td>fdiv</td>
<td>将栈顶两float型数值相除并将结果压入栈顶</td>
</tr>
<tr>
<td>0x6f</td>
<td>ddiv</td>
<td>将栈顶两double型数值相除并将结果压入栈顶</td>
</tr>
<tr>
<td>0x70</td>
<td>irem</td>
<td>将栈顶两int型数值作取模运算并将结果压入栈顶</td>
</tr>
<tr>
<td>0x71</td>
<td>lrem</td>
<td>将栈顶两long型数值作取模运算并将结果压入栈顶</td>
</tr>
<tr>
<td>0x72</td>
<td>frem</td>
<td>将栈顶两float型数值作取模运算并将结果压入栈顶</td>
</tr>
<tr>
<td>0x73</td>
<td>drem</td>
<td>将栈顶两double型数值作取模运算并将结果压入栈顶</td>
</tr>
<tr>
<td>0x74</td>
<td>ineg</td>
<td>将栈顶int型数值取负并将结果压入栈顶</td>
</tr>
<tr>
<td>0x75</td>
<td>lneg</td>
<td>将栈顶long型数值取负并将结果压入栈顶</td>
</tr>
<tr>
<td>0x76</td>
<td>fneg</td>
<td>将栈顶float型数值取负并将结果压入栈顶</td>
</tr>
<tr>
<td>0x77</td>
<td>dneg</td>
<td>将栈顶double型数值取负并将结果压入栈顶</td>
</tr>
<tr>
<td>0x78</td>
<td>ishl</td>
<td>将int型数值左移位指定位数并将结果压入栈顶</td>
</tr>
<tr>
<td>0x79</td>
<td>lshl</td>
<td>将long型数值左移位指定位数并将结果压入栈顶</td>
</tr>
<tr>
<td>0x7a</td>
<td>ishr</td>
<td>将int型数值右（符号）移位指定位数并将结果压入栈顶</td>
</tr>
<tr>
<td>0x7b</td>
<td>lshr</td>
<td>将long型数值右（符号）移位指定位数并将结果压入栈顶</td>
</tr>
<tr>
<td>0x7c</td>
<td>iushr</td>
<td>将int型数值右（无符号）移位指定位数并将结果压入栈顶</td>
</tr>
<tr>
<td>0x7d</td>
<td>lushr</td>
<td>将long型数值右（无符号）移位指定位数并将结果压入栈顶</td>
</tr>
<tr>
<td>0x7e</td>
<td>iand</td>
<td>将栈顶两int型数值作“按位与”并将结果压入栈顶</td>
</tr>
<tr>
<td>0x7f</td>
<td>land</td>
<td>将栈顶两long型数值作“按位与”并将结果压入栈顶</td>
</tr>
<tr>
<td>0x80</td>
<td>ior</td>
<td>将栈顶两int型数值作“按位或”并将结果压入栈顶</td>
</tr>
<tr>
<td>0x81</td>
<td>lor</td>
<td>将栈顶两long型数值作“按位或”并将结果压入栈顶</td>
</tr>
<tr>
<td>0x82</td>
<td>ixor</td>
<td>将栈顶两int型数值作“按位异或”并将结果压入栈顶</td>
</tr>
<tr>
<td>0x83</td>
<td>lxor</td>
<td>将栈顶两long型数值作“按位异或”并将结果压入栈顶</td>
</tr>
<tr>
<td>0x84</td>
<td>iinc</td>
<td>将指定int型变量增加指定值（i++, i–, i+&#x3D;2）</td>
</tr>
<tr>
<td>0x85</td>
<td>i2l</td>
<td>将栈顶int型数值强制转换成long型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x86</td>
<td>i2f</td>
<td>将栈顶int型数值强制转换成float型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x87</td>
<td>i2d</td>
<td>将栈顶int型数值强制转换成double型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x88</td>
<td>l2i</td>
<td>将栈顶long型数值强制转换成int型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x89</td>
<td>l2f</td>
<td>将栈顶long型数值强制转换成float型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x8a</td>
<td>l2d</td>
<td>将栈顶long型数值强制转换成double型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x8b</td>
<td>f2i</td>
<td>将栈顶float型数值强制转换成int型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x8c</td>
<td>f2l</td>
<td>将栈顶float型数值强制转换成long型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x8d</td>
<td>f2d</td>
<td>将栈顶float型数值强制转换成double型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x8e</td>
<td>d2i</td>
<td>将栈顶double型数值强制转换成int型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x8f</td>
<td>d2l</td>
<td>将栈顶double型数值强制转换成long型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x90</td>
<td>d2f</td>
<td>将栈顶double型数值强制转换成float型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x91</td>
<td>i2b</td>
<td>将栈顶int型数值强制转换成byte型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x92</td>
<td>i2c</td>
<td>将栈顶int型数值强制转换成char型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x93</td>
<td>i2s</td>
<td>将栈顶int型数值强制转换成short型数值并将结果压入栈顶</td>
</tr>
<tr>
<td>0x94</td>
<td>lcmp</td>
<td>比较栈顶两long型数值大小，并将结果（1，0，-1）压入栈顶</td>
</tr>
<tr>
<td>0x95</td>
<td>fcmpl</td>
<td>比较栈顶两float型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将-1压入栈顶</td>
</tr>
<tr>
<td>0x96</td>
<td>fcmpg</td>
<td>比较栈顶两float型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将1压入栈顶</td>
</tr>
<tr>
<td>0x97</td>
<td>dcmpl</td>
<td>比较栈顶两double型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将-1压入栈顶</td>
</tr>
<tr>
<td>0x98</td>
<td>dcmpg</td>
<td>比较栈顶两double型数值大小，并将结果（1，0，-1）压入栈顶；当其中一个数值为NaN时，将1压入栈顶</td>
</tr>
<tr>
<td>0x99</td>
<td>ifeq</td>
<td>当栈顶int型数值等于0时跳转</td>
</tr>
<tr>
<td>0x9a</td>
<td>ifne</td>
<td>当栈顶int型数值不等于0时跳转</td>
</tr>
<tr>
<td>0x9b</td>
<td>iflt</td>
<td>当栈顶int型数值小于0时跳转</td>
</tr>
<tr>
<td>0x9c</td>
<td>ifge</td>
<td>当栈顶int型数值大于等于0时跳转</td>
</tr>
<tr>
<td>0x9d</td>
<td>ifgt</td>
<td>当栈顶int型数值大于0时跳转</td>
</tr>
<tr>
<td>0x9e</td>
<td>ifle</td>
<td>当栈顶int型数值小于等于0时跳转</td>
</tr>
<tr>
<td>0x9f</td>
<td>if_icmpeq</td>
<td>比较栈顶两int型数值大小，当结果等于0时跳转</td>
</tr>
<tr>
<td>0xa0</td>
<td>if_icmpne</td>
<td>比较栈顶两int型数值大小，当结果不等于0时跳转</td>
</tr>
<tr>
<td>0xa1</td>
<td>if_icmplt</td>
<td>比较栈顶两int型数值大小，当结果小于0时跳转</td>
</tr>
<tr>
<td>0xa2</td>
<td>if_icmpge</td>
<td>比较栈顶两int型数值大小，当结果大于等于0时跳转</td>
</tr>
<tr>
<td>0xa3</td>
<td>if_icmpgt</td>
<td>比较栈顶两int型数值大小，当结果大于0时跳转</td>
</tr>
<tr>
<td>0xa4</td>
<td>if_icmple</td>
<td>比较栈顶两int型数值大小，当结果小于等于0时跳转</td>
</tr>
<tr>
<td>0xa5</td>
<td>if_acmpeq</td>
<td>比较栈顶两引用型数值，当结果相等时跳转</td>
</tr>
<tr>
<td>0xa6</td>
<td>if_acmpne</td>
<td>比较栈顶两引用型数值，当结果不相等时跳转</td>
</tr>
<tr>
<td>0xa7</td>
<td>goto</td>
<td>无条件跳转</td>
</tr>
<tr>
<td>0xa8</td>
<td>jsr</td>
<td>跳转至指定16位offset位置，并将jsr下一条指令地址压入栈顶</td>
</tr>
<tr>
<td>0xa9</td>
<td>ret</td>
<td>返回至本地变量指定的index的指令位置（一般与jsr, jsr_w联合使用）</td>
</tr>
<tr>
<td>0xaa</td>
<td>tableswitch</td>
<td>用于switch条件跳转，case值连续（可变长度指令）</td>
</tr>
<tr>
<td>0xab</td>
<td>lookupswitch</td>
<td>用于switch条件跳转，case值不连续（可变长度指令）</td>
</tr>
<tr>
<td>0xac</td>
<td>ireturn</td>
<td>从当前方法返回int</td>
</tr>
<tr>
<td>0xad</td>
<td>lreturn</td>
<td>从当前方法返回long</td>
</tr>
<tr>
<td>0xae</td>
<td>freturn</td>
<td>从当前方法返回float</td>
</tr>
<tr>
<td>0xaf</td>
<td>dreturn</td>
<td>从当前方法返回double</td>
</tr>
<tr>
<td>0xb0</td>
<td>areturn</td>
<td>从当前方法返回对象引用</td>
</tr>
<tr>
<td>0xb1</td>
<td>return</td>
<td>从当前方法返回void</td>
</tr>
<tr>
<td>0xb2</td>
<td>getstatic</td>
<td>获取指定类的静态域，并将其值压入栈顶</td>
</tr>
<tr>
<td>0xb3</td>
<td>putstatic</td>
<td>为指定的类的静态域赋值</td>
</tr>
<tr>
<td>0xb4</td>
<td>getfield</td>
<td>获取指定类的实例域，并将其值压入栈顶</td>
</tr>
<tr>
<td>0xb5</td>
<td>putfield</td>
<td>为指定的类的实例域赋值</td>
</tr>
<tr>
<td>0xb6</td>
<td>invokevirtual</td>
<td>调用实例方法</td>
</tr>
<tr>
<td>0xb7</td>
<td>invokespecial</td>
<td>调用超类构造方法，实例初始化方法，私有方法</td>
</tr>
<tr>
<td>0xb8</td>
<td>invokestatic</td>
<td>调用静态方法</td>
</tr>
<tr>
<td>0xb9</td>
<td>invokeinterface</td>
<td>调用接口方法</td>
</tr>
<tr>
<td>0xba</td>
<td>–</td>
<td></td>
</tr>
<tr>
<td>0xbb</td>
<td>new</td>
<td>创建一个对象，并将其引用值压入栈顶</td>
</tr>
<tr>
<td>0xbc</td>
<td>newarray</td>
<td>创建一个指定原始类型（如int, float, char…）的数组，并将其引用值压入栈顶</td>
</tr>
<tr>
<td>0xbd</td>
<td>anewarray</td>
<td>创建一个引用型（如类，接口，数组）的数组，并将其引用值压入栈顶</td>
</tr>
<tr>
<td>0xbe</td>
<td>arraylength</td>
<td>获得数组的长度值并压入栈顶</td>
</tr>
<tr>
<td>0xbf</td>
<td>athrow</td>
<td>将栈顶的异常抛出</td>
</tr>
<tr>
<td>0xc0</td>
<td>checkcast</td>
<td>检验类型转换，检验未通过将抛出ClassCastException</td>
</tr>
<tr>
<td>0xc1</td>
<td>instanceof</td>
<td>检验对象是否是指定的类的实例，如果是将1压入栈顶，否则将0压入栈顶</td>
</tr>
<tr>
<td>0xc2</td>
<td>monitorenter</td>
<td>获得对象的锁，用于同步方法或同步块</td>
</tr>
<tr>
<td>0xc3</td>
<td>monitorexit</td>
<td>释放对象的锁，用于同步方法或同步块</td>
</tr>
<tr>
<td>0xc4</td>
<td>wide</td>
<td>&lt;待补充&gt;</td>
</tr>
<tr>
<td>0xc5</td>
<td>multianewarray</td>
<td>创建指定类型和指定维度的多维数组（执行该指令时，操作栈中必须包含各维度的长度值），并将其引用值压入栈顶</td>
</tr>
<tr>
<td>0xc6</td>
<td>ifnull</td>
<td>为null时跳转</td>
</tr>
<tr>
<td>0xc7</td>
<td>ifnonnull</td>
<td>不为null时跳转</td>
</tr>
<tr>
<td>0xc8</td>
<td>goto_w</td>
<td>无条件跳转（宽索引）</td>
</tr>
<tr>
<td>0xc9</td>
<td>jsr_w</td>
<td>跳转至指定32位offset位置，并将jsr_w下一条指令地址压入栈顶</td>
</tr>
</tbody></table>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ASM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">ASM学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ASM-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">ASM 是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ASM-%E8%83%BD%E5%A4%9F%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.2.</span> <span class="toc-text">ASM 能够做什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#class-%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">.class 文件的结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#field-info-%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">field_info 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#method-info-%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.2.</span> <span class="toc-text">method_info 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-%E5%B1%9E%E6%80%A7%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.3.</span> <span class="toc-text">Code 属性结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ASMPrint-%E7%B1%BB"><span class="toc-number">1.4.</span> <span class="toc-text">ASMPrint 类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassVisitor-%E7%B1%BB"><span class="toc-number">1.5.</span> <span class="toc-text">ClassVisitor 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info"><span class="toc-number">1.5.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields"><span class="toc-number">1.5.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors"><span class="toc-number">1.5.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods"><span class="toc-number">1.5.4.</span> <span class="toc-text">methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.5.5.</span> <span class="toc-text">方法的调用顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visit-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.6.</span> <span class="toc-text">visit() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visitField-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.7.</span> <span class="toc-text">visitField() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visitMethod-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.8.</span> <span class="toc-text">visitMethod() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#visitEnd-%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.9.</span> <span class="toc-text">visitEnd() 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassWriter-%E7%B1%BB"><span class="toc-number">1.6.</span> <span class="toc-text">ClassWriter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-1"><span class="toc-number">1.6.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-1"><span class="toc-number">1.6.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-1"><span class="toc-number">1.6.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#COMPUTE-MAXS"><span class="toc-number">1.6.4.</span> <span class="toc-text">COMPUTE_MAXS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#COMPUTE-FRAMES"><span class="toc-number">1.6.5.</span> <span class="toc-text">COMPUTE_FRAMES</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-ClassWriter-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.6.6.</span> <span class="toc-text">创建 ClassWriter 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ClassWriter-%E7%B1%BB"><span class="toc-number">1.6.7.</span> <span class="toc-text">使用 ClassWriter 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.6.8.</span> <span class="toc-text">示例一：生成接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.8.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3-%E5%AD%97%E6%AE%B5-%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.9.</span> <span class="toc-text">示例二：生成接口 + 字段 + 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">1.6.9.1.</span> <span class="toc-text">编码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#visitField-%E5%92%8C-visitMethod-%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.9.2.</span> <span class="toc-text">visitField() 和 visitMethod() 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%88descriptor%EF%BC%89"><span class="toc-number">1.6.9.3.</span> <span class="toc-text">描述符（descriptor）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E7%94%9F%E6%88%90%E7%B1%BB"><span class="toc-number">1.6.10.</span> <span class="toc-text">示例三：生成类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">1.6.10.1.</span> <span class="toc-text">编码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%92%8C-%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.10.2.</span> <span class="toc-text">&lt;init&gt;() 和 &lt;clinit&gt;() 方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FieldVisitor-%E7%B1%BB"><span class="toc-number">1.7.</span> <span class="toc-text">FieldVisitor 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-2"><span class="toc-number">1.7.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-2"><span class="toc-number">1.7.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-2"><span class="toc-number">1.7.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-1"><span class="toc-number">1.7.4.</span> <span class="toc-text">methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E5%AD%97%E6%AE%B5%E5%B8%B8%E9%87%8F"><span class="toc-number">1.7.5.</span> <span class="toc-text">示例一：字段常量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E7%9B%AE%E6%A0%87"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">预期目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">编码实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FieldWriter-%E7%B1%BB"><span class="toc-number">1.8.</span> <span class="toc-text">FieldWriter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-3"><span class="toc-number">1.8.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-3"><span class="toc-number">1.8.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-3"><span class="toc-number">1.8.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-2"><span class="toc-number">1.8.4.</span> <span class="toc-text">methods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EFrame"><span class="toc-number">1.9.</span> <span class="toc-text">关于Frame</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-static-%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.1.</span> <span class="toc-text">1.static 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">方法定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B-Frame"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">初始 Frame</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HelloWorldFrameTree-%E7%B1%BB%E8%BE%93%E5%87%BA%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">HelloWorldFrameTree 类输出的内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="toc-number">1.9.1.4.</span> <span class="toc-text">字节码指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Frame-%E5%8F%98%E5%8C%96"><span class="toc-number">1.9.1.5.</span> <span class="toc-text">Frame 变化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-non-static-%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.2.</span> <span class="toc-text">2.non-static 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">方法定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B-Frame-1"><span class="toc-number">1.9.2.2.</span> <span class="toc-text">初始 Frame</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HelloWorldFrameTree-%E7%B1%BB%E8%BE%93%E5%87%BA%E7%9A%84%E5%86%85%E5%AE%B9-1"><span class="toc-number">1.9.2.3.</span> <span class="toc-text">HelloWorldFrameTree 类输出的内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4-1"><span class="toc-number">1.9.2.4.</span> <span class="toc-text">字节码指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Frame-%E5%8F%98%E5%8C%96-1"><span class="toc-number">1.9.2.5.</span> <span class="toc-text">Frame 变化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-long-%E5%92%8C-double-%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.9.3.</span> <span class="toc-text">3.long 和 double 类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E5%AE%9A%E4%B9%89-2"><span class="toc-number">1.9.3.1.</span> <span class="toc-text">方法定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B-Frame-2"><span class="toc-number">1.9.3.2.</span> <span class="toc-text">初始 Frame</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4-2"><span class="toc-number">1.9.3.3.</span> <span class="toc-text">字节码指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Frame-%E5%8F%98%E5%8C%96-2"><span class="toc-number">1.9.3.4.</span> <span class="toc-text">Frame 变化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MethodVisitor-%E7%B1%BB"><span class="toc-number">1.10.</span> <span class="toc-text">MethodVisitor 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-4"><span class="toc-number">1.10.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-4"><span class="toc-number">1.10.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-4"><span class="toc-number">1.10.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-3"><span class="toc-number">1.10.4.</span> <span class="toc-text">methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A-%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.5.</span> <span class="toc-text">示例一：&lt;init&gt;() 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-4"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A-%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.6.</span> <span class="toc-text">示例二：&lt;clinit&gt; 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-5"><span class="toc-number">1.10.6.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.10.7.</span> <span class="toc-text">示例三：创建对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-6"><span class="toc-number">1.10.7.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%9B%9B%EF%BC%9A%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.8.</span> <span class="toc-text">示例四：调用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0-7"><span class="toc-number">1.10.8.1.</span> <span class="toc-text">编码实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%94%EF%BC%9A%E4%B8%8D%E8%B0%83%E7%94%A8-visitMaxs-%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.9.</span> <span class="toc-text">示例五：不调用 visitMaxs() 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%85%AD%EF%BC%9A%E4%B8%8D%E5%90%8C%E7%9A%84-MethodVisitor-%E4%BA%A4%E5%8F%89%E4%BD%BF%E7%94%A8"><span class="toc-number">1.10.10.</span> <span class="toc-text">示例六：不同的 MethodVisitor 交叉使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E7%9B%AE%E6%A0%87-1"><span class="toc-number">1.10.10.1.</span> <span class="toc-text">预期目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%88%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%8C%E9%A1%BA%E5%BA%8F%EF%BC%89"><span class="toc-number">1.10.10.2.</span> <span class="toc-text">编码实现（第一种方式，顺序）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%AE%9E%E7%8E%B0%EF%BC%88%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%8C%E4%BA%A4%E5%8F%89%EF%BC%89"><span class="toc-number">1.10.10.3.</span> <span class="toc-text">编码实现（第二种方式，交叉）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MethodWriter-%E7%B1%BB"><span class="toc-number">1.11.</span> <span class="toc-text">MethodWriter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-5"><span class="toc-number">1.11.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-5"><span class="toc-number">1.11.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-5"><span class="toc-number">1.11.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-4"><span class="toc-number">1.11.4.</span> <span class="toc-text">methods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassReader-%E7%B1%BB"><span class="toc-number">1.12.</span> <span class="toc-text">ClassReader 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-6"><span class="toc-number">1.12.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-6"><span class="toc-number">1.12.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-6"><span class="toc-number">1.12.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-5"><span class="toc-number">1.12.4.</span> <span class="toc-text">methods</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#getXxx-%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.4.1.</span> <span class="toc-text">getXxx() 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#accept-%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.4.2.</span> <span class="toc-text">accept() 方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ClassReader-%E7%B1%BB"><span class="toc-number">1.12.5.</span> <span class="toc-text">使用 ClassReader 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parsingOptions-%E5%8F%82%E6%95%B0"><span class="toc-number">1.12.6.</span> <span class="toc-text">parsingOptions 参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80%EF%BC%9A%E4%BF%AE%E6%94%B9%E7%B1%BB%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-number">1.12.7.</span> <span class="toc-text">示例一：修改类的版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C%EF%BC%9A%E4%BF%AE%E6%94%B9%E7%B1%BB%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.12.8.</span> <span class="toc-text">示例二：修改类的接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80"><span class="toc-number">1.12.9.</span> <span class="toc-text">总结一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%88%A0%E9%99%A4%E5%AD%97%E6%AE%B5"><span class="toc-number">1.12.10.</span> <span class="toc-text">示例三：删除字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%9B%9B%EF%BC%9A%E6%B7%BB%E5%8A%A0%E5%AD%97%E6%AE%B5"><span class="toc-number">1.12.11.</span> <span class="toc-text">示例四：添加字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%BA%8C"><span class="toc-number">1.12.12.</span> <span class="toc-text">总结二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%94%EF%BC%9A%E5%88%A0%E9%99%A4%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.13.</span> <span class="toc-text">示例五：删除方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%85%AD%EF%BC%9A%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.14.</span> <span class="toc-text">示例六：添加方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AdviceAdapter-%E7%B1%BB"><span class="toc-number">1.13.</span> <span class="toc-text">AdviceAdapter 类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#class-info-7"><span class="toc-number">1.13.1.</span> <span class="toc-text">class info</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields-7"><span class="toc-number">1.13.2.</span> <span class="toc-text">fields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#constructors-7"><span class="toc-number">1.13.3.</span> <span class="toc-text">constructors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#methods-6"><span class="toc-number">1.13.4.</span> <span class="toc-text">methods</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">1. 应用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.13.4.2.</span> <span class="toc-text">2. 注意事项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.13.4.3.</span> <span class="toc-text">3. 工作原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%89%93%E5%8D%B0%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">1.13.5.</span> <span class="toc-text">示例：打印方法参数和返回值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%87%E4%BB%A4%E8%A1%A8"><span class="toc-number">1.14.</span> <span class="toc-text">Java虚拟机指令表</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&text=ASM字节码编辑学习笔记"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&is_video=false&description=ASM字节码编辑学习笔记"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ASM字节码编辑学习笔记&body=Check out this article: http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&title=ASM字节码编辑学习笔记"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&name=ASM字节码编辑学习笔记&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&t=ASM字节码编辑学习笔记"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        John Doe
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        --><!--
          --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- 不蒜子统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
